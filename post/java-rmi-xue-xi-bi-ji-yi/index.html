<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Java RMI å­¦ä¹ ç¬”è®°ï¼ˆä¸€ï¼‰ | skkyblu3</title>
<link rel="shortcut icon" href="https://skyblu3519.github.io/favicon.ico?v=1721054258675">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://skyblu3519.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="Java RMI å­¦ä¹ ç¬”è®°ï¼ˆä¸€ï¼‰ | skkyblu3 - Atom Feed" href="https://skyblu3519.github.io/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="âš ï¸ æ³¨æ„ï¼šè¿™æ˜¯ä¸€ç¯‡ç²—ç³™çš„ä¸ªäººç¬”è®°ï¼ï¼ï¼
ğŸ“– å‚è€ƒæ–‡ç« ï¼šhttps://su18.org/post/rmi-attack/
æµç¨‹æ¶‰åŠçš„éƒ¨åˆ†ç±»åŠå…¶æ„ä¹‰
æ³¨å†Œè¡¨ï¼šjava.rmi.registry.Registry
æ³¨å†Œè¡¨è·å–ä¸åˆ›å»ºï¼šjava..." />
    <meta name="keywords" content="RMI,JAVA,å­¦ä¹ ç¬”è®°" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://skyblu3519.github.io">
  <img class="avatar" src="https://skyblu3519.github.io/images/avatar.png?v=1721054258675" alt="">
  </a>
  <h1 class="site-title">
    skkyblu3
  </h1>
  <p class="site-description">
    Welcome to Internet
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          é¦–é¡µ
        </a>
      
    
      
        <a href="/archives" class="menu">
          å½’æ¡£
        </a>
      
    
      
        <a href="/tags" class="menu">
          æ ‡ç­¾
        </a>
      
    
      
        <a href="/post/about" class="menu">
          å…³äº
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              Java RMI å­¦ä¹ ç¬”è®°ï¼ˆä¸€ï¼‰
            </h2>
            <div class="post-info">
              <span>
                2024-04-01
              </span>
              <span>
                10 min read
              </span>
              
                <a href="https://skyblu3519.github.io/tag/R1aFszg13/" class="post-tag">
                  # RMI
                </a>
              
                <a href="https://skyblu3519.github.io/tag/RwDqGW2an/" class="post-tag">
                  # JAVA
                </a>
              
                <a href="https://skyblu3519.github.io/tag/SBvbIXKgV/" class="post-tag">
                  # å­¦ä¹ ç¬”è®°
                </a>
              
            </div>
            
              <img class="post-feature-image" src="https://skyblu3519.github.io/post-images/java-rmi-xue-xi-bi-ji-yi.jpeg" alt="">
            
            <div class="post-content-wrapper">
              <div class="post-content" v-pre>
                <p>âš ï¸ æ³¨æ„ï¼šè¿™æ˜¯ä¸€ç¯‡ç²—ç³™çš„ä¸ªäººç¬”è®°ï¼ï¼ï¼</p>
<p>ğŸ“– å‚è€ƒæ–‡ç« ï¼š<a href="https://su18.org/post/rmi-attack/">https://su18.org/post/rmi-attack/</a></p>
<h1 id="æµç¨‹æ¶‰åŠçš„éƒ¨åˆ†ç±»åŠå…¶æ„ä¹‰">æµç¨‹æ¶‰åŠçš„éƒ¨åˆ†ç±»åŠå…¶æ„ä¹‰</h1>
<p>æ³¨å†Œè¡¨ï¼šjava.rmi.registry.Registry<br>
æ³¨å†Œè¡¨è·å–ä¸åˆ›å»ºï¼šjava.rmi.registry.LocateRegistry<br>
è¿œç¨‹ç±»æ‰€ç»§æ‰¿çš„ï¼šjava.rmi.server.UnicastRemoteObject<br>
è¿œç¨‹å¯¹è±¡çš„åº”ç”¨ä¿¡æ¯ï¼šsun.rmi.transport.LiveRef<br>
å¤„ç†å®¢æˆ·ç«¯å¯¹è¿œç¨‹å¯¹è±¡çš„è°ƒç”¨è¯·æ±‚ï¼ˆä»£è¡¨æœåŠ¡ç«¯ï¼‰ï¼šjava.rmi.server.UnicastServerRef<br>
è¿œç¨‹å¯¹è±¡å¼•ç”¨çš„ä¸€ä¸ªå…·ä½“å®ç°ï¼ˆä»£è¡¨å®¢æˆ·ç«¯ï¼‰ï¼šjava.rmi.server.UnicastRef<br>
å¤„ç†ç½‘ç»œä¼ è¾“å±‚ç›¸å…³ä»»åŠ¡çš„ç±»å’Œæ¥å£ï¼šsun.rmi.transport<br>
ObjectTableè´Ÿè´£ç®¡ç†æœåŠ¡å™¨ç«¯çš„è¿œç¨‹å¯¹è±¡å¼•ç”¨ã€‚</p>
<h1 id="æºç åˆ†æ">æºç åˆ†æ</h1>
<h2 id="åˆ›å»º">åˆ›å»º</h2>
<h3 id="è¿œç¨‹å¯¹è±¡åˆ›å»º">è¿œç¨‹å¯¹è±¡åˆ›å»º</h3>
<p>è¿œç¨‹å¯¹è±¡å®ä¾‹åŒ–çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨UnicastRemoteObjectçš„æ„é€ æ–¹æ³•ã€‚</p>
<p>æœ€åä¼šè°ƒç”¨UnicastServerRefçš„exportObjectæ–¹æ³•<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711882519441-d328f624-cf31-4aab-8407-3cbe0dd9ef52.png" alt="image.png" loading="lazy"></p>
<p>è€ŒUnicastServerRefåœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šç”¨ä¸€ä¸ªLiveRefå¯¹è±¡ä¸ºè‡ªå·±çš„refå±æ€§èµ‹å€¼<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711882644062-c4a71bf3-f5eb-43e4-b1fb-531adced27dd.png" alt="image.png" loading="lazy"></p>
<p>LiveRefå¯¹è±¡åˆ™å°è£…äº†è¿™ä¸ªè¿œç¨‹å¯¹è±¡å¼•ç”¨ä¿¡æ¯<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711882938646-ef56f2f1-2496-429b-91e1-0a10c9a76ffe.png" alt="image.png" loading="lazy"></p>
<p>è¿™é‡ŒUnicastServerRefçš„exportObjectæ–¹æ³•ä¸»è¦åšäº†ä¸‰ä»¶äº‹ï¼š</p>
<ul>
<li>ä¸ºè¿™ä¸ªè¿œç¨‹å¯¹è±¡åˆ›å»ºä¸€ä¸ªå­˜æ ¹ï¼ˆ<strong>stub</strong>ï¼‰</li>
<li>åˆ›å»ºç›®æ ‡ï¼ˆ<strong>Target</strong>ï¼‰å®ä¾‹ã€‚</li>
<li>è°ƒç”¨<code>ref.exportObject(target)</code>å°†è¿œç¨‹å¯¹è±¡å¯¼å‡ºï¼Œä½¿å…¶å¯ä»¥æ¥å—è¿œç¨‹è°ƒç”¨ã€‚</li>
</ul>
<figure data-type="image" tabindex="1"><img src="https://skyblu3519.github.io/post-images/javarmi1/1711883462008-5e23c978-c91e-4424-a1fe-a3eac24c0f1b.png" alt="image.png" loading="lazy"></figure>
<p>åœ¨è°ƒç”¨<code>Util.createProxy(implClass, getClientRef(), forceStubUse)</code>åˆ›å»ºstubçš„æ—¶å€™è°ƒç”¨<code>getClientRef()</code>æ‰€è¿”å›çš„æ˜¯ä¸€ä¸ªæ ¹æ®<strong>UnicastServerRef</strong>çš„<strong>ref</strong>å±æ€§åˆ›å»ºçš„<strong>UnicastRef</strong>å®ä¾‹<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711883855723-d632b4f8-5208-40cd-ac49-f28787c579e7.png" alt="image.png" loading="lazy"></p>
<p>è€Œstubå…¶å®æ˜¯æˆ‘ä»¬è¿œç¨‹æ–¹æ³•çš„ä¸€ä¸ªåŠ¨æ€ä»£ç†ï¼Œå®ƒçš„ä½¿ç”¨çš„<strong>InvocationHandler</strong>æ˜¯<strong>RemoteObjectInvocationHandler</strong><br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711893132257-33d9e2a5-4ee2-48f7-ae21-244958f26c8b.png" alt="image.png" loading="lazy"></p>
<p><strong>RemoteObjectInvocationHandler</strong>ç»§æ‰¿äº<strong>RemoteObject</strong>ï¼Œå®ä¾‹åŒ–çš„æ—¶å€™ä¼šæ¥å—ä¸€ä¸ª<strong>UnicastRef</strong>ä¸ºè‡ªå·±çš„<strong>ref</strong>å±æ€§èµ‹å€¼ï¼Œåœ¨è¿œç¨‹è°ƒç”¨çš„æ—¶å€™å°±ä¼šä¾é è¿™ä¸ª<strong>ref</strong>å»äºæœåŠ¡å™¨è¿›è¡Œé€šè®¯ã€‚å®ƒçš„invokeæ–¹æ³•åœ¨åæ–‡ä¼šè¯´<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711893468082-cc75cba7-0c97-4b11-98ba-47ff724a118e.png" alt="image.png" loading="lazy"></p>
<p>åˆ›å»ºå¥½stubä¹‹åï¼Œç´§æ¥ç€ä¼šåˆ›å»ºTargetå®ä¾‹ã€‚è¯¥å®ä¾‹å°è£…äº†è¿œç¨‹å¯¹è±¡ï¼ˆ<strong>impl</strong>ï¼‰ï¼Œå®ƒæ‰€å±çš„<strong>UnicastServerRef</strong>å®ä¾‹ï¼ˆé€šå¸¸æ˜¯<strong>this</strong>ï¼‰ï¼Œè¿œç¨‹å¯¹è±¡çš„å­˜æ ¹ï¼ˆ<strong>stub</strong>ï¼‰ï¼Œå¯¹è±¡IDï¼ˆç”±<code>ref.getObjID()</code>è·å–ï¼‰ï¼Œä»¥åŠæ˜¯å¦ä¸ºæ°¸ä¹…å¯¼å‡ºï¼ˆ<strong>permanent</strong>å‚æ•°ï¼‰çš„ä¿¡æ¯ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711893811020-696dd2f6-e5cb-45be-99a7-0c2ad35a4bb1.png" alt="image.png" loading="lazy"></p>
<p>ç„¶åè°ƒç”¨<strong>LiveRef</strong>çš„<strong>exportObject</strong>å°†å¯¹è±¡å¯¼å‡ºã€‚è¿™é‡Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°<code>sun.rmi.transport.tcp.TCPTransport#exportObject</code>ï¼Œå…¶ä¸­ä¼šç›‘å¬æœ¬åœ°ç«¯å£ï¼Œ</p>
<blockquote>
<p>åœ¨ export æ—¶ï¼Œä¼šéšæœºç»‘å®šä¸€ä¸ªç«¯å£ï¼Œç›‘å¬å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œæ‰€ä»¥å³ä½¿ä¸æ³¨å†Œï¼Œç›´æ¥è¯·æ±‚è¿™ä¸ªç«¯å£ä¹Ÿå¯ä»¥é€šä¿¡ã€‚</p>
</blockquote>
<figure data-type="image" tabindex="2"><img src="https://skyblu3519.github.io/post-images/javarmi1/1711894114367-b5ac45d8-ff9b-4fdb-871c-084028f59da4.png" alt="image.png" loading="lazy"></figure>
<p>ç„¶åè°ƒç”¨ <strong>Transport</strong> çš„ exportObject æ–¹æ³•å°† Target å®ä¾‹æ³¨å†Œåˆ° ObjectTable ä¸­ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711894199606-7520e635-a30b-4198-a604-0ac8e7b5bfd6.png" alt="image.png" loading="lazy"></p>
<p><strong>ObjectTable</strong>ç”¨æ¥ç®¡ç†æ‰€æœ‰å‘å¸ƒçš„æœåŠ¡å®ä¾‹ <strong>Target</strong>ï¼Œ<strong>ObjectTable</strong> æä¾›äº†æ ¹æ® <strong>ObjectEndpoint</strong> å’Œ <strong>Remote</strong> å®ä¾‹ä¸¤ç§æ–¹å¼æŸ¥æ‰¾ <strong>Target</strong> çš„æ–¹æ³•<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711894356938-955091ad-7a5e-4163-a425-d690e4308001.png" alt="image.png" loading="lazy"></p>
<h3 id="æ³¨å†Œä¸­å¿ƒåˆ›å»º">æ³¨å†Œä¸­å¿ƒåˆ›å»º</h3>
<p>è°ƒç”¨<strong>java.rmi.registry.LocateRegistry#createRegistry</strong>å®ä¾‹åŒ–ä¸€ä¸ª<strong>RegistryImpl</strong><br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711895416279-0a52cd51-f67d-4b2b-9237-c513741112ea.png" alt="image.png" loading="lazy"></p>
<p>å®ä¾‹åŒ–ä¸€ä¸ª<strong>UnicastServerRef</strong>ç„¶åè°ƒç”¨<strong>setup</strong>æ–¹æ³•<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711895634033-e9e12a86-20d3-4e6d-9a10-30cd8af2c8c0.png" alt="image.png" loading="lazy"></p>
<p>setupä¼šè°ƒç”¨<strong>UnicastServerRef</strong>çš„<strong>exportObject</strong>å°†è‡ªå·±ï¼ˆ<strong>RegistryImpl</strong>ï¼‰å¯¼å‡ºï¼ˆ<strong>RegistryImpl</strong>çš„<strong>ref</strong>æ˜¯<strong>UnicastServerRef</strong>ï¼‰<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711895869676-202a0bb7-2f6c-408f-9cda-c9fad5034d0c.png" alt="image.png" loading="lazy"></p>
<p>åé¢çš„å†…å®¹å’Œè¿œç¨‹å¯¹è±¡åˆ›å»ºçš„æµç¨‹åŸºæœ¬ä¸€æ ·ï¼Œç¬¬ä¸€ä¸ªåŒºåˆ«åœ¨<strong>createProxy</strong>ã€‚<strong>createProxy</strong>åœ¨åˆ›å»º<strong>stub</strong>çš„æ—¶å€™ä¼šåˆ¤æ–­æœ¬åœ°æ˜¯å¦æœ‰è¿œç¨‹å¯¹è±¡çš„å­˜æ ¹ç±»å­˜åœ¨<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711896075903-3d00d489-e277-4133-8d68-1e20687e5a9f.png" alt="image.png" loading="lazy"></p>
<p>åˆ¤æ–­çš„æ–¹å¼å°±æ˜¯æŸ¥çœ‹æ˜¯å¦æœ‰<code>è¿œç¨‹å¯¹è±¡ç±»å+&quot;_Stub&quot;</code>çš„ç±»å­˜åœ¨<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711896181403-6cadbb31-6982-4388-a25c-b55327fc6159.png" alt="image.png" loading="lazy"></p>
<p>è¿™é‡Œå°±ä¼šæŠŠ<strong>RegistryImpl_Stub</strong>æ‰¾å‡ºæ¥ç„¶åå®ä¾‹åŒ–è¿”å›<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711896312090-b503c2b2-6445-434e-a066-166bf75864db.png" alt="image.png" loading="lazy"></p>
<p><strong>RegistryImpl_Stub</strong>å’Œ<strong>RemoteObjectInvocationHandler</strong>åŒæ ·ç»§æ‰¿äº<strong>RemoteObject</strong>ï¼Œå®ä¾‹åŒ–çš„æ—¶å€™ä¹Ÿä¼šæ¥å—ä¸€ä¸ª<strong>LiveRef</strong>ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711896706634-5b3ab7b5-4310-4762-af01-929257fd56ff.png" alt="image.png" loading="lazy"></p>
<p>ç¬¬äºŒä¸ªåŒºåˆ«åœ¨<strong>RegistryImpl_Stub</strong>åˆ›å»ºå¥½ä¹‹åï¼Œä¼šè°ƒç”¨<strong>setSkeleton</strong>è®¾ç½®<strong>UnicastServerRef</strong>çš„<strong>skel</strong>å±æ€§<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711897003866-5c1fdb41-5c6e-4210-882a-ece4a473f702.png" alt="image.png" loading="lazy"><br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711897015571-6796140d-101c-427c-a23e-88f6ec4daed5.png" alt="image.png" loading="lazy"></p>
<p>è¿™é‡Œçš„<strong>skel</strong>å…¶å®å°±æ˜¯å®ä¾‹åŒ–çš„<strong>RegistryImpl_Skel</strong>ï¼Œ<strong>RegistryImpl_Skel</strong>ä½¿ç”¨çš„æ˜¯<strong>java.rmi.server.Skeleton</strong>æ¥å£ï¼Œå®ç°äº†<strong>dispatch</strong>æ–¹æ³•æ¥åˆ†å‘å…·ä½“çš„æ“ä½œã€‚<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711897356746-c12e8971-3f9e-4948-8129-ce045678103f.png" alt="image.png" loading="lazy"></p>
<p>åç»­<strong>Target</strong>çš„å¯¼å‡ºå°±å’Œè¿œç¨‹å¯¹è±¡çš„é‚£ä¸€å—æ²¡ä»€ä¹ˆåŒºåˆ«äº†ã€‚</p>
<p>äºè¿œç¨‹å¯¹è±¡åˆ›å»ºåšä¸ªç±»æ¯”ï¼š</p>
<ul>
<li>æ‰‹å†™è¿œç¨‹å¯¹è±¡ç»§æ‰¿äº<strong>UnicastRemoteObject</strong>ï¼›æ³¨å†Œä¸­å¿ƒåˆ™ç›´æ¥ä½¿ç”¨çš„<strong>RegistryImpl</strong></li>
<li>è¿œç¨‹å¯¹è±¡çš„å­˜æ ¹æ˜¯ä½¿ç”¨<strong>RemoteObjectInvocationHandler</strong>çš„åŠ¨æ€ä»£ç†ï¼›æ³¨å†Œä¸­å¿ƒçš„å­˜æ ¹æ˜¯åå°„åˆ›å»ºçš„<strong>RegistryImpl_Stub</strong></li>
<li>è¿œç¨‹å¯¹è±¡å°è£…çš„<strong>UnicastServerRef</strong>ä¸­<strong>Skel</strong>ä¸ºç©ºï¼›æ³¨å†Œä¸­å¿ƒçš„åˆ™æ˜¯<strong>RegistryImpl_Skel</strong></li>
</ul>
<h2 id="bindlookup">bind/lookup</h2>
<h3 id="æ³¨å†Œä¸­å¿ƒè·å–">æ³¨å†Œä¸­å¿ƒè·å–</h3>
<p>Serverçš„<code>Naming.bind(&quot;rmi://localhost:1099/Hello&quot;, remoteObject)</code>åœ¨ç»‘å®šè¿œç¨‹å¯¹è±¡å‰ï¼Œå’ŒClientä¸€æ ·ï¼Œéƒ½å…ˆè°ƒç”¨äº†<code>LocateRegistry.getRegistry(&quot;localhost&quot;, 1099)</code>è·å–æ³¨å†Œè¡¨ã€‚å…¶ä¸­ä¼šè°ƒç”¨<strong>sun.rmi.server.Util#createProxy</strong>ä¹Ÿå°±æ˜¯ä¹‹å‰åˆ›å»ºstubçš„æ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ª<strong>RegistryImpl_Stub</strong>è¿”å›ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711899939115-8fe021db-f16f-4934-8b43-c385377fed5b.png" alt="image.png" loading="lazy"></p>
<h3 id="bind">bind</h3>
<p><strong>RegistryImpl_Stub.bind</strong>å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸‰æ­¥ï¼š</p>
<ol>
<li>åˆ›å»ºè¿œç¨‹è°ƒç”¨ï¼šè°ƒç”¨<code>sun.rmi.server.UnicastRef#newCall</code>å®ä¾‹åŒ–ä¸€ä¸ª<strong>StreamRemoteCall</strong>å¯¹è±¡å¹¶è¿”å›ï¼Œå®ƒç”¨äºå¤„ç†RMIå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¹‹é—´çš„è¿œç¨‹è°ƒç”¨è¿‡ç¨‹ä¸­çš„åºåˆ—åŒ–ï¼ˆç¼–ç»„ï¼‰å’Œååºåˆ—åŒ–ï¼ˆè§£ç»„ï¼‰çš„æµæ“ä½œã€‚åˆ›å»ºçš„æ—¶å€™æŒ‡å®šçš„æ“ä½œæ•°ï¼Œ0è¡¨ç¤ºbindä¸€ä¸ªè¿œç¨‹å¯¹è±¡ã€‚</li>
<li>åºåˆ—åŒ–å‚æ•°ï¼šè·å–RemoteCallçš„è¾“å‡ºæµï¼ˆ<code>ObjectOutput var4 = var3.getOutputStream();</code>ï¼‰ï¼Œå¹¶å°†è¦ç»‘å®šçš„åç§°ï¼ˆvar1ï¼‰å’Œè¿œç¨‹å¯¹è±¡ï¼ˆvar2ï¼‰åºåˆ—åŒ–åˆ°è¿™ä¸ªæµä¸­ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯å°†Javaå¯¹è±¡è½¬æ¢ä¸ºå¯ä»¥é€šè¿‡ç½‘ç»œä¼ è¾“çš„å­—èŠ‚æµçš„è¿‡ç¨‹ï¼Œç§°ä¸ºç¼–ç»„ï¼ˆmarshallingï¼‰ã€‚</li>
<li>æ‰§è¡Œè¿œç¨‹è°ƒç”¨ï¼šä½¿ç”¨<code>super.ref.invoke(var3)</code>è°ƒç”¨åœ¨è¿œç¨‹å¼•ç”¨ä¸Šæ‰§è¡Œè¿œç¨‹æ–¹æ³•è°ƒç”¨ã€‚è¿™ä¸ªæ­¥éª¤å®é™…ä¸Šæ˜¯å°†ä¹‹å‰ç¼–ç»„çš„å‚æ•°å‘é€åˆ°è¿œç¨‹RMIæ³¨å†Œè¡¨æœåŠ¡ï¼Œå¹¶è¯·æ±‚æ‰§è¡Œbindæ“ä½œã€‚</li>
</ol>
<figure data-type="image" tabindex="3"><img src="https://skyblu3519.github.io/post-images/javarmi1/1711902565270-4df28789-64f1-41e7-af90-6bbbd6517842.png" alt="image.png" loading="lazy"></figure>
<p>ï¼ˆæ¬¡æ—¥è¡¥å……ï¼š<br>
å¦‚æœæŒ‰ç…§è¿™é‡Œä»£ç æ‰€ç¤ºï¼Œåœ¨æ³¨å†Œä¸­å¿ƒç»‘å®šçš„åº”è¯¥æ˜¯è¿™ä¸ªè¿œç¨‹ç±»çš„å®ç°ç±»ã€‚ä½†å®é™…ä¸Šç»‘å®šçš„æ˜¯è¿™ä¸ªç±»çš„ä¸€ä¸ªä»£ç†ç±»ï¼Œå…¶ç»“æ„å¦‚ä¸‹ï¼š<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711961744635-3a9ace0d-8787-4a80-8d2b-5351ec108371.png" alt="image.png" loading="lazy"></p>
<p>æŒ‰ç…§æ–‡ç« ä¸­çš„è¯´æ³•ï¼Œåœ¨å®ä¾‹åŒ–<strong>StreamRemoteCall</strong>çš„æ—¶å€™ä¼šè°ƒç”¨<code>marshalCustomCallData</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯è®¾è®¡æ¥åºåˆ—åŒ–ï¼ˆç¼–ç»„ï¼‰è‡ªå®šä¹‰çš„è°ƒç”¨æ•°æ®åˆ°è¾“å‡ºæµä¸­çš„ã€‚å¼•ç”¨æ–‡ä¸­çš„å›¾ç‰‡å’Œæè¿°</p>
<blockquote>
<p>ä½¿ç”¨ sun.rmi.server.MarshalOutputStream å°è£…åä¼šä½¿ç”¨åŠ¨æ€ä»£ç†ç±»æ¥æ›¿æ¢åŸå§‹ç±»ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711961976285-aab5a303-b831-43bb-929e-8c236cf92fcf.png" alt="image.png" loading="lazy"></p>
</blockquote>
<p>ä¸è¿‡æˆ‘æ‰€è°ƒè¯•çš„æºç ä¸­<code>marshalCustomCallData</code>æ²¡æœ‰å®ç°ä»»ä½•å†…å®¹<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711962083536-f150ae2b-94e0-47df-8a25-18e842ca231b.png" alt="image.png" loading="lazy"></p>
<p>å¥‡æ€ªçš„æ˜¯æœ€åæ³¨å†Œè¡¨æ”¶åˆ°çš„ç±»ï¼Œè¿˜æ˜¯è¿™ä¸ªè¿œç¨‹ç±»çš„ä»£ç†ç±»ã€‚å¯èƒ½æ˜¯Javaç‰ˆæœ¬çš„åŸå› ï¼ˆæˆ‘æ‰€ç”¨çš„æ˜¯JDK 1.8.0_65ï¼‰ï¼Œè¿™é‡Œæš‚ä¸æ·±ç©¶<br>
ï¼‰</p>
<p>å½“ä¼ å…¥<code>sun.rmi.server.UnicastRef#invoke</code>çš„å‚æ•°ä¸º<strong>RemoteCall</strong>ç±»å‹æ—¶ï¼Œä¼šç›´æ¥è°ƒç”¨å®ƒçš„<code>executeCall</code>æ–¹æ³•<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711903259095-369500f6-87db-44b4-8563-f77379488af4.png" alt="image.png" loading="lazy"></p>
<p>åœ¨è¿™é‡Œé¢ä¼šè°ƒç”¨<code>releaseOutputStream()</code>é‡Šæ”¾è¾“å‡ºæµï¼Œå®ƒæ ‡å¿—ç€å‘é€ç»™è¿œç¨‹å¯¹è±¡çš„æ•°æ®å·²ç»å®Œæˆåºåˆ—åŒ–å¹¶è¢«å‘é€å‡ºå»ï¼›æ¥ç€ä¼šè°ƒç”¨<code>getInputStream()</code>æ¥ä»ç½‘ç»œè¿æ¥æ¥æ”¶æ•°æ®ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711903287620-25e4e206-0141-4837-81f3-383a1778a49f.png" alt="image.png" loading="lazy"></p>
<p>åœ¨ <strong>Registry</strong> ç«¯ï¼Œç”± <code>sun.rmi.transport.tcp.TCPTransport#handleMessages </code>æ¥å¤„ç†è¯·æ±‚ï¼Œè°ƒç”¨ <code>serviceCall</code> æ–¹æ³•å¤„ç†ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711903573254-ea0eb4b4-592a-48a1-9b84-65168e32e6f8.png" alt="image.png" loading="lazy"></p>
<p><code>serviceCall</code> æ–¹æ³•ä¸­ä» <strong>ObjectTable</strong> ä¸­è·å–å°è£…çš„ <code>Target</code> å¯¹è±¡ï¼Œå¹¶è·å–å…¶ä¸­çš„å°è£…çš„ <strong>UnicastServerRef</strong> ä»¥åŠ <strong>RegistryImpl</strong> å¯¹è±¡ã€‚ç„¶åè°ƒç”¨ <strong>UnicastServerRef</strong> çš„ <code>dispatch</code> æ–¹æ³•<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711903759350-addd7012-6c98-4604-b7c8-d1bc996a3198.png" alt="image.png" loading="lazy"></p>
<p><strong>UnicastServerRef</strong> çš„ <code>dispatch</code> æ–¹æ³•è°ƒç”¨ <code>oldDispatch</code> æ–¹æ³•ï¼Œè¿™é‡Œåˆ¤æ–­äº† <code>this.skel</code> æ˜¯å¦ä¸ºç©ºï¼Œç”¨æ¥åŒºåˆ«è‡ªå·±æ˜¯ <strong>Registry</strong> è¿˜æ˜¯ <strong>Server</strong>ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711903892067-465bb438-a65e-4a2b-b010-406dc405c6f2.png" alt="image.png" loading="lazy"></p>
<p>åœ¨<code>oldDispatch</code>ä¸­ä¼šè°ƒç”¨<strong>RegistryImpl_Skel</strong> çš„ <code>dispatch</code>ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711904200696-9f0fe3e8-3a1c-419c-9045-97f4b5b746cc.png" alt="image.png" loading="lazy"></p>
<p><strong>RegistryImpl_Skel</strong> çš„ <code>dispatch</code>ä¼šååºåˆ—åŒ–è¿œç¨‹å¯¹è±¡ä»¥åŠå®ƒçš„åç§°ï¼Œç„¶åè°ƒç”¨ <strong>RegistryImpl</strong> çš„<code>bind</code>æ–¹æ³•<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711904416949-001aaa3c-882d-4d77-8388-47bde09466e4.png" alt="image.png" loading="lazy"></p>
<p>æœ€ç»ˆä¼šåœ¨ <strong>RegistryImpl</strong>çš„ bindings ä¸Šæ·»åŠ è¿œç¨‹å¯¹è±¡çš„ä¿¡æ¯<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711904621048-0bae97d2-cc6b-4b93-b7d6-154ab82cb09b.png" alt="image.png" loading="lazy"></p>
<h3 id="lookup">lookup</h3>
<p>å®¢æˆ·ç«¯è°ƒç”¨çš„<code>lookup</code>ï¼Œå…¶å®æ˜¯<strong>RegistryImpl_Stub</strong>çš„<code>lookup</code>ã€‚è¿™ä¸ªæµç¨‹å’Œä¸Šé¢<code>bind</code>çš„ç±»ä¼¼ï¼Œé¦–å…ˆä¼šåˆ›å»ºä¸€ä¸ª<code>RemoteCall</code>æŒ‡å®šæ“ä½œæ•°ä¸º2ï¼Œä¹Ÿå°±æ˜¯lookupã€‚æ¥ç€ä¼šå°†è¦æŸ¥æ‰¾å¯¹è±¡åç§°åºåˆ—åŒ–åå†™å…¥æµï¼Œæ³¨å†Œä¸­å¿ƒæŸ¥æ‰¾å¯¹åº”çš„stubï¼Œåºåˆ—åŒ–ä¹‹åè¿”å›ç»™å®¢æˆ·ç«¯ã€‚å®¢æˆ·ç«¯ååºåˆ—åŒ–ä¹‹åè¿”å›è¿™ä¸ªstubã€‚<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711957115558-05dad9db-a125-4ba3-ae11-84c5903c9baa.png" alt="image.png" loading="lazy"></p>
<p>åœ¨<strong>RegistryImpl_Skel</strong>çš„<code>dispatch</code>ä¸­çœ‹ä¸‹<code>lookup</code>ï¼Œä¹Ÿå°±æ˜¯switch 2çš„å¤„ç†æ–¹å¼ã€‚è°ƒç”¨çš„æ˜¯<strong>RegistryImpl</strong>çš„<code>lookup</code>ï¼Œä¹Ÿå°±æ˜¯ä»<code>bindings</code>ä¸­è·å–å¯¹åº”çš„ä»£ç†ç±»ã€‚å†å°†è¿™ä¸ªç±»åºåˆ—åŒ–å†™å…¥æµï¼Œç”±å®¢æˆ·ç«¯æ¥å—ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711957330607-e721394d-3db8-43ef-95dc-c91b8b4492ef.png" alt="image.png" loading="lazy"></p>
<p>å®¢æˆ·ç«¯è·å–çš„stub<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711962690177-04b9b194-7f56-4b57-8d08-6803ec7430ea.png" alt="image.png" loading="lazy"></p>
<h2 id="è°ƒç”¨">è°ƒç”¨</h2>
<p>å®¢æˆ·ç«¯è°ƒç”¨è¿œç¨‹å¯¹è±¡æ–¹æ³•çš„æ—¶å€™ï¼Œå°±æ˜¯é€šè¿‡ **RemoteObjectInvocationHandler **çš„ <code>invoke</code> æ–¹æ³•ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711972157896-c579d148-e924-4e13-8a0a-073fc07a2405.png" alt="image.png" loading="lazy"></p>
<p><strong>RemoteObjectInvocationHandler</strong>çš„ <code>invokeRemoteMethod</code> ä¼šè°ƒç”¨è‡ªèº« <strong>UnicastRef</strong>çš„ <code>invoke</code> æ–¹æ³•ï¼Œå®ƒæ¥å—è¿œç¨‹å¯¹è±¡çš„ä»£ç†ï¼ˆ<strong>proxy</strong>ï¼‰ã€è°ƒç”¨çš„æ–¹æ³•ï¼ˆ<strong>method</strong>ï¼‰ã€å‚æ•°ï¼ˆ<strong>args</strong>ï¼‰å’Œæ–¹æ³•çš„å“ˆå¸Œï¼ˆ<strong>getMethodHash(method)</strong>ï¼‰ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711972671829-4a507efd-a24a-427e-89ef-0539adad853a.png" alt="image.png" loading="lazy"></p>
<p><strong>UnicastRef</strong>çš„ <code>invoke</code> æ–¹æ³•ä¼šå…ˆäºæœåŠ¡ç«¯ç»‘å®šè¿™ä¸ªè¿œç¨‹å¯¹è±¡çš„ç«¯å£å»ºç«‹ï¼Œæ‰§è¡Œè°ƒç”¨ï¼Œè¯»å–ç»“æœå¹¶ååºåˆ—åŒ–ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711973066511-f2c969e4-c500-49d1-8682-db69d374eec5.png" alt="image.png" loading="lazy"></p>
<p>ååºåˆ—åŒ–çš„æ–¹æ³•åœ¨åé¢çš„<code>unmarshalValue</code>ä¸­ï¼Œå¯ä»¥çœ‹åˆ°é™¤äº†åŸºç¡€ç±»å‹ï¼ˆä¸åŒ…å«Stringï¼‰ï¼Œéƒ½ä¼šå¯¹è¿”å›å¯¹è±¡è¿›è¡Œååºåˆ—åŒ–æ“ä½œã€‚<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711973130095-482f7796-6c80-4586-b3c5-c1247a2e3acf.png" alt="image.png" loading="lazy"></p>
<p>å’Œ <strong>RegistryImpl_Stub</strong>è°ƒç”¨æµç¨‹ç›¸ä¼¼ï¼ŒæœåŠ¡ç«¯é¦–å…ˆæ ¹æ®è¿æ¥çš„ä¿¡æ¯ä» <strong>ObjectTable</strong> æ‰¾åˆ° <strong>Target</strong>ï¼Œå†ç”¨ <code>getDispatcher</code> è·å¾—å…¶ä¸­çš„ <strong>UnicastServerRef</strong>ï¼Œå¹¶è°ƒç”¨ <strong>UnicastServerRef</strong>çš„ <code>dispatch</code> æ–¹æ³•æ¥å¤„ç†ã€‚</p>
<p>åœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œç”±äºæ˜¯è¿œç¨‹å¯¹è±¡è°ƒç”¨ï¼Œæ“ä½œæ•°ä¸º-1ï¼Œå°±ä¸å†èµ°skelçš„å¤„ç†é€»è¾‘äº†<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711974770832-643d7042-7b7f-4d82-a22b-1e16fdc8fa8f.png" alt="image.png" loading="lazy"></p>
<p>è°ƒç”¨æ–¹æ³•å‰ä¼šå…ˆæ£€æŸ¥è¦è°ƒç”¨çš„æ–¹æ³•å­˜ä¸å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™è°ƒç”¨<code>unmarshalValue</code>ååºåˆ—åŒ–å‡ºå‚æ•°ï¼Œç„¶ååå°„è°ƒç”¨æ–¹æ³•<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711974967664-668aaac4-f8ab-425b-b6ab-35547f55175e.png" alt="image.png" loading="lazy"></p>
<p>ç„¶åå°†è°ƒç”¨ç»“æœåºåˆ—åŒ–è¿”å›ç»™å®¢æˆ·ç«¯<br>
<img src="https://skyblu3519.github.io/post-images/javarmi1/1711975193013-5c704223-8427-4b2b-98eb-a2772fbde417.png" alt="image.png" loading="lazy"></p>
<h1 id="å°ç»“">å°ç»“</h1>
<p>ç°åœ¨å¯¹rmiå¤§è‡´çš„å·¥ä½œæµç¨‹æœ‰ä¸ªäº†è§£äº†ã€‚</p>
<p>ä¸»è¦æ˜¯ä»£è¡¨å®¢æˆ·ç«¯ <strong>stub</strong>çš„è°ƒç”¨æ–¹å¼ï¼Œè€Œæ³¨å†Œä¸­å¿ƒ <strong>Registry</strong>å°±ç›¸å½“äºåœ¨åŸºç¡€çš„ <strong>stub</strong> å’Œ <strong>UnicastServerRef</strong> çš„é€šä¿¡æµç¨‹ä¸Šå¤šäº†ä¸€ç‚¹ä¸œè¥¿ã€‚</p>
<p>ä»è¿™ä¸ªæµç¨‹æˆ‘ä»¬ä¹ŸçŸ¥é“äº†ï¼ŒServerï¼ŒRegistry å’Œ Client ä¹‹é—´çš„é€šè®¯å‡æ˜¯ç”±ååºåˆ—åŒ–å®ç°çš„ï¼Œä¹Ÿå°±è¯´æ˜é’ˆå¯¹ä¸‰ç«¯éƒ½æœ‰æ”»å‡»çš„å¯èƒ½ã€‚</p>
<p>å…·ä½“çš„æ”»å‡»æ–¹æ³•å…ˆå¤§è‡´çœ‹äº†ä¸€éï¼Œå…·ä½“æµç¨‹ç­‰ä¹‹åæœ‰æ—¶é—´å†åšäº†ï¼Œè¿™é‡Œå…ˆè®°ä¸€ä¸‹ã€‚</p>
<p><strong>æ”»å‡»Serverç«¯ï¼š</strong></p>
<ul>
<li>æ¶æ„åºåˆ—åŒ–å¯¹è±¡ä½œä¸ºå‚æ•°ä¼ å…¥
<ul>
<li>å¦‚ä½•å‚æ•°ä¸æ˜¯Objectç±»å‹ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹ä¼ å…¥æ–¹æ³•Hashæ¥åŒ¹é…ã€‚æ€»ç»“ï¼šServer ç«¯çš„è°ƒç”¨æ–¹æ³•å­˜åœ¨éåŸºç¡€ç±»å‹çš„å‚æ•°æ—¶ï¼Œå°±å¯ä»¥è¢«æ¶æ„ Client ç«¯ä¼ å…¥æ¶æ„æ•°æ®æµè§¦å‘ååºåˆ—åŒ–æ¼æ´ã€‚</li>
</ul>
</li>
<li>åŠ¨æ€ç±»åŠ è½½ï¼šé€šè¿‡<code>this.readLocation()</code>æ–¹æ³•è¯»å–æµä¸­åºåˆ—åŒ–çš„ <code>java.rmi.server.codebase</code> åœ°å€è®©æœåŠ¡ç«¯å†è¿œç¨‹åŠ è½½æ¶æ„ç±»</li>
</ul>
<p><strong>æ”»å‡» Registry ç«¯ï¼š</strong></p>
<ul>
<li>åœ¨ <strong>Server</strong> ç«¯å‘ <strong>Registry</strong> ç«¯æäº¤ <code>bind</code> çš„è¿œç¨‹å¯¹è±¡æ—¶ï¼Œ<strong>Registry</strong> ä¼šååºåˆ—åŒ–è¿™ä¸ªå¯¹è±¡å­˜æ”¾åˆ° <code>bindings</code> ä¸­ã€‚æ‰€ä»¥ <strong>Server</strong> ç«¯å¯ä»¥æäº¤ä¸€ä¸ªæ¶æ„ç±»ï¼Œéœ€è¦æ˜¯ <strong>Remote</strong> ç±»å‹ï¼ˆç”¨ <strong>AnnotationInvocationHandler</strong> æ¥åšï¼‰</li>
</ul>
<p><strong>æ”»å‡» Client ç«¯ï¼š</strong></p>
<ul>
<li>æ¶æ„ Server Stubï¼šåŒæ”»å‡» Registry ç«¯ï¼ŒClient ç«¯åœ¨ Registry ç«¯ lookup åä¼šæ‹¿åˆ°ä¸€ä¸ª Server ç«¯æ³¨å†Œåœ¨ Registry ç«¯çš„ä»£ç†å¯¹è±¡å¹¶ååºåˆ—åŒ–è§¦å‘æ¼æ´ã€‚</li>
<li>æ¶æ„ Server ç«¯è¿”å›å€¼ï¼šåŒæ”»å‡» Server ç«¯çš„æ¶æ„æœåŠ¡å‚æ•°ï¼ŒServer ç«¯è¿”å›ç»™ Client ç«¯æ¶æ„çš„è¿”å›å€¼ï¼ŒClient ç«¯ååºåˆ—åŒ–è§¦å‘æ¼æ´ï¼Œä¸å†èµ˜è¿°ã€‚</li>
<li>åŠ¨æ€ç±»åŠ è½½ï¼šåŒæ”»å‡» Server ç«¯çš„åŠ¨æ€ç±»åŠ è½½ï¼ŒServer ç«¯è¿”å›ç»™ Client ç«¯ä¸å­˜åœ¨çš„ç±»ï¼Œè¦æ±‚ Client ç«¯å» codebase åœ°å€è¿œç¨‹åŠ è½½æ¶æ„ç±»è§¦å‘æ¼æ´ï¼Œä¸å†èµ˜è¿°ã€‚</li>
</ul>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li><a href="#%E6%B5%81%E7%A8%8B%E6%B6%89%E5%8F%8A%E7%9A%84%E9%83%A8%E5%88%86%E7%B1%BB%E5%8F%8A%E5%85%B6%E6%84%8F%E4%B9%89">æµç¨‹æ¶‰åŠçš„éƒ¨åˆ†ç±»åŠå…¶æ„ä¹‰</a></li>
<li><a href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90">æºç åˆ†æ</a>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BA">åˆ›å»º</a>
<ul>
<li><a href="#%E8%BF%9C%E7%A8%8B%E5%AF%B9%E8%B1%A1%E5%88%9B%E5%BB%BA">è¿œç¨‹å¯¹è±¡åˆ›å»º</a></li>
<li><a href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%88%9B%E5%BB%BA">æ³¨å†Œä¸­å¿ƒåˆ›å»º</a></li>
</ul>
</li>
<li><a href="#bindlookup">bind/lookup</a>
<ul>
<li><a href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E8%8E%B7%E5%8F%96">æ³¨å†Œä¸­å¿ƒè·å–</a></li>
<li><a href="#bind">bind</a></li>
<li><a href="#lookup">lookup</a></li>
</ul>
</li>
<li><a href="#%E8%B0%83%E7%94%A8">è°ƒç”¨</a></li>
</ul>
</li>
<li><a href="#%E5%B0%8F%E7%BB%93">å°ç»“</a></li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">ä¸‹ä¸€ç¯‡</div>
            <a href="https://skyblu3519.github.io/post/utctf2024-schrodinger-easy-mergers/">
              <h3 class="post-title">
                UTCTF2024 SchrÃ¶dinger + Easy Mergers
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
  <a class="rss" href="https://skyblu3519.github.io/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
