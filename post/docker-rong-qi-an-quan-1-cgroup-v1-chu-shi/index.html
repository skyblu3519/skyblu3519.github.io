<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>[Dockerå®¹å™¨å®‰å…¨1] cgroup v1åˆè¯† | skkyblu3</title>
<link rel="shortcut icon" href="https://skyblu3519.github.io/favicon.ico?v=1721054258675">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://skyblu3519.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="[Dockerå®¹å™¨å®‰å…¨1] cgroup v1åˆè¯† | skkyblu3 - Atom Feed" href="https://skyblu3519.github.io/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="ä»Šå¤©å­¦ä¹ äº‘åŸç”Ÿå®‰å…¨ä¸­dockeré€ƒé€¸ç›¸å…³å†…å®¹ï¼Œé¦–å…ˆæ˜¯åˆ¤æ–­æ˜¯å¦ä¸ºå®¹å™¨ç¯å¢ƒ
cat /proc/1/cgroup | grep -qi docker &amp;&amp; echo &quot;Is Docker&quot; || echo &..." />
    <meta name="keywords" content="äº‘åŸç”Ÿ,å®¹å™¨å®‰å…¨,cgroup" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://skyblu3519.github.io">
  <img class="avatar" src="https://skyblu3519.github.io/images/avatar.png?v=1721054258675" alt="">
  </a>
  <h1 class="site-title">
    skkyblu3
  </h1>
  <p class="site-description">
    Welcome to Internet
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          é¦–é¡µ
        </a>
      
    
      
        <a href="/archives" class="menu">
          å½’æ¡£
        </a>
      
    
      
        <a href="/tags" class="menu">
          æ ‡ç­¾
        </a>
      
    
      
        <a href="/post/about" class="menu">
          å…³äº
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              [Dockerå®¹å™¨å®‰å…¨1] cgroup v1åˆè¯†
            </h2>
            <div class="post-info">
              <span>
                2024-03-26
              </span>
              <span>
                16 min read
              </span>
              
                <a href="https://skyblu3519.github.io/tag/uCbxLgxkz/" class="post-tag">
                  # äº‘åŸç”Ÿ
                </a>
              
                <a href="https://skyblu3519.github.io/tag/uVChpOuTBN/" class="post-tag">
                  # å®¹å™¨å®‰å…¨
                </a>
              
                <a href="https://skyblu3519.github.io/tag/gWvmlkUU0v/" class="post-tag">
                  # cgroup
                </a>
              
            </div>
            
              <img class="post-feature-image" src="https://skyblu3519.github.io/post-images/docker-rong-qi-an-quan-1-cgroup-v1-chu-shi.jpeg" alt="">
            
            <div class="post-content-wrapper">
              <div class="post-content" v-pre>
                <p>ä»Šå¤©å­¦ä¹ äº‘åŸç”Ÿå®‰å…¨ä¸­dockeré€ƒé€¸ç›¸å…³å†…å®¹ï¼Œé¦–å…ˆæ˜¯åˆ¤æ–­æ˜¯å¦ä¸ºå®¹å™¨ç¯å¢ƒ</p>
<pre><code class="language-shell">cat /proc/1/cgroup | grep -qi docker &amp;&amp; echo &quot;Is Docker&quot; || echo &quot;Not Docker&quot;
</code></pre>
<p>wait, è¿™ä¸ªcgroupæ˜¯å•¥ï¼Ÿ</p>
<h1 id="ç›¸å…³æ¦‚å¿µ">ç›¸å…³æ¦‚å¿µ</h1>
<h2 id="task">Task</h2>
<blockquote>
<p>Task(ä»»åŠ¡)ï¼š åœ¨ linux ç³»ç»Ÿä¸­ï¼Œå†…æ ¸æœ¬èº«çš„è°ƒåº¦å’Œç®¡ç†å¹¶ä¸å¯¹è¿›ç¨‹å’Œçº¿ç¨‹è¿›è¡ŒåŒºåˆ†ï¼Œåªæ˜¯æ ¹æ® clone() æ—¶ä¼ å…¥çš„å‚æ•°çš„ä¸åŒæ¥ä»æ¦‚å¿µä¸ŠåŒºåˆ†è¿›ç¨‹å’Œçº¿ç¨‹ã€‚è¿™é‡Œä½¿ç”¨ task æ¥è¡¨ç¤ºç³»ç»Ÿçš„ä¸€ä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹ã€‚</p>
</blockquote>
<h2 id="cgroup">Cgroup</h2>
<blockquote>
<p>Cgroup(æ§åˆ¶ç»„)ï¼šcgroups ä¸­çš„èµ„æºæ§åˆ¶ä»¥ cgroup ä¸ºå•ä½å®ç°ã€‚Cgroup è¡¨ç¤ºæŒ‰æŸç§èµ„æºæ§åˆ¶æ ‡å‡†åˆ’åˆ†è€Œæˆçš„ä»»åŠ¡ç»„ï¼ŒåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå­ç³»ç»Ÿã€‚ä¸€ä¸ªä»»åŠ¡å¯ä»¥åŠ å…¥æŸä¸ª cgroupï¼Œä¹Ÿå¯ä»¥ä»æŸä¸ª cgroup è¿ç§»åˆ°å¦ä¸€ä¸ª cgroupã€‚</p>
</blockquote>
<p>åˆ’åˆ†ç»„çš„ç›®çš„å°±æ˜¯æ–¹ä¾¿ç®¡ç†ï¼Œç®¡ç†Linuxä¸­ä»»åŠ¡è°ƒåº¦çš„èµ„æºç”¨çš„å°±æ˜¯cgroupã€‚å¦å¤–ï¼Œcgroupåœ¨ä¸åŒçš„ä¸Šä¸‹æ–‡ä¸­ä»£è¡¨ä¸åŒçš„æ„æ€ï¼Œå¯ä»¥æŒ‡æ•´ä¸ªLinuxçš„<strong>cgroupæŠ€æœ¯</strong>ï¼Œä¹Ÿå¯ä»¥æŒ‡ä¸€ä¸ª<strong>å…·ä½“è¿›ç¨‹ç»„</strong>ã€‚</p>
<h2 id="subsystem">Subsystem</h2>
<blockquote>
<p>Subsystem(å­ç³»ç»Ÿ)ï¼šcgroups ä¸­çš„å­ç³»ç»Ÿå°±æ˜¯ä¸€ä¸ªèµ„æºè°ƒåº¦æ§åˆ¶å™¨(åˆå« controllers)ã€‚æ¯”å¦‚ CPU å­ç³»ç»Ÿå¯ä»¥æ§åˆ¶ CPU çš„æ—¶é—´åˆ†é…ï¼Œå†…å­˜å­ç³»ç»Ÿå¯ä»¥é™åˆ¶å†…å­˜çš„ä½¿ç”¨é‡ã€‚ä»¥ç¬”è€…ä½¿ç”¨çš„ Ubuntu 16.04.3 ä¸ºä¾‹ï¼Œå…¶å†…æ ¸ç‰ˆæœ¬ä¸º 4.10.0ï¼Œæ”¯æŒçš„ subsystem å¦‚ä¸‹( cat /proc/cgroups)ï¼š</p>
<ul>
<li>blkiï¼šå¯¹å—è®¾å¤‡çš„ IO è¿›è¡Œé™åˆ¶ã€‚</li>
<li>cpuï¼šé™åˆ¶ CPU æ—¶é—´ç‰‡çš„åˆ†é…ï¼Œä¸ cpuacct æŒ‚è½½åœ¨åŒä¸€ç›®å½•ã€‚</li>
<li>cpuacctï¼šç”Ÿæˆ cgroup ä¸­çš„ä»»åŠ¡å ç”¨ CPU èµ„æºçš„æŠ¥å‘Šï¼Œä¸ cpu æŒ‚è½½åœ¨åŒä¸€ç›®å½•ã€‚</li>
<li>cpusetï¼šç»™ cgroup ä¸­çš„ä»»åŠ¡åˆ†é…ç‹¬ç«‹çš„ CPU(å¤šå¤„ç†å™¨ç³»ç»Ÿ) å’Œå†…å­˜èŠ‚ç‚¹ã€‚</li>
<li>devicesï¼šå…è®¸æˆ–ç¦æ­¢ cgroup ä¸­çš„ä»»åŠ¡è®¿é—®è®¾å¤‡ã€‚</li>
<li>freezerï¼šæš‚åœ/æ¢å¤ cgroup ä¸­çš„ä»»åŠ¡ã€‚</li>
<li>hugetlbï¼šé™åˆ¶ä½¿ç”¨çš„å†…å­˜é¡µæ•°é‡ã€‚</li>
<li>memoryï¼šå¯¹ cgroup ä¸­çš„ä»»åŠ¡çš„å¯ç”¨å†…å­˜è¿›è¡Œé™åˆ¶ï¼Œå¹¶è‡ªåŠ¨ç”Ÿæˆèµ„æºå ç”¨æŠ¥å‘Šã€‚</li>
<li>net_clsï¼šä½¿ç”¨ç­‰çº§è¯†åˆ«ç¬¦ï¼ˆclassidï¼‰æ ‡è®°ç½‘ç»œæ•°æ®åŒ…ï¼Œè¿™è®© Linux æµé‡æ§åˆ¶å™¨ï¼ˆtc æŒ‡ä»¤ï¼‰å¯ä»¥è¯†åˆ«æ¥è‡ªç‰¹å®š cgroup ä»»åŠ¡çš„æ•°æ®åŒ…ï¼Œå¹¶è¿›è¡Œç½‘ç»œé™åˆ¶ã€‚</li>
<li>net_prioï¼šå…è®¸åŸºäº cgroup è®¾ç½®ç½‘ç»œæµé‡(netowork traffic)çš„ä¼˜å…ˆçº§ã€‚</li>
<li>perf_eventï¼šå…è®¸ä½¿ç”¨ perf å·¥å…·æ¥ç›‘æ§ cgroupã€‚</li>
<li>pidsï¼šé™åˆ¶ä»»åŠ¡çš„æ•°é‡ã€‚</li>
</ul>
</blockquote>
<p>ç®€å•ç†è§£Subsystemå°±æ˜¯å¯¹LinuxæŸä¸€èµ„æºçš„ç®¡ç†ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼ŒLinuxæ”¯æŒ12ç§subsystemã€‚</p>
<h2 id="hierarchy">Hierarchy</h2>
<blockquote>
<p>Hierarchy(å±‚çº§)ï¼šä¸€ä¸ªhierarchyå¯ä»¥ç†è§£ä¸ºä¸€æ£µcgroupæ ‘ï¼Œæ ‘çš„æ¯ä¸ªèŠ‚ç‚¹å°±æ˜¯ä¸€ä¸ªè¿›ç¨‹ç»„ï¼Œæ¯æ£µæ ‘éƒ½ä¼šä¸é›¶åˆ°å¤šä¸ªsubsystemå…³è”ã€‚åœ¨ä¸€é¢—æ ‘é‡Œé¢ï¼Œä¼šåŒ…å«Linuxç³»ç»Ÿä¸­çš„æ‰€æœ‰è¿›ç¨‹ï¼Œä½†æ¯ä¸ªè¿›ç¨‹åªèƒ½å±äºä¸€ä¸ªèŠ‚ç‚¹ï¼ˆè¿›ç¨‹ç»„ï¼‰ã€‚ç³»ç»Ÿä¸­å¯ä»¥æœ‰å¾ˆå¤šé¢—cgroupæ ‘ï¼Œæ¯æ£µæ ‘éƒ½å’Œä¸åŒçš„subsystemå…³è”ï¼Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥å±äºå¤šé¢—æ ‘ï¼Œå³ä¸€ä¸ªè¿›ç¨‹å¯ä»¥å±äºå¤šä¸ªè¿›ç¨‹ç»„ï¼Œåªæ˜¯è¿™äº›è¿›ç¨‹ç»„å’Œä¸åŒçš„subsystemå…³è”ã€‚ç›®å‰Linuxæ”¯æŒ12ç§subsystemï¼Œå¦‚æœä¸è€ƒè™‘ä¸ä¸ä»»ä½•subsystemå…³è”çš„æƒ…å†µï¼ˆsystemdå°±å±äºè¿™ç§æƒ…å†µï¼‰ï¼ŒLinuxé‡Œé¢æœ€å¤šå¯ä»¥å»º12é¢—cgroupæ ‘ï¼Œæ¯æ£µæ ‘å…³è”ä¸€ä¸ªsubsystemï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åªå»ºä¸€æ£µæ ‘ï¼Œç„¶åè®©è¿™æ£µæ ‘å…³è”æ‰€æœ‰çš„subsystemã€‚å½“ä¸€é¢—cgroupæ ‘ä¸å’Œä»»ä½•subsystemå…³è”çš„æ—¶å€™ï¼Œæ„å‘³ç€è¿™æ£µæ ‘åªæ˜¯å°†è¿›ç¨‹è¿›è¡Œåˆ†ç»„ï¼Œè‡³äºè¦åœ¨åˆ†ç»„çš„åŸºç¡€ä¸Šåšäº›ä»€ä¹ˆï¼Œå°†ç”±åº”ç”¨ç¨‹åºè‡ªå·±å†³å®šï¼Œsystemdå°±æ˜¯ä¸€ä¸ªè¿™æ ·çš„ä¾‹å­ã€‚</p>
</blockquote>
<p>è¿™ä¸ª hierarchy çš„å®šä¹‰å®åœ¨æ˜¯æœ‰ç‚¹æŠ½è±¡ï¼Œæ‰€ä»¥æˆ‘å†³å®šç”¨ä¸ªä¾‹å­å¸®åŠ©ç†è§£ã€‚</p>
<h3 id="ä¸¾ä¸ªæ —å­">ä¸¾ä¸ªæ —å­</h3>
<p>æˆ‘ä»¬å‡è®¾æœ‰ä¸€ä¸ªåº”ç”¨ï¼Œå®ƒç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šä¸€ä¸ªå‰ç«¯æœåŠ¡å’Œä¸€ä¸ªåç«¯æœåŠ¡ã€‚æˆ‘ä»¬æƒ³è¦ç¡®ä¿åç«¯æœåŠ¡ï¼ˆå¤„ç†æ•°æ®å’Œé€»è¾‘çš„æ ¸å¿ƒéƒ¨åˆ†ï¼‰æ€»æ˜¯æœ‰è¶³å¤Ÿçš„<strong>å†…å­˜</strong>ï¼ˆmemoryï¼‰èµ„æºï¼Œè€Œå‰ç«¯æœåŠ¡ï¼ˆå¤„ç†ç”¨æˆ·ç•Œé¢çš„éƒ¨åˆ†ï¼‰åˆ™åœ¨èµ„æºç´§å¼ æ—¶å¯ä»¥è¢«é€‚å½“é™åˆ¶ã€‚</p>
<h4 id="åˆ›å»ºé¡¶å±‚ç»“æ„">åˆ›å»ºé¡¶å±‚ç»“æ„</h4>
<p>æ—¢ç„¶è¦é™åˆ¶å†…å­˜ï¼Œæˆ‘ä»¬æˆ‘ä»¬è‚¯å®šè¦åœ¨<strong>memory</strong>è¿™ä¸ªå­ç³»ç»Ÿä¸‹åˆ›å»ºæˆ‘ä»¬åº”ç”¨çš„<strong>cgroup</strong>ã€‚äºæ˜¯æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªé¡¶å±‚cgroupï¼ˆ<strong>root_group</strong>ï¼‰ä»£è¡¨æ•´ä¸ªåº”ç”¨</p>
<pre><code class="language-shell"># åˆ›å»ºé¡¶å±‚ cgroup
mkdir /sys/fs/cgroup/memory/root_group
</code></pre>
<p>å…¶å®è¿™é‡Œéšå«äº†ä¸€å±‚æ„æ€ï¼Œæˆ‘ä»¬åœ¨ä¸€é¢—æ ‘ä¸Šçš„æ ¹ç»“ç‚¹ä¸Šæ–°å»ºäº†ä¸€ä¸ªå­ç»“ç‚¹ï¼Œè€Œè¿™æ£µæ ‘æ˜¯ä¸<strong>memory subsystem</strong>ç›¸å…³è”çš„ã€‚</p>
<h4 id="åˆ›å»ºå­cgroup">åˆ›å»ºå­cgroup</h4>
<p>åœ¨ <strong>root_group</strong> ä¸‹ï¼Œæˆ‘ä»¬åˆ›å»ºä¸¤ä¸ªå­ <strong>cgroup</strong>ï¼š<strong>backend_group</strong> å’Œ <strong>frontend_group</strong>ï¼Œå…¶ä¸­ï¼š</p>
<ul>
<li><strong>backend_group</strong>ï¼šç”¨äºåç«¯æœåŠ¡ï¼Œç¡®ä¿æ ¸å¿ƒæœåŠ¡æœ‰è¶³å¤Ÿçš„èµ„æºã€‚</li>
<li><strong>frontend_group</strong>ï¼šç”¨äºå‰ç«¯æœåŠ¡ï¼Œå…¶èµ„æºå¯ä»¥è¢«é€‚å½“é™åˆ¶ä»¥ä¿è¯åç«¯æœåŠ¡çš„èµ„æºéœ€æ±‚ã€‚</li>
</ul>
<pre><code class="language-shell"># åˆ›å»ºå­ cgroup
mkdir /sys/fs/cgroup/memory/root_group/backend_group
mkdir /sys/fs/cgroup/memory/root_group/frontend_group
</code></pre>
<h4 id="è®¾ç½®å†…å­˜é™åˆ¶">è®¾ç½®å†…å­˜é™åˆ¶</h4>
<ul>
<li><strong>backend_group</strong>ï¼šä¸è®¾ç½®ç¡¬æ€§é™åˆ¶ï¼Œæˆ–è€…è®¾ç½®ä¸€ä¸ªè¾ƒé«˜çš„é™åˆ¶ï¼Œç¡®ä¿åç«¯æœåŠ¡æœ‰è¶³å¤Ÿçš„èµ„æºå¯ç”¨ã€‚</li>
<li><strong>frontend_group</strong>ï¼šè®¾ç½®è¾ƒä½çš„å†…å­˜é™åˆ¶ï¼Œæ¯”å¦‚ 50MBï¼Œç¡®ä¿åœ¨èµ„æºç´§å¼ æ—¶ï¼Œå‰ç«¯æœåŠ¡çš„èµ„æºä½¿ç”¨è¢«é€‚å½“é™åˆ¶ã€‚</li>
</ul>
<pre><code class="language-shell"># è®¾ç½®å‰ç«¯æœåŠ¡çš„å†…å­˜é™åˆ¶ä¸º 50MB
echo 52428800 &gt; /sys/fs/cgroup/memory/root_group/frontend_group/memory.limit_in_bytes
</code></pre>
<h4 id="å°†è¿›ç¨‹æ·»åŠ åˆ°ç›¸åº”çš„-cgroup-ä¸­">å°†è¿›ç¨‹æ·»åŠ åˆ°ç›¸åº”çš„ cgroup ä¸­</h4>
<ul>
<li>å°†åç«¯æœåŠ¡çš„è¿›ç¨‹ PID æ·»åŠ åˆ° backend_groupã€‚</li>
<li>å°†å‰ç«¯æœåŠ¡çš„è¿›ç¨‹ PID æ·»åŠ åˆ° frontend_groupã€‚</li>
</ul>
<pre><code class="language-shell"># æ·»åŠ è¿›ç¨‹åˆ° cgroup
echo 1234 &gt; /sys/fs/cgroup/memory/root_group/frontend_group/cgroup.procs
# å‡è®¾åç«¯æœåŠ¡çš„ PID ä¸º 5678
echo 5678 &gt; /sys/fs/cgroup/memory/root_group/backend_group/cgroup.procs
</code></pre>
<p>è¿™ä¸¤ä¸ªè¿›ç¨‹å°±åŠ å…¥äº†ä¸å†…å­˜ç›¸å…³è”çš„å­ç³»ç»Ÿçš„è¿™æ£µæ ‘ä¸‹çš„å…·ä½“çš„èŠ‚ç‚¹ï¼ˆcgroupï¼‰ï¼Œå½“ç„¶ä»–ä»¬ä¹Ÿå¯ä»¥åŠ å…¥åˆ°å…¶ä»–ä¸åŒçš„æ ‘ä¸­ï¼Œå—è¿™äº›æ ‘æ‰€å…³è”çš„å­ç³»ç»Ÿçš„æ§åˆ¶ã€‚</p>
<h1 id="cgroupsçš„æ–‡ä»¶ç³»ç»Ÿæ¥å£">cgroupsçš„æ–‡ä»¶ç³»ç»Ÿæ¥å£</h1>
<p>cgroups ä»¥æ–‡ä»¶çš„æ–¹å¼æä¾›åº”ç”¨æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ mount å‘½ä»¤æ¥æŸ¥çœ‹ cgroups é»˜è®¤çš„æŒ‚è½½ç‚¹ï¼š<code>mount | grep cgroup</code></p>
<pre><code>[root@xdd ~]# mount | grep cgroup
tmpfs on /sys/fs/cgroup type tmpfs (ro,nosuid,nodev,noexec,mode=755)
cgroup on /sys/fs/cgroup/systemd type cgroup (rw,nosuid,nodev,noexec,relatime,xattr,release_agent=/usr/lib/systemd/systemd-cgroups-agent,name=systemd)
cgroup on /sys/fs/cgroup/net_cls,net_prio type cgroup (rw,nosuid,nodev,noexec,relatime,net_prio,net_cls)
cgroup on /sys/fs/cgroup/pids type cgroup (rw,nosuid,nodev,noexec,relatime,pids)
cgroup on /sys/fs/cgroup/perf_event type cgroup (rw,nosuid,nodev,noexec,relatime,perf_event)
cgroup on /sys/fs/cgroup/devices type cgroup (rw,nosuid,nodev,noexec,relatime,devices)
cgroup on /sys/fs/cgroup/blkio type cgroup (rw,nosuid,nodev,noexec,relatime,blkio)
cgroup on /sys/fs/cgroup/cpu,cpuacct type cgroup (rw,nosuid,nodev,noexec,relatime,cpuacct,cpu)
cgroup on /sys/fs/cgroup/hugetlb type cgroup (rw,nosuid,nodev,noexec,relatime,hugetlb)
cgroup on /sys/fs/cgroup/freezer type cgroup (rw,nosuid,nodev,noexec,relatime,freezer)
cgroup on /sys/fs/cgroup/memory type cgroup (rw,nosuid,nodev,noexec,relatime,memory)
cgroup on /sys/fs/cgroup/cpuset type cgroup (rw,nosuid,nodev,noexec,relatime,cpuset)
</code></pre>
<p>æ‰§è¡Œè¿™ä¸ªå‘½ä»¤åè¿”å›çš„å†…å®¹è§£é‡Šå¦‚ä¸‹ï¼š</p>
<ul>
<li>ç¬¬ä¸€è¡Œï¼š<code>tmpfs on /sys/fs/cgroup type tmpfs (ro,nosuid,nodev,noexec,mode=755)</code> æ˜¾ç¤ºäº†ä¸€ä¸ª<strong>tmpfs</strong>ï¼ˆä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿï¼‰è¢«æŒ‚è½½åœ¨ <code>/sys/fs/cgroup</code>ã€‚
<ul>
<li><strong>cgroup</strong>ï¼šæ–‡ä»¶ç³»ç»Ÿçš„æ ¹ç›®å½•</li>
<li><strong>tmpfs</strong>ï¼š æ„å‘³ç€ cgroup çš„å…ƒæ•°æ®å’Œæ§åˆ¶æ–‡ä»¶å­˜å‚¨<strong>åœ¨å†…å­˜ä¸­</strong>ï¼Œè€Œä¸æ˜¯ç£ç›˜ä¸Šï¼Œè¿™æ ·å¯ä»¥æé«˜è®¿é—®é€Ÿåº¦ã€‚</li>
<li><strong>ro,nosuid,nodev,noexec,mode=755</strong>ï¼šæè¿°äº†æŒ‚è½½çš„é€‰é¡¹ï¼Œä¾‹å¦‚åªè¯»ï¼ˆ<strong>ro</strong>ï¼‰ã€ä¸å…è®¸ set-user-identifier æˆ– set-group-identifier æƒé™ï¼ˆ<strong>nosuid</strong>ï¼‰ã€ç¦æ­¢æ‰§è¡Œè®¾å¤‡æ–‡ä»¶ï¼ˆ<strong>nodev</strong>ï¼‰ã€ç¦æ­¢æ‰§è¡Œä»»ä½•äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆ<strong>noexec</strong>ï¼‰ï¼Œä»¥åŠç›®å½•çš„è®¿é—®æƒé™ï¼ˆ<strong>mode=755</strong>ï¼‰ã€‚</li>
</ul>
</li>
<li>ç¬¬äºŒè¡Œï¼š<code>cgroup on /sys/fs/cgroup/systemd type cgroup (rw,nosuid,nodev,noexec,relatime,xattr,release_agent=/usr/lib/systemd/systemd-cgroups-agent,name=systemd)</code>è¿™é‡Œæ¶‰åŠåˆ° systemd ç®¡ç†çš„ cgroupã€‚åœ¨ä½¿ç”¨ systemd ç³»ç»Ÿçš„æ“ä½œç³»ç»Ÿä¸­ï¼Œ/sys/fs/cgroup ç›®å½•éƒ½æ˜¯ç”± systemd åœ¨ç³»ç»Ÿå¯åŠ¨çš„è¿‡ç¨‹ä¸­æŒ‚è½½çš„ï¼Œå¹¶ä¸”æŒ‚è½½ä¸ºåªè¯»çš„ç±»å‹ã€‚æ¢å¥è¯è¯´ï¼Œç³»ç»Ÿæ˜¯ä¸å»ºè®®æˆ‘ä»¬åœ¨ /sys/fs/cgroup ç›®å½•ä¸‹åˆ›å»ºæ–°çš„ç›®å½•å¹¶æŒ‚è½½å…¶å®ƒå­ç³»ç»Ÿçš„ã€‚è¿™ä¸€ç‚¹ä¸ä¹‹å‰çš„æ“ä½œç³»ç»Ÿä¸å¤ªä¸€æ ·ï¼ˆğŸ¤”ï¼‰ã€‚</li>
<li>å…¶ä½™è¡Œï¼šæ¯ä¸ª cgroup å­ç³»ç»Ÿçš„æŒ‚è½½ç‚¹ï¼Œå¯¹åº”äº†å¯ä»¥æ§åˆ¶çš„èµ„æºç±»å‹ã€‚æ¯”å¦‚<code>cgroup on /sys/fs/cgroup/cpu,cpuacct type cgroup</code> è¡¨ç¤º CPU æ—¶é—´å’Œ CPU ä½¿ç”¨ç»Ÿè®¡çš„ cgroup å­ç³»ç»Ÿå…±åŒæŒ‚è½½åœ¨ <code>/sys/fs/cgroup/cpu,cpuacct</code>ã€‚</li>
</ul>
<p>/sys/fs/cgroupåŠå…¶å­ç›®å½•memoryç»“æ„<br>
<img src="https://skyblu3519.github.io/post-images/dockerSec_1/1711442513857-73c79df1-5fbb-4ba7-af46-74141c00adda.png" alt="image.png" loading="lazy"></p>
<p>/sys/fs/cgroup ç›®å½•ä¸‹æ˜¯å„ä¸ªå­ç³»ç»Ÿçš„æ ¹ç›®å½•ã€‚memory ç›®å½•ä¸‹çš„æ–‡ä»¶å°±æ˜¯ cgroups çš„ memory å­ç³»ç»Ÿä¸­çš„æ ¹çº§è®¾ç½®ã€‚æ¯”å¦‚ memory.limit_in_bytes ä¸­çš„æ•°å­—ç”¨æ¥é™åˆ¶è¿›ç¨‹çš„æœ€å¤§å¯ç”¨å†…å­˜ï¼Œmemory.swappiness ä¸­ä¿å­˜ç€ä½¿ç”¨ swap çš„æƒé‡ç­‰ç­‰ã€‚</p>
<h1 id="è¿›ç¨‹æ‰€å±çš„cgroup">è¿›ç¨‹æ‰€å±çš„cgroup</h1>
<p>å¯ä»¥é€šè¿‡ <code>/proc/[pid]/cgroup</code> æ¥æŸ¥çœ‹æŒ‡å®šè¿›ç¨‹å±äºå“ªäº› cgroupï¼š<br>
<img src="https://skyblu3519.github.io/post-images/dockerSec_1/1711442783301-a70bc3f1-6189-4ad3-8d3b-b252b8ca9b64.png" alt="image.png" loading="lazy"></p>
<p>è¿™ä¸ª cgroup ä¿¡æ¯æ˜¾ç¤ºäº†è¿›ç¨‹ ID ä¸º 794 çš„è¿›ç¨‹æ‰€å±çš„ cgroup é…ç½®ã€‚æ¯ä¸€è¡Œéƒ½ä»£è¡¨è¯¥è¿›ç¨‹åœ¨ä¸åŒ cgroup å­ç³»ç»Ÿä¸‹çš„å½’å±æƒ…å†µã€‚æ ¼å¼é€šå¸¸ä¸º <code>å±‚çº§ç¼–å·:å­ç³»ç»Ÿåç§°:è·¯å¾„</code>ï¼š</p>
<ul>
<li><strong>å±‚çº§ç¼–å·</strong>ï¼šcgroup æ ‘çš„ IDï¼Œ å’Œ /proc/cgroups æ–‡ä»¶ä¸­çš„ ID ä¸€ä¸€å¯¹åº”ã€‚</li>
<li><strong>å­ç³»ç»Ÿåç§°</strong>ï¼šè¡¨ç¤º cgroup æ§åˆ¶çš„èµ„æºç±»å‹ã€‚ä¾‹å¦‚ cpuã€memoryã€blkio ç­‰ã€‚æœ‰äº›è¡Œä¸­å‡ºç°çš„æ˜¯ç»„åˆå­ç³»ç»Ÿï¼Œå¦‚ cpuacct,cpuï¼Œæ„å‘³ç€è¿™äº›èµ„æºæ§åˆ¶å™¨è¢«ç»„åˆåœ¨ä¸€èµ·ç®¡ç†ã€‚</li>
<li><strong>è·¯å¾„</strong>ï¼šæ˜¾ç¤ºè¿›ç¨‹æ‰€å±çš„ cgroup åœ¨ cgroup æ–‡ä»¶ç³»ç»Ÿä¸­çš„è·¯å¾„ã€‚ä¾‹å¦‚ï¼Œ/system.slice/httpd.service è¡¨ç¤ºè¿›ç¨‹å±äºåä¸º httpd.service çš„æœåŠ¡å•å…ƒç®¡ç†çš„ cgroupã€‚è·¯å¾„ / è¡¨ç¤ºæ ¹ cgroupï¼Œä¹Ÿå°±æ˜¯æœ€é¡¶å±‚çš„ cgroupï¼Œå®ƒé€šå¸¸ç”¨äºæœªè¢«ç‰¹åˆ«åˆ†é…åˆ°å…¶ä»–ç‰¹å®š cgroup çš„è¿›ç¨‹ã€‚</li>
</ul>
<p>PS.å¯ä»¥é€šè¿‡æŸ¥çœ‹/proc/cgroups(since Linux 2.6.24)çŸ¥é“å½“å‰ç³»ç»Ÿæ”¯æŒå“ªäº›subsystemï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­</p>
<pre><code class="language-shell">#subsys_name    hierarchy       num_cgroups     enabled
cpuset          11              1               1
cpu             3               64              1
cpuacct         3               64              1
blkio           8               64              1
memory          9               104             1
devices         5               64              1
freezer         10              4               1
net_cls         6               1               1
perf_event      7               1               1
net_prio        6               1               1
hugetlb         4               1               1
pids            2               68              1
</code></pre>
<p>ä»å·¦åˆ°å³ï¼Œå­—æ®µçš„å«ä¹‰åˆ†åˆ«æ˜¯ï¼š</p>
<ol>
<li>subsystemçš„åå­—</li>
<li>subsystemæ‰€å…³è”åˆ°çš„cgroupæ ‘çš„IDï¼Œå¦‚æœå¤šä¸ªsubsystemå…³è”åˆ°åŒä¸€é¢—cgroupæ ‘ï¼Œé‚£ä¹ˆä»–ä»¬çš„è¿™ä¸ªå­—æ®µå°†ä¸€æ ·ï¼Œæ¯”å¦‚è¿™é‡Œçš„cpuå’Œcpuacctå°±ä¸€æ ·ï¼Œè¡¨ç¤ºä»–ä»¬ç»‘å®šåˆ°äº†åŒä¸€é¢—æ ‘ã€‚å¦‚æœå‡ºç°ä¸‹é¢çš„æƒ…å†µï¼Œè¿™ä¸ªå­—æ®µå°†ä¸º0ï¼š
<ul>
<li>å½“å‰subsystemæ²¡æœ‰å’Œä»»ä½•cgroupæ ‘ç»‘å®š</li>
<li>å½“å‰subsystemå·²ç»å’Œcgroup v2çš„æ ‘ç»‘å®š</li>
<li>å½“å‰subsystemæ²¡æœ‰è¢«å†…æ ¸å¼€å¯</li>
</ul>
</li>
<li>subsystemæ‰€å…³è”çš„cgroupæ ‘ä¸­è¿›ç¨‹ç»„çš„ä¸ªæ•°ï¼Œä¹Ÿå³æ ‘ä¸ŠèŠ‚ç‚¹çš„ä¸ªæ•°</li>
<li>1è¡¨ç¤ºå¼€å¯ï¼Œ0è¡¨ç¤ºæ²¡æœ‰è¢«å¼€å¯(å¯ä»¥é€šè¿‡è®¾ç½®å†…æ ¸çš„å¯åŠ¨å‚æ•°â€œcgroup_disableâ€æ¥æ§åˆ¶subsystemçš„å¼€å¯).</li>
</ol>
<p>å…³äº<code>1:name=systemd:/system.slice/httpd.service</code>ï¼ˆğŸ¤”ï¼‰ï¼š</p>
<ul>
<li><strong>name=systemd</strong>ï¼š è¿™éƒ¨åˆ†è¯´æ˜è¿™ä¸ªç‰¹å®šçš„ cgroup å±‚çº§æ˜¯ç”± systemd ä½¿ç”¨çš„ï¼Œè€Œä¸æ˜¯ç”±å•ä¸€çš„èµ„æºç±»å‹ï¼ˆå¦‚ cpu æˆ– memoryï¼‰ç›´æ¥æ§åˆ¶ã€‚name=systemd è¡¨ç¤ºè¿™ä¸ªå±‚çº§æ˜¯ä¸“é—¨ä¸º systemd ä½¿ç”¨è€Œè®¾ç½®çš„ä¸€ä¸ªå‘½åå±‚çº§ï¼Œç”¨æ¥ç®¡ç†å’Œç»„ç»‡ç”± systemd æ§åˆ¶çš„æœåŠ¡ã€‚è¿™æ˜¯ cgroup v1 ä¸­æ”¯æŒä¸ºå„ç§ä¸åŒçš„ç›®çš„åˆ›å»ºå‘½åå±‚çº§çš„åŠŸèƒ½ä¹‹ä¸€ã€‚</li>
<li><strong>/system.slice/httpd.service</strong>: è¿™éƒ¨åˆ†æ˜¾ç¤ºäº† cgroup åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„è·¯å¾„ã€‚è¿™ä¸ªè·¯å¾„æŒ‡ç¤ºè¿›ç¨‹å±äº httpd.service æœåŠ¡ï¼Œè¿™æ˜¯ä¸€ä¸ª systemd æœåŠ¡å•å…ƒçš„åç§°ã€‚åœ¨ systemd çš„ä½“ç³»ä¸­ï¼Œsystem.slice æ˜¯ä¸€ä¸ª<strong>ç”¨äºç»„ç»‡ç³»ç»ŸæœåŠ¡çš„åˆ†ç‰‡</strong>ï¼ˆsliceï¼‰ï¼Œè€Œ httpd.service åˆ™æ˜¯è¿è¡Œåœ¨è¿™ä¸ªåˆ†ç‰‡ä¸­çš„ç‰¹å®šæœåŠ¡ã€‚</li>
<li>ä¸å…¶ä»–è¡Œç›¸æ¯”ï¼Œè¿™è¡Œä¿¡æ¯çš„ç‰¹æ®Šä¹‹å¤„åœ¨äºå®ƒç›´æ¥å…³è”åˆ° systemdï¼Œè€Œä¸æ˜¯æ ‡å‡†çš„èµ„æºç±»å‹å­ç³»ç»Ÿã€‚systemd ä½¿ç”¨å®ƒè‡ªå·±çš„ cgroup å±‚çº§æ¥ç»„ç»‡å’Œç®¡ç†æœåŠ¡ï¼Œè¿™ä½¿å¾— systemd èƒ½å¤Ÿåˆ©ç”¨ cgroup æä¾›çš„åŠŸèƒ½æ¥æ‰§è¡Œè¯¸å¦‚æœåŠ¡å¯åŠ¨ã€åœæ­¢ã€é‡å¯ä»¥åŠèµ„æºé™åˆ¶ç­‰æ“ä½œã€‚</li>
</ul>
<h1 id="cgroupæµ‹è¯•">cgroupæµ‹è¯•</h1>
<h2 id="å®‰è£…cgroupså·¥å…·">å®‰è£…cgroupså·¥å…·</h2>
<p>Centosä¸‹å®‰è£…cgroup å·¥å…·ï¼š</p>
<ul>
<li>å®‰è£… libcgroup</li>
</ul>
<pre><code>yum install libcgroup
</code></pre>
<ul>
<li>å®‰è£… libcgroup-tools</li>
</ul>
<pre><code>yum install libcgroup-tools
</code></pre>
<ul>
<li>éªŒè¯å®‰è£…ï¼Œä½¿ç”¨ cgget å‘½ä»¤æŸ¥çœ‹å½“å‰ cgroup é…ç½®</li>
</ul>
<pre><code>cgget -g cpu:/
</code></pre>
<h2 id="æµ‹è¯•é™åˆ¶è¿›ç¨‹å¯ç”¨çš„-cpu">æµ‹è¯•ï¼šé™åˆ¶è¿›ç¨‹å¯ç”¨çš„ CPU</h2>
<p>åœ¨<code>/sys/fs/cgroup/cpu</code> ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªåç§°ä¸º skky_cpu çš„ç›®å½•ï¼š</p>
<pre><code class="language-shell">mkdir /sys/fs/cgroup/cpu/skky_cpu
</code></pre>
<p>cgroups çš„æ–‡ä»¶ç³»ç»Ÿä¼šåœ¨åˆ›å»ºæ–‡ä»¶ç›®å½•çš„æ—¶å€™è‡ªåŠ¨åˆ›å»ºç›¸å…³çš„é…ç½®æ–‡ä»¶<br>
<img src="https://skyblu3519.github.io/post-images/dockerSec_1/1711444614768-1f6d4ab8-14f8-4f4a-87c2-158a498fe71e.png" alt="image.png" loading="lazy"></p>
<p>åœ¨è®¾ç½®skky_cpuå‰ï¼Œå…ˆçœ‹ä¸‹é»˜è®¤çš„ç›¸å…³é…ç½®ï¼š</p>
<pre><code class="language-shell">[root@xdd ~]# cat /sys/fs/cgroup/cpu/cpu.cfs_period_us
100000
[root@xdd ~]# cat /sys/fs/cgroup/cpu/cpu.cfs_quota_us
-1
</code></pre>
<ul>
<li>**cpu.cfs_period_usï¼š**è¡¨ç¤ºè°ƒåº¦å‘¨æœŸçš„é•¿åº¦ï¼Œä»¥å¾®ç§’ï¼ˆusï¼‰ä¸ºå•ä½ã€‚åœ¨è¿™ä¸ªå‘¨æœŸå†…ï¼Œcgroup å¯ä»¥è¢«é™åˆ¶åªèƒ½ä½¿ç”¨ä¸€å®šé‡çš„ CPU æ—¶é—´ï¼Œå¿…é¡»ä¸cfs_quota_usé…åˆä½¿ç”¨ã€‚</li>
<li><strong>cpu.cfs_quota_us ï¼š<strong>è®¾å®šå‘¨æœŸå†…æœ€å¤šå¯ä½¿ç”¨çš„æ—¶é—´ï¼Œè¿™é‡Œçš„é…ç½®æŒ‡ task å¯¹å•ä¸ª cpu çš„ä½¿ç”¨ä¸Šé™ã€‚å‡å¦‚</strong>cpu.cfs_period_us</strong> è¢«è®¾ç½®ä¸º 100000ï¼ˆå³ 100 æ¯«ç§’ï¼‰ï¼Œè€Œ **cpu.cfs_quota_us **è¢«è®¾ç½®ä¸º 10000ï¼ˆå³ 10 æ¯«ç§’ï¼‰ã€‚è¿™æ„å‘³ç€ï¼Œåœ¨æ¯ 100 æ¯«ç§’çš„æ—¶é—´çª—å£ä¸­ï¼Œå±äºè¯¥ cgroup çš„è¿›ç¨‹æ€»å…±èƒ½ä½¿ç”¨æœ€å¤š 10 æ¯«ç§’çš„ CPU æ—¶é—´ã€‚è¿™ç›¸å½“äºåˆ†é…äº† 10% çš„ CPU æ—¶é—´ç»™è¯¥ cgroupã€‚è€Œé»˜è®¤é…ç½®ä¸­è¿™ä¸ªå€¼ä¸º-1ï¼Œè¡¨ç¤ºè¡¨ç¤ºä¸å¯¹è¯¥ cgroup çš„ CPU æ—¶é—´ä½¿ç”¨é‡åšé™åˆ¶ã€‚</li>
</ul>
<p>ç°åœ¨æˆ‘ä»¬å§skky_cpuçš„ CPU å‘¨æœŸé™åˆ¶ä¸ºæ€»é‡çš„ååˆ†ä¹‹ä¸€ï¼š</p>
<pre><code class="language-shell">echo 10000 &gt; /sys/fs/cgroup/cpu/skky_cpu/cpu.cfs_quota_us
</code></pre>
<p>ç”¨ä¸€ä¸ªCPU å¯†é›†å‹çš„ç¨‹åºæµ‹è¯•ï¼š</p>
<pre><code class="language-c">void main(){
    unsigned int i, end;

    end = 1024 * 1024 * 1024;
    for(i = 0; i &lt; end; )
    {
        i ++;
    }
}
</code></pre>
<p>ç¼–è¯‘å¹¶æ‰§è¡Œï¼š</p>
<pre><code class="language-shell">gcc cputime.c -o cputime
time ./cputime
time cgexec -g cpu:skky_cpu ./cputime
</code></pre>
<figure data-type="image" tabindex="1"><img src="https://skyblu3519.github.io/post-images/dockerSec_1/1711452018680-80811a51-bf38-439d-8b1a-bc0d10d02fa1.png" alt="image.png" loading="lazy"></figure>
<p>å¯ä»¥çœ‹åˆ°ç¨‹åºæ­£å¸¸è¿è¡Œçš„æ—¶é—´ä¸º2.5sï¼Œè€Œæ·»åŠ  cgroup çš„è¿è¡Œæ—¶é—´ä¸º28sã€‚</p>
<h1 id="ä½¿ç”¨cgroupåˆ¤æ–­å®¹å™¨ç¯å¢ƒ">ä½¿ç”¨Cgroupåˆ¤æ–­å®¹å™¨ç¯å¢ƒ</h1>
<p>åœ¨dockerå®¹å™¨pidä¸º1çš„è¿›ç¨‹ï¼Œé€šå¸¸æ˜¯å®¹å™¨çš„åˆå§‹åŒ–è¿›ç¨‹</p>
<pre><code class="language-shell">root@662559eb1259:/# cat /proc/1/cgroup
11:cpuset:/docker/662559eb1259dd29170985293fdcc5465cca5ac1c655bba37aa364cb988670e9
10:memory:/docker/662559eb1259dd29170985293fdcc5465cca5ac1c655bba37aa364cb988670e9
9:freezer:/docker/662559eb1259dd29170985293fdcc5465cca5ac1c655bba37aa364cb988670e9
8:hugetlb:/docker/662559eb1259dd29170985293fdcc5465cca5ac1c655bba37aa364cb988670e9
7:cpuacct,cpu:/docker/662559eb1259dd29170985293fdcc5465cca5ac1c655bba37aa364cb988670e9
6:blkio:/docker/662559eb1259dd29170985293fdcc5465cca5ac1c655bba37aa364cb988670e9
5:devices:/docker/662559eb1259dd29170985293fdcc5465cca5ac1c655bba37aa364cb988670e9
4:perf_event:/docker/662559eb1259dd29170985293fdcc5465cca5ac1c655bba37aa364cb988670e9
3:pids:/docker/662559eb1259dd29170985293fdcc5465cca5ac1c655bba37aa364cb988670e9
2:net_prio,net_cls:/docker/662559eb1259dd29170985293fdcc5465cca5ac1c655bba37aa364cb988670e9
1:name=systemd:/docker/662559eb1259dd29170985293fdcc5465cca5ac1c655bba37aa364cb988670e9
</code></pre>
<p>ä»è¿™ä¸ªå“åº”å¯ä»¥çœ‹åˆ°ï¼Œåœ¨dockerå®¹å™¨ä¸­æ‰€æœ‰cgroupå­ç³»ç»Ÿçš„è·¯å¾„éƒ½æ˜¯<code>/docker/[å®¹å™¨ID]</code>ï¼Œè¿™å°±æ˜¯ä½¿ç”¨<code>cat /proc/1/cgroup</code>å¯ä»¥åˆ¤æ–­å½“å‰æ˜¯å¦ä¸ºå®¹å™¨ç¯å¢ƒçš„åŸå› ã€‚</p>
<h2 id="cgroup-v2">cgroup v2</h2>
<p>cgroup v2 æ˜¯å¯¹æœ€åˆçš„ cgroupï¼ˆæ§åˆ¶ç»„ï¼‰æœºåˆ¶çš„é‡å¤§æ”¹è¿›å’Œç®€åŒ–ï¼Œåœ¨v2ä¸­ä¸å†ä¸ºæ¯ç§èµ„æºç±»å‹ï¼ˆå¦‚ CPUã€å†…å­˜ç­‰ï¼‰åˆ›å»ºç‹¬ç«‹çš„å±‚çº§ï¼Œè€Œæ˜¯å¼•å…¥å•ä¸€çš„å±‚çº§ç³»ç»Ÿï¼Œæ‰€æœ‰ç±»å‹çš„èµ„æºéƒ½åœ¨è¿™ä¸ªç»Ÿä¸€çš„å±‚çº§ä¸‹ç®¡ç†ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/dockerSec_1/1711455747561-eb5add86-525c-4126-9834-237d874c6605.png" alt="image.png" loading="lazy"></p>
<p>å…³äºcgroup v2 å…·ä½“çš„ç»†èŠ‚è¿™é‡Œå…ˆä¸å…³å¿ƒï¼Œç®€å•è¯´ä¸‹å¯¹dockerçš„å½±å“ã€‚ä½¿ç”¨<code>cat /proc/1/cgroup</code>çš„è¾“å‡ºä¸ºï¼š</p>
<pre><code class="language-shell">root@015731e32eb9:/# cat /proc/1/cgroup
0::/
</code></pre>
<ul>
<li><code>0</code>: è¿™ä¸ªéƒ¨åˆ†è¡¨ç¤º cgroup çš„å±‚çº§ç¼–å·ã€‚åœ¨ cgroup v2 ä¸­ï¼Œç”±äºåªæœ‰ä¸€ä¸ªç»Ÿä¸€çš„å±‚çº§ï¼Œæ‰€ä»¥è¿™ä¸ªç¼–å·æ˜¯ <code>0</code>ã€‚è¿™æ˜¯ä¸€ä¸ªæ ‡å¿—æ€§çš„å˜åŒ–ï¼Œè¡¨æ˜ç³»ç»Ÿä½¿ç”¨çš„æ˜¯ cgroup v2ã€‚</li>
<li><code>::</code> è¿™ä¸ªéƒ¨åˆ†åŸæœ¬åœ¨ cgroup v1 ä¸­ç”¨äºåˆ†éš”å±‚çº§ç¼–å·å’Œå­ç³»ç»Ÿåˆ—è¡¨ï¼ˆä¾‹å¦‚ cpu, memoryï¼‰ã€‚åœ¨ cgroup v2 ä¸­ï¼Œç”±äºä¸å†éœ€è¦æŒ‡å®šå­ç³»ç»Ÿï¼ˆæ‰€æœ‰èµ„æºæ§åˆ¶éƒ½åœ¨ä¸€ä¸ªå±‚çº§ä¸­ï¼‰ï¼Œå› æ­¤è¿™é‡Œä¸å†æ˜¾ç¤ºå…·ä½“çš„å­ç³»ç»Ÿåç§°ï¼Œä»…ç”¨å†’å·è¡¨ç¤ºåˆ†éš”ã€‚</li>
<li><code>/</code> è¿™ä¸ªéƒ¨åˆ†è¡¨ç¤º cgroup çš„è·¯å¾„ã€‚åœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­ï¼Œ<code>/</code> æŒ‡çš„æ˜¯æ ¹ cgroupï¼Œä¹Ÿå°±æ˜¯æ•´ä¸ª cgroup å±‚çº§çš„æœ€é¡¶å±‚ã€‚è¿›ç¨‹å·ä¸º 1 çš„è¿›ç¨‹ï¼ˆç³»ç»Ÿçš„åˆå§‹åŒ–è¿›ç¨‹ï¼Œé€šå¸¸æ˜¯ systemd æˆ– initï¼‰å±äºè¿™ä¸ªæœ€é¡¶å±‚çš„ cgroupï¼Œè¡¨ç¤ºå®ƒæœ‰æƒç®¡ç†å’Œæ§åˆ¶ç³»ç»Ÿä¸­çš„æ‰€æœ‰å…¶ä»–è¿›ç¨‹å’Œèµ„æºã€‚</li>
</ul>
<p>å®¿ä¸»æœºä¸Šæœ‰å…³dockerå®¹å™¨çš„cgroupä¿¡æ¯åœ¨<code>/sys/fs/cgroup/system.slice/</code>ç›®å½•ä¸‹ï¼Œæ ¼å¼ä¸º</p>
<pre><code class="language-shell">/sys/fs/cgroup/system.slice/docker-&lt;longid&gt;.scope/
</code></pre>
<figure data-type="image" tabindex="2"><img src="https://skyblu3519.github.io/post-images/dockerSec_1/1711464780383-ca74ca26-6af1-4569-ab2c-6b132b3b13d3.png" alt="image.png" loading="lazy"></figure>
<p>å¦‚æœè¦åœ¨ cgroup v2 æŸ¥å‡º docker å®¹å™¨çš„IDå·ï¼Œå¯ä»¥æŸ¥çœ‹<code>/proc/1/mountinfo</code>æ–‡ä»¶ï¼Œé‡Œé¢æ˜¯è¿›ç¨‹çš„æŒ‚è½½ç‚¹ä¿¡æ¯<br>
<img src="https://skyblu3519.github.io/post-images/dockerSec_1/1711464948514-7165a872-95ab-4967-ae0b-67b9b81abdcc.png" alt="image.png" loading="lazy"></p>
<h1 id="å‚è€ƒæ–‡ç« ">å‚è€ƒæ–‡ç« </h1>
<p><a href="https://www.cnblogs.com/sparkdev/p/8296063.html">https://www.cnblogs.com/sparkdev/p/8296063.html</a><br>
<a href="https://segmentfault.com/a/1190000006917884">https://segmentfault.com/a/1190000006917884</a><br>
<a href="https://mikechengwei.github.io/2020/06/03/cgroup%E5%8E%9F%E7%90%86/">https://mikechengwei.github.io/2020/06/03/cgroup%E5%8E%9F%E7%90%86/</a><br>
<a href="https://stackoverflow.com/questions/68816329/how-to-get-docker-container-id-from-within-the-container-with-cgroup-v2">https://stackoverflow.com/questions/68816329/how-to-get-docker-container-id-from-within-the-container-with-cgroup-v2</a><br>
<a href="https://zone.huoxian.cn/d/990">https://zone.huoxian.cn/d/990</a></p>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li><a href="#%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5">ç›¸å…³æ¦‚å¿µ</a>
<ul>
<li><a href="#task">Task</a></li>
<li><a href="#cgroup">Cgroup</a></li>
<li><a href="#subsystem">Subsystem</a></li>
<li><a href="#hierarchy">Hierarchy</a>
<ul>
<li><a href="#%E4%B8%BE%E4%B8%AA%E6%A0%97%E5%AD%90">ä¸¾ä¸ªæ —å­</a>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BA%E9%A1%B6%E5%B1%82%E7%BB%93%E6%9E%84">åˆ›å»ºé¡¶å±‚ç»“æ„</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E5%AD%90cgroup">åˆ›å»ºå­cgroup</a></li>
<li><a href="#%E8%AE%BE%E7%BD%AE%E5%86%85%E5%AD%98%E9%99%90%E5%88%B6">è®¾ç½®å†…å­˜é™åˆ¶</a></li>
<li><a href="#%E5%B0%86%E8%BF%9B%E7%A8%8B%E6%B7%BB%E5%8A%A0%E5%88%B0%E7%9B%B8%E5%BA%94%E7%9A%84-cgroup-%E4%B8%AD">å°†è¿›ç¨‹æ·»åŠ åˆ°ç›¸åº”çš„ cgroup ä¸­</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#cgroups%E7%9A%84%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%8E%A5%E5%8F%A3">cgroupsçš„æ–‡ä»¶ç³»ç»Ÿæ¥å£</a></li>
<li><a href="#%E8%BF%9B%E7%A8%8B%E6%89%80%E5%B1%9E%E7%9A%84cgroup">è¿›ç¨‹æ‰€å±çš„cgroup</a></li>
<li><a href="#cgroup%E6%B5%8B%E8%AF%95">cgroupæµ‹è¯•</a>
<ul>
<li><a href="#%E5%AE%89%E8%A3%85cgroups%E5%B7%A5%E5%85%B7">å®‰è£…cgroupså·¥å…·</a></li>
<li><a href="#%E6%B5%8B%E8%AF%95%E9%99%90%E5%88%B6%E8%BF%9B%E7%A8%8B%E5%8F%AF%E7%94%A8%E7%9A%84-cpu">æµ‹è¯•ï¼šé™åˆ¶è¿›ç¨‹å¯ç”¨çš„ CPU</a></li>
</ul>
</li>
<li><a href="#%E4%BD%BF%E7%94%A8cgroup%E5%88%A4%E6%96%AD%E5%AE%B9%E5%99%A8%E7%8E%AF%E5%A2%83">ä½¿ç”¨Cgroupåˆ¤æ–­å®¹å™¨ç¯å¢ƒ</a>
<ul>
<li><a href="#cgroup-v2">cgroup v2</a></li>
</ul>
</li>
<li><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0">å‚è€ƒæ–‡ç« </a></li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">ä¸‹ä¸€ç¯‡</div>
            <a href="https://skyblu3519.github.io/post/nkctf2024-wp-web/">
              <h3 class="post-title">
                NKCTF2024 WP WEB
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
  <a class="rss" href="https://skyblu3519.github.io/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
