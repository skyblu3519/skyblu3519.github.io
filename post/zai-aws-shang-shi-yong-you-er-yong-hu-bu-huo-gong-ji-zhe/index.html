<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>åœ¨AWSä¸Šä½¿ç”¨è¯±é¥µç”¨æˆ·æ•è·æ”»å‡»è€… | skkyblu3</title>
<link rel="shortcut icon" href="https://skyblu3519.github.io/favicon.ico?v=1721054258675">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://skyblu3519.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="åœ¨AWSä¸Šä½¿ç”¨è¯±é¥µç”¨æˆ·æ•è·æ”»å‡»è€… | skkyblu3 - Atom Feed" href="https://skyblu3519.github.io/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="æ€è·¯å°±æ˜¯åˆ›å»ºä¸€ä¸ªIAMç”¨æˆ·ï¼Œç„¶åç”¨CloudWatchç›‘æ§è¯¥ç”¨æˆ·çš„è¡Œä¸ºï¼Œå¦‚æœå‡ºç°äº†è¯¥ç”¨æˆ·çš„æ“ä½œåˆ™è§¦å‘å‘Šè­¦ï¼Œå¹¶é€šè¿‡é‚®ä»¶é€šçŸ¥ã€‚
ä½¿ç”¨æ§åˆ¶å°å’ŒTerraformä¸¤ç§æ–¹æ³•å®ç°
æ§åˆ¶å°åˆ›å»º
åˆ›å»ºè¯±é¥µç”¨æˆ·
åœ¨ IAM æ§åˆ¶å°åˆ›å»ºä¸€ä¸ªè¯±é¥µç”¨æˆ·honeyU..." />
    <meta name="keywords" content="æ¬ºéª—é˜²å¾¡,Terraform,AWS" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://skyblu3519.github.io">
  <img class="avatar" src="https://skyblu3519.github.io/images/avatar.png?v=1721054258675" alt="">
  </a>
  <h1 class="site-title">
    skkyblu3
  </h1>
  <p class="site-description">
    Welcome to Internet
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          é¦–é¡µ
        </a>
      
    
      
        <a href="/archives" class="menu">
          å½’æ¡£
        </a>
      
    
      
        <a href="/tags" class="menu">
          æ ‡ç­¾
        </a>
      
    
      
        <a href="/post/about" class="menu">
          å…³äº
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              åœ¨AWSä¸Šä½¿ç”¨è¯±é¥µç”¨æˆ·æ•è·æ”»å‡»è€…
            </h2>
            <div class="post-info">
              <span>
                2024-07-09
              </span>
              <span>
                17 min read
              </span>
              
                <a href="https://skyblu3519.github.io/tag/tsQCojXdQ/" class="post-tag">
                  # æ¬ºéª—é˜²å¾¡
                </a>
              
                <a href="https://skyblu3519.github.io/tag/IM02GT8L2N/" class="post-tag">
                  # Terraform
                </a>
              
                <a href="https://skyblu3519.github.io/tag/su2_uaPzNg/" class="post-tag">
                  # AWS
                </a>
              
            </div>
            
              <img class="post-feature-image" src="https://skyblu3519.github.io/post-images/zai-aws-shang-shi-yong-you-er-yong-hu-bu-huo-gong-ji-zhe.jpg" alt="">
            
            <div class="post-content-wrapper">
              <div class="post-content" v-pre>
                <p>æ€è·¯å°±æ˜¯åˆ›å»ºä¸€ä¸ªIAMç”¨æˆ·ï¼Œç„¶åç”¨CloudWatchç›‘æ§è¯¥ç”¨æˆ·çš„è¡Œä¸ºï¼Œå¦‚æœå‡ºç°äº†è¯¥ç”¨æˆ·çš„æ“ä½œåˆ™è§¦å‘å‘Šè­¦ï¼Œå¹¶é€šè¿‡é‚®ä»¶é€šçŸ¥ã€‚</p>
<p>ä½¿ç”¨æ§åˆ¶å°å’ŒTerraformä¸¤ç§æ–¹æ³•å®ç°</p>
<h1 id="æ§åˆ¶å°åˆ›å»º">æ§åˆ¶å°åˆ›å»º</h1>
<h2 id="åˆ›å»ºè¯±é¥µç”¨æˆ·">åˆ›å»ºè¯±é¥µç”¨æˆ·</h2>
<p>åœ¨ IAM æ§åˆ¶å°åˆ›å»ºä¸€ä¸ªè¯±é¥µç”¨æˆ·<strong>honeyUser</strong>ï¼Œä¸é™„åŠ ä»»ä½•æƒé™<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720081492814-3e17265e-d254-41d0-a77f-54f84a647378.png" alt="image.png" loading="lazy"></p>
<p>ä¸º<strong>honeyUser</strong>åˆ›å»ºä¸€ä¸ªè®¿é—®å¯†é’¥ï¼Œè¿™å¯¹å¯†é’¥ä¹‹åä¾¿å¯ä»¥é€šè¿‡ä¸€äº›æ–¹æ³•æ³„éœ²å‡ºå»ï¼Œè¿›è€Œæ•è·å¯ç–‘çš„æ”»å‡»è€…ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720081561008-5584f5f6-0d2b-4c9a-bd73-152c263e3b6f.png" alt="image.png" loading="lazy"></p>
<h2 id="åˆ›å»ºcloudtrailå¹¶å°†äº‹ä»¶å‘é€è‡³cloudwatch">åˆ›å»ºCloudTrailå¹¶å°†äº‹ä»¶å‘é€è‡³CloudWatch</h2>
<p>è¿›å…¥<strong>CloudTrail</strong>æ§åˆ¶å°åˆ›å»ºä¸€ä¸ª<strong>trail</strong>ï¼ˆè¿½è¸ªï¼‰ï¼Œåˆ›å»º<strong>CloudTrail</strong>çš„æ—¶å€™éœ€è¦é€‰æ‹©ä¸€ä¸ªS3æ¥å¯¹æ—¥å¿—è¿›è¡Œå­˜å‚¨ï¼Œå¦‚æœæ²¡æœ‰æå‰å‡†å¤‡å¥½åˆ™éœ€è¦åœ¨è¿™é‡Œæ–°åˆ›å»ºä¸€ä¸ªã€‚<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720084252797-7f09bc55-a982-41a0-9746-ff4f8c8ec10d.png" alt="image.png" loading="lazy"></p>
<p>è¿™é‡Œä¸ä½¿ç”¨åŠ å¯†æ–¹ä¾¿åé¢æ•°æ®çš„æ£€ç´¢<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720082522978-0a4e8c78-584b-4455-98fc-ec6c2003573a.png" alt="image.png" loading="lazy"></p>
<p>é…ç½®å‘<strong>CloudWatch Logs</strong>å‘é€äº‹ä»¶ï¼Œä¹‹åå¯ä»¥åœ¨<strong>CloudWatch</strong>é…ç½®è§„åˆ™æ¥å¯¹è¯±é¥µç”¨æˆ·çš„ç™»å½•è¡Œä¸ºè¿›è¡Œå‘Šè­¦ã€‚<strong>CloudTrail</strong> ä½¿ç”¨ <strong>CloudWatch</strong> æ—¥å¿—ç»„ä½œä¸ºæ—¥å¿—äº‹ä»¶çš„ä¼ è¾“ç»ˆç«¯èŠ‚ç‚¹ï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªæ—¥å¿—ç»„æˆ–è€…æŒ‡å®šä¸€ä¸ªç°æœ‰æ—¥å¿—ç»„ã€‚åŒæ—¶éœ€è¦ä¸€ä¸ª <strong>IAMè§’è‰²</strong> å°†äº‹ä»¶å‘é€åˆ° <strong>CloudWatch</strong>ï¼Œè¿™ä¸ªè§’è‰²éœ€è¦æœ‰<code>logs:CreateLogStream</code>å’Œ<code>logs:PutLogEvents</code>ä¸¤ä¸ªæƒé™ã€‚è¿™é‡Œè®©å®ƒæ–°å»ºä¸€ä¸ªæ—¥å¿—ç»„å’Œè§’è‰²ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720084273034-2b8cd697-2d68-495d-ba1c-a8bcd7dcb5af.png" alt="image.png" loading="lazy"></p>
<p>åœ¨ä¸‹ä¸€æ­¥è¿½è¸ªçš„äº‹ä»¶ä¸­åªé€‰æ‹©<code>Management events</code>ï¼Œä¸»è¦è¿½è¸ªç”¨æˆ·çš„ç™»å½•è¡Œä¸º<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720084370949-747883e2-fbf3-4d51-8c18-87918a5c3598.png" alt="image.png" loading="lazy"></p>
<p>åˆ›å»ºå¥½ååœ¨ <strong>Trailsé¡µé¢</strong> æ˜¾ç¤ºè¯¥<strong>Trail</strong> å·²å¼€å§‹å·¥ä½œï¼ˆStatus: Loggingï¼‰<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720084619035-22a6424b-f1f5-4b15-804a-61c3979a9af5.png" alt="image.png" loading="lazy"></p>
<p>åœ¨é…ç½®CloudWatchä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹å’Œè¿™ä¸ª <strong>Trail</strong> ä»¥å‰åˆ›å»ºçš„éƒ½æœ‰é‚£äº›èµ„æºã€‚è¿›å…¥ <strong>IAMé¡µé¢</strong> åœ¨ <strong>ç­–ç•¥</strong> ä¸­æŸ¥çœ‹å®¢æˆ·æ‰˜ç®¡ç­–ç•¥ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€ä¸ªæ–°åˆ›å»ºçš„ç”¨æ¥æ¨é€ <strong>CloudWatch</strong> çš„æ‰˜ç®¡ç­–ç•¥ã€‚å®ƒçš„æè¿°æ˜¯ï¼š<code>Policy for config CloudWathLogs for trail cloudtrail-logging-honey, created by CloudTrail console</code><br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720085238845-d879e93c-d500-4412-ba75-86bd168cb67f.png" alt="image.png" loading="lazy"></p>
<p>ç‚¹å‡»æŸ¥çœ‹å®ƒçš„ç­–ç•¥å†…å®¹ã€‚è¿™é‡Œè®¸å¯äº†ä¸¤ä¸ªæ“ä½œã€‚è€Œä»–ä»¬æŒ‡å‘çš„èµ„æºéƒ½æ˜¯ <strong>CloudTrail</strong> å‘ <strong>CloudWatch Logs</strong> å‘é€çš„è¿™æ¡æ—¥å¿—æµ</p>
<ul>
<li><strong>logs:CreateLogStream</strong>: å…è®¸è¢«æˆæƒçš„å®ä½“åˆ›å»ºæ—¥å¿—æµ</li>
<li><strong>logs:PutLogEvents</strong>: å…è®¸è¢«æˆæƒçš„å®ä½“å‘æ—¥å¿—æµä¸­å†™å…¥æ—¥å¿—äº‹ä»¶ã€‚</li>
</ul>
<figure data-type="image" tabindex="1"><img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720085429872-efdcb37a-c5ee-47a1-bf84-198a5d29223b.png" alt="image.png" loading="lazy"></figure>
<p>è¿›å…¥ <strong>è§’è‰²</strong> å¯ä»¥çœ‹åˆ° <strong>CloudTrail</strong> åˆ›å»ºçš„è§’è‰² <strong>CloudTrailRoleForCloudWatch-Honey</strong><br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720085905922-883fb904-4fb3-4133-a75e-6717bb9b532e.png" alt="image.png" loading="lazy"></p>
<p>åŒæ—¶å®ƒçš„å¯ä¿¡å®ä½“æŒ‡å‘äº†æŒ‡å®šäº† AWS çš„ <strong>CloudTrail</strong> æœåŠ¡ (<code>cloudtrail.amazonaws.com</code>)<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720085957456-cda42843-1058-4c6f-ba5c-817bcfe1e64d.png" alt="image.png" loading="lazy"></p>
<p>æƒé™åˆ™ä½¿ç”¨çš„æ˜¯åˆšåˆšçœ‹åˆ°çš„ç­–ç•¥ç»„<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720086049997-9f862dee-a967-469f-907a-144a23e66156.png" alt="image.png" loading="lazy"></p>
<p>åœ¨ <strong>CloudWatch</strong> ä¸­çš„æ—¥å¿—ç»„ä¸­ï¼Œçœ‹åˆ° <strong>CloudTrail</strong> åˆ›å»ºçš„æ—¥å¿—ç»„ <strong>aws-cloudtrail-logs-CloudWatch-Honey</strong><br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720086403608-a041b1a3-ebc2-45dd-8536-22dfea5688b6.png" alt="image.png" loading="lazy"></p>
<p>ç°åœ¨æˆ‘ä»¬åœ¨ AWS CLI ä¸­ç™»å½•ä¹‹å‰åˆ›å»ºçš„ honeyUser<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720086607466-7a19947d-5b95-4b59-8aae-7861465d0ec7.png" alt="image.png" loading="lazy"></p>
<p>å›åˆ° <strong>CloudWatch</strong> é¡µé¢ï¼Œè¿›å…¥ <strong>Live Tail</strong>ï¼Œé€‰æ‹©è¦ç­›é€‰çš„æ—¥å¿—ç»„<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720086831606-9ac3c56c-3ed9-4d48-96b0-f3acd179c106.png" alt="image.png" loading="lazy"></p>
<p>è¿‡äº†ä¸€ä¼šå„¿åçœ‹åˆ°æˆ‘ä»¬çš„ç™»å½•è®°å½•<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720087141533-20e9d7f3-de6e-45f6-9be0-ae6b61026900.png" alt="image.png" loading="lazy"></p>
<h2 id="åˆ›å»ºæ—¥å¿—ç­›é€‰å¹¶è®¾ç½®å‘Šè­¦">åˆ›å»ºæ—¥å¿—ç­›é€‰å¹¶è®¾ç½®å‘Šè­¦</h2>
<p>é€‰æ‹©æ—¥å¿—ç»„ï¼Œæ“ä½œ -&gt; åˆ›å»ºæŒ‡æ ‡ç­›é€‰æ¡ä»¶<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720094509300-2e7a594c-1a84-4b45-89c7-fe425c745d46.png" alt="image.png" loading="lazy"></p>
<p>ä½¿ç”¨ç­›é€‰æ¨¡æ¿ç­›é€‰å‡º honeyUser çš„æ‰€æœ‰æ—¥å¿—</p>
<pre><code>{ $.userIdentity.type = &quot;IAMUser&quot; &amp;&amp; $.userIdentity.userName = &quot;honeyUser&quot; }
</code></pre>
<figure data-type="image" tabindex="2"><img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720095262029-8f4aae34-b4a7-40f4-b9f0-f006151ab3ee.png" alt="image.png" loading="lazy"></figure>
<p>åœ¨åˆ†é…æŒ‡æ ‡é¡µé¢è¾“å…¥ç­›é€‰åç§°ã€å‘½åç©ºé—´ã€æŒ‡æ ‡åç§°ã€æŒ‡æ ‡å€¼è®¾ç½®ä¸º1<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720095864584-4b6fc5d6-84d6-4b8c-8093-15d94b8c01e4.png" alt="image.png" loading="lazy"></p>
<p>é…ç½®å¥½ä¹‹åä¸ºå®ƒåˆ›å»ºå‘Šè­¦<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720096232046-d4e44916-ecfd-46dd-9d1a-32bb64bd398e.png" alt="image.png" loading="lazy"></p>
<p>å‘¨æœŸé…ç½®ä¸º<code>1åˆ†é’Ÿ</code>ï¼Œé˜ˆå€¼é…ç½®ä¸º<code>&gt;=1</code>ã€‚è¿™æ„å‘³ç€åœ¨ä»»ä½•ç»™å®šçš„ 1 åˆ†é’Ÿå‘¨æœŸå†…ï¼Œå¦‚æœè¯¥ç”¨æˆ·è‡³å°‘ç™»å½•ä¸€æ¬¡ï¼Œå°±ä¼šè§¦å‘å‘Šè­¦ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720097123625-3a798543-86f4-4c00-b571-4d45b911bf7d.png" alt="image.png" loading="lazy"><br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720097131806-61322baa-f631-4eab-a170-3dfcac72b3ad.png" alt="image.png" loading="lazy"></p>
<p>åœ¨ä¸‹ä¸€æ­¥é…ç½®å‘Šè­¦å¦‚ä½•å¤„ç†ï¼Œè¿™é‡Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä¸»é¢˜ï¼ŒæŠŠå‘Šè­¦å‘é€åˆ°æˆ‘ä»¬çš„é‚®ç®±ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720097357712-bbdbaeca-df16-4537-a114-b385a1d1010b.png" alt="image.png" loading="lazy"></p>
<p>åœ¨ä¸‹ä¸€æ­¥é…ç½®ä¸‹è¡¨è¿°<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720097519442-b13ea343-032b-4562-b6c6-d25149aab6cd.png" alt="image.png" loading="lazy"></p>
<p>è¿™æ ·å‘Šè­¦å°±é…ç½®å¥½äº†<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720097591519-0767394b-93c3-4c69-82e7-c1f6029c5f49.png" alt="image.png" loading="lazy"></p>
<p>æœ€ååœ¨åˆ°é‚®ç®±é‡Œç¡®è®¤ä¸‹è®¢é˜…<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720098089437-e0940d82-5efb-4b8c-8e2e-3bb57f17bb41.png" alt="image.png" loading="lazy"></p>
<p>åœ¨ CLI ä¸­å°è¯•ç™»å½• honeyUserï¼ŒHoney_Alarm å˜ä¸ºå‘Šè­¦ä¸­<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720099278832-158f8623-26c2-4f18-9580-d19989da553c.png" alt="image.png" loading="lazy"></p>
<p>åŒæ—¶é‚®ç®±æ”¶åˆ°å‘Šè­¦<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720099318259-d036533c-2f5d-4e06-9824-159e034d54ac.png" alt="image.png" loading="lazy"></p>
<p>å®éªŒå®Œåè®°å¾—æ¸…ç†åˆšåˆšåˆ›å»ºçš„å†…å®¹ï¼Œä»¥å…äº§ç”Ÿé¢å¤–çš„è´¹ç”¨</p>
<ul>
<li>CloudWatch Log å‘Šè­¦</li>
<li>CloudWatch Log æ—¥å¿—ç»„</li>
<li>Amazon SNS</li>
<li>CloudTrail è¿½è¸ª</li>
<li>S3</li>
<li>IAMè§’è‰²</li>
<li>IAMå®¢æˆ·æ‰˜ç®¡ç­–ç•¥</li>
<li>IAMç”¨æˆ· honeyUser</li>
</ul>
<h1 id="ä½¿ç”¨terraformä»£ç åˆ›å»º">ä½¿ç”¨Terraformä»£ç åˆ›å»º</h1>
<p>Terraformæ˜¯ä¸€ä¸ªåŸºç¡€è®¾æ–½å³ä»£ç ï¼ˆIaCï¼‰å·¥å…·ï¼Œç®€è€Œè¨€ä¹‹å®ƒè®©æˆ‘ä»¬å¯ä»¥ç”¨ä»£ç çš„æ–¹å¼å¯¹äº‘ä¸Šçš„å„ä¸ªèµ„æºè¿›è¡Œåˆ›å»ºã€é…ç½®å’Œæ›´æ–°ã€‚</p>
<p>å¯¹äºä¸Šé¢çš„åˆ›å»ºæµç¨‹å¤§è‡´å¯ä»¥åˆ†ä¸ºå‡ æ­¥ï¼š</p>
<ul>
<li>åˆ›å»ºä¸€ä¸ª<strong>IAMç”¨æˆ·</strong>ï¼Œä½œä¸ºè¯±é¥µç”¨æˆ·ã€‚</li>
<li>åˆ›å»ºä¸€ä¸ª<strong>CloudTrailè¿½è¸ª</strong>ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª<strong>S3æ¡¶</strong>æ¥å­˜å‚¨æ—¥å¿—ã€‚</li>
<li>åˆ›å»ºä¸€ä¸ª<strong>CloudWatch Logæ—¥å¿—ç»„</strong>æ¥åˆ†ææ—¥å¿—ï¼ŒåŒæ—¶è¿˜è¦ä¸€ä¸ªæ‹¥æœ‰åˆ›å»º/æ¨é€æ—¥å¿—æµæƒé™çš„<strong>IAMè§’è‰²</strong>å‘æ—¥å¿—ç»„ä¸­æ¨é€æ—¥å¿—ã€‚</li>
<li>åˆ›å»ºä¸€ä¸ª<strong>CloudWatch Logæ—¥å¿—ç­›é€‰</strong>ï¼ŒåŒæ—¶ä¸ºå®ƒåˆ›å»ºä¸€ä¸ª<strong>CloudWatch Logå‘Šè­¦</strong>ï¼Œå†åˆ›å»ºä¸€ä¸ª<strong>SNSä¸»é¢˜</strong>ç”¨æ¥æ¥æ”¶å‘Šè­¦ï¼Œå¹¶ä¸ºå®ƒé…ç½®å¥½<strong>endpoint</strong>ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„é‚®ç®±åœ°å€ã€‚</li>
</ul>
<p>åœ¨ä½¿ç”¨Terraformä»£ç å®ç°è¿™ä¸ªæµç¨‹ä¹‹å‰ï¼Œå…ˆå‡†å¤‡å¥½ä¸€ä¸ªç©ºç›®å½•ï¼Œé‡Œé¢åˆ›å»ºæ–‡ä»¶ç»“æ„å¦‚ä¸‹</p>
<pre><code>./
â”œâ”€â”€ main.tf
â”œâ”€â”€ outputs.tf
â””â”€â”€ povider.tf
</code></pre>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li>provider.tfï¼šç”¨æ¥é…ç½® AWS povider</li>
<li>main.tfï¼šåŒ…å«äº†ä¸»è¦çš„èµ„æºé…ç½®</li>
<li>outputs.tfï¼šç”¨æ¥å®šä¹‰è¾“å‡ºå˜é‡</li>
</ul>
<p>æœ¬æ¬¡å®éªŒçš„ç‰ˆæœ¬<code>Terraform v1.8.5</code>ï¼ŒåŒæ—¶æå‰ç¼“å­˜å¥½äº†AWS poviderã€‚ä¸‹é¢å¼€å§‹coding</p>
<h2 id="åˆ›å»ºawsç”¨æˆ·">åˆ›å»ºAWSç”¨æˆ·</h2>
<p>é¦–å…ˆç¼–å†™<code>povider.tf</code>ï¼Œé…ç½®å¥½<code>region</code>å’Œ<code>AK/SK</code></p>
<pre><code class="language-yaml">provider &quot;aws&quot; {
  region     = &quot;us-east-1&quot;
  access_key = &quot;&lt;aws_access_key&gt;&quot;
  secret_key = &quot;&lt;aws_secret_key&gt;&quot;
}
</code></pre>
<p><code>main.tf</code>åˆ›å»ºè¯±é¥µç”¨æˆ·ï¼ŒåŒæ—¶å¼€å¯å‡­è¯è®¿é—®</p>
<pre><code class="language-yaml"># è¯±é¥µç”¨æˆ· backup_admin
resource &quot;aws_iam_user&quot; &quot;backup_admin&quot; {
  name = &quot;backup-admin&quot;
}

resource &quot;aws_iam_access_key&quot; &quot;backup_admin_key&quot; {
  user = aws_iam_user.backup_admin.name
}
</code></pre>
<p><code>outputs.tf</code>å°†AK/SKè¾“å‡ºã€‚å› ä¸ºå¯†é’¥å±äºæ•æ„Ÿä¿¡æ¯ï¼Œæ— æ³•ç›´æ¥åœ¨æ§åˆ¶å°è¾“å‡ºï¼Œæ‰€ä»¥è¦ä¸ºå˜é‡è®¾ç½®<code>sensitive = true</code>ã€‚è‹¥è¦æŸ¥çœ‹ä½¿ç”¨å‘½ä»¤ï¼š<code>terraform output -json</code></p>
<pre><code class="language-yaml">output &quot;access_key_id&quot; {
  value     = aws_iam_access_key.backup_admin_key.id
  sensitive = true
}

output &quot;secret_access_key&quot; {
  value     = aws_iam_access_key.backup_admin_key.secret
  sensitive = true
}
</code></pre>
<p>ç¼–è¾‘å¥½ä¹‹åä¾æ¬¡è¾“å…¥å‘½ä»¤</p>
<pre><code class="language-yaml">terraform init
terraform plan
terraform apply
</code></pre>
<figure data-type="image" tabindex="3"><img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720448356405-25ad5bf7-8edc-44e8-9b30-570329459b00.png" alt="image.png" loading="lazy"></figure>
<p>è¿™æ ·Terraformå°±è‡ªåŠ¨ä¸ºæˆ‘ä»¬åˆ›å»ºäº†è¿™ä¸ª<code>backup-admin</code>ç”¨æˆ·<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720505884086-59865913-dd1a-4b9b-a46c-dde8bc052656.png" alt="image.png" loading="lazy"></p>
<h2 id="åˆ›å»ºé…ç½®cloudtrail">åˆ›å»ºé…ç½®CloudTrail</h2>
<p>é¦–å…ˆå®šä¹‰å¥½å½“å‰AWSç”¨æˆ·çš„æ•°æ®æºï¼Œä¹‹ååˆ›å»ºçš„æ—¶å€™ä¼šç”¨åˆ°å…¶ä¸­çš„ä¿¡æ¯</p>
<pre><code class="language-yaml"># AWS å…ƒæ•°æ®
data &quot;aws_caller_identity&quot; &quot;current&quot; {}

data &quot;aws_partition&quot; &quot;current&quot; {}

data &quot;aws_region&quot; &quot;current&quot; {}
</code></pre>
<p>ç„¶åæ˜¯åˆ›å»ºCloudTrailçš„ä»£ç </p>
<pre><code class="language-yaml"># åˆ›å»º CloudTrail 
resource &quot;aws_cloudtrail&quot; &quot;cloudtrail_honey&quot; {
  name                          = &quot;cloudtrail_honey&quot;
  s3_bucket_name                = aws_s3_bucket.cloudtrail_bucket.id
  include_global_service_events = true
  is_multi_region_trail         = true

  depends_on = [aws_s3_bucket_policy.cloudtrail_bucket_policy]
}

# CloudTrail æ‰€ç”¨çš„ S3 é…ç½®
resource &quot;aws_s3_bucket&quot; &quot;cloudtrail_bucket&quot; {
  bucket        = &quot;cloudtrail-bucket-honey&quot;
  force_destroy = true
}

data &quot;aws_iam_policy_document&quot; &quot;cloudtrail_bucket_policy_document&quot; {
  statement {
    sid    = &quot;AWSCloudTrailAclCheck&quot;
    effect = &quot;Allow&quot;

    principals {
      type        = &quot;Service&quot;
      identifiers = [&quot;cloudtrail.amazonaws.com&quot;]
    }

    actions   = [&quot;s3:GetBucketAcl&quot;]
    resources = [aws_s3_bucket.cloudtrail_bucket.arn]
    condition {
      test     = &quot;StringEquals&quot;
      variable = &quot;aws:SourceArn&quot;
      values   = [&quot;arn:${data.aws_partition.current.partition}:cloudtrail:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:trail/cloudtrail_honey&quot;]
    }
  }

  statement {
    sid    = &quot;AWSCloudTrailWrite&quot;
    effect = &quot;Allow&quot;

    principals {
      type        = &quot;Service&quot;
      identifiers = [&quot;cloudtrail.amazonaws.com&quot;]
    }

    actions   = [&quot;s3:PutObject&quot;]
    resources = [&quot;${aws_s3_bucket.cloudtrail_bucket.arn}/AWSLogs/${data.aws_caller_identity.current.account_id}/*&quot;]

    condition {
      test     = &quot;StringEquals&quot;
      variable = &quot;s3:x-amz-acl&quot;
      values   = [&quot;bucket-owner-full-control&quot;]
    }
    condition {
      test     = &quot;StringEquals&quot;
      variable = &quot;aws:SourceArn&quot;
      values   = [&quot;arn:${data.aws_partition.current.partition}:cloudtrail:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:trail/cloudtrail_honey&quot;]
    }
  }
}

resource &quot;aws_s3_bucket_policy&quot; &quot;cloudtrail_bucket_policy&quot; {
  bucket = aws_s3_bucket.cloudtrail_bucket.id
  policy = data.aws_iam_policy_document.cloudtrail_bucket_policy_document.json
}
</code></pre>
<p>ä¸‹é¢ä¸€æ­¥ä¸€æ­¥è¯´æ˜ï¼Œé¦–å…ˆæ˜¯ <code>resource &quot;aws_cloudtrail&quot;</code> å—ã€‚è¿™é‡Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª<strong>AWS CloudTrailè¿½è¸ªå™¨</strong>å…¶ä¸­ï¼š</p>
<ul>
<li><code>name</code>æŒ‡å®šçš„æ˜¯CloudTrailè¿½è¸ªå™¨çš„åç§°ä¸º<code>cloudtrail_honey</code>ã€‚</li>
<li><code>s3_bucket_name</code>æŒ‡å®šå­˜å‚¨ CloudTrail æ—¥å¿—çš„ Amazon S3 æ¡¶çš„åç§°ã€‚è¿™é‡Œå¼•ç”¨äº†å¦ä¸€ä¸ª Terraform èµ„æº aws_s3_bucketï¼Œè¯¥èµ„æºçš„ ID è¢«ç”¨ä½œ S3 æ¡¶çš„åç§°ã€‚</li>
<li><code>include_global_service_events = true</code>è®¾ç½®å¯ç”¨äº†å…¨çƒæœåŠ¡äº‹ä»¶çš„è®°å½•ï¼Œå¦‚ AWS Identity and Access Management (IAM) æ“ä½œã€‚è¿™æ„å‘³ç€ä¸ä»…é™äºåœ°ç†åŒºåŸŸç‰¹å®šçš„æœåŠ¡ï¼Œå…¨çƒæœåŠ¡çš„äº‹ä»¶ä¹Ÿä¼šè¢«è®°å½•ã€‚</li>
<li><code>is_multi_region_trail = true</code>å¯ç”¨å¤šåŒºåŸŸè¿½è¸ªï¼Œç¡®ä¿æ‰€æœ‰ AWS åŒºåŸŸä¸­çš„äº‹ä»¶éƒ½è¢«è®°å½•ã€‚</li>
<li><code>depends_on = [aws_s3_bucket_policy.cloudtrail_bucket_policy]</code>è¿™æ˜¯ä¸€ä¸ª Terraform çš„éšå¼ä¾èµ–å…³ç³»å£°æ˜ï¼Œç”¨æ¥ç¡®ä¿åœ¨åˆ›å»º CloudTrail è¿½è¸ªå™¨ä¹‹å‰ï¼Œç›¸å…³çš„ S3 æ¡¶ç­–ç•¥å·²ç»è¢«åˆ›å»ºå’Œåº”ç”¨ã€‚</li>
</ul>
<pre><code class="language-yaml">resource &quot;aws_cloudtrail&quot; &quot;cloudtrail_honey&quot; {
  name                          = &quot;cloudtrail_honey&quot;
  s3_bucket_name                = aws_s3_bucket.cloudtrail_bucket.id
  include_global_service_events = true
  is_multi_region_trail         = true
  
  depends_on = [aws_s3_bucket_policy.cloudtrail_bucket_policy]
}
</code></pre>
<p>æ¥ä¸‹æ¥å®šä¹‰äº†ä¸€ä¸ªä¾›<code>cloudtrail_honey</code>ä½¿ç”¨çš„S3ä»¥åŠè¯¥S3çš„ç­–ç•¥ã€‚å…¶ä¸­</p>
<ul>
<li><strong>force_destroy</strong>ï¼šå½“è®¾ç½®ä¸º true æ—¶ï¼Œè¿™ä¸ªå±æ€§å…è®¸ Terraform åœ¨æ‰§è¡Œ terraform destroy å‘½ä»¤æ—¶åˆ é™¤å­˜å‚¨æ¡¶ï¼Œå³ä½¿å­˜å‚¨æ¡¶ä¸­è¿˜åŒ…å«æ–‡ä»¶ã€‚è¿™æ˜¯ä¸ºäº†ç¡®ä¿åœ¨æµ‹è¯•æˆ–ä¸´æ—¶éƒ¨ç½²çš„æƒ…å†µä¸‹ï¼Œèµ„æºå¯ä»¥è¢«å®Œå…¨æ¸…ç†ã€‚</li>
<li><strong>data &quot;aws_iam_policy_document&quot;</strong>ï¼šç­–ç•¥æ–‡æ¡£å°†è¦å®šä¹‰ AWS CloudTrail å†™å…¥æ—¥å¿—æ–‡ä»¶çš„æƒé™ã€‚</li>
<li><strong>policy</strong>ï¼šå°†å‰é¢å®šä¹‰çš„ IAM ç­–ç•¥æ–‡æ¡£ï¼ˆåºåˆ—åŒ–ä¸º JSON æ ¼å¼ï¼‰åº”ç”¨åˆ°æŒ‡å®šçš„å­˜å‚¨æ¡¶ã€‚è¿™æ ·ï¼Œå­˜å‚¨æ¡¶çš„è®¿é—®æƒé™å°±æ ¹æ®è¿™ä¸ªç­–ç•¥è¿›è¡Œäº†é…ç½®ã€‚</li>
</ul>
<pre><code class="language-yaml">resource &quot;aws_s3_bucket&quot; &quot;cloudtrail_bucket&quot; {
  bucket        = &quot;cloudtrail-bucket-honey&quot;
  force_destroy = true
}

data &quot;aws_iam_policy_document&quot; &quot;cloudtrail_bucket_policy_document&quot; {
  ......
}

resource &quot;aws_s3_bucket_policy&quot; &quot;cloudtrail_bucket_policy&quot; {
  bucket = aws_s3_bucket.cloudtrail_bucket.id
  policy = data.aws_iam_policy_document.cloudtrail_bucket_policy_document.json
}
</code></pre>
<p>S3çš„ç­–ç•¥æ–‡æ¡£ä¸»è¦æ˜¯è®© CloudTrail èƒ½å¤Ÿå°†æ—¥å¿—å­˜å‚¨åˆ°è¯¥ S3 ä¸­ã€‚è¿™ä¸ªç­–ç•¥åŒ…å«ä¸¤ä¸ªä¸»è¦çš„å£°æ˜ (statement)ï¼š</p>
<ul>
<li>ç¬¬ä¸€æ¡å£°æ˜: AWSCloudTrailAclCheck
<ul>
<li><strong>ä¸»ä½“ (Principals)</strong>ï¼šæŒ‡å®šæœåŠ¡ä¸»ä½“ä¸º cloudtrail.amazonaws.comï¼Œæ„å‘³ç€è¿™æ¡è§„åˆ™ä¸“ä¸º CloudTrail æœåŠ¡è®¾ç½®ã€‚</li>
<li><strong>åŠ¨ä½œ (Actions)</strong>ï¼šå…è®¸åŠ¨ä½œ s3:GetBucketAclï¼Œä½¿ CloudTrail èƒ½æ£€æŸ¥å­˜å‚¨æ¡¶çš„æƒé™è®¾ç½®ã€‚</li>
<li><strong>èµ„æº (Resources)</strong>ï¼šé™åˆ¶æƒé™åˆ°ç‰¹å®šçš„ S3 å­˜å‚¨æ¡¶ï¼ˆaws_s3_bucket.cloudtrail_bucket.arnï¼‰ã€‚</li>
<li><strong>æ¡ä»¶ (Condition)</strong>ï¼šç¡®ä¿åªæœ‰å½“è¯·æ±‚æ¥è‡ªç‰¹å®š CloudTrail è¿½è¸ªå™¨ (cloudtrail_honey) æ—¶ï¼Œæ‰å…è®¸è®¿é—®ã€‚é€šè¿‡åŒ¹é…è¯·æ±‚çš„æ¥æº ARN æ¥å¼ºåŒ–å®‰å…¨æªæ–½ã€‚</li>
</ul>
</li>
<li>ç¬¬äºŒæ¡å£°æ˜: AWSCloudTrailWrite
<ul>
<li><strong>ä¸»ä½“ (Principals)</strong>ï¼šåŒæ ·æŒ‡å®šæœåŠ¡ä¸»ä½“ä¸º cloudtrail.amazonaws.comã€‚</li>
<li><strong>åŠ¨ä½œ (Actions)</strong>ï¼šå…è®¸åŠ¨ä½œ s3:PutObjectï¼Œæˆæƒ CloudTrail å‘æŒ‡å®šè·¯å¾„å†™å…¥æ—¥å¿—æ–‡ä»¶ã€‚</li>
<li><strong>èµ„æº (Resources)</strong>ï¼šæŒ‡å®š CloudTrail å¯ä»¥å†™å…¥åˆ°çš„å…·ä½“å¯¹è±¡è·¯å¾„ï¼ŒåŒ…æ‹¬ AWS è´¦æˆ· ID å’Œå­˜å‚¨æ¡¶ ARN çš„ç»„åˆï¼Œç¡®ä¿æ—¥å¿—æ•°æ®çš„ç»„ç»‡å’Œéš”ç¦»ã€‚</li>
<li><strong>æ¡ä»¶ (Condition)</strong>ï¼š
<ul>
<li>s3:x-amz-acl ç¡®ä¿æ‰€æœ‰å†™å…¥çš„å¯¹è±¡è®¾ç½®ä¸º bucket-owner-full-controlï¼Œè¿™ä¸ºå­˜å‚¨æ¡¶æ‰€æœ‰è€…æä¾›äº†å¯¹æ—¥å¿—æ–‡ä»¶çš„å®Œå…¨æ§åˆ¶æƒã€‚</li>
<li>aws:SourceArn æ¡ä»¶åŒç¬¬ä¸€æ¡å£°æ˜ï¼Œä¿è¯åªæœ‰ç‰¹å®š CloudTrail è¿½è¸ªå™¨çš„è¯·æ±‚æ‰è¢«å…è®¸ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code class="language-yaml">data &quot;aws_iam_policy_document&quot; &quot;cloudtrail_bucket_policy_document&quot; {
  statement {
    sid    = &quot;AWSCloudTrailAclCheck&quot;
    effect = &quot;Allow&quot;

    principals {
      type        = &quot;Service&quot;
      identifiers = [&quot;cloudtrail.amazonaws.com&quot;]
    }

    actions   = [&quot;s3:GetBucketAcl&quot;]
    resources = [aws_s3_bucket.cloudtrail_bucket.arn]
    condition {
      test     = &quot;StringEquals&quot;
      variable = &quot;aws:SourceArn&quot;
      values   = [&quot;arn:${data.aws_partition.current.partition}:cloudtrail:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:trail/cloudtrail_honey&quot;]
    }
  }

  statement {
    sid    = &quot;AWSCloudTrailWrite&quot;
    effect = &quot;Allow&quot;

    principals {
      type        = &quot;Service&quot;
      identifiers = [&quot;cloudtrail.amazonaws.com&quot;]
    }

    actions   = [&quot;s3:PutObject&quot;]
    resources = [&quot;${aws_s3_bucket.cloudtrail_bucket.arn}/AWSLogs/${data.aws_caller_identity.current.account_id}/*&quot;]

    condition {
      test     = &quot;StringEquals&quot;
      variable = &quot;s3:x-amz-acl&quot;
      values   = [&quot;bucket-owner-full-control&quot;]
    }
    condition {
      test     = &quot;StringEquals&quot;
      variable = &quot;aws:SourceArn&quot;
      values   = [&quot;arn:${data.aws_partition.current.partition}:cloudtrail:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:trail/cloudtrail_honey&quot;]
    }
  }
}
</code></pre>
<p>è¿˜æ˜¯ç”¨ä¹‹å‰çš„å‘½ä»¤éƒ¨ç½²ï¼Œå®Œæˆä¹‹åå¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„ S3 å’Œ CloudTrailè¿½è¸ªå™¨<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720508544812-92692e4e-8d47-4783-968c-a0a86d891be4.png" alt="image.png" loading="lazy"><br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720508590128-fe79ebe2-5fe0-4433-82d1-e37fb2542849.png" alt="image.png" loading="lazy"></p>
<h2 id="åˆ›å»ºcloudwatch-logæ—¥å¿—ç»„">åˆ›å»ºCloudWatch Logæ—¥å¿—ç»„</h2>
<p>åˆ›å»ºCloudWatch Logæ—¥å¿—ç»„ä¹‹å‰ï¼Œè¿˜è¦è¦å‡†å¤‡ä¸€ä¸ªIAMè§’è‰²è®©CloudTrailå¯ä»¥å°†æ—¥å¿—æ¨é€åˆ°æ—¥å¿—ç»„ä¸­ã€‚</p>
<pre><code class="language-yaml"># ä¿®æ”¹ cloudtrailï¼Œæ·»åŠ å†™å…¥æ—¥å¿—ç»„çš„è§’è‰²å’Œæ—¥å¿—ç»„
resource &quot;aws_cloudtrail&quot; &quot;cloudtrail_honey&quot; {
  ......
  
  cloud_watch_logs_group_arn    = &quot;${aws_cloudwatch_log_group.cloudwatch_log_group_honey.arn}:*&quot;
  cloud_watch_logs_role_arn     = aws_iam_role.cloudtrail_logging_role.arn
    
  ......
}

# åˆ›å»ºCloudWatch Logæ—¥å¿—ç»„
resource &quot;aws_cloudwatch_log_group&quot; &quot;cloudwatch_log_group_honey&quot; {
  name = &quot;cloudwatch-log-group-honey&quot;
}

# åˆ›å»º CloudTrail æ¨é€æ—¥å¿—ç»„çš„è§’è‰²
resource &quot;aws_iam_role&quot; &quot;cloudtrail_logging_role&quot; {
  name               = &quot;cloudtrail-logging-role&quot;

  assume_role_policy = jsonencode({
    Version = &quot;2012-10-17&quot;
    Statement = [
      {
        Action = &quot;sts:AssumeRole&quot;
        Principal = {
          Service = &quot;cloudtrail.amazonaws.com&quot;
        }
        Effect = &quot;Allow&quot;
        Sid    = &quot;&quot;
      },
    ]
  })
}

resource &quot;aws_iam_role_policy&quot; &quot;cloudtrail_logging_role_policy&quot; {
  name      = &quot;cloudtrail-logging-role-policy&quot;
  role      = aws_iam_role.cloudtrail_logging_role.id

  policy    = jsonencode({
    Version = &quot;2012-10-17&quot;
    Statement = [
      {
        Action = [
          &quot;logs:CreateLogStream&quot;,
          &quot;logs:PutLogEvents&quot;
        ],
        Effect   = &quot;Allow&quot;,
        Resource = &quot;${aws_cloudwatch_log_group.cloudwatch_log_group_honey.arn}:log-stream:*&quot;
      },
    ]
  })
}
</code></pre>
<p>è¿™é‡Œå’Œå‰é¢æ§åˆ¶å°ä¸ä¸€æ ·çš„æ˜¯ï¼ŒIAMè§’è‰²æ·»åŠ çš„æ˜¯ä¸€ä¸ªå†…è”ç­–ç•¥è€Œä¸æ˜¯ä¸€ä¸ªæ‰˜ç®¡ç­–ç•¥ã€‚å…¶ä¸­å¯¹äº<strong>logs:CreateLogStream</strong>å’Œ<strong>logs:PutLogEvents</strong>æƒé™å¯¹åº”çš„<code>Resource</code>å†™æ³•ä¸º<code>${aws_cloudwatch_log_group.example.arn}:log-stream:*</code>ï¼Œè¿™ä¸ªè¡¨ç¤ºè¯¥æ—¥å¿—ç»„ä¸‹çš„æ‰€æœ‰æ—¥å¿—æµã€‚</p>
<p>é‡æ–°éƒ¨ç½²ï¼Œåœ¨CloudWatchçš„Live Tailä¸­æŸ¥çœ‹å®æ—¶çš„æ—¥å¿—<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720510175780-b7079c09-b6e2-468d-97d1-45f1fc2c199f.png" alt="image.png" loading="lazy"></p>
<h2 id="åˆ›å»ºå‘Šè­¦">åˆ›å»ºå‘Šè­¦</h2>
<p>é¦–å…ˆåˆ›å»ºä¸€ä¸ª CloudWatch Logs çš„æŒ‡æ ‡è¿‡æ»¤å™¨ç”¨æ¥è¿‡æ»¤å‡ºè¯±é¥µè´¦æˆ·çš„è¡Œä¸ºï¼š</p>
<ul>
<li>Resource: aws_cloudwatch_log_metric_filter
<ul>
<li><code>log_group_name = aws_cloudwatch_log_group.cloudwatch_log_group_honey.name</code>æŒ‡å®šåº”ç”¨è¯¥è¿‡æ»¤å™¨çš„æ—¥å¿—ç»„ã€‚</li>
</ul>
</li>
<li>Metric Transformation
<ul>
<li><code>name = &quot;honeyToken&quot;</code>ï¼šè¿™æ˜¯åˆ›å»ºçš„ CloudWatch æŒ‡æ ‡çš„åç§°ï¼Œå½“æ—¥å¿—åŒ¹é…åˆ°ä¸Šè¿°æ¨¡å¼æ—¶ï¼Œæ­¤æŒ‡æ ‡ä¼šè¢«è§¦å‘æˆ–æ›´æ–°ã€‚</li>
<li><code>namespace = &quot;honeyAlarm&quot;</code>ï¼šæŒ‡æ ‡çš„å‘½åç©ºé—´ï¼Œå‘½åç©ºé—´ç”¨äºéš”ç¦»å„ä¸ªæŒ‡æ ‡é›†åˆï¼Œé˜²æ­¢å‘½åå†²çªã€‚</li>
<li><code>value = &quot;1&quot;</code>ï¼šæ¯å½“æ—¥å¿—åŒ¹é…åˆ°æ¨¡å¼æ—¶ï¼ŒæŒ‡æ ‡çš„å€¼å¢åŠ  1ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥é€šè¿‡è§‚å¯Ÿè¿™ä¸ªæŒ‡æ ‡çš„å˜åŒ–æ¥æ£€æµ‹åŒ¹é…åˆ°çš„æ—¥å¿—äº‹ä»¶çš„é¢‘ç‡ã€‚</li>
</ul>
</li>
</ul>
<pre><code class="language-yaml">resource &quot;aws_cloudwatch_log_metric_filter&quot; &quot;honeyUser_filter&quot; {
  name           = &quot;honeyUser_metric_filter&quot;
  pattern        = &quot;{ $.userIdentity.type = \&quot;IAMUser\&quot; &amp;&amp; $.userIdentity.userName = \&quot;${aws_iam_user.backup_admin.name}\&quot; }&quot;
  log_group_name = aws_cloudwatch_log_group.cloudwatch_log_group_honey.name

  metric_transformation {
    name      = &quot;honeyToken&quot;
    namespace = &quot;honeyAlarm&quot;
    value     = &quot;1&quot;
  }
}
</code></pre>
<p>åˆ›å»ºå‘Šè­¦åŒæ—¶é…ç½®æ¥å—å‘Šè­¦çš„é‚®ç®±ï¼š</p>
<ul>
<li>Resource: aws_cloudwatch_metric_alarm
<ul>
<li><code>comparison_operator = &quot;GreaterThanOrEqualToThreshold&quot;</code>ï¼šè¿™ä¸ªæ¯”è¾ƒæ“ä½œç¬¦å®šä¹‰äº†è§¦å‘å‘Šè­¦çš„æ¡ä»¶ï¼Œè¡¨ç¤ºå½“ç›‘æ§çš„æŒ‡æ ‡å€¼å¤§äºæˆ–ç­‰äºè®¾ç½®çš„é˜ˆå€¼æ—¶ï¼Œå‘Šè­¦å°†è¢«è§¦å‘ã€‚</li>
<li><code>evaluation_periods = &quot;1&quot;</code>ï¼šè¡¨ç¤ºè¯„ä¼°æœŸæ•°ï¼Œå³ CloudWatch ä¼šè€ƒè™‘æœ€è¿‘çš„ä¸€ä¸ªæŒ‡å®šå‘¨æœŸï¼ˆåœ¨è¿™é‡Œæ˜¯60ç§’ï¼‰çš„æ•°æ®ç‚¹æ¥åˆ¤æ–­æ˜¯å¦è§¦å‘å‘Šè­¦ã€‚</li>
<li><code>metric_name/namespace</code>ï¼šå‘Šè­¦å°†ç›‘æ§ honeyAlarm å‘½åç©ºé—´ä¸‹çš„ metric_name æŒ‡æ ‡ï¼Œä¹Ÿå°±æ˜¯åˆšåˆšé…ç½®çš„å†…å®¹</li>
<li><code>period = 60</code>ï¼šæŒ‡å®šçš„å‘¨æœŸï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ï¼Œæ„å‘³ç€ CloudWatch ä¼šæ¯60ç§’æ”¶é›†ä¸€æ¬¡æŒ‡æ ‡æ•°æ®ï¼Œå¹¶ç”¨è¿™äº›æ•°æ®æ¥è¯„ä¼°æ˜¯å¦è§¦å‘å‘Šè­¦ã€‚</li>
<li><code>statistic** **= &quot;Sum&quot;</code>ï¼šç»Ÿè®¡æ–¹æ³•ï¼Œè¡¨ç¤ºåœ¨æ¯ä¸ªè¯„ä¼°å‘¨æœŸå†…ï¼ŒCloudWatch å°†å¯¹æ”¶é›†çš„æ•°æ®ç‚¹æ±‚å’Œæ¥è¿›è¡Œæ¯”è¾ƒåˆ¤æ–­ã€‚</li>
<li><code>threshold = 1</code>ï¼šå‘Šè­¦çš„è§¦å‘é˜ˆå€¼ï¼Œç»“åˆä¸Šè¿°çš„ comparison_operatorï¼Œæ„å‘³ç€å¦‚æœåœ¨ä¸€ä¸ªå‘¨æœŸå†…ï¼ˆ60ç§’ï¼‰æŒ‡æ ‡â€œhoneyTokenâ€çš„æ€»å’Œå¤§äºæˆ–ç­‰äº1ï¼Œåˆ™è§¦å‘å‘Šè­¦ã€‚</li>
<li><code>alarm_actions = [aws_sns_topic.alarm_topic.arn]</code>ï¼šå½“å‘Šè­¦çŠ¶æ€å˜ä¸º ALARM æ—¶ï¼Œå°†è§¦å‘çš„åŠ¨ä½œåˆ—è¡¨ã€‚åœ¨è¿™é‡Œï¼ŒæŒ‡å®šäº†ä¸€ä¸ª Amazon SNS ä¸»é¢˜çš„ ARNï¼Œå½“å‘Šè­¦è§¦å‘æ—¶ï¼Œå°†å‘è¿™ä¸ª SNS ä¸»é¢˜å‘é€é€šçŸ¥ã€‚</li>
</ul>
</li>
</ul>
<pre><code class="language-yaml"># åˆ›å»ºå‘Šè­¦
resource &quot;aws_cloudwatch_metric_alarm&quot; &quot;backup_admin_alarm&quot; {
  alarm_name          = &quot;BackupAdminActivityAlarm&quot;
  comparison_operator = &quot;GreaterThanOrEqualToThreshold&quot;
  evaluation_periods  = &quot;1&quot;
  metric_name         = &quot;honeyToken&quot;
  namespace           = &quot;honeyAlarm&quot;
  period              = 60
  statistic           = &quot;Sum&quot;
  threshold           = 1
  alarm_description   = &quot;Alarm when backup-admin performs any activity.&quot;
  alarm_actions       = [aws_sns_topic.alarm_topic.arn]
}

# åˆ›å»ºSNSå¹¶é…ç½®é‚®ä»¶
resource &quot;aws_sns_topic&quot; &quot;alarm_topic&quot; {
  name = &quot;backup-admin-activity-topic&quot;
}

resource &quot;aws_sns_topic_subscription&quot; &quot;alarm_subscription&quot; {
  topic_arn = aws_sns_topic.alarm_topic.arn
  protocol  = &quot;email&quot;
  endpoint  = &quot;skky@blu3.com&quot;
}
</code></pre>
<p>applyä¹‹åå»é‚®ç®±é‡Œé¢ç¡®è®¤è®¢é˜…ä¾¿å¯æ¥å—å‘Šè­¦ä¿¡æ¯äº†ã€‚<code>terraform output -json</code>è¾“å‡ºè´¦æˆ·å‡­è¯ï¼Œç„¶ååœ¨CLIç™»å½•ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720513588154-04e69601-a07c-4680-a076-70a790598a6f.png" alt="image.png" loading="lazy"></p>
<p>é‚®ç®±æ”¶åˆ°å‘Šè­¦<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720513799153-03a6e07b-7ddb-4181-9a53-32791b56b9e4.png" alt="image.png" loading="lazy"></p>
<p>å®éªŒå®Œä¹‹åæ‰§è¡Œ<code>terraform destroy</code>æ¸…ç†æ‰åˆšåˆšåˆ›å»ºçš„æ‰€æœ‰èµ„æºã€‚éå¸¸æ–¹ä¾¿ğŸ˜<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720514314472-ec0e5420-83f0-4562-836d-732c9d3abcf9.png" alt="image.png" loading="lazy"></p>
<h1 id="æ€»ç»“">æ€»ç»“</h1>
<p>è¿™ä¸ªå›é¡¾è¿™ä¸ªæµç¨‹ï¼Œå…¶ä¸­CloudTrailè¿½è¸ªã€CloudWatch Logæ—¥å¿—ç»„ã€SNSä¸»é¢˜ç­‰èµ„æºæ˜¯ç›¸å¯¹æ¥è¯´ä¸ä¼šå˜çš„ã€‚å±äºè¯±é¥µè´¦æˆ·çš„éƒ¨åˆ†å°±åªæœ‰ä¸€ä¸ªIAMç”¨æˆ·å’Œå®ƒçš„CloudWatchå‘Šè­¦ã€‚æ‰€ä»¥æˆ‘ä»¬çš„tfä»£ç é€»è¾‘ä¸Šåº”è¯¥åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li>ä¸€éƒ¨åˆ†æ˜¯åŸºç¡€èµ„æºçš„åˆ›å»ºï¼Œè¿™é‡Œåˆ›å»ºå®Œä¹‹åè¦æä¾›ä¸€ä¸ªCloudWatch Logæ—¥å¿—ç»„åç§°å’ŒSNSä¸»é¢˜ã€‚</li>
<li>å¦ä¸€ä¸ªéƒ¨åˆ†æ˜¯è¯±é¥µèµ„æºåˆ›å»ºï¼Œä¹Ÿå°±æ˜¯åˆ›å»ºä¸€ä¸ªIAMç”¨æˆ·å’Œå¹¶å®ƒçš„å‘Šè­¦ã€‚</li>
</ul>
<p>è¿™æ ·ä¹‹åå†åˆ›å»ºã€ä¿®æ”¹è¯±é¥µèµ„æºçš„æ—¶å€™å°±å¯ä»¥åªä¸“æ³¨äºè¯±é¥µèµ„æºçš„ä»£ç äº†<br>
<img src="https://skyblu3519.github.io/post-images/AWSHoneyToken/1720515078560-dc9ccd94-27f2-4825-9b42-0c19866abd77.png" alt="image.png" loading="lazy"></p>
<h1 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥</h1>
<p><a href="https://pwnedlabs.io/labs/detect-malicious-activity-with-aws-honey-tokens">https://pwnedlabs.io/labs/detect-malicious-activity-with-aws-honey-tokens</a><br>
<a href="https://wiki.teamssix.com/CloudNative/Terraform/terraform-introductory.html">https://wiki.teamssix.com/CloudNative/Terraform/terraform-introductory.html</a><br>
<a href="https://lonegunmanb.github.io/introduction-terraform/3.4.%E8%BE%93%E5%87%BA%E5%80%BC.html">https://lonegunmanb.github.io/introduction-terraform/3.4.%E8%BE%93%E5%87%BA%E5%80%BC.html</a><br>
<a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudtrail">https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudtrail</a><br>
<a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_metric_alarm">https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_metric_alarm</a></p>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li><a href="#%E6%8E%A7%E5%88%B6%E5%8F%B0%E5%88%9B%E5%BB%BA">æ§åˆ¶å°åˆ›å»º</a>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BA%E8%AF%B1%E9%A5%B5%E7%94%A8%E6%88%B7">åˆ›å»ºè¯±é¥µç”¨æˆ·</a></li>
<li><a href="#%E5%88%9B%E5%BB%BAcloudtrail%E5%B9%B6%E5%B0%86%E4%BA%8B%E4%BB%B6%E5%8F%91%E9%80%81%E8%87%B3cloudwatch">åˆ›å»ºCloudTrailå¹¶å°†äº‹ä»¶å‘é€è‡³CloudWatch</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E6%97%A5%E5%BF%97%E7%AD%9B%E9%80%89%E5%B9%B6%E8%AE%BE%E7%BD%AE%E5%91%8A%E8%AD%A6">åˆ›å»ºæ—¥å¿—ç­›é€‰å¹¶è®¾ç½®å‘Šè­¦</a></li>
</ul>
</li>
<li><a href="#%E4%BD%BF%E7%94%A8terraform%E4%BB%A3%E7%A0%81%E5%88%9B%E5%BB%BA">ä½¿ç”¨Terraformä»£ç åˆ›å»º</a>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BAaws%E7%94%A8%E6%88%B7">åˆ›å»ºAWSç”¨æˆ·</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AEcloudtrail">åˆ›å»ºé…ç½®CloudTrail</a></li>
<li><a href="#%E5%88%9B%E5%BB%BAcloudwatch-log%E6%97%A5%E5%BF%97%E7%BB%84">åˆ›å»ºCloudWatch Logæ—¥å¿—ç»„</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E5%91%8A%E8%AD%A6">åˆ›å»ºå‘Šè­¦</a></li>
</ul>
</li>
<li><a href="#%E6%80%BB%E7%BB%93">æ€»ç»“</a></li>
<li><a href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5">å‚è€ƒé“¾æ¥</a></li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">ä¸‹ä¸€ç¯‡</div>
            <a href="https://skyblu3519.github.io/post/aws-account-id-reconnaissance/">
              <h3 class="post-title">
                AWS Account ID Reconnaissance
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
  <a class="rss" href="https://skyblu3519.github.io/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
